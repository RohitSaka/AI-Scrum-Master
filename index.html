<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG AI Agile Platform</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --ig-cyan: #22d3ee; --ig-yellow: #facc15; --ig-magenta: #e879f9; --ig-navy: #0f172a; }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }

        .light-mode {
            background-color: #f8fafc; color: #0f172a;
            --bg-sidebar: #ffffff; --bg-card: #ffffff; --text-main: #0f172a; --text-muted: #64748b; --border-color: #e2e8f0;
        }
        .dark-mode {
            background-color: var(--ig-navy); color: #f8fafc;
            --bg-sidebar: #020617; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155;
            background-image: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.05), transparent 30%), radial-gradient(circle at 90% 80%, rgba(232, 121, 249, 0.05), transparent 30%);
        }
        .glass-card { background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .active-tab { background: rgba(34, 211, 238, 0.1); border-left: 4px solid var(--ig-cyan); color: var(--text-main); }
        .sticky-note { cursor: grab; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #1e293b; }
        .sticky-green { background: #dcfce7; border-left: 4px solid #22c55e; }
        .sticky-red { background: #fee2e2; border-left: 4px solid #ef4444; }
        .sticky-blue { background: #dbeafe; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;
        const API_BASE = "https://ai-scrum-master-cm2c.onrender.com"; 

        const IGLogo = () => (
            <div class="flex gap-1"><div class="w-3 h-3 rounded-full bg-[var(--ig-cyan)]"></div><div class="w-3 h-3 rounded-full bg-[var(--ig-yellow)]"></div><div class="w-3 h-3 rounded-full bg-[var(--ig-magenta)]"></div></div>
        );

        function App() {
            const [view, setView] = useState('dashboard');
            const [project, setProject] = useState('SCRUM');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [theme, setTheme] = useState('dark');
            const [selectedTask, setSelectedTask] = useState(null); // For Drawer

            const toggleTheme = () => {
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                document.body.className = newTheme === 'dark' ? 'dark-mode' : 'light-mode';
            };

            return (
                <div class="flex h-screen overflow-hidden">
                    <header class="md:hidden flex items-center justify-between p-4 border-b z-20 absolute w-full top-0 glass-card">
                        <div class="flex items-center gap-3 font-bold"><IGLogo /><span class="tracking-wide text-[var(--text-main)]">IG AGILE</span></div>
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} class="text-[var(--text-main)]">‚ò∞</button>
                    </header>

                    <aside class={`fixed md:relative z-30 h-full w-64 flex flex-col justify-between transition-transform duration-300 border-r ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`} style={{backgroundColor: 'var(--bg-sidebar)', borderColor: 'var(--border-color)'}}>
                        <div>
                            <div class="p-6 hidden md:block">
                                <div class="flex items-center gap-3 mb-2"><IGLogo /><h1 class="text-2xl font-black text-[var(--text-main)]">IG AGILE</h1></div>
                                <p class="text-xs text-[var(--text-muted)] font-mono pl-1">Enterprise v4.0</p>
                            </div>
                            <nav class="mt-4 md:mt-4 pt-16 md:pt-0 space-y-1 px-2">
                                <NavBtn id="dashboard" icon="üìä" label="Command Center" active={view} set={setView} />
                                <NavBtn id="timeline" icon="üóìÔ∏è" label="Timeline" active={view} set={setView} />
                                <NavBtn id="standup" icon="ü§ñ" label="Standup Bot" active={view} set={setView} />
                                <NavBtn id="burndown" icon="üìâ" label="Burndown" active={view} set={setView} />
                                <NavBtn id="retro" icon="üßò" label="Retrospective" active={view} set={setView} />
                                <NavBtn id="reports" icon="üìë" label="Reports" active={view} set={setView} />
                            </nav>
                        </div>
                        <div class="p-4 border-t" style={{borderColor: 'var(--border-color)'}}>
                             <button onClick={toggleTheme} class="w-full mb-4 p-2 rounded flex items-center justify-center gap-2 border text-xs font-bold uppercase tracking-wider" style={{borderColor: 'var(--border-color)', color: 'var(--text-muted)'}}>{theme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode'}</button>
                             <select value={project} onChange={(e) => setProject(e.target.value)} class="w-full p-2 rounded border outline-none" style={{backgroundColor: 'var(--bg-card)', color: 'var(--text-main)', borderColor: 'var(--border-color)'}}>
                                <option value="SCRUM">Provider Services</option>
                                <option value="OT">Ops Team</option>
                            </select>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto pt-16 md:pt-0 relative">
                        <div class="p-6 md:p-10 max-w-7xl mx-auto">
                            {view === 'dashboard' && <DashboardView project={project} />}
                            {view === 'timeline' && <TimelineView project={project} onTaskClick={setSelectedTask} />}
                            {view === 'standup' && <StandupView project={project} />}
                            {view === 'burndown' && <BurndownView project={project} />}
                            {view === 'retro' && <RetroView project={project} />}
                            {view === 'reports' && <ReportsView project={project} />}
                        </div>
                    </main>

                    {/* INSPECTOR DRAWER */}
                    <AnimatePresence>
                        {selectedTask && (
                            <>
                                <motion.div initial={{opacity:0}} animate={{opacity:0.5}} exit={{opacity:0}} onClick={() => setSelectedTask(null)} class="fixed inset-0 bg-black z-40" />
                                <motion.div initial={{x:"100%"}} animate={{x:0}} exit={{x:"100%"}} transition={{type:"spring", damping:25}} class="fixed right-0 top-0 h-full w-96 z-50 p-6 shadow-2xl overflow-y-auto" style={{backgroundColor: 'var(--bg-sidebar)', borderLeft: '1px solid var(--border-color)'}}>
                                    <div class="flex justify-between items-start mb-6">
                                        <h2 class="text-xl font-bold text-[var(--text-main)]">{selectedTask.key}</h2>
                                        <button onClick={() => setSelectedTask(null)} class="text-[var(--text-muted)]">‚úï</button>
                                    </div>
                                    <div class="space-y-6">
                                        <div><label class="text-[10px] uppercase font-bold text-[var(--text-muted)]">Summary</label><p class="text-[var(--text-main)] text-lg font-medium">{selectedTask.summary}</p></div>
                                        <div class="glass-card p-4 rounded-xl space-y-4">
                                            <div>
                                                <label class="text-[10px] uppercase font-bold text-[var(--ig-cyan)] block mb-1">Due Date</label>
                                                <input type="date" defaultValue={selectedTask.end} onChange={(e) => fetch(`${API_BASE}/issue/update`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:selectedTask.key,field:'duedate',value:e.target.value})})} class="w-full p-2 rounded border outline-none" style={{backgroundColor:'var(--bg-card)', color:'var(--text-main)', borderColor:'var(--border-color)'}} />
                                            </div>
                                            <div>
                                                <label class="text-[10px] uppercase font-bold text-[var(--ig-magenta)] block mb-1">Assignee</label>
                                                <input type="text" placeholder="Enter username..." onKeyDown={(e) => {if(e.key==='Enter') fetch(`${API_BASE}/issue/update`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:selectedTask.key,field:'assignee',value:e.target.value})}).then(()=>alert("Updated!"))}} class="w-full p-2 rounded border outline-none" style={{backgroundColor:'var(--bg-card)', color:'var(--text-main)', borderColor:'var(--border-color)'}} />
                                            </div>
                                        </div>
                                        <div><label class="text-[10px] uppercase font-bold text-[var(--text-muted)]">Description</label><div class="mt-2 text-[var(--text-main)] text-sm leading-relaxed">{selectedTask.description}</div></div>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set }) => (
            <button onClick={() => set(id)} class={`w-full text-left p-3 rounded-lg transition flex items-center gap-3 text-sm font-medium ${active === id ? 'active-tab shadow-lg' : 'text-[var(--text-muted)] hover:bg-opacity-10 hover:bg-white'}`}>
                <span class="text-lg">{icon}</span> {label}
            </button>
        );

        // --- DASHBOARD ---
        function DashboardView({ project }) {
            const [data, setData] = useState(null);
            useEffect(() => { fetch(`${API_BASE}/analytics/${project}`).then(r=>r.json()).then(setData); }, [project]);
            if (!data) return <LoadingScreen />;
            return (
                <div class="animate-fade-in space-y-8">
                    <header><h2 class="text-3xl font-bold text-[var(--text-main)]">Command Center</h2></header>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <MetricCard label="Active Tickets" value={data.metrics.total_tickets} color="border-[var(--ig-cyan)]" />
                        <MetricCard label="Story Points" value={data.metrics.total_points} color="border-[var(--ig-magenta)]" />
                        <MetricCard label="Blockers" value={data.metrics.blockers} color="border-red-500" />
                        <MetricCard label="Team Size" value={Object.keys(data.metrics.assignees).length} color="border-[var(--ig-yellow)]" />
                    </div>
                    <div class="glass-card rounded-xl p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 opacity-5 text-9xl grayscale">üß†</div>
                        <h3 class="font-bold text-[var(--ig-yellow)] mb-2 uppercase tracking-wider text-xs">AI Executive Analysis</h3>
                        <p class="text-[var(--text-main)] leading-relaxed text-lg font-light">"{data.ai_insights.sprint_summary}"</p>
                    </div>
                </div>
            );
        }

        // --- TIMELINE (With Click) ---
        function TimelineView({ project, onTaskClick }) {
            const [data, setData] = useState(null);
            useEffect(() => { fetch(`${API_BASE}/analytics/${project}`).then(r=>r.json()).then(setData); }, [project]);
            if (!data) return <LoadingScreen />;
            const days = ["Mon", "Tue", "Wed", "Thu", "Fri"];
            return (
                <div class="animate-fade-in">
                    <h2 class="text-3xl font-bold text-[var(--text-main)] mb-6">Timeline Capacity</h2>
                    <div class="glass-card rounded-xl overflow-hidden shadow-2xl">
                        <div class="grid grid-cols-[200px_repeat(5,1fr)] border-b" style={{borderColor: 'var(--border-color)', backgroundColor: 'var(--bg-sidebar)'}}>
                            <div class="p-3 text-[var(--text-muted)] font-bold text-xs uppercase flex items-center">Developer</div>
                            {days.map(d => <div key={d} class="p-3 text-center text-[var(--text-muted)] font-bold text-xs border-l" style={{borderColor: 'var(--border-color)'}}>{d}</div>)}
                        </div>
                        {Object.entries(data.metrics.assignees).map(([name, stats]) => (
                            <div key={name} class="grid grid-cols-[200px_repeat(5,1fr)] border-b" style={{borderColor: 'var(--border-color)'}}>
                                <div class="p-4 border-r flex flex-col justify-center" style={{borderColor: 'var(--border-color)', backgroundColor: 'var(--bg-card)'}}>
                                    <div class="flex items-center gap-2 mb-2"><img src={stats.avatar} class="w-6 h-6 rounded-full" /><span class="text-[var(--text-main)] text-xs font-bold truncate">{name.split(" ")[0]}</span></div>
                                    <div class="w-full h-1 rounded-full mb-1" style={{backgroundColor: 'rgba(0,0,0,0.1)'}}><div class={`h-1 rounded-full ${stats.points > 15 ? 'bg-red-500' : 'bg-[var(--ig-cyan)]'}`} style={{width: `${Math.min(100, (stats.points/20)*100)}%`}}></div></div>
                                </div>
                                <div class="col-span-5 p-2 flex flex-wrap gap-2 content-start" style={{backgroundColor: 'var(--bg-sidebar)'}}>
                                    {stats.tasks.map(t => (
                                        <div key={t.key} onClick={() => onTaskClick(t)} class={`w-full p-2 rounded border-l-2 mb-1 cursor-pointer transition ${t.priority === 'High' ? 'bg-red-500/10 border-red-500 text-red-500' : 'bg-[var(--ig-cyan)]/10 border-[var(--ig-cyan)] text-[var(--ig-cyan)]'}`}>
                                            <div class="flex justify-between font-bold text-[10px]"><span>{t.key}</span><span>{t.points} pts</span></div>
                                            <div class="truncate opacity-70 text-[10px]">{t.summary}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- STANDUP BOT ---
        function StandupView({ project }) {
            const [tasks, setTasks] = useState([]);
            const [curr, setCurr] = useState(0);
            const [reply, setReply] = useState("");
            const [hist, setHist] = useState([]);

            useEffect(() => {
                fetch(`${API_BASE}/analytics/${project}`).then(r=>r.json()).then(d => {
                    const all = Object.values(d.metrics.assignees).flatMap(u => u.tasks);
                    setTasks(all);
                    if(all.length) setHist([{sender:'bot', text:`Hi! Found ${all.length} tasks. Status on ${all[0].key}?`}]);
                });
            }, [project]);

            const send = () => {
                if(!reply) return;
                const task = tasks[curr];
                setHist([...hist, {sender:'user', text:reply}]);
                setReply("");
                fetch(`${API_BASE}/standup/post`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({key:task.key, message:reply})});
                setTimeout(() => {
                    if(curr+1 < tasks.length) { setCurr(curr+1); setHist(prev => [...prev, {sender:'bot', text:`Logged. Next: ${tasks[curr+1].key}?`}]); }
                    else setHist(prev => [...prev, {sender:'bot', text:"All done! üöÄ"}]);
                }, 800);
            };

            return (
                <div class="max-w-2xl mx-auto h-[600px] flex flex-col glass-card rounded-xl overflow-hidden">
                    <div class="p-4 border-b flex items-center gap-3" style={{borderColor:'var(--border-color)', backgroundColor:'var(--bg-sidebar)'}}>
                        <div class="w-10 h-10 rounded-full bg-[var(--ig-cyan)] flex items-center justify-center font-bold text-slate-900">ü§ñ</div>
                        <div><h3 class="font-bold text-[var(--text-main)]">Standup Bot</h3><p class="text-xs text-[var(--text-muted)]">Syncs to Jira</p></div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-4">
                        {hist.map((m, i) => (
                            <div key={i} class={`flex ${m.sender==='user'?'justify-end':'justify-start'}`}>
                                <div class={`max-w-[80%] p-3 rounded-xl text-sm ${m.sender==='user'?'bg-blue-600 text-white':'bg-gray-700 text-white'}`}>{m.text}</div>
                            </div>
                        ))}
                    </div>
                    <div class="p-4 border-t flex gap-2" style={{borderColor:'var(--border-color)', backgroundColor:'var(--bg-sidebar)'}}>
                        <input value={reply} onChange={e=>setReply(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Type update..." class="flex-1 p-3 rounded-lg border outline-none" style={{backgroundColor:'var(--bg-card)', color:'var(--text-main)', borderColor:'var(--border-color)'}} />
                        <button onClick={send} class="bg-[var(--ig-cyan)] text-slate-900 px-6 font-bold rounded-lg hover:brightness-110">Send</button>
                    </div>
                </div>
            );
        }

        // --- OTHER VIEWS (Burndown, Retro, Reports - Keeping same logic, applying theme vars) ---
        function BurndownView({ project }) {
            const chartRef = useRef(null);
            useEffect(() => { fetch(`${API_BASE}/burndown/${project}`).then(r=>r.json()).then(d => {
                if(chartRef.current) new Chart(chartRef.current, {type:'line', data:{labels:d.labels, datasets:[{label:'Actual', data:d.actual, borderColor:'#e879f9', fill:true}]}, options:{responsive:true, plugins:{legend:{labels:{color:'#94a3b8'}}}, scales:{y:{ticks:{color:'#94a3b8'}, grid:{color:'rgba(128,128,128,0.1)'}}, x:{ticks:{color:'#94a3b8'}, grid:{display:false}}}}});
            }); }, [project]);
            return (<div><h2 class="text-3xl font-bold text-[var(--text-main)] mb-6">Burndown</h2><div class="glass-card p-6 rounded-xl h-[500px]"><canvas ref={chartRef}></canvas></div></div>);
        }

        function RetroView({ project }) {
            const [board, setBoard] = useState({ well: [], improve: [], actions: [] });
            const [input, setInput] = useState("");
            const [col, setCol] = useState("well");
            const refresh = () => fetch(`${API_BASE}/retro/${project}`).then(r=>r.json()).then(setBoard);
            useEffect(() => { refresh(); }, [project]);
            const add = () => { if(!input) return; const nb = {...board, [col]: [...board[col], {id:Date.now(), text:input}]}; fetch(`${API_BASE}/retro/update`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({project, board:nb})}).then(refresh); setInput(""); };
            return (
                <div class="h-full flex flex-col pb-20">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-[var(--text-main)]">Retrospective</h2><div class="p-1 rounded-lg flex gap-1 border" style={{borderColor:'var(--border-color)', backgroundColor:'var(--bg-card)'}}>{['well', 'improve', 'actions'].map(c => <button key={c} onClick={()=>setCol(c)} class={`px-4 py-2 rounded text-sm font-bold capitalize ${col===c?'bg-[var(--ig-cyan)] text-slate-900':'text-[var(--text-muted)]'}`}>{c}</button>)}</div></div>
                    <div class="flex gap-2 mb-8"><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&add()} placeholder="Add note..." class="flex-1 p-4 rounded-xl border outline-none" style={{backgroundColor:'var(--bg-card)', color:'var(--text-main)', borderColor:'var(--border-color)'}} /><button onClick={add} class="bg-[var(--ig-cyan)] text-slate-900 px-8 rounded-xl font-bold">Post</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 min-h-0">
                        {['well', 'improve', 'actions'].map(c => <div key={c} class="glass-card p-4 rounded-xl overflow-y-auto space-y-3"><h3 class="font-bold text-[var(--text-muted)] uppercase text-xs mb-4">{c}</h3>{board[c].map(i => <div key={i.id} class="sticky-note p-4 rounded-lg bg-white text-slate-900 shadow">{i.text}</div>)}</div>)}
                    </div>
                </div>
            );
        }

        function ReportsView({ project }) {
            const [report, setReport] = useState(null);
            useEffect(() => { fetch(`${API_BASE}/reports/${project}/weekly`).then(r=>r.json()).then(setReport); }, [project]);
            if(!report) return <LoadingScreen />;
            return (
                <div class="animate-fade-in"><h2 class="text-3xl font-bold text-[var(--text-main)] mb-6">Weekly Report</h2><div class="glass-card p-8 rounded-xl max-w-3xl"><div class="flex justify-between mb-8 pb-8 border-b" style={{borderColor:'var(--border-color)'}}><div><div class="text-[var(--text-muted)] text-xs uppercase font-bold">Completed</div><div class="text-6xl font-black text-[var(--text-main)]">{report.completed_count}</div></div><div><div class="text-[var(--text-muted)] text-xs uppercase font-bold">Velocity</div><div class="text-6xl font-black text-[var(--ig-cyan)]">{report.completed_points}</div></div></div><div class="prose"><h3 class="text-[var(--ig-yellow)] font-bold mb-2 uppercase text-sm">Summary</h3><p class="text-[var(--text-main)] leading-relaxed text-lg font-light">{report.ai_summary.summary}</p></div></div></div>
            );
        }

        function LoadingScreen() { return <div class="h-96 flex flex-col items-center justify-center"><div class="w-12 h-12 border-4 border-[var(--ig-cyan)] border-t-transparent rounded-full animate-spin"></div></div>; }
        function MetricCard({ label, value, color }) { return <div class={`glass-card p-5 rounded-xl border-l-4 ${color}`} style={{borderColor:color.includes('cyan')?'var(--ig-cyan)':color.includes('magenta')?'var(--ig-magenta)':'var(--ig-yellow)'}}><div class="text-[var(--text-muted)] text-[10px] font-bold uppercase mb-1">{label}</div><div class="text-3xl font-black text-[var(--text-main)]">{value}</div></div>; }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>