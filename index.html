<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Agile Scrum | Enterprise</title>
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%236366f1"/><text x="50" y="65" font-family="Arial" font-size="50" font-weight="bold" fill="white" text-anchor="middle">IG</text></svg>'>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --transition-speed: 0.3s; }
        .dark-mode { --bg-body: #0B1121; --bg-sidebar: #020617; --bg-card: #1E293B; --bg-hover: #334155; --text-main: #F8FAFC; --text-muted: #94A3B8; --border: #334155; --primary: #D97706; --primary-dim: rgba(217, 119, 6, 0.15); --danger: #EF4444; --success: #10B981; --warning: #F59E0B; --glass-border: rgba(255, 255, 255, 0.08); --glass-bg: rgba(30, 41, 59, 0.7); }
        .light-mode { --bg-body: #F0F2F5; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF; --bg-hover: #E2E8F0; --text-main: #0F172A; --text-muted: #475569; --border: #CBD5E1; --primary: #0369A1; --primary-dim: rgba(3, 105, 161, 0.1); --danger: #DC2626; --success: #059669; --warning: #D97706; --glass-border: rgba(0, 0, 0, 0.05); --glass-bg: rgba(255, 255, 255, 0.85); }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background-color var(--transition-speed), color var(--transition-speed); overflow: hidden; margin: 0; }
        .glass-card { background: var(--glass-bg); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); backdrop-filter: blur(12px); border-radius: 1rem; }
        .nav-btn { color: var(--text-muted); padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; border-left: 3px solid transparent; }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-btn.active { background: var(--primary-dim); color: var(--primary); border-left-color: var(--primary); }
        .input-field { background-color: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-dim); }
        .prose strong { color: var(--text-main); font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; }
        .prose li { margin-bottom: 0.25rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .loader { width: 20px; height: 20px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 0.8s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .retro-col { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; flex-direction: column; height: 100%; overflow: hidden; backdrop-filter: blur(10px); }
        .retro-col-header { padding: 1rem; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; color: var(--text-muted); }
        .retro-col-body { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .retro-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-size: 0.875rem; line-height: 1.5; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; }
        .retro-card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .roadmap-grid { display: grid; grid-template-columns: 250px repeat(12, 1fr); background: transparent; }
        .roadmap-header { font-weight: 700; font-size: 10px; text-transform: uppercase; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); text-align: center; background: var(--bg-card); }
        .roadmap-cell { border-right: 1px solid var(--border); opacity: 0.2; }
        .roadmap-item { position: absolute; border-radius: 6px; padding: 8px 12px; font-size: 11px; font-weight: 600; color: white; display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 10; transition: transform 0.2s, z-index 0s; }
        .roadmap-item:hover { z-index: 20; transform: translateY(-2px) scale(1.01); }
        @media print { 
            html, body, #root, div { height: auto !important; overflow: visible !important; position: static !important; }
            body * { visibility: hidden; } 
            #print-engine-container, #print-engine-container * { visibility: visible; }
            #print-engine-container { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; display: block !important; opacity: 1 !important; z-index: 99999 !important; }
            .print-slide { width: 1280px !important; height: 720px !important; page-break-after: always !important; break-after: page !important; background: #0B1121 !important; margin: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { size: landscape; margin: 0; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'bg-body': 'var(--bg-body)', 'bg-sidebar': 'var(--bg-sidebar)', 'bg-card': 'var(--bg-card)', 'bg-hover': 'var(--bg-hover)', 'text-main': 'var(--text-main)', 'text-muted': 'var(--text-muted)', 'border': 'var(--border)', 'primary': 'var(--primary)', 'primary-dim': 'var(--primary-dim)', 'danger': 'var(--danger)', 'success': 'var(--success)', 'warning': 'var(--warning)' } } }
        }
    </script>
</head>
<body class="dark-mode">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;
        const API_BASE = "https://ai-scrum-master-cm2c.onrender.com";

        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>,
                Activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
                RefreshCcw: <><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></>,
                MessageSquare: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></>,
                Monitor: <><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></>,
                ChevronLeft: <><polyline points="15 18 9 12 15 6"></polyline></>,
                ChevronRight: <><polyline points="9 18 15 12 9 6"></polyline></>,
                Sun: <><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line></>,
                Moon: <><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></>,
                Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></>,
                Sparkles: <><path d="M12 3l1.912 5.813a2 2 0 001.275 1.275L21 12l-5.813 1.912a2 2 0 00-1.275 1.275L12 21l-1.912-5.813a2 2 0 00-1.275-1.275L3 12l5.813-1.912a2 2 0 001.275-1.275L12 3z"></path></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
                CloudLightning: <><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></>,
                Maximize: <><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
                Image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>,
                Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>,
                Star: <><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></>,
                AlertTriangle: <><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></>,
                Link: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></>,
                Copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>,
                Zap: <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></>,
                Target: <><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></>,
                AlignLeft: <><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></>,
                Trash: <><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></>,
                Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || null}</svg>;
        };

        const secureFetch = async (endpoint, options = {}) => {
            const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
            const isGuest = endpoint.startsWith('/guest'); 
            if (!isGuest && !config.license_key && !config.token) return null; 
            const headers = { 'Content-Type': 'application/json', 'x-license-key': config.license_key || '', 'x-jira-domain': config.domain || '', 'x-jira-email': config.email || '', 'x-jira-token': config.token || '', ...options.headers };
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                if (res.status === 401 || res.status === 403) { localStorage.removeItem('ig_config'); window.location.reload(); return null; }
                return res;
            } catch (error) { return null; }
        };

        function App() {
            const [theme, setTheme] = useState(localStorage.getItem('ig_theme') || 'dark');
            useEffect(() => { document.body.className = theme === 'dark' ? 'dark-mode' : 'light-mode'; localStorage.setItem('ig_theme', theme); }, [theme]);
            
            const params = new URLSearchParams(window.location.search);
            const guestToken = params.get('guest_token');
            if (guestToken) return <GuestRetroView token={guestToken} theme={theme} setTheme={setTheme} />;

            const [config, setConfig] = useState(JSON.parse(localStorage.getItem('ig_config')));
            if (!config || (!config.token && !config.license_key)) return <LoginScreen onLogin={setConfig} theme={theme} setTheme={setTheme} />;
            return <DashboardLayout userRole={config.role || 'scrum_master'} theme={theme} setTheme={setTheme} />;
        }

        function GuestRetroView({ token, theme, setTheme }) {
            const [board, setBoard] = useState(null);
            const [info, setInfo] = useState({ project: '', sprint: '' });
            const [input, setInput] = useState("");
            const [col, setCol] = useState("well");
            const [error, setError] = useState(null);

            const fetchBoard = () => {
                fetch(`${API_BASE}/guest/retro/${token}`)
                    .then(r => { if (!r.ok) throw new Error("Invalid Link"); return r.json(); })
                    .then(d => { setBoard(d.board); setInfo({ project: d.project, sprint: d.sprint }); setError(null); })
                    .catch(e => setError("This invite link has expired or is invalid."));
            };

            useEffect(() => {
                fetchBoard();
                const interval = setInterval(fetchBoard, 3000); 
                return () => clearInterval(interval);
            }, [token]);

            const add = async () => {
                if (!input.trim()) return;
                const r = await fetch(`${API_BASE}/guest/retro/${token}/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ column: col, text: input })
                });
                const res = await r.json();
                if (res.status === 'success') { setBoard(res.board); setInput(""); }
            };

            if (error) return <div className="h-screen flex items-center justify-center text-danger font-bold text-xl">{error}</div>;
            if (!board) return <LoadingScreen msg="Joining Team Retro..." />;

            return (
                <div className="h-screen flex flex-col relative transition-colors duration-500 bg-bg-body p-8">
                    <div className="absolute top-4 right-4 z-50"><ThemeToggle theme={theme} setTheme={setTheme} /></div>
                    <header className="mb-10 text-center">
                        <div className="w-16 h-16 rounded-xl flex items-center justify-center text-white font-black text-2xl mx-auto mb-4 shadow-xl bg-gradient-to-br from-primary to-amber-600">IG</div>
                        <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Team Retrospective</h2>
                        <p className="text-lg font-medium mt-2 text-text-muted">Sprint {info.sprint} ‚Ä¢ Anonymous Guest Mode</p>
                    </header>
                    <div className="max-w-5xl mx-auto w-full flex-1 flex flex-col">
                        <div className="flex gap-4 mb-10 bg-bg-card p-4 rounded-2xl border border-border shadow-2xl">
                            <div className="flex bg-bg-body rounded-xl p-1.5 border border-border">
                                {['well', 'improve', 'kudos'].map(c => (<button key={c} onClick={() => setCol(c)} className={`px-8 py-4 rounded-lg text-sm font-black uppercase tracking-wider transition-all ${col === c ? 'bg-primary text-white shadow-md' : 'text-text-muted hover:text-text-main'}`}>{c}</button>))}
                            </div>
                            <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && add()} placeholder="Drop an anonymous note here..." className="flex-1 bg-transparent text-text-main px-6 font-medium text-xl outline-none" />
                            <button onClick={add} className="bg-primary px-12 text-white font-extrabold rounded-xl hover:shadow-lg hover:scale-105 transition-all text-lg">Post</button>
                        </div>
                        <div className="grid grid-cols-3 gap-10 flex-1 pb-10">
                            {['well', 'improve', 'kudos'].map(c => (
                                <div key={c} className="retro-col shadow-2xl border-t-4" style={{ borderTopColor: c === 'well' ? 'var(--success)' : c === 'improve' ? 'var(--danger)' : 'var(--primary)' }}>
                                    <div className="retro-col-header bg-bg-card/50 text-sm"><span>{c}</span><Icon name={c === 'well' ? 'CheckCircle' : c === 'improve' ? 'TrendingDown' : 'Star'} size={20} /></div>
                                    <div className="retro-col-body bg-bg-body/50 p-4">
                                        <AnimatePresence>
                                            {board[c]?.map(i => (
                                                <motion.div key={i.id} initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} className="retro-card font-medium text-base p-5 border-l-4" style={{ borderLeftColor: 'var(--primary)' }}>{i.text}</motion.div>
                                            ))}
                                        </AnimatePresence>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function LoginScreen({ onLogin, theme, setTheme }) {
            const [licenseKey, setLicenseKey] = useState('');
            const [role, setRole] = useState('scrum_master');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('success') === 'true') {
                    const savedLicense = localStorage.getItem('pending_license');
                    const savedRole = localStorage.getItem('pending_role');
                    if (savedLicense) {
                        const newConfig = { license_key: savedLicense, role: savedRole };
                        localStorage.setItem('ig_config', JSON.stringify(newConfig));
                        localStorage.removeItem('pending_license'); localStorage.removeItem('pending_role');
                        window.history.replaceState({}, document.title, window.location.pathname); 
                        onLogin(newConfig);
                    }
                }
            }, []);

            const handleOAuthLogin = () => {
                if (!licenseKey) return alert("Please enter your Enterprise License Key.");
                setLoading(true); localStorage.setItem('pending_license', licenseKey); localStorage.setItem('pending_role', role);
                window.location.href = `${API_BASE}/auth/login?license_key=${licenseKey}`;
            };

            return (
                <div className="h-screen flex items-center justify-center relative transition-colors duration-500" style={{ backgroundColor: 'var(--bg-body)' }}>
                    <div className="absolute top-4 right-4"><ThemeToggle theme={theme} setTheme={setTheme} /></div>
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="w-[420px] glass-card p-10 z-10 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-48 h-48 bg-primary-dim rounded-full blur-3xl -mr-10 -mt-10 opacity-50"></div>
                        <div className="mb-10 text-center relative z-10">
                            <div className="w-20 h-20 rounded-2xl flex items-center justify-center text-white font-black text-3xl mx-auto mb-6 shadow-xl bg-gradient-to-br from-primary to-amber-600">IG</div>
                            <h1 className="text-3xl font-extrabold tracking-tight" style={{ color: 'var(--text-main)' }}>Agile Intelligence</h1>
                            <p className="text-sm font-medium mt-2" style={{ color: 'var(--text-muted)' }}>Enterprise Edition</p>
                        </div>
                        <div className="space-y-6 relative z-10">
                            <div><label className="text-xs font-bold uppercase tracking-wider mb-2 block" style={{ color: 'var(--text-muted)' }}>Role Profile</label><select value={role} onChange={e => setRole(e.target.value)} className="w-full p-3 rounded-lg text-sm input-field font-semibold shadow-sm"><option value="leadership">üëë Executive / CDO</option><option value="scrum_master">‚öîÔ∏è Scrum Master / PM</option></select></div>
                            <div><label className="text-xs font-bold uppercase tracking-wider mb-2 flex items-center gap-2" style={{ color: 'var(--text-muted)' }}><Icon name="Key" size={14} /> License Key</label><input value={licenseKey} onChange={e => setLicenseKey(e.target.value)} placeholder="IG-ENT-..." className="w-full p-3 rounded-lg text-sm input-field shadow-sm font-mono tracking-wide" /></div>
                            <button onClick={handleOAuthLogin} disabled={loading} className="w-full text-white font-bold p-4 rounded-lg shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex justify-center items-center gap-3 text-sm bg-primary disabled:opacity-70 disabled:hover:scale-100">{loading ? <span className="loader w-5 h-5 border-2"></span> : <><Icon name="Activity" size={20} /> Log in with Atlassian</>}</button>
                        </div>
                    </motion.div>
                </div>
            );
        }

        function DashboardLayout({ userRole, theme, setTheme }) {
            const [view, setView] = useState('timeline');
            const [projects, setProjects] = useState([]);
            const [activeProject, setActiveProject] = useState(null);
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);

            useEffect(() => {
                secureFetch('/projects').then(r => r ? r.json() : []).then(data => {
                    if (data && data.length > 0) { setProjects(data); setActiveProject(data[0].key); }
                    else { setProjects([{ key: 'DEMO', name: 'Demo Project' }]); setActiveProject('DEMO'); }
                });
            }, []);

            return (
                <div className="flex h-screen overflow-hidden bg-bg-body">
                    <aside className="w-72 shrink-0 flex flex-col justify-between border-r transition-colors duration-300 no-print bg-bg-sidebar border-border">
                        <div className="p-6">
                            <div className="mb-10 pl-2 flex items-center gap-4">
                                <div className="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-lg bg-gradient-to-br from-primary to-amber-600">IG</div>
                                <div><h1 className="text-xl font-extrabold tracking-tight leading-none text-text-main">Agile Scrum</h1></div>
                            </div>
                            <nav className="space-y-2">
                                <NavBtn id="smartdeck" icon="Monitor" label="AI Sprint Deck" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="dashboard" icon="Activity" label="Command Center" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="timeline" icon="Zap" label="Sprint Dynamics & Build" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="roadmap" icon="Map" label="Strategic Roadmap" active={view} set={setView} disabled={isGlobalLoading} />
                                {(userRole === 'scrum_master' || userRole === 'leadership') && <><NavBtn id="reports" icon="FileText" label="Reports & Reviews" active={view} set={setView} disabled={isGlobalLoading} /><NavBtn id="retro" icon="RefreshCcw" label="Retrospective" active={view} set={setView} disabled={isGlobalLoading} /></>}
                            </nav>
                        </div>
                        <div className="p-6 border-t border-border space-y-6">
                            <ThemeToggle theme={theme} setTheme={setTheme} fullWidth />
                            <div><label className="text-xs font-bold uppercase mb-3 block text-text-muted tracking-wider">Active Project</label><select value={activeProject || ''} onChange={e => setActiveProject(e.target.value)} disabled={isGlobalLoading} className={`w-full p-3 rounded-lg border text-sm input-field transition-all font-semibold ${isGlobalLoading ? 'opacity-30 cursor-not-allowed bg-slate-800' : 'cursor-pointer'}`}>{projects.map(p => <option key={p.key} value={p.key}>{p.name} ({p.key})</option>)}</select></div>
                            <button onClick={() => { localStorage.removeItem('ig_config'); window.location.reload() }} className="w-full text-left text-xs p-2 hover:bg-danger/10 rounded-lg font-bold text-danger transition-colors flex items-center gap-2"><Icon name="X" size={14} /> Sign Out</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative transition-colors duration-300 bg-bg-body" style={{ padding: view === 'smartdeck' ? '0' : '2.5rem' }}>
                        {activeProject ? (
                            <div className="flex-1 min-h-0 relative h-full">
                                {view === 'smartdeck' && <SmartDeckView project={activeProject} endpoint={`/super_deck/${activeProject}?sprint_id=active`} isFullScreenLayout={true} />}
                                {view === 'dashboard' && <DashboardView project={activeProject} role={userRole} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'roadmap' && <RoadmapView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'timeline' && <TimelineView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'standup' && <StandupView project={activeProject} />}
                                {view === 'retro' && <RetroView project={activeProject} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'reports' && <ReportsView project={activeProject} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                            </div>
                        ) : <LoadingScreen msg="Authenticating with Atlassian..." />}
                    </main>
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set, disabled }) => (<button onClick={() => set(id)} disabled={disabled} className={`nav-btn w-full ${active === id ? 'active' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}><Icon name={icon} size={20} /> {label}</button>);
        function ThemeToggle({ theme, setTheme, fullWidth }) { return (<button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`p-3 rounded-lg border text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-3 transition hover:bg-bg-hover border-border text-text-muted bg-bg-card ${fullWidth ? 'w-full' : ''}`}><Icon name={theme === 'dark' ? 'Sun' : 'Moon'} size={16} /> {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}</button>); }
        function MetricCard({ label, value, color, isDanger }) { return (<div className="glass-card p-6 border-l-4 transition-all hover:scale-[1.02]" style={{ borderLeftColor: isDanger ? 'var(--danger)' : `var(--${color})` }}><div className="text-xs font-bold uppercase tracking-widest mb-2 text-text-muted">{label}</div><div className="text-4xl font-extrabold text-text-main">{value}</div></div>); }

        /* ============================================================
           ‚úÖ FIX: DashboardView ‚Äî Command Center (was missing/undefined)
           ============================================================ */
        function DashboardView({ project, role, setIsLoading, isGlobalLoading }) {
            const [data, setData] = useState(null);
            const [sprints, setSprints] = useState([]);
            const [activeSprint, setActiveSprint] = useState('active');

            useEffect(() => {
                secureFetch(`/sprints/${project}`)
                    .then(r => r?.json())
                    .then(d => { if (d && d.length) setSprints(d); });
            }, [project]);

            useEffect(() => {
                setData(null);
                setIsLoading(true);
                const url = activeSprint === 'active'
                    ? `/analytics/${project}`
                    : `/analytics/${project}?sprint_id=${activeSprint}`;
                secureFetch(url)
                    .then(r => r?.json())
                    .then(d => { setData(d); setIsLoading(false); })
                    .catch(() => setIsLoading(false));
            }, [project, activeSprint]);

            if (!data) return <LoadingScreen msg="Loading Command Center..." />;

            const metrics = data.metrics || {};
            const ai = data.ai_insights || {};
            const assignees = Object.entries(metrics.assignees || {});
            const maxPts = Math.max(1, ...assignees.map(([, s]) => s.points || 0));

            const statusColor = (status) => {
                const s = (status || '').toLowerCase();
                if (s.includes('done') || s.includes('closed') || s.includes('resolved')) return 'var(--success)';
                if (s.includes('progress') || s.includes('review')) return 'var(--primary)';
                return 'var(--border)';
            };

            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4 space-y-10">
                    {/* Header */}
                    <header className="flex justify-between items-end pb-6 border-b border-border">
                        <div>
                            <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Command Center</h2>
                            <p className="text-base font-medium mt-2 text-text-muted">Sprint Intelligence Dashboard ¬∑ Project <span className="text-primary font-black">{project}</span></p>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-xs font-black uppercase tracking-wider text-text-muted">Sprint</span>
                            <select value={activeSprint} onChange={e => setActiveSprint(e.target.value)} className="p-3 rounded-lg border bg-bg-card text-text-main font-bold shadow-sm outline-none cursor-pointer hover:border-primary transition-colors border-border">
                                <option value="active">üü¢ Active Sprint</option>
                                {sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                    </header>

                    {/* KPI Row */}
                    <div className="grid grid-cols-4 gap-6">
                        <MetricCard label="Total Issues" value={metrics.total || 0} color="primary" />
                        <MetricCard label="Story Points" value={(metrics.points || 0).toFixed(1)} color="success" />
                        <MetricCard label="High Priority" value={metrics.blockers || 0} color="danger" isDanger={(metrics.blockers || 0) > 0} />
                        <MetricCard label="Bugs" value={metrics.bugs || 0} color="warning" isDanger={(metrics.bugs || 0) > 0} />
                    </div>

                    {/* AI Executive Summary */}
                    {ai.executive_summary && (
                        <motion.div initial={{ opacity: 0, y: 16 }} animate={{ opacity: 1, y: 0 }} className="glass-card p-8 border-t-4 border-primary relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-primary-dim rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none opacity-50"></div>
                            <h3 className="text-xs font-black uppercase tracking-widest text-primary mb-4 flex items-center gap-2 relative z-10">
                                <Icon name="Sparkles" size={16} /> AI Executive Summary
                            </h3>
                            <p className="text-xl font-bold text-text-main leading-relaxed relative z-10">{ai.executive_summary}</p>
                            {ai.business_value && (
                                <p className="text-sm text-text-muted mt-4 font-medium leading-relaxed border-t border-border pt-4 relative z-10">{ai.business_value}</p>
                            )}
                        </motion.div>
                    )}

                    {/* Team Workload */}
                    {assignees.length > 0 && (
                        <div className="glass-card p-8">
                            <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2">
                                <Icon name="Users" size={16} /> Team Workload Distribution
                            </h3>
                            <div className="space-y-4">
                                {assignees.map(([name, stats]) => (
                                    <div key={name} className="flex items-center gap-4 p-4 bg-bg-body rounded-xl border border-border hover:border-primary transition-colors group">
                                        {stats.avatar
                                            ? <img src={stats.avatar} className="w-10 h-10 rounded-full border-2 border-primary shrink-0" alt={name} />
                                            : <div className="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold text-sm shrink-0">{name.charAt(0)}</div>
                                        }
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="font-bold text-text-main text-sm truncate">{name}</span>
                                                <span className="text-xs font-black text-primary ml-4 shrink-0">{(stats.points || 0).toFixed(1)} pts</span>
                                            </div>
                                            <div className="w-full h-2 bg-border rounded-full overflow-hidden">
                                                <motion.div
                                                    initial={{ width: 0 }}
                                                    animate={{ width: `${Math.min(100, ((stats.points || 0) / maxPts) * 100)}%` }}
                                                    transition={{ duration: 0.8, ease: "easeOut" }}
                                                    className="h-full bg-primary rounded-full"
                                                ></motion.div>
                                            </div>
                                            <div className="text-xs text-text-muted mt-1">{stats.count} issues assigned</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Story Progress */}
                    {ai.story_progress && ai.story_progress.length > 0 && (
                        <div className="glass-card p-8">
                            <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2">
                                <Icon name="AlignLeft" size={16} /> AI Story Analysis
                            </h3>
                            <div className="space-y-4">
                                {ai.story_progress.map((story, i) => (
                                    <motion.div
                                        key={i}
                                        initial={{ opacity: 0, x: -10 }}
                                        animate={{ opacity: 1, x: 0 }}
                                        transition={{ delay: i * 0.05 }}
                                        className="p-5 bg-bg-body rounded-xl border border-border hover:border-primary transition-colors"
                                    >
                                        <div className="flex justify-between items-start gap-4 mb-2">
                                            <span className="text-xs font-black text-primary bg-primary-dim px-2.5 py-1 rounded-full shrink-0">{story.key}</span>
                                            <span className="text-xs font-bold px-2.5 py-1 rounded-full shrink-0" style={{ background: `${statusColor(story.status)}22`, color: statusColor(story.status), border: `1px solid ${statusColor(story.status)}44` }}>{story.status}</span>
                                        </div>
                                        <div className="font-bold text-text-main text-sm mt-2">{story.summary}</div>
                                        {story.analysis && <div className="text-xs text-text-muted mt-2 font-medium leading-relaxed border-t border-border pt-2">{story.analysis}</div>}
                                        {story.assignee && <div className="text-xs text-primary font-bold mt-2 flex items-center gap-1"><Icon name="Users" size={12} /> {story.assignee}</div>}
                                    </motion.div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* No data state */}
                    {assignees.length === 0 && !ai.executive_summary && (
                        <div className="glass-card p-16 flex flex-col items-center justify-center text-center">
                            <Icon name="Activity" size={56} className="text-text-muted mb-6 opacity-40" />
                            <h3 className="text-2xl font-extrabold text-text-main mb-3">No Sprint Data Found</h3>
                            <p className="text-text-muted font-medium max-w-md">No active sprint issues were found for project <span className="text-primary font-bold">{project}</span>. Select a specific sprint from the dropdown or ensure issues are assigned to a sprint in Jira.</p>
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           ‚úÖ FIX: RoadmapView ‚Äî Strategic Roadmap (was missing/undefined)
           ============================================================ */
        function RoadmapView({ project, setIsLoading }) {
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null);

            useEffect(() => {
                setData(null); setError(null); setIsLoading(true);
                secureFetch(`/roadmap/${project}`)
                    .then(r => r?.json())
                    .then(d => {
                        if (d && d.timeline && d.tracks) { setData(d); }
                        else { setError("AI could not generate roadmap data. Check that your project has backlog items."); }
                        setIsLoading(false);
                    })
                    .catch(() => { setError("Network error loading roadmap."); setIsLoading(false); });
            }, [project]);

            if (!data && !error) return <LoadingScreen msg="Building Strategic Roadmap with AI..." />;
            if (error) return (
                <div className="animate-fade-in h-full flex items-center justify-center">
                    <div className="glass-card p-12 max-w-lg text-center">
                        <Icon name="AlertTriangle" size={48} className="text-warning mx-auto mb-4 opacity-80" />
                        <h3 className="text-xl font-extrabold text-text-main mb-3">Roadmap Unavailable</h3>
                        <p className="text-text-muted font-medium">{error}</p>
                    </div>
                </div>
            );

            const TRACK_COLORS = ['#D97706', '#6366F1', '#10B981', '#EF4444', '#8B5CF6', '#EC4899'];
            const PRIORITY_COLORS = { High: '#EF4444', Highest: '#EF4444', Critical: '#EF4444', Medium: '#F59E0B', Low: '#10B981', Lowest: '#94A3B8' };
            const timeline = data.timeline || [];
            const tracks = data.tracks || [];

            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4">
                    {/* Header */}
                    <header className="flex justify-between items-end pb-6 border-b border-border mb-8">
                        <div>
                            <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Strategic Roadmap</h2>
                            <p className="text-base font-medium mt-2 text-text-muted">12-Week Release Plan ¬∑ AI Orchestrated ¬∑ Project <span className="text-primary font-black">{project}</span></p>
                        </div>
                        <div className="flex gap-4 flex-wrap justify-end">
                            {tracks.map((track, i) => (
                                <span key={i} className="flex items-center gap-2 text-xs font-bold text-text-muted uppercase tracking-wider">
                                    <span className="w-3 h-3 rounded-full inline-block shrink-0" style={{ background: TRACK_COLORS[i % TRACK_COLORS.length] }}></span>
                                    {track.name}
                                </span>
                            ))}
                        </div>
                    </header>

                    {/* Roadmap Grid */}
                    <div className="glass-card overflow-hidden shadow-xl mb-8">
                        <div className="overflow-x-auto hide-scroll">
                            <div style={{ minWidth: `${250 + timeline.length * 80}px` }}>
                                {/* Header row */}
                                <div style={{ display: 'grid', gridTemplateColumns: `250px repeat(${timeline.length}, 1fr)` }}>
                                    <div className="roadmap-header text-left px-4">Track</div>
                                    {timeline.map(w => <div key={w} className="roadmap-header">{w}</div>)}
                                </div>

                                {/* Track rows */}
                                {tracks.map((track, trackIdx) => {
                                    const color = TRACK_COLORS[trackIdx % TRACK_COLORS.length];
                                    const items = track.items || [];
                                    // Calculate row height based on overlapping items
                                    const rowH = Math.max(80, items.length > 0 ? 80 : 60);
                                    return (
                                        <div key={trackIdx} className="border-b border-border last:border-0" style={{ position: 'relative', minHeight: `${rowH}px` }}>
                                            {/* Grid columns background */}
                                            <div style={{ display: 'grid', gridTemplateColumns: `250px repeat(${timeline.length}, 1fr)`, height: '100%', position: 'absolute', inset: 0 }}>
                                                <div className="p-4 font-bold text-sm text-text-main border-r border-border flex items-center gap-3 bg-bg-card z-10">
                                                    <span className="w-3 h-3 rounded-full shrink-0" style={{ background: color }}></span>
                                                    <span className="truncate">{track.name}</span>
                                                </div>
                                                {timeline.map((_, ci) => (
                                                    <div key={ci} className="border-r border-border/30" style={{ background: ci % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.01)' }}></div>
                                                ))}
                                            </div>

                                            {/* Items overlay */}
                                            <div style={{ position: 'absolute', left: '250px', right: 0, top: 0, bottom: 0, pointerEvents: 'none' }}>
                                                {items.map((item, itemIdx) => {
                                                    const start = Math.max(0, Math.min(item.start || 0, timeline.length - 1));
                                                    const duration = Math.max(1, Math.min(item.duration || 1, timeline.length - start));
                                                    const leftPct = (start / timeline.length) * 100;
                                                    const widthPct = (duration / timeline.length) * 100;
                                                    const isDone = (item.status || '').toLowerCase().includes('done');

                                                    return (
                                                        <div
                                                            key={itemIdx}
                                                            className="roadmap-item"
                                                            style={{
                                                                left: `calc(${leftPct}% + 4px)`,
                                                                width: `calc(${widthPct}% - 8px)`,
                                                                top: `${12 + itemIdx * 40}px`,
                                                                background: isDone ? '#334155' : color,
                                                                opacity: isDone ? 0.6 : 1,
                                                                pointerEvents: 'auto',
                                                                border: selectedItem?.key === item.key ? '2px solid white' : '2px solid transparent',
                                                            }}
                                                            title={`${item.key}: ${item.summary}`}
                                                            onClick={() => setSelectedItem(selectedItem?.key === item.key ? null : item)}
                                                        >
                                                            <span className="truncate text-xs font-bold">{item.key}: {item.summary}</span>
                                                            {isDone && <span className="ml-2 opacity-70 shrink-0">‚úì</span>}
                                                        </div>
                                                    );
                                                })}
                                            </div>

                                            {/* Spacer to expand row for stacked items */}
                                            <div style={{ minHeight: `${Math.max(80, 12 + (track.items || []).length * 40 + 20)}px` }}></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Selected Item Detail Panel */}
                    <AnimatePresence>
                        {selectedItem && (
                            <motion.div
                                initial={{ opacity: 0, y: 20 }}
                                animate={{ opacity: 1, y: 0 }}
                                exit={{ opacity: 0, y: 20 }}
                                transition={{ type: "spring", bounce: 0.3 }}
                                className="glass-card p-8 border-l-4 border-primary"
                            >
                                <div className="flex justify-between items-start gap-6">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-3 flex-wrap">
                                            <span className="text-xs font-black text-primary bg-primary-dim px-3 py-1 rounded-full">{selectedItem.key}</span>
                                            <span className="text-xs font-bold px-3 py-1 rounded-full" style={{ background: `${PRIORITY_COLORS[selectedItem.priority] || 'var(--border)'}22`, color: PRIORITY_COLORS[selectedItem.priority] || 'var(--text-muted)', border: `1px solid ${PRIORITY_COLORS[selectedItem.priority] || 'var(--border)'}44` }}>{selectedItem.priority || 'Medium'} Priority</span>
                                            <span className="text-xs font-bold px-3 py-1 rounded-full bg-border/30 text-text-muted border border-border">{selectedItem.status || 'To Do'}</span>
                                        </div>
                                        <h3 className="text-xl font-extrabold text-text-main mb-2">{selectedItem.summary}</h3>
                                        <div className="flex gap-6 text-sm font-bold text-text-muted">
                                            <span>Start: <span className="text-text-main">Week {(selectedItem.start || 0) + 1}</span></span>
                                            <span>Duration: <span className="text-text-main">{selectedItem.duration || 1} week(s)</span></span>
                                            <span>End: <span className="text-text-main">Week {(selectedItem.start || 0) + (selectedItem.duration || 1)}</span></span>
                                        </div>
                                    </div>
                                    <button onClick={() => setSelectedItem(null)} className="p-2 text-text-muted hover:text-text-main transition bg-bg-body rounded-lg border border-border shrink-0"><Icon name="X" size={18} /></button>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Legend */}
                    <div className="mt-6 flex items-center gap-6 text-xs text-text-muted font-bold">
                        <span className="flex items-center gap-2"><span className="w-4 h-4 rounded bg-primary inline-block"></span> Active / Planned</span>
                        <span className="flex items-center gap-2"><span className="w-4 h-4 rounded bg-border inline-block opacity-60"></span> Completed</span>
                        <span className="text-primary">Click any item to view details</span>
                    </div>
                </div>
            );
        }

        function RenderSlide({ slide }) {
            const layout = slide.layout || 'standard';
            const containerVars = { hidden: { opacity: 0 }, visible: { opacity: 1, transition: { staggerChildren: 0.15, delayChildren: 0.1 } } };
            const titleVars = { hidden: { opacity: 0, y: -20, scale: 0.95 }, visible: { opacity: 1, y: 0, scale: 1, transition: { type: "spring", bounce: 0.4 } } };
            const cardVars = { hidden: { opacity: 0, y: 40, rotateX: -10 }, visible: { opacity: 1, y: 0, rotateX: 0, transition: { type: "spring", bounce: 0.5, duration: 0.8 } } };
            const flowVars = { hidden: { opacity: 0, x: -40, scale: 0.9 }, visible: { opacity: 1, x: 0, scale: 1, transition: { type: "spring", bounce: 0.5 } } };
            const bulletVars = { hidden: { opacity: 0, x: -20 }, visible: { opacity: 1, x: 0, transition: { type: "spring", bounce: 0.3 } } };

            const safeItems = Array.isArray(slide.items) ? slide.items : (slide.items ? [{ title: slide.items, label: "Item", value: slide.items, text: slide.items }] : []);
            const safeContent = Array.isArray(slide.content) ? slide.content : (slide.content ? [slide.content] : []);

            if (layout === 'hero') return (
                <motion.div initial="hidden" animate="visible" variants={containerVars} className="w-full h-full p-20 flex flex-col justify-center items-center text-center bg-bg-body text-text-main relative overflow-hidden">
                    <motion.div initial={{ scale: 0, opacity: 0 }} animate={{ scale: 1, opacity: 0.6 }} transition={{ duration: 2, ease: "easeOut" }} className="absolute top-0 right-0 w-[500px] h-[500px] bg-primary-dim rounded-full blur-3xl -mr-32 -mt-32"></motion.div>
                    {slide.icon && <motion.div variants={titleVars} className="text-6xl mb-8 text-primary">{slide.icon}</motion.div>}
                    <motion.h1 variants={titleVars} className="text-5xl font-black mb-6 tracking-tight leading-tight">{slide.title}</motion.h1>
                    <motion.p variants={titleVars} className="text-2xl text-primary font-medium">{slide.subtitle}</motion.p>
                </motion.div>
            );

            if (layout === 'kpi_grid') return (
                <motion.div initial="hidden" animate="visible" variants={containerVars} className="w-full h-full p-20 flex flex-col justify-center bg-bg-body text-text-main relative perspective-1000">
                    <motion.h2 variants={titleVars} className="text-4xl font-extrabold mb-12">{slide.title}</motion.h2>
                    <div className="grid grid-cols-4 gap-6">
                        {safeItems.map((kpi, i) => (
                            <motion.div variants={cardVars} key={i} className="glass-card p-8 flex flex-col items-center justify-center text-center hover:scale-105 transition-transform origin-bottom border-t-4 border-primary">
                                {kpi.icon && <div className="text-4xl mb-4 text-primary">{kpi.icon}</div>}
                                <div className="text-5xl font-black text-text-main mb-2">{kpi.value}</div>
                                <div className="text-sm text-text-muted font-bold uppercase tracking-wider">{kpi.label}</div>
                            </motion.div>
                        ))}
                    </div>
                </motion.div>
            );

            if (layout === 'flowchart') return (
                <motion.div initial="hidden" animate="visible" variants={containerVars} className="w-full h-full p-20 flex flex-col justify-center bg-bg-body text-text-main relative">
                    <motion.h2 variants={titleVars} className="text-4xl font-extrabold mb-16">{slide.title}</motion.h2>
                    <div className="flex gap-6 items-center justify-between w-full">
                        {safeItems.map((step, i) => (
                            <React.Fragment key={i}>
                                <motion.div variants={flowVars} className="flex-1 glass-card p-8 text-center relative hover:-translate-y-3 transition-transform border-b-4 border-primary">
                                    <div className="text-lg font-black text-primary mb-2 uppercase tracking-widest">Step {i + 1}</div>
                                    <div className="text-xl font-bold text-text-main">{step.title}</div>
                                </motion.div>
                                {i < (safeItems.length - 1) && <motion.div variants={flowVars}><Icon name="ChevronRight" size={40} className="text-border shrink-0" /></motion.div>}
                            </React.Fragment>
                        ))}
                    </div>
                </motion.div>
            );

            if (layout === 'icon_columns') return (
                <motion.div initial="hidden" animate="visible" variants={containerVars} className="w-full h-full p-20 flex flex-col justify-center bg-bg-body text-text-main relative perspective-1000">
                    <motion.h2 variants={titleVars} className="text-4xl font-extrabold mb-10">{slide.title}</motion.h2>
                    <div className="grid grid-cols-3 gap-8">
                        {safeItems.map((col, i) => (
                            <motion.div variants={cardVars} key={i} className="glass-card p-8 hover:-translate-y-3 transition-transform border-t-4 border-primary">
                                {col.icon && <div className="text-5xl mb-4 text-primary">{col.icon}</div>}
                                <h3 className="text-2xl font-extrabold text-text-main mb-3">{col.title}</h3>
                                <p className="text-base text-text-muted leading-relaxed font-medium">{col.text}</p>
                            </motion.div>
                        ))}
                    </div>
                </motion.div>
            );

            return (
                <motion.div initial="hidden" animate="visible" variants={containerVars} className="w-full h-full p-20 flex flex-col bg-bg-body text-text-main relative">
                    <motion.h2 variants={titleVars} className="text-3xl font-extrabold mb-8 pb-4 border-b-4 border-primary inline-block self-start">{slide.title}</motion.h2>
                    <motion.div variants={cardVars} className="glass-card flex-1 p-10 flex flex-col justify-center">
                        <ul className="list-none pl-2 space-y-5">
                            {safeContent.map((bullet, i) => (
                                <motion.li variants={bulletVars} key={i} className="text-xl text-text-main leading-relaxed font-medium flex items-start gap-4">
                                    <span className="text-primary mt-1"><Icon name="ChevronRight" size={20} /></span>
                                    {bullet}
                                </motion.li>
                            ))}
                        </ul>
                    </motion.div>
                </motion.div>
            );
        }

        function SmartDeckView({ project, endpoint, isFullScreenLayout, onClose }) {
            const [slides, setSlides] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isExporting, setIsExporting] = useState(false);
            const [scale, setScale] = useState(1);
            const [aiError, setAiError] = useState(null);

            const containerRef = useRef(null);
            const wrapperRef = useRef(null);

            useEffect(() => {
                setLoading(true); setAiError(null);
                secureFetch(endpoint)
                    .then(r => r?.json())
                    .then(data => {
                        if (data && data.status === 'success' && data.slides) {
                            setSlides(data.slides);
                        } else {
                            setAiError(data?.message || "Failed to generate deck data.");
                        }
                        setLoading(false);
                    })
                    .catch(() => {
                        setAiError("Network connection to AI failed.");
                        setLoading(false);
                    });
            }, [endpoint]);

            useEffect(() => {
                const calculateScale = () => {
                    if (containerRef.current) {
                        const { clientWidth, clientHeight } = containerRef.current;
                        const padding = 64;
                        const scaleX = (clientWidth - padding) / 1280;
                        const scaleY = (clientHeight - padding) / 720;
                        setScale(Math.min(scaleX, scaleY));
                    }
                };
                const ro = new ResizeObserver(calculateScale);
                if (containerRef.current) ro.observe(containerRef.current);
                window.addEventListener('resize', calculateScale);
                setTimeout(calculateScale, 100);
                return () => { ro.disconnect(); window.removeEventListener('resize', calculateScale); };
            }, [slides]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowRight' || e.key === ' ') setCurrentIdx(prev => Math.min(slides.length - 1, prev + 1));
                    else if (e.key === 'ArrowLeft') setCurrentIdx(prev => Math.max(0, prev - 1));
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [slides]);

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) wrapperRef.current.requestFullscreen().catch(err => console.error(err));
                else document.exitFullscreen();
            };

            const handleExportPPTX = async () => {
                setIsExporting(true);
                try {
                    const res = await secureFetch('/generate_ppt', { method: 'POST', body: JSON.stringify({ project: project, slides: slides }) });
                    if (res && res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${project}_Premium_Deck.pptx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } else { alert("Failed to compile native Presentation."); }
                } catch (e) { console.error(e); }
                setIsExporting(false);
            };

            if (loading) return <LoadingScreen msg="Super Agent orchestrating Premium Presentation..." />;
            if (aiError) return <div className="p-10 text-danger font-bold bg-danger/10 border border-danger/30 rounded-xl m-8"><Icon name="AlertTriangle" size={24} className="mb-2" /> Error: {aiError}</div>;
            if (!slides || slides.length === 0) return <div className="p-10 text-text-main font-bold">No slide data returned.</div>;

            return (
                <div ref={wrapperRef} className={`flex flex-col relative overflow-hidden animate-fade-in ${isFullScreenLayout ? 'h-full bg-bg-body' : 'h-[650px] rounded-2xl border border-border shadow-2xl mb-8 bg-bg-body'}`}>
                    <div className="h-20 shrink-0 flex items-center justify-between px-8 border-b border-border bg-bg-card z-40">
                        <div className="flex items-center gap-4">
                            <div className="px-4 py-1.5 bg-primary-dim text-primary rounded-full text-xs font-black border border-primary-dim flex items-center gap-2 uppercase tracking-wider"><Icon name="Sparkles" size={14} /> AI Generated Deck</div>
                            <span className="text-text-muted text-sm font-bold">Slide {currentIdx + 1} of {slides.length}</span>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={toggleFullScreen} className="flex items-center gap-2 px-4 py-2.5 bg-bg-body hover:bg-bg-hover text-text-main rounded-lg text-sm font-bold transition border border-border" title="Present Mode">
                                <Icon name="Maximize" size={18} />
                            </button>
                            <button onClick={handleExportPPTX} disabled={isExporting} className="flex items-center gap-3 px-6 py-2.5 text-white rounded-lg text-sm font-bold transition shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-70 disabled:hover:scale-100 bg-primary">
                                {isExporting ? <span className="loader w-4 h-4 border-2"></span> : <Icon name="Download" size={18} />}
                                {isExporting ? 'Compiling PPTX...' : 'Export Native PPTX'}
                            </button>
                            {onClose && <button onClick={onClose} className="p-2.5 ml-2 text-text-muted hover:text-text-main transition bg-bg-body hover:bg-bg-hover rounded-lg border border-border"><Icon name="X" size={22} /></button>}
                        </div>
                    </div>

                    <div ref={containerRef} className="flex-1 relative flex items-center justify-center p-8 bg-bg-body/50 backdrop-blur-xl overflow-hidden">
                        <div className="shrink-0 flex items-center justify-center relative" style={{ width: '1280px', height: '720px', transform: `scale(${scale})`, transformOrigin: 'center center', transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)' }}>
                            <AnimatePresence mode="wait">
                                <motion.div
                                    key={currentIdx}
                                    initial={{ opacity: 0, scale: 0.92, filter: 'blur(12px)' }}
                                    animate={{ opacity: 1, scale: 1, filter: 'blur(0px)' }}
                                    exit={{ opacity: 0, scale: 1.08, filter: 'blur(12px)' }}
                                    transition={{ duration: 0.6, ease: [0.16, 1, 0.3, 1] }}
                                    className="absolute inset-0 w-full h-full rounded-3xl overflow-hidden shadow-[0_32px_64px_rgba(0,0,0,0.2)] border border-border bg-bg-body"
                                >
                                    <RenderSlide slide={slides[currentIdx]} />
                                </motion.div>
                            </AnimatePresence>
                        </div>
                        <button onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))} disabled={currentIdx === 0} className="absolute left-8 w-16 h-16 rounded-full bg-bg-card/80 hover:bg-primary hover:text-white text-text-main flex items-center justify-center transition disabled:opacity-30 border border-border z-30 shadow-2xl backdrop-blur-md"><Icon name="ChevronLeft" size={32} /></button>
                        <button onClick={() => setCurrentIdx(Math.min(slides.length - 1, currentIdx + 1))} disabled={currentIdx === slides.length - 1} className="absolute right-8 w-16 h-16 rounded-full bg-bg-card/80 hover:bg-primary hover:text-white text-text-main flex items-center justify-center transition disabled:opacity-30 border border-border z-30 shadow-2xl backdrop-blur-md"><Icon name="ChevronRight" size={32} /></button>
                    </div>
                </div>
            );
        }

        function TimelineView({ project, setIsLoading }) {
            const [data, setData] = useState(null);
            const [sprints, setSprints] = useState([]);
            const [activeSprint, setActiveSprint] = useState('active');

            const [storyPrompt, setStoryPrompt] = useState("");
            const [isGeneratingStory, setIsGeneratingStory] = useState(false);
            const [generatedStory, setGeneratedStory] = useState(null);
            const [isCreatingStory, setIsCreatingStory] = useState(false);
            const [storyStatus, setStoryStatus] = useState(null);
            const [selectedImage, setSelectedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const fileInputRef = useRef(null);

            const [epicPrompt, setEpicPrompt] = useState("");
            const [isGeneratingEpic, setIsGeneratingEpic] = useState(false);
            const [generatedEpic, setGeneratedEpic] = useState(null);
            const [isCreatingEpic, setIsCreatingEpic] = useState(false);
            const [epicStatus, setEpicStatus] = useState(null);

            useEffect(() => {
                secureFetch(`/sprints/${project}`).then(r => r?.json()).then(d => { if (d && d.length) setSprints(d); });
            }, [project]);

            useEffect(() => {
                setData(null); setIsLoading(true);
                secureFetch(activeSprint === 'active' ? `/analytics/${project}` : `/analytics/${project}?sprint_id=${activeSprint}`)
                    .then(r => r?.json())
                    .then(d => { setData(d); setIsLoading(false); });
            }, [project, activeSprint]);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) { setSelectedImage(file); const reader = new FileReader(); reader.onloadend = () => setImagePreview(reader.result); reader.readAsDataURL(file); }
            };

            const clearImage = () => { setSelectedImage(null); setImagePreview(null); if (fileInputRef.current) fileInputRef.current.value = ""; };

            const handleGenerateStory = async () => {
                if (!storyPrompt.trim() && !selectedImage) return;
                setIsGeneratingStory(true); setGeneratedStory(null); setStoryStatus(null);
                let imageDataUrl = null;
                if (selectedImage) imageDataUrl = await new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.readAsDataURL(selectedImage); });

                try {
                    const payload = { project, prompt: storyPrompt };
                    if (imageDataUrl) payload.image_data = imageDataUrl;
                    const r = await secureFetch('/timeline/generate_story', { method: 'POST', body: JSON.stringify(payload) });
                    const res = await r.json();
                    if (res.status === 'success') { setGeneratedStory(res.story); clearImage(); }
                    else { setStoryStatus({ type: 'error', text: res.message || "AI failed to generate story." }); }
                } catch (e) { setStoryStatus({ type: 'error', text: "Network error generating story." }); }
                setIsGeneratingStory(false);
            };

            const handlePushStory = async () => {
                setIsCreatingStory(true); setStoryStatus(null);
                try {
                    const r = await secureFetch('/timeline/create_issue', { method: 'POST', body: JSON.stringify({ project, issue_type: "Story", story: generatedStory }) });
                    const res = await r.json();
                    if (res.status === 'success') {
                        setStoryStatus({ type: 'success', text: `Success! Story ${res.key} added to Jira.`, url: res.url });
                        setTimeout(() => { setGeneratedStory(null); setStoryPrompt(""); setStoryStatus(null); }, 8000);
                    } else { setStoryStatus({ type: 'error', text: res.message }); }
                } catch (e) { setStoryStatus({ type: 'error', text: "Network connection to backend failed." }); }
                setIsCreatingStory(false);
            };

            const handleGenerateEpic = async () => {
                if (!epicPrompt.trim()) return;
                setIsGeneratingEpic(true); setGeneratedEpic(null); setEpicStatus(null);
                try {
                    const r = await secureFetch('/timeline/generate_epic', { method: 'POST', body: JSON.stringify({ project, prompt: epicPrompt }) });
                    const res = await r.json();
                    if (res.status === 'success') { setGeneratedEpic(res.epic); }
                    else { setEpicStatus({ type: 'error', text: res.message || "AI failed to generate Epic." }); }
                } catch (e) { setEpicStatus({ type: 'error', text: "Network error generating Epic." }); }
                setIsGeneratingEpic(false);
            };

            const handlePushEpic = async () => {
                setIsCreatingEpic(true); setEpicStatus(null);
                try {
                    const r = await secureFetch('/timeline/create_issue', { method: 'POST', body: JSON.stringify({ project, issue_type: "Epic", story: generatedEpic }) });
                    const res = await r.json();
                    if (res.status === 'success') {
                        setEpicStatus({ type: 'success', text: `Success! Epic ${res.key} added to Jira.`, url: res.url });
                        setTimeout(() => { setGeneratedEpic(null); setEpicPrompt(""); setEpicStatus(null); }, 8000);
                    } else { setEpicStatus({ type: 'error', text: res.message }); }
                } catch (e) { setEpicStatus({ type: 'error', text: "Network connection failed." }); }
                setIsCreatingEpic(false);
            };

            if (!data) return <LoadingScreen msg="Loading Workspace..." />;

            const dynamicsData = Object.entries(data.metrics?.assignees || {}).map(([name, stats]) => {
                const origList = stats.tasks.filter(t => !t.added_mid_sprint);
                const midList = stats.tasks.filter(t => t.added_mid_sprint);
                const originalPts = origList.reduce((sum, t) => sum + (t.points || 0), 0);
                const midPts = midList.reduce((sum, t) => sum + (t.points || 0), 0);
                const finalPts = stats.tasks
                    .filter(t => t.status.toLowerCase().includes('done') || t.status.toLowerCase().includes('closed') || t.status.toLowerCase().includes('resolved'))
                    .reduce((sum, t) => sum + (t.points || 0), 0);
                let delta = 0;
                if (originalPts > 0) delta = (((finalPts - originalPts) / originalPts) * 100);
                else if (originalPts === 0 && finalPts > 0) delta = 100;
                return { user: name, originalPts, origList, midPts, midList, finalPts, delta, avatar: stats.avatar };
            });

            const totalOrig = dynamicsData.reduce((sum, r) => sum + r.originalPts, 0);
            const totalMid = dynamicsData.reduce((sum, r) => sum + r.midPts, 0);
            const totalFinal = dynamicsData.reduce((sum, r) => sum + r.finalPts, 0);
            const totalDelta = totalOrig > 0 ? (((totalFinal - totalOrig) / totalOrig) * 100).toFixed(2) : "0.00";

            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-32 pr-4 relative space-y-16 block">
                    <div>
                        <header className="mb-8 flex justify-between items-end pb-6 border-b border-border">
                            <div>
                                <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Sprint Dynamics</h2>
                                <p className="text-base font-medium mt-2 text-text-muted">Real-time view of capacity and delivery delta</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-black uppercase tracking-wider text-text-muted">Target Sprint</span>
                                <select value={activeSprint} onChange={e => setActiveSprint(e.target.value)} className="p-3 rounded-lg border bg-bg-card text-text-main font-bold shadow-sm outline-none cursor-pointer hover:border-primary transition-colors">
                                    <option value="active">üü¢ Active Sprint</option>
                                    {sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                        </header>
                        
                        {dynamicsData.length === 0 ? (
                            <div className="p-10 rounded-2xl border border-border shadow-xl bg-bg-card flex flex-col items-center justify-center">
                                <Icon name="AlertTriangle" size={48} className="text-warning mb-4 opacity-80" />
                                <h3 className="text-xl font-extrabold text-text-main mb-2">No Active Data Found</h3>
                                <p className="text-text-muted font-medium text-center max-w-md">We couldn't detect any user tickets in Jira for this sprint.</p>
                            </div>
                        ) : (
                            <div className="rounded-2xl border border-[#334155] shadow-2xl overflow-hidden bg-gradient-to-b from-[#1E293B] to-[#0F172A]">
                                <div className="overflow-x-auto hide-scroll">
                                    <table className="w-full text-left border-collapse whitespace-nowrap">
                                        <thead>
                                            <tr className="bg-[#0B1121] text-[#94A3B8] text-[11px] uppercase tracking-widest border-b border-[#334155]">
                                                <th className="p-5 font-black border-r border-[#334155]/50">Assignee</th>
                                                <th className="p-5 font-black text-center border-r border-[#334155]/50">Original Commitment</th>
                                                <th className="p-5 font-black border-r border-[#334155]/50 w-1/3">Original Scope (Jira IDs)</th>
                                                <th className="p-5 font-black text-center border-r border-[#334155]/50">Mid-Sprint Variance</th>
                                                <th className="p-5 font-black border-r border-[#334155]/50 w-1/4">Scope Creep / Added</th>
                                                <th className="p-5 font-black text-center border-r border-[#334155]/50">Final Delivered</th>
                                                <th className="p-5 font-black text-center">Sprint Delta</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm font-medium divide-y divide-[#334155]/50">
                                            {dynamicsData.map(row => (
                                                <tr key={row.user} className="hover:bg-[#334155]/20 transition-colors">
                                                    <td className="p-5 border-r border-[#334155]/50 flex items-center gap-3">
                                                        {row.avatar ? <img src={row.avatar} className="w-8 h-8 rounded-full border border-[#334155]" /> : <div className="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white font-bold text-xs shadow-md">{row.user.charAt(0)}</div>}
                                                        <span className="text-white font-bold tracking-wide">{row.user}</span>
                                                    </td>
                                                    <td className="p-5 border-r border-[#334155]/50 text-center text-white font-black text-lg">{row.originalPts}</td>
                                                    <td className="p-5 border-r border-[#334155]/50">
                                                        <div className="flex flex-wrap gap-2">
                                                            {row.origList.length > 0 ? row.origList.map(t => <span key={t.key} className="px-2.5 py-1 bg-[#0F172A] border border-[#334155] rounded-md text-xs text-[#94A3B8] shadow-sm font-bold" title={t.summary}>{t.key}</span>) : <span className="text-xs text-[#475569] italic">None</span>}
                                                        </div>
                                                    </td>
                                                    <td className="p-5 border-r border-[#334155]/50 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-black shadow-sm ${row.midPts > 0 ? 'bg-amber-500/10 text-amber-400 border border-amber-500/20' : 'bg-[#0F172A] text-[#94A3B8] border border-[#334155]'}`}>
                                                            {row.midPts > 0 ? `+${row.midPts} pts` : '0 pts'}
                                                        </span>
                                                    </td>
                                                    <td className="p-5 border-r border-[#334155]/50">
                                                        <div className="flex flex-wrap gap-2">
                                                            {row.midList.length > 0 ? row.midList.map(t => <span key={t.key} className="px-2.5 py-1 bg-amber-500/10 border border-amber-500/20 rounded-md text-xs text-amber-400 shadow-sm font-bold" title={t.summary}>{t.key}</span>) : <span className="text-xs text-[#475569] italic font-medium">No scope creep</span>}
                                                        </div>
                                                    </td>
                                                    <td className="p-5 border-r border-[#334155]/50 text-center text-white font-black text-lg">{row.finalPts}</td>
                                                    <td className="p-5 text-center">
                                                        <span className={`px-3 py-1.5 rounded-lg text-xs font-black shadow-sm flex items-center justify-center gap-1 mx-auto w-24 ${row.delta < 0 ? 'bg-red-500/10 text-red-400 border border-red-500/20' : row.delta > 0 ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-[#0F172A] text-[#94A3B8] border border-[#334155]'}`}>
                                                            {row.delta > 0 ? '‚Üë' : row.delta < 0 ? '‚Üì' : '‚Äî'} {Math.abs(row.delta).toFixed(1)}%
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot className="bg-primary-dim border-t-2 border-primary/30">
                                            <tr>
                                                <td className="p-5 border-r border-primary/20 text-primary font-black uppercase tracking-widest text-xs">Sprint Totals</td>
                                                <td className="p-5 border-r border-primary/20 text-center text-primary font-black text-xl">{totalOrig}</td>
                                                <td className="p-5 border-r border-primary/20"></td>
                                                <td className="p-5 border-r border-primary/20 text-center text-amber-500 font-black text-lg">+{totalMid}</td>
                                                <td className="p-5 border-r border-primary/20"></td>
                                                <td className="p-5 border-r border-primary/20 text-center text-primary font-black text-xl">{totalFinal}</td>
                                                <td className="p-5 text-center text-primary font-black text-lg tracking-wide">{totalDelta}%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>

                    <div>
                        <div className="glass-card border-t-4 border-primary p-8 relative overflow-hidden shadow-2xl">
                            <div className="absolute top-0 right-0 w-80 h-80 bg-primary-dim rounded-full blur-3xl -mr-24 -mt-24 pointer-events-none opacity-40"></div>
                            <h3 className="text-2xl font-extrabold flex items-center gap-3 mb-6 text-text-main"><Icon name="Sparkles" size={24} className="text-primary" /> Auto-Generate User Story (with Vision)</h3>

                            <div className="flex flex-col gap-4">
                                <textarea value={storyPrompt} onChange={e => setStoryPrompt(e.target.value)} placeholder="Describe the feature, or paste requirements here..." className="w-full bg-bg-body border border-border rounded-xl px-5 py-4 text-base font-medium text-text-main outline-none focus:border-primary focus:ring-2 focus:ring-primary-dim transition-all resize-none h-32 shadow-inner" ></textarea>
                                <div className="flex gap-4 items-start">
                                    <input type="file" accept="image/*" onChange={handleImageChange} ref={fileInputRef} className="hidden" />
                                    <button onClick={() => fileInputRef.current.click()} className="px-5 py-3 bg-bg-card border border-border rounded-xl font-bold text-text-muted hover:text-text-main hover:border-primary transition flex items-center gap-3 shrink-0">
                                        <Icon name="Image" size={20} /> {selectedImage ? 'Change Image' : 'Upload Screenshot / Diagram'}
                                    </button>
                                    {imagePreview && (
                                        <div className="relative group">
                                            <img src={imagePreview} alt="Preview" className="h-20 w-auto rounded-lg border border-border shadow-md" />
                                            <button onClick={clearImage} className="absolute -top-2 -right-2 bg-danger text-white rounded-full p-1 shadow-lg opacity-0 group-hover:opacity-100 transition"><Icon name="X" size={12} /></button>
                                        </div>
                                    )}
                                    <button onClick={handleGenerateStory} disabled={isGeneratingStory || (!storyPrompt && !selectedImage)} className="flex-1 px-8 py-4 font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 bg-primary flex items-center justify-center gap-3 text-lg shadow-lg">
                                        {isGeneratingStory ? <span className="loader w-6 h-6 border-2"></span> : <Icon name="Sparkles" size={22} />}
                                        {isGeneratingStory ? 'Synthesizing...' : 'Generate Story'}
                                    </button>
                                </div>
                            </div>

                            <AnimatePresence>
                                {storyStatus && !generatedStory && (
                                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`mt-6 p-4 rounded-xl text-sm font-bold border flex items-center gap-3 shadow-lg ${storyStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}>
                                        <Icon name={storyStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} />
                                        {storyStatus.text}
                                    </motion.div>
                                )}
                            </AnimatePresence>

                            <AnimatePresence>
                                {generatedStory && (
                                    <motion.div initial={{ opacity: 0, height: 0, y: 20 }} animate={{ opacity: 1, height: 'auto', y: 0 }} exit={{ opacity: 0, height: 0, y: 20 }} transition={{ type: "spring", bounce: 0.3 }} className="mt-8 pt-8 border-t border-border">
                                        <div className="bg-bg-card rounded-2xl p-8 border border-border shadow-xl relative overflow-hidden flex flex-col gap-6">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="text-sm font-black text-primary uppercase tracking-widest flex items-center gap-2"><Icon name="AlignLeft" size={16} /> Review & Edit Story</h4>
                                            </div>

                                            <div className="grid grid-cols-4 gap-6">
                                                <div className="col-span-3">
                                                    <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Story Summary</label>
                                                    <input value={generatedStory.title} onChange={e => setGeneratedStory({ ...generatedStory, title: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-lg font-bold text-text-main outline-none focus:border-primary transition-all" />
                                                </div>
                                                <div>
                                                    <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Story Points</label>
                                                    <input type="number" value={generatedStory.points} onChange={e => setGeneratedStory({ ...generatedStory, points: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-lg font-bold text-primary text-center outline-none focus:border-primary transition-all" />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Description</label>
                                                <textarea rows="4" value={generatedStory.description} onChange={e => setGeneratedStory({ ...generatedStory, description: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y" />
                                            </div>

                                            <div>
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Acceptance Criteria (One per line)</label>
                                                <textarea rows="4" value={generatedStory.acceptance_criteria.join('\n')} onChange={e => setGeneratedStory({ ...generatedStory, acceptance_criteria: e.target.value.split('\n') })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y leading-relaxed" />
                                            </div>

                                            <div className="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Target Assignee</label>
                                                    <input value={generatedStory.assignee} onChange={e => setGeneratedStory({ ...generatedStory, assignee: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-sm font-bold text-text-main outline-none focus:border-primary transition-all" />
                                                </div>
                                                <div className="bg-primary-dim p-4 rounded-xl border border-primary/20 flex gap-4 items-start">
                                                    <Icon name="Sparkles" size={20} className="text-primary shrink-0 mt-0.5" />
                                                    <div><h5 className="text-xs font-black text-primary uppercase tracking-widest mb-1">AI Reasoning</h5><p className="text-xs text-text-main leading-relaxed font-semibold">{generatedStory.tech_stack_inferred}</p></div>
                                                </div>
                                            </div>

                                            <div className="mt-4 flex flex-col items-end gap-4 border-t border-border pt-6">
                                                <AnimatePresence>
                                                    {storyStatus && (
                                                        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`p-4 rounded-xl text-sm w-full flex items-center gap-3 font-bold border shadow-md ${storyStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}>
                                                            <Icon name={storyStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} />
                                                            <span className="flex-1">{storyStatus.text}</span>
                                                            {storyStatus.url && <a href={storyStatus.url} target="_blank" className="px-4 py-2 bg-success text-white rounded-lg font-bold flex items-center gap-2 hover:shadow-lg transition shadow-md text-xs uppercase tracking-wider">View in Jira <Icon name="ExternalLink" size={14} /></a>}
                                                        </motion.div>
                                                    )}
                                                </AnimatePresence>
                                                <button onClick={handlePushStory} disabled={isCreatingStory || (storyStatus && storyStatus.type === 'success')} className="px-10 py-4 text-base font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 bg-success flex items-center gap-3 shadow-lg w-full md:w-auto justify-center">
                                                    {isCreatingStory ? <span className="loader w-5 h-5 border-2"></span> : <Icon name="Upload" size={20} />}
                                                    {isCreatingStory ? 'Pushing to Jira...' : 'Confirm & Push Story to Jira'}
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>

                    <div className="glass-card overflow-hidden shadow-2xl border-t-4 border-indigo-500 relative">
                        <div className="bg-indigo-900/10 border-b border-border p-10 relative">
                            <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
                            <div className="max-w-3xl relative z-10">
                                <h3 className="text-3xl font-extrabold text-text-main flex items-center gap-3 mb-4"><Icon name="Target" size={28} className="text-indigo-500" /> The AI Backlog Generator</h3>
                                <h4 className="text-lg font-bold text-indigo-400 mb-3">Built right into your agile flow</h4>
                                <p className="text-base text-text-muted leading-relaxed font-medium">Writing clear, structured backlog items takes time. The AI Epic Generator transforms raw ideas into implementation-ready Epics.</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-8 p-10 bg-bg-body border-b border-border relative z-10">
                            <div><h5 className="font-extrabold text-text-main text-lg mb-2 flex items-center gap-2"><Icon name="MessageSquare" size={18} className="text-indigo-500" /> Write the way you talk</h5><p className="text-sm text-text-muted font-medium leading-relaxed">Just tell the AI in a short sentence what you want to build.</p></div>
                            <div><h5 className="font-extrabold text-text-main text-lg mb-2 flex items-center gap-2"><Icon name="Zap" size={18} className="text-indigo-500" /> Auto-Generated Epics</h5><p className="text-sm text-text-muted font-medium leading-relaxed">Get detailed and structured Epics with description, acceptance criteria & more.</p></div>
                            <div><h5 className="font-extrabold text-text-main text-lg mb-2 flex items-center gap-2"><Icon name="CheckCircle" size={18} className="text-indigo-500" /> Better clarity for everyone</h5><p className="text-sm text-text-muted font-medium leading-relaxed">Actionable, consistent epics that keep Stakeholder, Product Owner and Dev Teams aligned.</p></div>
                        </div>

                        <div className="p-10 bg-bg-card relative z-10">
                            <h4 className="text-lg font-bold text-text-main mb-6 text-center">How the AI Backlog Generator works<br /><span className="text-indigo-500 text-sm font-black uppercase tracking-widest mt-2 block">From messy notes to developer-ready Epics ‚Äî in seconds.</span></h4>

                            <div className="flex flex-col gap-4 max-w-4xl mx-auto">
                                <textarea value={epicPrompt} onChange={e => setEpicPrompt(e.target.value)} placeholder="e.g. I need a feature to create and manage customer journeys..." className="w-full bg-bg-body border border-indigo-500/30 focus:border-indigo-500 rounded-xl px-6 py-5 text-lg font-medium text-text-main outline-none focus:ring-4 focus:ring-indigo-500/10 transition-all resize-none h-32 shadow-inner" ></textarea>
                                <button onClick={handleGenerateEpic} disabled={isGeneratingEpic || !epicPrompt} className="self-end px-10 py-4 font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 bg-indigo-600 flex items-center justify-center gap-3 text-lg shadow-lg">
                                    {isGeneratingEpic ? <span className="loader w-6 h-6 border-2"></span> : <Icon name="Sparkles" size={22} />}
                                    {isGeneratingEpic ? 'Crafting Epic...' : 'Generate Epic'}
                                </button>
                            </div>

                            <AnimatePresence>
                                {epicStatus && !generatedEpic && (
                                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`mt-6 max-w-4xl mx-auto p-4 rounded-xl text-sm font-bold border flex items-center gap-3 shadow-lg ${epicStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}>
                                        <Icon name={epicStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} />
                                        {epicStatus.text}
                                    </motion.div>
                                )}
                            </AnimatePresence>

                            <AnimatePresence>
                                {generatedEpic && (
                                    <motion.div initial={{ opacity: 0, height: 0, y: 20 }} animate={{ opacity: 1, height: 'auto', y: 0 }} exit={{ opacity: 0, height: 0, y: 20 }} transition={{ type: "spring", bounce: 0.3 }} className="mt-10 max-w-4xl mx-auto">
                                        <div className="bg-bg-body rounded-2xl p-8 border border-indigo-500/20 shadow-xl flex flex-col gap-6">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="text-sm font-black text-indigo-500 uppercase tracking-widest flex items-center gap-2"><Icon name="AlignLeft" size={16} /> Review & Edit Epic</h4>
                                            </div>

                                            <div>
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Epic Summary</label>
                                                <input value={generatedEpic.title} onChange={e => setGeneratedEpic({ ...generatedEpic, title: e.target.value })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-lg font-bold text-text-main outline-none focus:border-indigo-500 transition-all" />
                                            </div>

                                            <div>
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Motivation / Business Value</label>
                                                <textarea rows="3" value={generatedEpic.motivation} onChange={e => setGeneratedEpic({ ...generatedEpic, motivation: e.target.value })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-indigo-500 transition-all resize-y" />
                                            </div>

                                            <div>
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Description</label>
                                                <textarea rows="5" value={generatedEpic.description} onChange={e => setGeneratedEpic({ ...generatedEpic, description: e.target.value })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-indigo-500 transition-all resize-y" />
                                            </div>

                                            <div>
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Acceptance Criteria (One per line)</label>
                                                <textarea rows="5" value={generatedEpic.acceptance_criteria.join('\n')} onChange={e => setGeneratedEpic({ ...generatedEpic, acceptance_criteria: e.target.value.split('\n') })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-indigo-500 transition-all resize-y leading-relaxed" />
                                            </div>

                                            <div className="mt-4 flex flex-col items-end gap-4 border-t border-border pt-6">
                                                <AnimatePresence>
                                                    {epicStatus && (
                                                        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`p-4 rounded-xl text-sm w-full flex items-center gap-3 font-bold border shadow-md ${epicStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}>
                                                            <Icon name={epicStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} />
                                                            <span className="flex-1">{epicStatus.text}</span>
                                                            {epicStatus.url && <a href={epicStatus.url} target="_blank" className="px-4 py-2 bg-success text-white rounded-lg font-bold flex items-center gap-2 hover:shadow-lg transition shadow-md text-xs uppercase tracking-wider">View in Jira <Icon name="ExternalLink" size={14} /></a>}
                                                        </motion.div>
                                                    )}
                                                </AnimatePresence>
                                                <button onClick={handlePushEpic} disabled={isCreatingEpic || (epicStatus && epicStatus.type === 'success')} className="px-10 py-4 text-base font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 bg-indigo-600 flex items-center gap-3 shadow-lg w-full md:w-auto justify-center">
                                                    {isCreatingEpic ? <span className="loader w-5 h-5 border-2"></span> : <Icon name="Upload" size={20} />}
                                                    {isCreatingEpic ? 'Pushing to Jira...' : 'Confirm & Push Epic to Jira'}
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>
                </div>
            );
        }

        function ReportsView({ project, setIsLoading, isGlobalLoading }) {
            const [data, setData] = useState(null);
            const [timeframe, setTimeframe] = useState('weekly');
            const [showDeck, setShowDeck] = useState(false);

            useEffect(() => {
                setData(null); setShowDeck(false); setIsLoading(true);
                secureFetch(`/reports/${project}/${timeframe}`).then(r => r?.json()).then(d => { setData(d); setIsLoading(false); });
            }, [project, timeframe]);

            if (!data) return <LoadingScreen msg={`Compiling ${timeframe} AI Dossier...`} />;
            const dossier = data.dossier || {};

            return (
                <div className="animate-fade-in space-y-8 h-full overflow-y-auto pb-12 pr-4">
                    <header className="flex justify-between items-end mb-10 border-b border-border pb-6">
                        <div><h2 className="text-4xl font-extrabold tracking-tight text-text-main">AI Performance Dossier</h2></div>
                        <div className="flex items-center gap-2 bg-bg-card p-1.5 rounded-xl border border-border shadow-sm">{['weekly', 'monthly', 'quarterly'].map(t => (<button key={t} onClick={() => setTimeframe(t)} className={`px-5 py-2.5 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${timeframe === t ? 'bg-primary text-white shadow-md' : 'text-text-muted hover:text-text-main hover:bg-bg-hover'}`}>{t}</button>))}</div>
                    </header>

                    <div className="bg-gradient-to-br from-primary to-amber-700 p-8 rounded-2xl border border-primary/20 flex justify-between items-center shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>
                        <div className="relative z-10">
                            <h3 className="text-2xl font-extrabold text-white mb-2 flex items-center gap-3"><Icon name="Monitor" size={24} /> Generate {timeframe.charAt(0).toUpperCase() + timeframe.slice(1)} Business Review</h3>
                            <p className="text-base text-white/80 font-medium">The Super Agent will write a structured, multi-slide executive presentation.</p>
                        </div>
                        <button onClick={() => setShowDeck(true)} className="bg-white text-primary px-8 py-4 rounded-xl font-extrabold shadow-lg hover:shadow-xl hover:scale-105 transition-all relative z-10 flex items-center gap-3"><Icon name="Sparkles" size={20} /> Generate Deck</button>
                    </div>

                    {showDeck && <SmartDeckView project={project} endpoint={`/report_deck/${project}/${timeframe}`} isFullScreenLayout={false} onClose={() => setShowDeck(false)} />}

                    <div className="glass-card p-10 border-t-4 border-primary"><h3 className="text-sm font-black text-primary mb-6 uppercase tracking-widest flex items-center gap-3"><Icon name="Sparkles" size={18} /> The AI Verdict</h3><p className="text-3xl font-bold leading-relaxed text-text-main">{dossier.ai_verdict}</p></div>
                    <div className="grid grid-cols-3 gap-8">
                        <div className="glass-card p-8 text-center hover:border-success transition-colors"><span className="text-xs font-black text-text-muted uppercase tracking-widest">Issues Completed</span><div className="text-6xl font-black text-success mt-4">{data.completed_count}</div></div>
                        <div className="glass-card p-8 text-center hover:border-primary transition-colors"><span className="text-xs font-black text-text-muted uppercase tracking-widest">Velocity Delivered</span><div className="text-6xl font-black text-primary mt-4">{data.completed_points}</div></div>
                        <div className="glass-card p-8 text-center border-t-4 border-warning relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-warning"></div><Icon name="Star" size={32} className="text-warning mx-auto mb-4" /><span className="text-xs font-black text-text-muted uppercase tracking-widest">Top Contributor</span><div className="text-2xl font-extrabold mt-3 text-text-main">{dossier.top_contributor?.split('-')[0]}</div><div className="text-sm text-text-muted font-bold mt-2">{dossier.top_contributor?.split('-')[1]}</div></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="glass-card p-8 border-t-4 border-success">
                            <h3 className="text-sm font-black uppercase tracking-widest flex items-center gap-3 mb-8 text-success"><Icon name="TrendingDown" size={18} /> Key Accomplishments</h3>
                            <div className="space-y-6">{dossier.key_accomplishments?.map((acc, i) => (<div key={i} className="flex gap-5 items-start pb-6 border-b last:border-0 border-border"><div className="w-8 h-8 rounded-lg bg-success/10 text-success flex items-center justify-center font-black text-sm shrink-0">{i + 1}</div><div><h4 className="text-lg font-extrabold mb-2 text-text-main">{acc.title}</h4><p className="text-sm leading-relaxed font-medium text-text-muted">{acc.impact}</p></div></div>))}</div>
                        </div>
                        <div className="glass-card p-8 border-l-4 border-danger bg-danger/5">
                            <h3 className="text-sm font-black uppercase tracking-widest flex items-center gap-3 mb-8 text-danger"><Icon name="AlertTriangle" size={18} /> Hidden Friction Detected</h3>
                            <div className="p-6 rounded-xl bg-bg-body border border-danger/20 shadow-inner"><p className="text-base leading-relaxed font-bold text-text-main">{dossier.hidden_friction}</p></div>
                        </div>
                    </div>
                </div>
            );
        }

        function RetroView({ project, setIsLoading, isGlobalLoading }) {
            const [sprints, setSprints] = useState([]); const [activeSprint, setActiveSprint] = useState(null); const [board, setBoard] = useState(null); const [input, setInput] = useState(""); const [col, setCol] = useState("well");
            const [toast, setToast] = useState(null);

            const [chatHistory, setChatHistory] = useState([{ role: 'ai', text: "Hi! I am your AI Agile Coach. What would you like to know about this sprint's retrospective?" }]);
            const [chatInput, setChatInput] = useState("");
            const [isChatting, setIsChatting] = useState(false);
            const chatEndRef = useRef(null);

            useEffect(() => { secureFetch(`/sprints/${project}`).then(r => r?.json()).then(d => { setSprints(d); if (d && d.length) setActiveSprint(d[0].id); }); }, [project]);

            const fetchBoard = () => { if (activeSprint) { secureFetch(`/retro/${project}?sprint_id=${activeSprint}`).then(r => r?.json()).then(setBoard); } };
            useEffect(() => { fetchBoard(); const interval = setInterval(fetchBoard, 5000); return () => clearInterval(interval); }, [project, activeSprint]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory, isChatting]);

            const save = (b) => { setBoard(b); secureFetch(`/retro/update`, { method: 'POST', body: JSON.stringify({ project, sprint: activeSprint, board: b }) }); };
            const add = () => { if (!input.trim()) return; const n = board[col] ? [...board[col]] : []; n.push({ id: Date.now(), text: input }); save({ ...board, [col]: n }); setInput(""); };
            const remove = (columnName, itemId) => { const updatedCol = board[columnName].filter(item => item.id !== itemId); save({ ...board, [columnName]: updatedCol }); };

            const sendChat = async () => {
                if (!chatInput.trim()) return;
                const newHistory = [...chatHistory, { role: 'user', text: chatInput }];
                setChatHistory(newHistory); setChatInput(""); setIsChatting(true);

                try {
                    const r = await secureFetch(`/retro/chat`, { method: 'POST', body: JSON.stringify({ board, question: chatInput }) });
                    const d = await r.json();
                    setChatHistory([...newHistory, { role: 'ai', text: d.reply || "Sorry, I couldn't generate a response." }]);
                } catch (e) {
                    setChatHistory([...newHistory, { role: 'ai', text: "‚ö†Ô∏è Network error connecting to the Agile Coach." }]);
                }
                setIsChatting(false);
            };

            const generateInviteLink = async () => {
                const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
                const r = await secureFetch(`/guest/retro/generate_link`, { method: 'POST', body: JSON.stringify({ project, sprint: activeSprint, license_key: config.license_key }) });
                const d = await r.json();
                if (d.token) {
                    const link = `${window.location.origin}${window.location.pathname}?guest_token=${d.token}`;
                    navigator.clipboard.writeText(link); setToast("Guest Link copied to clipboard!"); setTimeout(() => setToast(null), 3000);
                }
            };

            if (!board) return <LoadingScreen msg="Fetching Retrospective..." />;
            return (
                <div className="h-full flex flex-col animate-fade-in pr-4 relative">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-4xl font-extrabold text-text-main flex items-center gap-4">
                                Retrospective
                                <button onClick={generateInviteLink} className="text-sm px-4 py-2 bg-primary-dim text-primary rounded-lg font-bold flex items-center gap-2 hover:bg-primary hover:text-white transition-colors border border-primary-dim shadow-sm">
                                    <Icon name="Link" size={16} /> Invite Team
                                </button>
                            </h2>
                        </div>
                        <select value={activeSprint || ""} onChange={e => setActiveSprint(e.target.value)} className="p-3 rounded-lg border bg-bg-card text-text-main font-bold shadow-sm">{sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                    </header>

                    <AnimatePresence>
                        {toast && (
                            <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className="absolute top-0 right-4 z-50 bg-success text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-3">
                                <Icon name="CheckCircle" size={18} /> {toast}
                            </motion.div>
                        )}
                    </AnimatePresence>

                    <div className="flex gap-4 mb-10 bg-bg-card p-4 rounded-2xl border border-border shadow-lg">
                        <div className="flex bg-bg-body rounded-xl p-1.5 border border-border">{['well', 'improve', 'kudos'].map(c => (<button key={c} onClick={() => setCol(c)} className={`px-6 py-3 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${col === c ? 'bg-primary text-white shadow-md' : 'text-text-muted hover:text-text-main'}`}>{c}</button>))}</div>
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && add()} placeholder="Type feedback here..." className="flex-1 bg-transparent text-text-main px-6 font-medium text-lg outline-none" />
                        <button onClick={add} className="bg-primary px-10 text-white font-extrabold rounded-xl hover:shadow-lg hover:scale-105 transition-all">Post</button>
                    </div>

                    <div className="grid grid-cols-4 gap-8 flex-1 pb-6 min-h-0">
                        {['well', 'improve', 'kudos'].map(c => (
                            <div key={c} className="retro-col shadow-xl">
                                <div className="retro-col-header bg-bg-card/50"><span>{c}</span><Icon name={c === 'well' ? 'CheckCircle' : c === 'improve' ? 'TrendingDown' : 'Star'} size={18} /></div>
                                <div className="retro-col-body bg-bg-body/50">
                                    {board[c]?.map(i => (
                                        <div key={i.id} className="retro-card font-medium relative group">
                                            <span className="pr-6 block">{i.text}</span>
                                            <button onClick={() => remove(c, i.id)} className="absolute top-2 right-2 p-1.5 bg-danger/10 text-danger rounded-md opacity-0 group-hover:opacity-100 transition-all hover:bg-danger hover:text-white">
                                                <Icon name="Trash" size={14} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}

                        <div className="retro-col border-primary/30 shadow-xl flex flex-col h-full" style={{ background: 'var(--primary-dim)' }}>
                            <div className="retro-col-header bg-primary/10 text-primary shrink-0">
                                <span className="flex items-center gap-2"><Icon name="Sparkles" size={16} /> Ask your Agile Coach</span>
                            </div>

                            <div className="retro-col-body bg-primary/5 flex flex-col p-4 gap-4 overflow-y-auto hide-scroll flex-1">
                                {chatHistory.map((msg, idx) => (
                                    <div key={idx} className={`p-4 rounded-2xl max-w-[90%] text-sm shadow-sm ${msg.role === 'user' ? 'bg-primary text-white self-end rounded-br-none' : 'bg-bg-card text-text-main border border-border self-start rounded-bl-none prose prose-sm dark:prose-invert'}`}
                                        dangerouslySetInnerHTML={msg.role === 'ai' ? { __html: marked.parse(msg.text) } : undefined}>
                                        {msg.role === 'user' ? msg.text : null}
                                    </div>
                                ))}
                                {isChatting && <div className="self-start text-primary p-3"><span className="loader w-5 h-5 border-2"></span></div>}
                                <div ref={chatEndRef} />
                            </div>

                            <div className="p-3 bg-bg-card border-t border-border flex gap-3 shrink-0">
                                <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendChat()} placeholder="Ask for insights or action items..." className="flex-1 bg-bg-body text-text-main text-sm font-medium px-4 py-3 rounded-xl outline-none border border-border focus:border-primary transition-colors" />
                                <button onClick={sendChat} disabled={isChatting || !chatInput.trim()} className="bg-primary text-white px-4 rounded-xl hover:scale-105 transition disabled:opacity-50 disabled:hover:scale-100 shadow-md">
                                    <Icon name="Zap" size={18} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function StandupView() { return <div className="h-full flex items-center justify-center text-2xl font-black text-text-muted uppercase tracking-widest">Standup Bot Coming Soon</div>; }
        function LoadingScreen({ msg = "Loading..." }) { return (<div className="h-full w-full flex flex-col items-center justify-center animate-pulse"><div className="w-12 h-12 border-4 border-t-transparent rounded-full animate-spin mb-6 text-primary" style={{ borderColor: 'var(--border)', borderTopColor: 'var(--primary)' }}></div><div className="text-base font-bold tracking-wider text-primary uppercase">{msg}</div></div>); }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>