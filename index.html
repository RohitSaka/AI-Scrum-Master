<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Agile Intelligence | Enterprise</title>
    <link rel="icon" href="data:,">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --transition-speed: 0.2s; }
        .dark-mode { --bg-body: #0f172a; --bg-sidebar: #020617; --bg-card: #1e293b; --bg-hover: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155; --primary: #6366f1; --primary-dim: rgba(99, 102, 241, 0.15); --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
        .light-mode { --bg-body: #F4F5F7; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF; --bg-hover: #EBECF0; --text-main: #172B4D; --text-muted: #5E6C84; --border: #DFE1E6; --primary: #0052CC; --primary-dim: rgba(0, 82, 204, 0.1); --danger: #DE350B; --success: #00875A; --warning: #FF991F; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background-color var(--transition-speed), color var(--transition-speed); overflow: hidden; margin: 0; }
        .glass-card { background: var(--bg-card); border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 0.5rem; }
        .nav-btn { color: var(--text-muted); padding: 0.75rem; border-radius: 0.375rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-btn.active { background: var(--primary-dim); color: var(--primary); border-left: 3px solid var(--primary); }
        .input-field { background-color: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: var(--primary); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); border-radius: 3px; }
        .loader { width: 20px; height: 20px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .retro-col { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; display: flex; flex-direction: column; height: 100%; overflow: hidden; backdrop-filter: blur(10px); }
        .retro-col-header { padding: 1rem; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .retro-col-body { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .retro-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; font-size: 0.875rem; color: #e2e8f0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .roadmap-grid { display: grid; grid-template-columns: 250px repeat(12, 1fr); background: transparent; }
        .roadmap-header { font-weight: 700; font-size: 10px; text-transform: uppercase; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); text-align: center; background: var(--bg-card); }
        .roadmap-cell { border-right: 1px solid var(--border); opacity: 0.2; }
        .roadmap-item { position: absolute; border-radius: 6px; padding: 8px 12px; font-size: 11px; font-weight: 600; color: white; display: flex; align-items: center; white-space: nowrap; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10; transition: transform 0.2s; }
    </style>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion;
        const API_BASE = "https://ai-scrum-master-cm2c.onrender.com"; 

        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>,
                Activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
                RefreshCcw: <><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></>,
                MessageSquare: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></>,
                Monitor: <><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></>,
                ChevronLeft: <><polyline points="15 18 9 12 15 6"></polyline></>,
                ChevronRight: <><polyline points="9 18 15 12 9 6"></polyline></>,
                Sun: <><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line></>,
                Moon: <><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></>,
                Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></>,
                Sparkles: <><path d="M12 3l1.912 5.813a2 2 0 001.275 1.275L21 12l-5.813 1.912a2 2 0 00-1.275 1.275L12 21l-1.912-5.813a2 2 0 00-1.275-1.275L3 12l5.813-1.912a2 2 0 001.275-1.275L12 3z"></path></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
                CloudLightning: <><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || null}</svg>;
        };

        const secureFetch = async (endpoint, options = {}) => {
            const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
            if (!config.license_key && !config.token) return null; 
            const headers = { 'Content-Type': 'application/json', 'x-license-key': config.license_key || '', 'x-jira-domain': config.domain || '', 'x-jira-email': config.email || '', 'x-jira-token': config.token || '', ...options.headers };
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                if (res.status === 401 || res.status === 403) { localStorage.removeItem('ig_config'); window.location.reload(); return null; }
                return res;
            } catch (error) { return null; }
        };

        function App() {
            const [config, setConfig] = useState(JSON.parse(localStorage.getItem('ig_config')));
            const [theme, setTheme] = useState(localStorage.getItem('ig_theme') || 'dark');
            useEffect(() => { document.body.className = theme === 'dark' ? 'dark-mode' : 'light-mode'; localStorage.setItem('ig_theme', theme); }, [theme]);
            if (!config || (!config.token && !config.license_key)) return <LoginScreen onLogin={setConfig} theme={theme} setTheme={setTheme} />;
            return <DashboardLayout userRole={config.role || 'scrum_master'} theme={theme} setTheme={setTheme} />;
        }

        function LoginScreen({ onLogin, theme, setTheme }) {
            const [licenseKey, setLicenseKey] = useState('');
            const [role, setRole] = useState('scrum_master');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('success') === 'true') {
                    const savedLicense = localStorage.getItem('pending_license');
                    const savedRole = localStorage.getItem('pending_role');
                    if (savedLicense) {
                        const newConfig = { license_key: savedLicense, role: savedRole };
                        localStorage.setItem('ig_config', JSON.stringify(newConfig));
                        localStorage.removeItem('pending_license'); localStorage.removeItem('pending_role');
                        window.history.replaceState({}, document.title, window.location.pathname); 
                        onLogin(newConfig);
                    }
                }
            }, []);

            const handleOAuthLogin = () => {
                if (!licenseKey) return alert("Please enter your Enterprise License Key.");
                setLoading(true); localStorage.setItem('pending_license', licenseKey); localStorage.setItem('pending_role', role);
                window.location.href = `${API_BASE}/auth/login?license_key=${licenseKey}`;
            };

            return (
                <div className="h-screen flex items-center justify-center relative transition-colors duration-500" style={{backgroundColor: 'var(--bg-body)'}}>
                    <div className="absolute top-4 right-4"><ThemeToggle theme={theme} setTheme={setTheme} /></div>
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="w-[420px] glass-card p-10 z-10 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div className="mb-8 text-center relative z-10">
                            <div className="w-16 h-16 rounded-xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4 shadow-lg" style={{background: 'linear-gradient(135deg, #6366f1, #3b82f6)'}}>IG</div>
                            <h1 className="text-2xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>IG Agile <span className="font-light text-slate-400">Intelligence</span></h1>
                        </div>
                        <div className="space-y-5 relative z-10">
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-2 block" style={{color: 'var(--text-muted)'}}>Role Profile</label><select value={role} onChange={e=>setRole(e.target.value)} className="w-full p-3 rounded-lg text-sm input-field font-medium shadow-sm"><option value="leadership">üëë Executive / CDO</option><option value="scrum_master">‚öîÔ∏è Scrum Master / PM</option></select></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-2 block flex items-center gap-1" style={{color: 'var(--text-muted)'}}><Icon name="Key" size={12}/> License Key</label><input value={licenseKey} onChange={e=>setLicenseKey(e.target.value)} placeholder="IG-ENT-..." className="w-full p-3 rounded-lg text-sm input-field shadow-sm font-mono tracking-wide" /></div>
                            <button onClick={handleOAuthLogin} disabled={loading} className="w-full text-white font-bold p-3 rounded-lg shadow-xl hover:shadow-indigo-500/25 transition flex justify-center items-center gap-3" style={{backgroundColor: '#0052CC'}}>{loading ? <span className="loader"></span> : <><Icon name="Activity" size={18}/> Log in with Atlassian</>}</button>
                        </div>
                    </motion.div>
                </div>
            );
        }

        function DashboardLayout({ userRole, theme, setTheme }) {
            const [view, setView] = useState('smartdeck');
            const [projects, setProjects] = useState([]);
            const [activeProject, setActiveProject] = useState(null);
            const [isGlobalLoading, setIsGlobalLoading] = useState(false); 

            useEffect(() => {
                secureFetch('/projects').then(r => r ? r.json() : []).then(data => {
                    if (data && data.length > 0) { setProjects(data); setActiveProject(data[0].key); }
                    else { setProjects([{key: 'DEMO', name: 'Demo Project'}]); setActiveProject('DEMO'); }
                });
            }, []);

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 shrink-0 flex flex-col justify-between border-r transition-colors duration-300" style={{backgroundColor: 'var(--bg-sidebar)', borderColor: 'var(--border)'}}>
                        <div className="p-4">
                            <div className="mb-8 pl-2 flex items-center gap-2"><div className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold" style={{backgroundColor: 'var(--primary)'}}>IG</div><div><h1 className="text-lg font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Agile</h1></div></div>
                            <nav className="space-y-1">
                                <NavBtn id="smartdeck" icon="Monitor" label="AI Sprint Deck" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="dashboard" icon="Activity" label="Command Center" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="roadmap" icon="Map" label="Strategic Roadmap" active={view} set={setView} disabled={isGlobalLoading} />
                                {userRole !== 'leadership' && <><NavBtn id="timeline" icon="Calendar" label="Timeline Flow" active={view} set={setView} disabled={isGlobalLoading} /><NavBtn id="standup" icon="MessageSquare" label="Standup Bot" active={view} set={setView} disabled={isGlobalLoading} /></>}
                                {(userRole === 'scrum_master' || userRole === 'leadership') && <><NavBtn id="reports" icon="FileText" label="Reports & Reviews" active={view} set={setView} disabled={isGlobalLoading} /><NavBtn id="retro" icon="RefreshCcw" label="Retrospective" active={view} set={setView} disabled={isGlobalLoading} /></>}
                            </nav>
                        </div>
                        <div className="p-4 border-t space-y-4" style={{borderColor: 'var(--border)'}}>
                            <ThemeToggle theme={theme} setTheme={setTheme} fullWidth />
                            <div><label className="text-[10px] font-bold uppercase mb-2 block" style={{color: 'var(--text-muted)'}}>Active Project</label><select value={activeProject || ''} onChange={e=>setActiveProject(e.target.value)} disabled={isGlobalLoading} className={`w-full p-2 rounded border text-sm input-field transition-all ${isGlobalLoading ? 'opacity-30 cursor-not-allowed bg-slate-800' : 'cursor-pointer'}`}>{projects.map(p => <option key={p.key} value={p.key}>{p.name} ({p.key})</option>)}</select></div>
                            <button onClick={()=>{localStorage.removeItem('ig_config'); window.location.reload()}} className="w-full text-left text-xs p-1 hover:underline font-bold" style={{color: 'var(--danger)'}}>Sign Out</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-hidden p-8 relative transition-colors duration-300" style={{padding: view === 'smartdeck' ? '0' : '2rem'}}>
                        {activeProject ? (
                            <div className="h-full">
                                {view === 'smartdeck' && <SmartDeckView project={activeProject} endpoint={`/super_deck/${activeProject}?sprint_id=active`} isFullScreen={true} />}
                                {view === 'dashboard' && <DashboardView project={activeProject} role={userRole} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'roadmap' && <RoadmapView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'timeline' && <TimelineView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'standup' && <StandupView project={activeProject} />}
                                {view === 'retro' && <RetroView project={activeProject} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'reports' && <ReportsView project={activeProject} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                            </div>
                        ) : <LoadingScreen msg="Authenticating with Atlassian..." />}
                    </main>
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set, disabled }) => (<button onClick={()=>set(id)} disabled={disabled} className={`nav-btn w-full ${active===id ? 'active' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}><Icon name={icon} size={18} /> {label}</button>);
        function ThemeToggle({ theme, setTheme, fullWidth }) { return (<button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`p-2 rounded border text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 transition hover:opacity-80 ${fullWidth ? 'w-full' : ''}`} style={{borderColor: 'var(--border)', color: 'var(--text-muted)', background: 'var(--bg-card)'}}><Icon name={theme === 'dark' ? 'Sun' : 'Moon'} size={14} /> {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}</button>); }
        function MetricCard({ label, value, color, isDanger }) { return (<div className="glass-card p-6 border-l-4 transition" style={{borderLeftColor: isDanger ? 'var(--danger)' : `var(--${color})`}}><div className="text-[10px] font-bold uppercase tracking-widest mb-1" style={{color: 'var(--text-muted)'}}>{label}</div><div className="text-3xl font-bold" style={{color: 'var(--text-main)'}}>{value}</div></div>); }

        // ================= ‚ú® AI HTML RENDERER (NATIVE LAYOUTS) ‚ú® =================
        function RenderSlide({ slide }) {
            const layout = slide.layout || 'standard';
            
            if (layout === 'hero') return (
                <div className="w-full h-full p-16 flex flex-col justify-center items-center text-center bg-slate-900 text-white relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-600/20 rounded-full blur-3xl -mr-20 -mt-20"></div>
                    {slide.icon && <div className="text-7xl mb-6">{slide.icon}</div>}
                    <h1 className="text-6xl font-black mb-4 tracking-tight">{slide.title}</h1>
                    <p className="text-3xl text-indigo-400 font-light">{slide.subtitle}</p>
                </div>
            );

            if (layout === 'kpi_grid') return (
                <div className="w-full h-full p-16 flex flex-col justify-center bg-slate-900 text-white relative">
                    <h2 className="text-5xl font-bold mb-12">{slide.title}</h2>
                    <div className="grid grid-cols-4 gap-6">
                        {(slide.items || []).map((kpi, i) => (
                            <div key={i} className="bg-slate-800 p-8 rounded-2xl border border-slate-700 flex flex-col items-center justify-center text-center shadow-lg">
                                {kpi.icon && <div className="text-5xl mb-4">{kpi.icon}</div>}
                                <div className="text-6xl font-black text-indigo-400 mb-2">{kpi.value}</div>
                                <div className="text-xl text-slate-300 font-medium uppercase tracking-wider">{kpi.label}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (layout === 'flowchart') return (
                <div className="w-full h-full p-16 flex flex-col justify-center bg-slate-900 text-white relative">
                    <h2 className="text-5xl font-bold mb-16">{slide.title}</h2>
                    <div className="flex gap-4 items-center justify-between w-full">
                        {(slide.items || []).map((step, i) => (
                            <React.Fragment key={i}>
                                <div className="flex-1 bg-slate-800 border border-slate-700 p-8 rounded-xl text-center shadow-lg relative">
                                    <div className="text-3xl font-bold text-indigo-400 mb-2">Step {i+1}</div>
                                    <div className="text-2xl text-white">{step.title}</div>
                                </div>
                                {i < (slide.items.length - 1) && <Icon name="ChevronRight" size={48} className="text-slate-600 shrink-0"/>}
                            </React.Fragment>
                        ))}
                    </div>
                </div>
            );

            if (layout === 'icon_columns') return (
                <div className="w-full h-full p-16 flex flex-col justify-center bg-slate-900 text-white relative">
                    <h2 className="text-5xl font-bold mb-12">{slide.title}</h2>
                    <div className="grid grid-cols-3 gap-8">
                        {(slide.items || []).map((col, i) => (
                            <div key={i} className="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-lg">
                                {col.icon && <div className="text-5xl mb-6">{col.icon}</div>}
                                <h3 className="text-3xl font-bold text-indigo-400 mb-4">{col.title}</h3>
                                <p className="text-xl text-slate-300 leading-relaxed">{col.text}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // Standard layout
            return (
                <div className="w-full h-full p-16 flex flex-col bg-slate-900 text-white relative">
                    <h2 className="text-5xl font-bold mb-10 pb-6 border-b-4 border-indigo-500 inline-block self-start">{slide.title}</h2>
                    <div className="bg-slate-800 flex-1 rounded-2xl border border-slate-700 p-10 shadow-lg flex flex-col justify-center">
                        <ul className="list-disc pl-10 space-y-6">
                            {(slide.content || []).map((bullet, i) => (
                                <li key={i} className="text-3xl text-slate-200 leading-relaxed">{bullet}</li>
                            ))}
                        </ul>
                    </div>
                </div>
            );
        }

        // ================= ‚ú® UNIVERSAL DECK VIEWER ‚ú® =================
        function SmartDeckView({ project, endpoint, isFullScreen, onClose }) {
            const [slides, setSlides] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isExporting, setIsExporting] = useState(false);

            useEffect(() => {
                setLoading(true);
                secureFetch(endpoint)
                    .then(r => r?.json())
                    .then(data => { if (data && data.slides) setSlides(data.slides); setLoading(false); })
                    .catch(() => setLoading(false));
            }, [endpoint]);

            // ‚ú® NATIVE EDITABLE PPTX EXPORT ‚ú®
            const handleExportPPTX = async () => {
                setIsExporting(true);
                try {
                    const res = await secureFetch('/generate_ppt', { method: 'POST', body: JSON.stringify({ project: project, slides: slides }) });
                    if(res && res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${project}_Native_Deck.pptx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } else { alert("Failed to compile native Presentation."); }
                } catch(e) { console.error(e); }
                setIsExporting(false);
            };

            if (loading) return <LoadingScreen msg="Super Agent orchestrating Professional Presentation..." />;
            if (!slides || slides.length === 0) return <div className="p-10 text-white">Failed to generate deck. Try refreshing.</div>;

            return (
                <div className={`flex flex-col relative bg-slate-900 overflow-hidden animate-fade-in ${isFullScreen ? 'h-full' : 'h-[600px] rounded-xl border border-slate-700 shadow-2xl mb-8'}`}>
                    <div className="h-16 shrink-0 flex items-center justify-between px-6 border-b border-slate-800 bg-slate-900 z-40">
                        <div className="flex items-center gap-4">
                            <div className="px-3 py-1 bg-indigo-500/20 text-indigo-400 rounded text-xs font-bold border border-indigo-500/30 flex items-center gap-2"><Icon name="Sparkles" size={14}/> AI Generated Deck</div>
                            <span className="text-slate-400 text-sm font-medium">Slide {currentIdx + 1} of {slides.length}</span>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={handleExportPPTX} disabled={isExporting} className="flex items-center gap-2 px-4 py-2 text-white rounded-lg text-sm font-bold transition shadow-lg disabled:opacity-50" style={{background: 'linear-gradient(to right, #6366f1, #a855f7)'}}>
                                {isExporting ? <span className="loader" style={{width:'16px', height:'16px'}}></span> : <Icon name="Download" size={16}/>}
                                {isExporting ? 'Compiling Native PPTX...' : 'Export Native PPTX'}
                            </button>
                            {onClose && <button onClick={onClose} className="p-2 text-slate-400 hover:text-white transition"><Icon name="X" size={20}/></button>}
                        </div>
                    </div>

                    <div className="flex-1 relative flex items-center justify-center p-8 bg-black/50 overflow-hidden">
                        <div className="w-full max-w-[1000px] aspect-video bg-slate-900 rounded-xl overflow-hidden relative border border-slate-700 transition-all duration-300 shadow-[0_20px_50px_rgba(0,0,0,0.5)] transform scale-90 md:scale-100">
                            <RenderSlide slide={slides[currentIdx]} />
                        </div>
                        <button onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))} disabled={currentIdx === 0} className="absolute left-6 w-12 h-12 rounded-full bg-slate-800/80 hover:bg-indigo-600 text-white flex items-center justify-center transition disabled:opacity-30 border border-white/10 z-30 shadow-2xl"><Icon name="ChevronLeft" size={24}/></button>
                        <button onClick={() => setCurrentIdx(Math.min(slides.length - 1, currentIdx + 1))} disabled={currentIdx === slides.length - 1} className="absolute right-6 w-12 h-12 rounded-full bg-slate-800/80 hover:bg-indigo-600 text-white flex items-center justify-center transition disabled:opacity-30 border border-white/10 z-30 shadow-2xl"><Icon name="ChevronRight" size={24}/></button>
                    </div>
                </div>
            );
        }

        // ================= STRATEGIC ROADMAP VIEW =================
        function RoadmapView({ project, setIsLoading }) {
            const [roadmap, setRoadmap] = useState(null);
            useEffect(() => { setIsLoading(true); setRoadmap(null); secureFetch(`/roadmap/${project}`).then(r => r?.json()).then(data => { setRoadmap(data); setIsLoading(false); }).catch(() => setIsLoading(false)); }, [project]);
            if (!roadmap) return <LoadingScreen msg="AI is analyzing the backlog and predicting release timelines..." />;
            const trackColors = ["linear-gradient(to right, #3b82f6, #60a5fa)", "linear-gradient(to right, #10b981, #34d399)", "linear-gradient(to right, #8b5cf6, #a78bfa)", "linear-gradient(to right, #f59e0b, #fbbf24)"];

            return (
                <div className="animate-fade-in h-full flex flex-col pr-2 pb-10">
                    <header className="mb-6 flex justify-between items-end pb-4 border-b" style={{borderColor: 'var(--border)'}}>
                        <div><h2 className="text-3xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Strategic Roadmap</h2><p className="text-sm mt-1" style={{color: 'var(--text-muted)'}}>AI-Predicted Release Timeline based on Priority & Dependencies</p></div>
                        <div className="flex items-center gap-2 px-4 py-2 rounded-full border text-xs font-bold" style={{borderColor: 'var(--border)', color: 'var(--primary)', background: 'var(--primary-dim)'}}><Icon name="Sparkles" size={14}/> 12-Week Horizon</div>
                    </header>
                    <div className="flex-1 overflow-auto hide-scroll rounded-xl border shadow-2xl relative" style={{borderColor: 'var(--border)', backgroundColor: 'var(--bg-card)'}}>
                        <div className="min-w-[1000px]">
                            <div className="roadmap-grid sticky top-0 z-30" style={{borderBottom: '1px solid var(--border)'}}>
                                <div className="roadmap-header" style={{textAlign: 'left', paddingLeft: '24px'}}>Workstream</div>{roadmap.timeline.map((wk, i) => (<div key={i} className="roadmap-header">{wk}</div>))}
                            </div>
                            {roadmap.tracks.map((track, trackIdx) => (
                                <div key={trackIdx} className="relative border-b last:border-b-0" style={{borderColor: 'var(--border)'}}>
                                    <div className="roadmap-grid border-0 rounded-none absolute inset-0 h-full"><div className="roadmap-cell" style={{borderRight: '1px solid var(--border)'}}></div>{roadmap.timeline.map((_, i) => (<div key={i} className="roadmap-cell" style={{borderRight: '1px solid var(--border)'}}></div>))}</div>
                                    <div className="relative z-10 flex">
                                        <div className="w-[250px] shrink-0 p-6 flex flex-col justify-center border-r" style={{borderColor: 'var(--border)'}}><span className="font-bold text-sm leading-snug" style={{color: 'var(--text-main)'}}>{track.name}</span><span className="text-[10px] mt-1 uppercase font-bold" style={{color: 'var(--text-muted)'}}>{track.items.length} Items</span></div>
                                        <div className="flex-1 relative" style={{minHeight: `${Math.max(track.items.length * 44 + 24, 80)}px`}}>
                                            <AnimatePresence>
                                                {track.items.map((item, i) => {
                                                    const start = Math.max(0, Math.min(item.start, 11)); const dur = Math.max(1, Math.min(item.duration, 12 - start));
                                                    return (
                                                        <motion.div key={item.key} initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: i * 0.1, ease: "easeOut" }} className="roadmap-item" style={{background: trackColors[trackIdx % trackColors.length], left: `calc(${(start / 12) * 100}% + 8px)`, width: `calc(${(dur / 12) * 100}% - 16px)`, top: `${i * 44 + 12}px`}} title={`${item.key}: ${item.summary} [Priority: ${item.priority}]`}><span className="font-bold opacity-80 mr-2 shrink-0">{item.key}</span><span className="truncate">{item.summary}</span></motion.div>
                                                    )
                                                })}
                                            </AnimatePresence>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ================= COMMAND CENTER =================
        function DashboardView({ project, role, setIsLoading, isGlobalLoading }) {
            const [data, setData] = useState(null); const [sprints, setSprints] = useState([]); const [activeSprint, setActiveSprint] = useState('active'); 
            useEffect(() => { secureFetch(`/sprints/${project}`).then(r=>r?.json()).then(d => { if(d && d.length) setSprints(d); }); }, [project]);
            useEffect(() => { setData(null); setIsLoading(true); secureFetch(activeSprint === 'active' ? `/analytics/${project}` : `/analytics/${project}?sprint_id=${activeSprint}`).then(r => r ? r.json() : null).then(d => { setData(d); setIsLoading(false); }); }, [project, activeSprint]);
            if (!data) return <LoadingScreen msg="AI is analyzing descriptions, acceptance criteria, and assignee comments..." />;
            return (
                <div className="animate-fade-in space-y-6 h-full overflow-y-auto pb-10 pr-2">
                    <header className="flex justify-between items-end mb-8 border-b pb-4" style={{borderColor: 'var(--border)'}}>
                        <div><h2 className="text-3xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Executive Insights</h2><p className="text-sm mt-1" style={{color: 'var(--text-muted)'}}>AI-driven delivery analysis & business value</p></div>
                        <div className="flex items-center gap-2"><span className="text-[10px] font-bold uppercase tracking-wider" style={{color: 'var(--text-muted)'}}>Target Sprint</span><select value={activeSprint} onChange={e=>setActiveSprint(e.target.value)} disabled={isGlobalLoading} className={`p-2 rounded border text-sm input-field font-medium min-w-[200px]`}><option value="active">üü¢ Active Sprint</option>{sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                    </header>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4"><MetricCard label="Velocity (Pts)" value={data.metrics.points} color="primary" /><MetricCard label="Total Tickets" value={data.metrics.total} color="success" /><MetricCard label="Blockers" value={data.metrics.blockers} color="danger" isDanger={data.metrics.blockers > 0} /><MetricCard label="Bugs Found" value={data.metrics.bugs} color="warning" /></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass-card p-6 border-t-4" style={{borderTopColor: 'var(--primary)'}}><h3 className="text-xs font-bold uppercase tracking-widest flex items-center gap-2 mb-4" style={{color: 'var(--text-muted)'}}><Icon name="Activity" size={14}/> Executive Summary</h3><p className="text-sm leading-relaxed" style={{color: 'var(--text-main)'}}>{data.ai_insights?.executive_summary}</p></div>
                        <div className="glass-card p-6 border-t-4" style={{borderTopColor: 'var(--success)'}}><h3 className="text-xs font-bold uppercase tracking-widest flex items-center gap-2 mb-4" style={{color: 'var(--text-muted)'}}><Icon name="TrendingDown" size={14}/> Business Value Delivered</h3><p className="text-sm leading-relaxed" style={{color: 'var(--text-main)'}} dangerouslySetInnerHTML={{ __html: marked.parse(data.ai_insights?.business_value || "") }}></p></div>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold mb-4 mt-8" style={{color: 'var(--text-main)'}}>Deep Story Progress Analysis</h3>
                        <div className="grid grid-cols-1 gap-3">
                            {data.ai_insights?.story_progress?.map((story, idx) => (
                                <div key={idx} className="glass-card p-4 flex gap-4 items-center">
                                    <div className="w-24 text-center"><div className="text-xs font-bold" style={{color: 'var(--primary)'}}>{story.key}</div><div className="text-[9px] uppercase tracking-wider mt-1 px-2 py-0.5 rounded-full border inline-block" style={{color: 'var(--text-muted)'}}>{story.status}</div></div>
                                    <div className="flex-1 border-l pl-4" style={{borderColor: 'var(--border)'}}><div className="text-sm font-semibold mb-1" style={{color: 'var(--text-main)'}}>{story.summary} <span className="font-normal opacity-50 ml-2">({story.assignee})</span></div><div className="text-xs" style={{color: 'var(--text-muted)'}}><strong style={{color: 'var(--warning)'}}>AI Note: </strong> {story.analysis}</div></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ================= TIMELINE AI GENERATOR VIEW =================
        function TimelineView({ project, setIsLoading }) {
            const [data, setData] = useState(null); const [prompt, setPrompt] = useState(""); const [isGeneratingStory, setIsGeneratingStory] = useState(false); const [generatedStory, setGeneratedStory] = useState(null); const [isCreatingIssue, setIsCreatingIssue] = useState(false);
            useEffect(() => { setData(null); setIsLoading(true); secureFetch(`/analytics/${project}`).then(r=>r?.json()).then(d => { setData(d); setIsLoading(false); }); }, [project]);
            const handleGenerateStory = async () => { if(!prompt.trim()) return; setIsGeneratingStory(true); setGeneratedStory(null); const r = await secureFetch('/timeline/generate_story', { method: 'POST', body: JSON.stringify({ project, prompt }) }); const res = await r.json(); if(res.status === 'success') setGeneratedStory(res.story); setIsGeneratingStory(false); };
            const handleCreateIssue = async () => { setIsCreatingIssue(true); const r = await secureFetch('/timeline/create_issue', { method: 'POST', body: JSON.stringify({ project, story: generatedStory }) }); const res = await r.json(); if(res.status === 'success') { alert(`Success! Issue ${res.key} added.`); setGeneratedStory(null); setPrompt(""); } setIsCreatingIssue(false); };
            if (!data) return <LoadingScreen msg="Loading Resource Allocation and Capacity..." />;
            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-10 flex flex-col pr-2">
                    <header className="mb-6"><h2 className="text-3xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Team Timeline & Capacity</h2></header>
                    <div className="space-y-4 mb-10">
                        {Object.entries(data.metrics.assignees).map(([name, stats]) => (
                            <div key={name} className="glass-card p-4 flex items-center gap-6 overflow-hidden">
                                <div className="w-48 shrink-0 flex items-center gap-3 pr-4 border-r" style={{borderColor: 'var(--border)'}}>{stats.avatar ? <img src={stats.avatar} className="w-10 h-10 rounded-full border border-indigo-500" /> : <div className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white bg-indigo-600 shadow-lg">{name.charAt(0)}</div>}<div className="min-w-0"><div className="text-sm font-bold truncate" style={{color: 'var(--text-main)'}}>{name.split(" ")[0]}</div><div className="text-[10px] font-medium mt-0.5 px-2 py-0.5 rounded bg-black/20 text-indigo-400 inline-block">{stats.points} Points</div></div></div>
                                <div className="flex-1 flex gap-3 overflow-x-auto hide-scroll pb-2 pt-2">{stats.tasks?.map(t => (<div key={t.key} className="shrink-0 w-64 p-3 rounded-lg border shadow-sm flex flex-col justify-between" style={{borderColor: t.priority==='High' ? 'var(--danger)' : 'rgba(255,255,255,0.05)', backgroundColor: 'var(--bg-card)'}}><div><div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-indigo-400">{t.key}</span><span className="text-[9px] uppercase text-slate-500">{t.status}</span></div><p className="text-xs text-slate-200 line-clamp-2">{t.summary}</p></div><div className="mt-3 flex justify-end"><span className="text-[10px] font-bold bg-slate-800 text-slate-300 px-2 py-1 rounded">{t.points} pts</span></div></div>))}</div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-auto">
                        <div className="glass-card border-t-4 p-6 relative overflow-hidden" style={{borderTopColor: '#c084fc'}}>
                            <h3 className="text-lg font-bold flex items-center gap-2 mb-2" style={{color: 'var(--text-main)'}}><Icon name="Sparkles" size={20} className="text-purple-400"/> Auto-Generate User Story</h3>
                            <div className="flex gap-3"><input value={prompt} onChange={e=>setPrompt(e.target.value)} className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm text-white" /><button onClick={handleGenerateStory} disabled={isGeneratingStory} className="px-6 py-3 font-bold text-white rounded-lg" style={{background: 'linear-gradient(to right, #8b5cf6, #d946ef)'}}>{isGeneratingStory ? '...' : 'Create Story'}</button></div>
                            <AnimatePresence>
                                {generatedStory && (
                                    <motion.div initial={{opacity:0, height:0}} animate={{opacity:1, height:'auto'}} className="mt-6 pt-6 border-t border-slate-700/50"><div className="bg-slate-900/50 rounded-xl p-6 border border-slate-700"><div className="flex justify-between mb-4"><h4 className="text-xl font-bold text-white">{generatedStory.title}</h4><div><span className="px-3 py-1 bg-indigo-500/20 text-indigo-300 rounded-full text-xs font-bold mr-2">{generatedStory.points} Points</span><span className="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">{generatedStory.assignee}</span></div></div><div className="mb-6"><h5 className="text-xs font-bold text-slate-400 mb-2">Description</h5><p className="text-sm text-slate-200">{generatedStory.description}</p></div><div className="mb-6"><h5 className="text-xs font-bold text-slate-400 mb-2">Acceptance Criteria</h5><ul className="list-disc pl-5 text-sm text-slate-200 space-y-1">{generatedStory.acceptance_criteria.map((ac, i) => <li key={i}>{ac}</li>)}</ul></div><div className="bg-purple-500/10 p-4 rounded-lg border border-purple-500/20 flex gap-3 items-start"><Icon name="Sparkles" size={16} className="text-purple-400 shrink-0 mt-0.5"/><div><h5 className="text-xs font-bold text-purple-300 uppercase tracking-widest mb-1">AI Reasoning</h5><p className="text-xs text-slate-300 leading-relaxed">{generatedStory.tech_stack_inferred}</p></div></div><div className="mt-6 flex justify-end"><button onClick={handleCreateIssue} disabled={isCreatingIssue} className="px-6 py-2.5 text-sm font-bold text-white rounded-lg" style={{backgroundColor: 'var(--success)'}}>Pushing to Jira</button></div></div></motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>
                </div>
            );
        }

        // ================= DOSSIER REPORTS (WITH DECK INTEGRATION) =================
        function ReportsView({ project, setIsLoading, isGlobalLoading }) { 
            const [data, setData] = useState(null); 
            const [timeframe, setTimeframe] = useState('weekly');
            const [showDeck, setShowDeck] = useState(false);

            useEffect(()=>{ 
                setData(null); setShowDeck(false); setIsLoading(true); 
                secureFetch(`/reports/${project}/${timeframe}`).then(r=>r?.json()).then(d => { setData(d); setIsLoading(false); }); 
            },[project, timeframe]);
            
            if(!data) return <LoadingScreen msg={`Compiling ${timeframe} AI Dossier...`}/>;
            const dossier = data.dossier || {};

            return (
                <div className="animate-fade-in space-y-6 h-full overflow-y-auto pb-10 pr-2">
                    <header className="flex justify-between items-end mb-8 border-b pb-4">
                        <div><h2 className="text-3xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>AI Performance Dossier</h2></div>
                        <div className="flex items-center gap-2 bg-black/10 p-1 rounded-lg border" style={{borderColor: 'var(--border)'}}>
                            {['weekly', 'monthly', 'quarterly'].map(t => (<button key={t} onClick={() => setTimeframe(t)} className={`px-4 py-1.5 rounded-md text-xs font-bold capitalize transition ${timeframe === t ? 'bg-indigo-500 text-white' : 'text-slate-500 hover:text-white'}`}>{t}</button>))}
                        </div>
                    </header>

                    {/* ‚ú® NEW: DYNAMIC WBR/MBR/QBR DECK GENERATOR ‚ú® */}
                    <div className="bg-gradient-to-r from-indigo-900 to-purple-900 p-6 rounded-xl border border-indigo-500/30 flex justify-between items-center shadow-lg">
                        <div>
                            <h3 className="text-lg font-bold text-white mb-1"><Icon name="Monitor" size={18} className="inline mr-2"/> Generate {timeframe.charAt(0).toUpperCase() + timeframe.slice(1)} Business Review</h3>
                            <p className="text-sm text-indigo-200">The Super Agent will write a structured, multi-slide executive presentation for this period.</p>
                        </div>
                        <button onClick={() => setShowDeck(true)} className="bg-white text-indigo-900 px-6 py-3 rounded-lg font-bold shadow-xl hover:scale-105 transition">‚ú® Generate Deck</button>
                    </div>

                    {showDeck && <SmartDeckView project={project} endpoint={`/report_deck/${project}/${timeframe}`} isFullScreen={false} onClose={() => setShowDeck(false)} />}

                    {/* ‚ú® RESTORED DOSSIER UI ‚ú® */}
                    <div className="glass-card p-8"><h3 className="text-xs font-bold text-primary mb-4 uppercase tracking-widest">The AI Verdict</h3><p className="text-2xl font-light">{dossier.ai_verdict}</p></div>
                    <div className="grid grid-cols-3 gap-6">
                        <div className="glass-card p-6 text-center"><span className="text-[10px] font-bold text-muted uppercase tracking-widest">Issues Completed</span><div className="text-5xl font-black text-emerald-500 mt-2">{data.completed_count}</div></div>
                        <div className="glass-card p-6 text-center"><span className="text-[10px] font-bold text-muted uppercase tracking-widest">Velocity Delivered</span><div className="text-5xl font-black text-indigo-500 mt-2">{data.completed_points}</div></div>
                        <div className="glass-card p-6 text-center border-t-4 border-amber-400"><Icon name="Star" size={24} className="text-amber-400 mx-auto mb-2"/><span className="text-[10px] font-bold text-muted uppercase tracking-widest">Top Contributor</span><div className="text-lg font-bold mt-2">{dossier.top_contributor?.split('-')[0]}</div><div className="text-xs text-muted italic mt-1">{dossier.top_contributor?.split('-')[1]}</div></div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass-card p-6">
                            <h3 className="text-sm font-bold uppercase tracking-widest flex items-center gap-2 mb-6" style={{color: 'var(--success)'}}><Icon name="TrendingDown" size={16}/> Key Accomplishments</h3>
                            <div className="space-y-4">{dossier.key_accomplishments?.map((acc, i) => (<div key={i} className="flex gap-4 items-start pb-4 border-b last:border-0" style={{borderColor: 'var(--border)'}}><div className="w-6 h-6 rounded bg-emerald-500/20 text-emerald-400 flex items-center justify-center font-bold text-xs shrink-0">{i+1}</div><div><h4 className="text-sm font-bold mb-1" style={{color: 'var(--text-main)'}}>{acc.title}</h4><p className="text-xs leading-relaxed" style={{color: 'var(--text-muted)'}}>{acc.impact}</p></div></div>))}</div>
                        </div>
                        <div className="glass-card p-6 border-l-4" style={{borderLeftColor: 'var(--danger)'}}>
                            <h3 className="text-sm font-bold uppercase tracking-widest flex items-center gap-2 mb-6" style={{color: 'var(--danger)'}}><Icon name="AlertTriangle" size={16}/> Hidden Friction Detected</h3>
                            <div className="p-5 rounded-lg bg-red-500/10 border border-red-500/20"><p className="text-sm leading-relaxed" style={{color: 'var(--text-main)'}}>{dossier.hidden_friction}</p></div>
                        </div>
                    </div>
                </div>
            ); 
        }

        // ================= RETRO BOARD =================
        function RetroView({ project, setIsLoading, isGlobalLoading }) {
            const [sprints, setSprints] = useState([]); const [activeSprint, setActiveSprint] = useState(null); const [board, setBoard] = useState(null); const [input, setInput] = useState(""); const [col, setCol] = useState("well"); const [loadingAI, setLoadingAI] = useState(false);
            useEffect(() => { secureFetch(`/sprints/${project}`).then(r=>r?.json()).then(d => { setSprints(d); if(d && d.length) setActiveSprint(d[0].id); }); }, [project]);
            useEffect(() => { if(activeSprint) { secureFetch(`/retro/${project}?sprint_id=${activeSprint}`).then(r=>r?.json()).then(setBoard); } }, [project, activeSprint]);
            const save = (b) => { setBoard(b); secureFetch(`/retro/update`, {method:'POST', body:JSON.stringify({project, sprint:activeSprint, board:b})}); };
            const add = () => { if(!input.trim()) return; const n = board[col] ? [...board[col]] : []; n.push({id:Date.now(), text:input}); save({...board, [col]: n}); setInput(""); };
            const genActions = () => { setLoadingAI(true); secureFetch(`/retro/generate_actions`, {method:'POST', body:JSON.stringify({board})}).then(r=>r.json()).then(d => { save({...board, actions: [...(board.actions||[]), ...d.actions]}); setLoadingAI(false); }); };
            
            if(!board) return <LoadingScreen msg="Fetching Retrospective..." />;
            return (
                <div className="h-full flex flex-col animate-fade-in pr-2">
                    <header className="flex justify-between items-center mb-6"><h2 className="text-3xl font-bold">Retrospective</h2><select value={activeSprint||""} onChange={e=>setActiveSprint(e.target.value)} className="p-2 rounded border bg-slate-900 text-white">{sprints.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></header>
                    <div className="flex gap-4 mb-8 bg-slate-800 p-3 rounded-xl"><div className="flex bg-slate-900 rounded-lg p-1">{['well', 'improve', 'kudos'].map(c => (<button key={c} onClick={()=>setCol(c)} className={`px-6 py-2 rounded-md text-xs font-bold ${col === c ? 'bg-indigo-500 text-white' : 'text-slate-400'}`}>{c}</button>))}</div><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&add()} className="flex-1 bg-transparent text-white px-4" /><button onClick={add} className="bg-primary px-8 text-white font-bold rounded">Post</button></div>
                    <div className="grid grid-cols-4 gap-6 flex-1 pb-4">
                        {['well', 'improve', 'kudos'].map(c => (<div key={c} className="retro-col"><div className="retro-col-header"><span>{c}</span></div><div className="retro-col-body">{board[c]?.map(i => (<div key={i.id} className="retro-card">{i.text}</div>))}</div></div>))}
                        <div className="retro-col" style={{background: 'rgba(49, 46, 129, 0.2)'}}><div className="retro-col-header"><span>Action Plan</span><button onClick={genActions} className="bg-indigo-500 text-white px-2 rounded">Gen</button></div><div className="retro-col-body">{board.actions?.map(i => (<div key={i.id} className="retro-card">{i.text}</div>))}</div></div>
                    </div>
                </div>
            );
        }

        function StandupView() { return <div className="h-full flex items-center justify-center text-xl font-bold" style={{color: 'var(--text-muted)'}}>Standup Component Coming Soon</div>; }
        function BurndownView() { return <div className="h-full flex items-center justify-center text-xl font-bold" style={{color: 'var(--text-muted)'}}>Burndown Component Coming Soon</div>; }
        function LoadingScreen({ msg = "Loading..." }) { return (<div className="h-full w-full flex flex-col items-center justify-center animate-pulse"><div className="w-10 h-10 border-4 border-t-transparent rounded-full animate-spin mb-4" style={{borderColor: 'var(--primary)', borderTopColor: 'transparent'}}></div><div className="text-sm font-medium tracking-wide" style={{color: 'var(--primary)'}}>{msg}</div></div>); }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>