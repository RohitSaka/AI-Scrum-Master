<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Agile Intelligence | Executive</title>
    <link rel="icon" href="data:,">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --transition-speed: 0.2s; }
        .dark-mode {
            --bg-body: #0f172a; --bg-sidebar: #020617; --bg-card: #1e293b; --bg-hover: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
            --primary: #6366f1; --primary-fg: #ffffff; --primary-dim: rgba(99, 102, 241, 0.15);
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .light-mode {
            --bg-body: #F4F5F7; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF; --bg-hover: #EBECF0;
            --text-main: #172B4D; --text-muted: #5E6C84; --border: #DFE1E6;
            --primary: #0052CC; --primary-fg: #ffffff; --primary-dim: rgba(0, 82, 204, 0.1);
            --danger: #DE350B; --success: #00875A; --warning: #FF991F;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); --glass-border: 1px solid var(--border);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background-color var(--transition-speed), color var(--transition-speed); overflow: hidden; }
        .glass-card { background: var(--bg-card); border: var(--glass-border); box-shadow: var(--shadow); border-radius: 0.5rem; }
        .nav-btn { color: var(--text-muted); padding: 0.75rem; border-radius: 0.375rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-btn.active { background: var(--primary-dim); color: var(--primary); border-left: 3px solid var(--primary); }
        .input-field { background-color: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: var(--primary); }
        .prose strong { color: var(--primary); font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; }
        .prose li { margin-bottom: 0.25rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .loader { width: 20px; height: 20px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion;
        const API_BASE = "https://ai-scrum-master-cm2c.onrender.com"; 

        const Icon = ({ name, size = 18 }) => {
            const icons = {
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>,
                Activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icons[name] || null}</svg>;
        };

        const secureFetch = async (endpoint, options = {}) => {
            const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
            if (!config.token || !config.domain) return null;
            const headers = { 'Content-Type': 'application/json', 'x-license-key': 'IG-ENTERPRISE', 'x-jira-domain': config.domain, 'x-jira-email': config.email, 'x-jira-token': config.token, ...options.headers };
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                if (res.status === 403 || res.status === 401) { localStorage.removeItem('ig_config'); window.location.reload(); return null; }
                return res;
            } catch (error) { console.error("Network Error:", error); return null; }
        };

        function App() {
            const [config, setConfig] = useState(JSON.parse(localStorage.getItem('ig_config')));
            useEffect(() => { document.body.className = 'dark-mode'; }, []);
            if (!config || !config.token) return <LoginScreen onLogin={(c) => setConfig(c)} />;
            return <DashboardLayout userRole={config.role || 'scrum_master'} />;
        }

        function LoginScreen({ onLogin }) {
            const [form, setForm] = useState({ domain: '', email: '', token: '', role: 'scrum_master' });
            const [loading, setLoading] = useState(false);
            const handleLogin = () => {
                if (!form.domain || !form.email || !form.token) return alert("Please fill in all fields.");
                setLoading(true); localStorage.setItem('ig_config', JSON.stringify(form));
                setTimeout(() => { setLoading(false); onLogin(form); }, 1000);
            };
            return (
                <div className="h-screen flex items-center justify-center relative transition-colors duration-500" style={{backgroundColor: 'var(--bg-body)'}}>
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="w-[400px] glass-card p-10 z-10 shadow-2xl">
                        <div className="mb-8 text-center">
                            <h1 className="text-2xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>IG Agile</h1>
                            <p className="text-sm" style={{color: 'var(--text-muted)'}}>Enterprise Intelligence</p>
                        </div>
                        <div className="space-y-5">
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>Role Profile</label><select value={form.role} onChange={e=>setForm({...form, role:e.target.value})} className="w-full p-3 rounded-lg text-sm input-field cursor-pointer"><option value="leadership">üëë Executive / Leadership</option><option value="scrum_master">‚öîÔ∏è Scrum Master / PM</option><option value="developer">üõ†Ô∏è Developer / Engineer</option></select></div>
                            <div className="h-px bg-slate-700/20"></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>Jira Domain</label><input value={form.domain} onChange={e=>setForm({...form, domain:e.target.value})} placeholder="company.atlassian.net" className="w-full p-3 rounded-lg text-sm input-field" /></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>Email</label><input value={form.email} onChange={e=>setForm({...form, email:e.target.value})} placeholder="you@company.com" className="w-full p-3 rounded-lg text-sm input-field" /></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>API Token</label><input type="password" value={form.token} onChange={e=>setForm({...form, token:e.target.value})} placeholder="Atlassian API Token" className="w-full p-3 rounded-lg text-sm input-field" /></div>
                            <button onClick={handleLogin} disabled={loading} className="w-full text-white font-bold p-3 rounded-lg shadow-lg transition disabled:opacity-50 mt-4 flex justify-center items-center gap-2" style={{backgroundColor: 'var(--primary)', color: 'var(--primary-fg)'}}>{loading ? <span className="loader"></span> : "Connect Securely"}</button>
                        </div>
                    </motion.div>
                </div>
            );
        }

        function DashboardLayout({ userRole }) {
            const [view, setView] = useState('dashboard');
            const [projects, setProjects] = useState([]);
            const [activeProject, setActiveProject] = useState(null);
            const [isGlobalLoading, setIsGlobalLoading] = useState(false); 

            useEffect(() => {
                secureFetch('/projects').then(r => r ? r.json() : []).then(data => {
                    if (data && data.length > 0) { setProjects(data); setActiveProject(data[0].key); }
                    else { setProjects([{key: 'DEMO', name: 'Demo Project'}]); setActiveProject('DEMO'); }
                }).catch(() => setProjects([{key: 'ERR', name: 'Connection Error'}]));
            }, []);

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 flex flex-col justify-between border-r transition-colors duration-300" style={{backgroundColor: 'var(--bg-sidebar)', borderColor: 'var(--border)'}}>
                        <div className="p-4">
                            <div className="mb-8 pl-2 flex items-center gap-2">
                                <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold" style={{backgroundColor: 'var(--primary)'}}>IG</div>
                                <div><h1 className="text-lg font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Agile</h1><p className="text-[10px] uppercase tracking-wider" style={{color: 'var(--text-muted)'}}>{userRole.replace('_', ' ')}</p></div>
                            </div>
                            <nav className="space-y-1">
                                <NavBtn id="dashboard" icon="Activity" label="Command Center" active={view} set={setView} disabled={isGlobalLoading} />
                            </nav>
                        </div>
                        <div className="p-4 border-t space-y-4" style={{borderColor: 'var(--border)'}}>
                            <div>
                                <label className="text-[10px] font-bold uppercase mb-2 block" style={{color: 'var(--text-muted)'}}>Active Project</label>
                                <select 
                                    value={activeProject || ''} 
                                    onChange={e=>setActiveProject(e.target.value)} 
                                    disabled={isGlobalLoading}
                                    className={`w-full p-2 rounded border text-sm input-field transition-all ${isGlobalLoading ? 'opacity-30 cursor-not-allowed bg-slate-800' : 'cursor-pointer hover:bg-slate-700'}`}
                                >
                                    {projects.map(p => <option key={p.key} value={p.key}>{p.name} ({p.key})</option>)}
                                </select>
                            </div>
                            <button onClick={()=>{localStorage.removeItem('ig_config'); window.location.reload()}} className="w-full text-left text-xs p-1 hover:underline" style={{color: 'var(--danger)'}}>Sign Out</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-auto p-8 relative transition-colors duration-300">
                        {activeProject ? (
                            <>
                                {view === 'dashboard' && <DashboardView project={activeProject} role={userRole} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                            </>
                        ) : <LoadingScreen msg="Connecting to Jira..." />}
                    </main>
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set, disabled }) => (
            <button onClick={()=>set(id)} disabled={disabled} className={`nav-btn w-full ${active===id ? 'active' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}><Icon name={icon} size={18} /> {label}</button>
        );

        function MetricCard({ label, value, color, isDanger }) {
            return (
                <div className="glass-card p-6 border-l-4 transition" style={{borderLeftColor: isDanger ? 'var(--danger)' : `var(--${color})`}}>
                    <div className="text-[10px] font-bold uppercase tracking-widest mb-1" style={{color: 'var(--text-muted)'}}>{label}</div>
                    <div className="text-3xl font-bold" style={{color: 'var(--text-main)'}}>{value}</div>
                </div>
            );
        }

        // --- EXECUTIVE COMMAND CENTER ---
        function DashboardView({ project, role, setIsLoading, isGlobalLoading }) {
            const [data, setData] = useState(null);
            const [sprints, setSprints] = useState([]);
            const [activeSprint, setActiveSprint] = useState('active'); 
            const [isGeneratingPPT, setIsGeneratingPPT] = useState(false);

            useEffect(() => {
                secureFetch(`/sprints/${project}`).then(r=>r?.json()).then(d => {
                    if(d && d.length) setSprints(d);
                });
            }, [project]);

            useEffect(() => { 
                setData(null);
                setIsLoading(true);
                const url = activeSprint === 'active' ? `/analytics/${project}` : `/analytics/${project}?sprint_id=${activeSprint}`;
                
                secureFetch(url)
                    .then(r => r ? r.json() : null)
                    .then(d => { setData(d); setIsLoading(false); })
                    .catch(() => { setIsLoading(false); });
            }, [project, activeSprint]);

            const handleDownloadPPT = async () => {
                if(!data) return;
                setIsGeneratingPPT(true);
                try {
                    const res = await secureFetch('/generate_ppt', {
                        method: 'POST',
                        body: JSON.stringify({ project: project, data: data })
                    });
                    
                    if(res && res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        // CHANGED: Download as a real .pptx file!
                        a.download = `${project}_Smart_Deck.pptx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } else {
                        alert("Failed to generate Presentation.");
                    }
                } catch(e) {
                    console.error(e);
                }
                setIsGeneratingPPT(false);
            };
            
            if (!data) return <LoadingScreen msg="AI is reading descriptions, acceptance criteria, and assignee comments..." />;

            return (
                <div className="animate-fade-in space-y-6">
                    <header className="flex justify-between items-end mb-8 border-b pb-4" style={{borderColor: 'var(--border)'}}>
                        <div>
                            <h2 className="text-3xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Executive Insights</h2>
                            <p className="text-sm mt-1" style={{color: 'var(--text-muted)'}}>AI-driven delivery analysis & business value</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] font-bold uppercase tracking-wider" style={{color: 'var(--text-muted)'}}>Target Sprint</span>
                                <select 
                                    value={activeSprint} 
                                    onChange={e=>setActiveSprint(e.target.value)} 
                                    disabled={isGlobalLoading}
                                    className={`p-2 rounded border text-sm input-field font-medium min-w-[200px] ${isGlobalLoading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                                >
                                    <option value="active">üü¢ Active Sprint (Live)</option>
                                    {sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            
                            {/* SMART DECK EXPORT BUTTON */}
                            <button 
                                onClick={handleDownloadPPT} 
                                disabled={isGeneratingPPT || isGlobalLoading}
                                className="flex items-center gap-2 px-5 py-2.5 text-sm font-bold text-white rounded-lg shadow-lg hover:scale-105 transition disabled:opacity-50 disabled:hover:scale-100"
                                style={{background: 'linear-gradient(to right, #6366f1, #a855f7)'}}
                            >
                                {isGeneratingPPT ? <span className="loader" style={{width:'16px', height:'16px'}}></span> : <Icon name="Download" size={18}/>}
                                {isGeneratingPPT ? 'Generating Deck...' : '‚ú® Export Smart Deck'}
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <MetricCard label="Velocity (Pts)" value={data.metrics.points} color="primary" />
                        <MetricCard label="Total Tickets" value={data.metrics.total} color="success" />
                        <MetricCard label="Blockers" value={data.metrics.blockers} color="danger" isDanger={data.metrics.blockers > 0} />
                        <MetricCard label="Bugs Found" value={data.metrics.bugs} color="warning" />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass-card p-6 border-t-4 flex flex-col" style={{borderTopColor: 'var(--primary)'}}>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xs font-bold uppercase tracking-widest flex items-center gap-2" style={{color: 'var(--text-muted)'}}><Icon name="Activity" size={14}/> Executive Summary</h3>
                                {data.ai_insights?.risk_level && <span className={`px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wide border ${data.ai_insights.risk_level === 'High' ? 'bg-red-500/10 border-red-500 text-red-500' : 'bg-emerald-500/10 border-emerald-500 text-emerald-500'}`}>Risk: {data.ai_insights.risk_level}</span>}
                            </div>
                            <p className="text-sm leading-relaxed flex-1" style={{color: 'var(--text-main)'}}>{data.ai_insights?.executive_summary || "Analyzing..."}</p>
                            {data.ai_insights?.key_recommendation && (
                                <div className="mt-4 pt-4 border-t" style={{borderColor: 'var(--border)'}}>
                                    <span className="text-[10px] font-bold uppercase block mb-1" style={{color: 'var(--warning)'}}>AI Recommendation</span>
                                    <span className="text-xs" style={{color: 'var(--text-muted)'}}>{data.ai_insights.key_recommendation}</span>
                                </div>
                            )}
                        </div>

                        <div className="glass-card p-6 border-t-4 flex flex-col" style={{borderTopColor: 'var(--success)'}}>
                            <h3 className="text-xs font-bold uppercase tracking-widest flex items-center gap-2 mb-4" style={{color: 'var(--text-muted)'}}><Icon name="TrendingDown" size={14}/> Business Value Delivered</h3>
                            <p className="text-sm leading-relaxed" style={{color: 'var(--text-main)'}} dangerouslySetInnerHTML={{ __html: marked.parse(data.ai_insights?.business_value || "Parsing user stories...") }}></p>
                        </div>
                    </div>

                    <div>
                        <h3 className="text-lg font-bold mb-4 mt-4" style={{color: 'var(--text-main)'}}>Deep Story Progress Analysis</h3>
                        <div className="grid grid-cols-1 gap-3">
                            {data.ai_insights?.story_progress?.map((story, idx) => (
                                <div key={idx} className="glass-card p-4 flex gap-4 items-center transition hover:bg-opacity-50">
                                    <div className="w-24 text-center">
                                        <div className="text-xs font-bold" style={{color: 'var(--primary)'}}>{story.key}</div>
                                        <div className="text-[9px] uppercase tracking-wider mt-1 px-2 py-0.5 rounded-full border inline-block" style={{borderColor: 'var(--border)', color: 'var(--text-muted)'}}>{story.status}</div>
                                    </div>
                                    <div className="flex-1 border-l pl-4" style={{borderColor: 'var(--border)'}}>
                                        <div className="text-sm font-semibold mb-1" style={{color: 'var(--text-main)'}}>{story.summary} <span className="font-normal opacity-50 ml-2">({story.assignee})</span></div>
                                        <div className="text-xs leading-relaxed" style={{color: 'var(--text-muted)'}}>
                                            <strong style={{color: 'var(--warning)'}}>AI Note: </strong> {story.analysis}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {(!data.ai_insights?.story_progress || data.ai_insights.story_progress.length === 0) && (
                                <div className="p-8 text-center text-sm italic" style={{color: 'var(--text-muted)'}}>No deep analysis available for specific stories yet.</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function LoadingScreen({ msg = "Loading..." }) { 
            return (
                <div className="h-full w-full flex flex-col items-center justify-center animate-pulse">
                    <div className="w-10 h-10 border-4 border-t-transparent rounded-full animate-spin mb-4" style={{borderColor: 'var(--primary)', borderTopColor: 'transparent'}}></div>
                    <div className="text-sm font-medium tracking-wide" style={{color: 'var(--primary)'}}>{msg}</div>
                </div>
            ); 
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>