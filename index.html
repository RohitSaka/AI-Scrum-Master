<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Agile Scrum | Enterprise</title>
    <link rel="icon"
        href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%236366f1"/><text x="50" y="65" font-family="Arial" font-size="50" font-weight="bold" fill="white" text-anchor="middle">IG</text></svg>'>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --transition-speed: 0.3s;
        }

        /* ═══════════════════════════════════════════
           DARK MODE — Deep Navy / Sapphire Corporate
           ═══════════════════════════════════════════ */
        .dark-mode {
            --bg-body: #070B14;
            --bg-sidebar: #0A0F1C;
            --bg-card: #111827;
            --bg-hover: #1F2937;
            --text-main: #F1F5F9;
            --text-muted: #8B9DC3;
            --border: #1E2A3F;
            --primary: #3B82F6;
            --primary-dim: rgba(59, 130, 246, 0.12);
            --danger: #F43F5E;
            --success: #10B981;
            --warning: #F59E0B;
            --glass-border: rgba(255, 255, 255, 0.06);
            --glass-bg: rgba(17, 24, 39, 0.75);
            --accent-gradient: linear-gradient(135deg, #3B82F6, #8B5CF6);
            --accent-gradient-2: linear-gradient(135deg, #06B6D4, #3B82F6);
            --accent-gradient-warm: linear-gradient(135deg, #F59E0B, #F43F5E);
            --surface-elevated: rgba(30, 41, 59, 0.5);
            --surface-glossy: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.04) 100%);
            --glow-primary: rgba(59, 130, 246, 0.25);
            --glow-accent: rgba(139, 92, 246, 0.2);
            /* Slide-specific */
            --slide-bg: #080D19;
            --slide-surface: rgba(17, 24, 39, 0.85);
            --slide-surface-alt: rgba(30, 41, 59, 0.6);
            --slide-accent: #3B82F6;
            --slide-accent-2: #8B5CF6;
            --slide-accent-3: #06B6D4;
            --slide-accent-4: #F59E0B;
            --slide-border: rgba(59, 130, 246, 0.15);
            --slide-text: #F1F5F9;
            --slide-text-dim: #8B9DC3;
            --slide-glow: rgba(59, 130, 246, 0.15);
        }

        /* ═══════════════════════════════════════════
           LIGHT MODE — Pearl / Corporate Blue
           ═══════════════════════════════════════════ */
        .light-mode {
            --bg-body: #F3F6FC;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-hover: #EBF0F9;
            --text-main: #0C1832;
            --text-muted: #5A6B8A;
            --border: #D4DFEF;
            --primary: #2563EB;
            --primary-dim: rgba(37, 99, 235, 0.08);
            --danger: #E11D48;
            --success: #059669;
            --warning: #D97706;
            --glass-border: rgba(37, 99, 235, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --accent-gradient: linear-gradient(135deg, #2563EB, #7C3AED);
            --accent-gradient-2: linear-gradient(135deg, #0891B2, #2563EB);
            --accent-gradient-warm: linear-gradient(135deg, #D97706, #E11D48);
            --surface-elevated: rgba(255, 255, 255, 0.8);
            --surface-glossy: linear-gradient(135deg, rgba(37, 99, 235, 0.04) 0%, rgba(124, 58, 237, 0.02) 100%);
            --glow-primary: rgba(37, 99, 235, 0.1);
            --glow-accent: rgba(124, 58, 237, 0.08);
            /* Slide-specific */
            --slide-bg: #F7F9FE;
            --slide-surface: rgba(255, 255, 255, 0.92);
            --slide-surface-alt: rgba(243, 246, 252, 0.8);
            --slide-accent: #2563EB;
            --slide-accent-2: #7C3AED;
            --slide-accent-3: #0891B2;
            --slide-accent-4: #D97706;
            --slide-border: rgba(37, 99, 235, 0.12);
            --slide-text: #0C1832;
            --slide-text-dim: #5A6B8A;
            --slide-glow: rgba(37, 99, 235, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow: hidden;
            margin: 0;
        }

        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(16px);
            border-radius: 1rem;
        }

        .nav-btn {
            color: var(--text-muted);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-main);
        }

        .nav-btn.active {
            background: var(--primary-dim);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .input-field {
            background-color: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-dim);
        }

        .prose strong {
            color: var(--text-main);
            font-weight: 700;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.2rem;
        }

        .prose li {
            margin-bottom: 0.25rem;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 0.8s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .retro-col {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .retro-col-header {
            padding: 1rem;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
        }

        .retro-col-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .retro-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .retro-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .roadmap-grid {
            display: grid;
            grid-template-columns: 250px repeat(12, 1fr);
            background: transparent;
        }

        .roadmap-header {
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 12px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            text-align: center;
            background: var(--bg-card);
        }

        .roadmap-cell {
            border-right: 1px solid var(--border);
            opacity: 0.2;
        }

        .roadmap-item {
            position: absolute;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, z-index 0s;
        }

        .roadmap-item:hover {
            z-index: 20;
            transform: translateY(-2px) scale(1.01);
        }

        /* ===== SLIDE DECK PREMIUM STYLES ===== */
        .deck-wrapper {
            font-family: 'Outfit', 'DM Sans', -apple-system, sans-serif;
        }

        .slide-root {
            font-family: 'Outfit', 'DM Sans', -apple-system, sans-serif;
        }

        @keyframes orbFloat {

            0%,
            100% {
                transform: translateY(0px) scale(1);
            }

            50% {
                transform: translateY(-18px) scale(1.02);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        .orb-float {
            animation: orbFloat 8s ease-in-out infinite;
        }

        .orb-float-delay {
            animation: orbFloat 11s ease-in-out infinite 2s;
        }

        .shimmer-line {
            background: linear-gradient(90deg, transparent, var(--slide-accent), transparent);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @media print {

            html,
            body,
            #root,
            div {
                height: auto !important;
                overflow: visible !important;
                position: static !important;
            }

            body * {
                visibility: hidden;
            }

            #print-engine-container,
            #print-engine-container * {
                visibility: visible;
            }

            #print-engine-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                display: block !important;
                opacity: 1 !important;
                z-index: 99999 !important;
            }

            .print-slide {
                width: 1280px !important;
                height: 720px !important;
                page-break-after: always !important;
                break-after: page !important;
                background: #0B1121 !important;
                margin: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            @page {
                size: landscape;
                margin: 0;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'bg-body': 'var(--bg-body)', 'bg-sidebar': 'var(--bg-sidebar)', 'bg-card': 'var(--bg-card)', 'bg-hover': 'var(--bg-hover)', 'text-main': 'var(--text-main)', 'text-muted': 'var(--text-muted)', 'border': 'var(--border)', 'primary': 'var(--primary)', 'primary-dim': 'var(--primary-dim)', 'danger': 'var(--danger)', 'success': 'var(--success)', 'warning': 'var(--warning)' } } }
        }
    </script>
</head>

<body class="dark-mode">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;
        const API_BASE = "https://ai-scrum-master-cm2c.onrender.com";

        /* ═══════════════════════════════════════════
           ICON SYSTEM — Clean SVG Icons (No Emojis)
           ═══════════════════════════════════════════ */
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>,
                Activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
                RefreshCcw: <><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></>,
                MessageSquare: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></>,
                Monitor: <><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></>,
                ChevronLeft: <><polyline points="15 18 9 12 15 6"></polyline></>,
                ChevronRight: <><polyline points="9 18 15 12 9 6"></polyline></>,
                Sun: <><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></>,
                Moon: <><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></>,
                Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></>,
                Sparkles: <><path d="M12 3l1.912 5.813a2 2 0 001.275 1.275L21 12l-5.813 1.912a2 2 0 00-1.275 1.275L12 21l-1.912-5.813a2 2 0 00-1.275-1.275L3 12l5.813-1.912a2 2 0 001.275-1.275L12 3z"></path></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
                CloudLightning: <><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></>,
                Maximize: <><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
                Image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>,
                Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>,
                Star: <><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></>,
                AlertTriangle: <><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></>,
                Link: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></>,
                Copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>,
                Zap: <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></>,
                Target: <><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></>,
                AlignLeft: <><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></>,
                Trash: <><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></>,
                Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></>,
                Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></>,
                Shield: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></>,
                Award: <><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></>,
                GitBranch: <><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></>,
                Clock: <><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>,
                ArrowRight: <><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>,
                BarChart: <><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></>,
                Hash: <><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></>,
                Crosshair: <><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></>,
                Box: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>,
                Globe: <><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></>,
                Mail: <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></>,
                UserPlus: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></>,
                Briefcase: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></>,
                Phone: <><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></>,
                Edit3: <><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || null}</svg>;
        };

        const secureFetch = async (endpoint, options = {}) => {
            const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
            const isGuest = endpoint.startsWith('/guest');
            if (!isGuest && !config.license_key && !config.token) return null;
            const headers = { 'Content-Type': 'application/json', 'x-license-key': config.license_key || '', 'x-jira-domain': config.domain || '', 'x-jira-email': config.email || '', 'x-jira-token': config.token || '', ...options.headers };
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                if (res.status === 401 || res.status === 403) { localStorage.removeItem('ig_config'); window.location.reload(); return null; }
                return res;
            } catch (error) { return null; }
        };

        function App() {
            const [theme, setTheme] = useState(localStorage.getItem('ig_theme') || 'dark');
            useEffect(() => { document.body.className = theme === 'dark' ? 'dark-mode' : 'light-mode'; localStorage.setItem('ig_theme', theme); }, [theme]);
            const params = new URLSearchParams(window.location.search);
            const guestToken = params.get('guest_token');
            if (guestToken) return <GuestRetroView token={guestToken} theme={theme} setTheme={setTheme} />;
            const [config, setConfig] = useState(JSON.parse(localStorage.getItem('ig_config')));
            if (!config || (!config.token && !config.license_key)) return <LoginScreen onLogin={setConfig} theme={theme} setTheme={setTheme} />;
            return <DashboardLayout userRole={config.role || 'scrum_master'} theme={theme} setTheme={setTheme} />;
        }

        function GuestRetroView({ token, theme, setTheme }) {
            const [board, setBoard] = useState(null);
            const [info, setInfo] = useState({ project: '', sprint: '' });
            const [input, setInput] = useState("");
            const [col, setCol] = useState("well");
            const [error, setError] = useState(null);

            const fetchBoard = () => {
                fetch(`${API_BASE}/guest/retro/${token}`)
                    .then(r => { if (!r.ok) throw new Error("Invalid Link"); return r.json(); })
                    .then(d => { setBoard(d.board); setInfo({ project: d.project, sprint: d.sprint }); setError(null); })
                    .catch(e => setError("This invite link has expired or is invalid."));
            };

            useEffect(() => { fetchBoard(); const interval = setInterval(fetchBoard, 3000); return () => clearInterval(interval); }, [token]);

            const add = async () => {
                if (!input.trim()) return;
                const r = await fetch(`${API_BASE}/guest/retro/${token}/add`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ column: col, text: input }) });
                const res = await r.json();
                if (res.status === 'success') { setBoard(res.board); setInput(""); }
            };

            if (error) return <div className="h-screen flex items-center justify-center text-danger font-bold text-xl">{error}</div>;
            if (!board) return <LoadingScreen msg="Joining Team Retro..." />;

            return (
                <div className="h-screen flex flex-col relative transition-colors duration-500 bg-bg-body p-8">
                    <div className="absolute top-4 right-4 z-50"><ThemeToggle theme={theme} setTheme={setTheme} /></div>
                    <header className="mb-10 text-center">
                        <div className="w-16 h-16 rounded-xl flex items-center justify-center text-white font-black text-2xl mx-auto mb-4 shadow-xl" style={{ background: 'var(--accent-gradient)' }}>IG</div>
                        <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Team Retrospective</h2>
                        <p className="text-lg font-medium mt-2 text-text-muted">Sprint {info.sprint} &middot; Anonymous Guest Mode</p>
                    </header>
                    <div className="max-w-5xl mx-auto w-full flex-1 flex flex-col">
                        <div className="flex gap-4 mb-10 bg-bg-card p-4 rounded-2xl border border-border shadow-2xl">
                            <div className="flex bg-bg-body rounded-xl p-1.5 border border-border">
                                {['well', 'improve', 'kudos'].map(c => (<button key={c} onClick={() => setCol(c)} className={`px-8 py-4 rounded-lg text-sm font-black uppercase tracking-wider transition-all ${col === c ? 'bg-primary text-white shadow-md' : 'text-text-muted hover:text-text-main'}`}>{c}</button>))}
                            </div>
                            <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && add()} placeholder="Drop an anonymous note here..." className="flex-1 bg-transparent text-text-main px-6 font-medium text-xl outline-none" />
                            <button onClick={add} className="bg-primary px-12 text-white font-extrabold rounded-xl hover:shadow-lg hover:scale-105 transition-all text-lg">Post</button>
                        </div>
                        <div className="grid grid-cols-3 gap-10 flex-1 pb-10">
                            {['well', 'improve', 'kudos'].map(c => (
                                <div key={c} className="retro-col shadow-2xl border-t-4" style={{ borderTopColor: c === 'well' ? 'var(--success)' : c === 'improve' ? 'var(--danger)' : 'var(--primary)' }}>
                                    <div className="retro-col-header bg-bg-card/50 text-sm"><span>{c}</span><Icon name={c === 'well' ? 'CheckCircle' : c === 'improve' ? 'TrendingDown' : 'Star'} size={20} /></div>
                                    <div className="retro-col-body bg-bg-body/50 p-4">
                                        <AnimatePresence>
                                            {board[c]?.map(i => (
                                                <motion.div key={i.id} initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} className="retro-card font-medium text-base p-5 border-l-4" style={{ borderLeftColor: 'var(--primary)' }}>{i.text}</motion.div>
                                            ))}
                                        </AnimatePresence>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function LoginScreen({ onLogin, theme, setTheme }) {
            const [licenseKey, setLicenseKey] = useState('');
            const [role, setRole] = useState('scrum_master');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('success') === 'true') {
                    const savedLicense = localStorage.getItem('pending_license');
                    const savedRole = localStorage.getItem('pending_role');
                    if (savedLicense) {
                        const newConfig = { license_key: savedLicense, role: savedRole };
                        localStorage.setItem('ig_config', JSON.stringify(newConfig));
                        localStorage.removeItem('pending_license'); localStorage.removeItem('pending_role');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        onLogin(newConfig);
                    }
                }
            }, []);

            const handleOAuthLogin = () => {
                if (!licenseKey) return alert("Please enter your Enterprise License Key.");
                setLoading(true); localStorage.setItem('pending_license', licenseKey); localStorage.setItem('pending_role', role);
                window.location.href = `${API_BASE}/auth/login?license_key=${licenseKey}`;
            };

            return (
                <div className="h-screen flex items-center justify-center relative transition-colors duration-500" style={{ backgroundColor: 'var(--bg-body)' }}>
                    <div className="absolute top-4 right-4"><ThemeToggle theme={theme} setTheme={setTheme} /></div>
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="w-[420px] glass-card p-10 z-10 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-48 h-48 rounded-full blur-3xl -mr-10 -mt-10 opacity-50" style={{ background: 'var(--glow-primary)' }}></div>
                        <div className="mb-10 text-center relative z-10">
                            <div className="w-20 h-20 rounded-2xl flex items-center justify-center text-white font-black text-3xl mx-auto mb-6 shadow-xl" style={{ background: 'var(--accent-gradient)' }}>IG</div>
                            <h1 className="text-3xl font-extrabold tracking-tight" style={{ color: 'var(--text-main)' }}>Agile Intelligence</h1>
                            <p className="text-sm font-medium mt-2" style={{ color: 'var(--text-muted)' }}>Enterprise Edition</p>
                        </div>
                        <div className="space-y-6 relative z-10">
                            <div><label className="text-xs font-bold uppercase tracking-wider mb-2 block" style={{ color: 'var(--text-muted)' }}>Role Profile</label><select value={role} onChange={e => setRole(e.target.value)} className="w-full p-3 rounded-lg text-sm input-field font-semibold shadow-sm"><option value="leadership">Executive / CDO</option><option value="scrum_master">Scrum Master / PM</option></select></div>
                            <div><label className="text-xs font-bold uppercase tracking-wider mb-2 flex items-center gap-2" style={{ color: 'var(--text-muted)' }}><Icon name="Key" size={14} /> License Key</label><input value={licenseKey} onChange={e => setLicenseKey(e.target.value)} placeholder="IG-ENT-..." className="w-full p-3 rounded-lg text-sm input-field shadow-sm font-mono tracking-wide" /></div>
                            <button onClick={handleOAuthLogin} disabled={loading} className="w-full text-white font-bold p-4 rounded-lg shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex justify-center items-center gap-3 text-sm disabled:opacity-70 disabled:hover:scale-100" style={{ background: 'var(--accent-gradient)' }}>{loading ? <span className="loader w-5 h-5 border-2"></span> : <><Icon name="Activity" size={20} /> Log in with Atlassian</>}</button>
                        </div>
                    </motion.div>
                </div>
            );
        }

        function DashboardLayout({ userRole, theme, setTheme }) {
            const [view, setView] = useState('timeline');
            const [projects, setProjects] = useState([]);
            const [activeProject, setActiveProject] = useState(null);
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);

            useEffect(() => {
                secureFetch('/projects').then(r => r ? r.json() : []).then(data => {
                    if (data && data.length > 0) { setProjects(data); setActiveProject(data[0].key); }
                    else { setProjects([{ key: 'DEMO', name: 'Demo Project' }]); setActiveProject('DEMO'); }
                });
            }, []);

            return (
                <div className="flex h-screen overflow-hidden bg-bg-body">
                    <aside className="w-72 shrink-0 flex flex-col justify-between border-r transition-colors duration-300 no-print bg-bg-sidebar border-border">
                        <div className="p-6">
                            <div className="mb-10 pl-2 flex items-center gap-4">
                                <div className="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-lg" style={{ background: 'var(--accent-gradient)' }}>IG</div>
                                <div><h1 className="text-xl font-extrabold tracking-tight leading-none text-text-main">Agile Scrum</h1></div>
                            </div>
                            <nav className="space-y-2">
                                <NavBtn id="feature_roadmap" icon="FileText" label="Feature Roadmap" active={view} set={setView} disabled={isGlobalLoading}/>
                                <NavBtn id="smartdeck" icon="Layers" label="AI Sprint Deck" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="dashboard" icon="Activity" label="Command Center" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="timeline" icon="Zap" label="Sprint Dynamics & Build" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="roadmap" icon="Map" label="Strategic Roadmap" active={view} set={setView} disabled={isGlobalLoading} />
                                <NavBtn id="planning_poker" icon="Users" label="Planning Poker" active={view} set={setView} disabled={isGlobalLoading} />
                                {(userRole === 'scrum_master' || userRole === 'leadership') && <><NavBtn id="meeting_agent" icon="MessageSquare" label="Meeting Agent" active={view} set={setView} disabled={isGlobalLoading} /><NavBtn id="reports" icon="FileText" label="Artifacts" active={view} set={setView} disabled={isGlobalLoading} /><NavBtn id="roles" icon="Users" label="Roles & Team" active={view} set={setView} disabled={isGlobalLoading} /><NavBtn id="retro" icon="RefreshCcw" label="Retrospective" active={view} set={setView} disabled={isGlobalLoading} /></>}
                            </nav>
                        </div>
                        <div className="p-6 border-t border-border space-y-6">
                            <ThemeToggle theme={theme} setTheme={setTheme} fullWidth />
                            <div><label className="text-xs font-bold uppercase mb-3 block text-text-muted tracking-wider">Active Project</label><select value={activeProject || ''} onChange={e => setActiveProject(e.target.value)} disabled={isGlobalLoading} className={`w-full p-3 rounded-lg border text-sm input-field transition-all font-semibold ${isGlobalLoading ? 'opacity-30 cursor-not-allowed' : 'cursor-pointer'}`}>{projects.map(p => <option key={p.key} value={p.key}>{p.name} ({p.key})</option>)}</select></div>
                            <button onClick={() => { localStorage.removeItem('ig_config'); window.location.reload() }} className="w-full text-left text-xs p-2 hover:bg-danger/10 rounded-lg font-bold text-danger transition-colors flex items-center gap-2"><Icon name="X" size={14} /> Sign Out</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative transition-colors duration-300 bg-bg-body" style={{ padding: view === 'smartdeck' ? '0' : '2.5rem' }}>
                        {activeProject ? (
                            <div className="flex-1 min-h-0 relative h-full">
                                {view === 'feature_roadmap' && <FeatureRoadmapView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'smartdeck' && <SmartDeckView project={activeProject} endpoint={`/super_deck/${activeProject}?sprint_id=active`} isFullScreenLayout={true} />}
                                {view === 'dashboard' && <DashboardView project={activeProject} role={userRole} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'roadmap' && <RoadmapView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'timeline' && <TimelineView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'standup' && <StandupView project={activeProject} />}
                                {view === 'retro' && <RetroView project={activeProject} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'roles' && <RolesView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'reports' && <ReportsView project={activeProject} setIsLoading={setIsGlobalLoading} isGlobalLoading={isGlobalLoading} />}
                                {view === 'meeting_agent' && <MeetingAgentView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                                {view === 'planning_poker' && <PlanningPokerView project={activeProject} setIsLoading={setIsGlobalLoading} />}
                            </div>
                        ) : <LoadingScreen msg="Authenticating with Atlassian..." />}
                    </main>
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set, disabled }) => (<button onClick={() => set(id)} disabled={disabled} className={`nav-btn w-full ${active === id ? 'active' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}><Icon name={icon} size={20} /> {label}</button>);
        function ThemeToggle({ theme, setTheme, fullWidth }) { return (<button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`p-3 rounded-lg border text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-3 transition hover:bg-bg-hover border-border text-text-muted bg-bg-card ${fullWidth ? 'w-full' : ''}`}><Icon name={theme === 'dark' ? 'Sun' : 'Moon'} size={16} /> {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}</button>); }
        function MetricCard({ label, value, color, isDanger }) { return (<div className="glass-card p-6 border-l-4 transition-all hover:scale-[1.02]" style={{ borderLeftColor: isDanger ? 'var(--danger)' : `var(--${color})` }}><div className="text-xs font-bold uppercase tracking-widest mb-2 text-text-muted">{label}</div><div className="text-4xl font-extrabold text-text-main">{value}</div></div>); }

    function FeatureRoadmapView({ project, setIsLoading }) {
    const [techStack, setTechStack] = useState('');
    const [customStack, setCustomStack] = useState('');
    const [featuresText, setFeaturesText] = useState('');
    const [inputMode, setInputMode] = useState('manual');
    const [features, setFeatures] = useState([{ name: '', description: '' }]);
    const [extracting, setExtracting] = useState(false);
    const [extractionSummary, setExtractionSummary] = useState('');
    const [uploadedFileName, setUploadedFileName] = useState('');
    const [durationValue, setDurationValue] = useState(6);
    const [durationUnit, setDurationUnit] = useState('months');
    const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
    const [data, setData] = useState(null);
    const [error, setError] = useState(null);
    const [loading, setLoading] = useState(false);
    const [progress, setProgress] = useState(0); // <-- NEW: Progress state
    const [activeSection, setActiveSection] = useState('analysis');
    const [pushingJira, setPushingJira] = useState(false);
    const [jiraResult, setJiraResult] = useState(null);
    const [downloadingXLSX, setDownloadingXLSX] = useState(false);
    const [ganttScrollLeft, setGanttScrollLeft] = useState(0);

    // <-- Dynamic Progress Bar — scales with feature count
    const featureCount = features.filter(f => f.name?.trim()).length || featuresText.split('\n').filter(l => l.trim()).length || 1;
    const estimatedSeconds = Math.max(60, Math.min(900, featureCount <= 20 ? 120 : featureCount <= 50 ? 300 : featureCount <= 100 ? 420 : 600 + (featureCount - 100) * 3));
    const estimatedMinutes = Math.ceil(estimatedSeconds / 60);
    React.useEffect(() => {
        let interval;
        if (loading) {
            interval = setInterval(() => {
                setProgress(p => (p >= 95 ? 95 : p + (95 / estimatedSeconds)));
            }, 1000);
        } else {
            setProgress(0);
        }
        return () => clearInterval(interval);
    }, [loading, estimatedSeconds]);

    const TECH_STACKS = [
        'React + Node.js + PostgreSQL',
        'React + Python (FastAPI) + PostgreSQL',
        'Next.js + Node.js + MongoDB',
        'Angular + Java Spring Boot + MySQL',
        'Vue.js + Django + PostgreSQL',
        'React Native + Node.js + Firebase',
        'Flutter + Dart + Firebase',
        'MERN Stack (MongoDB, Express, React, Node)',
        '.NET Core + Angular + SQL Server',
        'Salesforce + Apex + Lightning',
        'SAP + ABAP + HANA',
        'Power Platform + Dataverse + Azure',
        'Custom (specify below)'
    ];

    const DURATION_PRESETS = {
        days:   [30, 45, 60, 90, 120, 150, 180],
        months: [2, 3, 4, 6, 8, 10, 12, 14, 18, 24],
        years:  [1, 1.5, 2, 2.5, 3, 4]
    };

    const SIZE_CONFIG = {
        'XXS': { color: '#06B6D4', bg: 'rgba(6,182,212,0.12)', pts: 1 },
        'SMALL': { color: '#10B981', bg: 'rgba(16,185,129,0.12)', pts: 2 },
        'MEDIUM': { color: '#3B82F6', bg: 'rgba(59,130,246,0.12)', pts: 3 },
        'LARGE': { color: '#F59E0B', bg: 'rgba(245,158,11,0.12)', pts: 5 },
        'XL': { color: '#F97316', bg: 'rgba(249,115,22,0.12)', pts: 8 },
        'XXL': { color: '#F43F5E', bg: 'rgba(244,63,94,0.12)', pts: 13 },
        'XXXL': { color: '#DC2626', bg: 'rgba(220,38,38,0.12)', pts: 21 },
    };

    const TYPE_COLORS = {
        'Application (UI)': '#3B82F6',
        'Systems Integration': '#8B5CF6',
        'Reporting': '#10B981',
        'Process Automation': '#F59E0B',
        'Data & Backend': '#06B6D4',
    };

    const SECTIONS = [
        { id: 'analysis', label: 'Feature Analysis', icon: 'ClipboardList' },
        { id: 'team', label: 'Team & Streams', icon: 'Users' },
        { id: 'timeline', label: 'Timeline', icon: 'Clock' },
        { id: 'gantt', label: 'Day-Level Gantt', icon: 'BarChart3' },
        { id: 'sprints', label: 'Sprint Map', icon: 'Calendar' },
        { id: 'jira', label: 'Jira Breakdown', icon: 'Layers' },
    ];

    const selectedStack = techStack === 'Custom (specify below)' ? customStack : techStack;

    // ── Generate ──
    const handleGenerate = async () => {
        let featuresList;
        if (features.some(f => f.name?.trim())) {
            featuresList = features.filter(f => f.name?.trim()).map(f => f.description?.trim() ? { name: f.name.trim(), description: f.description.trim() } : f.name.trim());
        } else {
            featuresList = featuresText.split('\n').map(f => f.replace(/^[-•*\d.)\s]+/, '').trim()).filter(f => f.length > 0);
        }
        if (!selectedStack || featuresList.length === 0 || !durationValue) return;

        setLoading(true); setError(null); setData(null); setJiraResult(null); setIsLoading(true);
        try {
            const res = await secureFetch('/feature_roadmap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tech_stack: selectedStack,
                    features: featuresList,
                    target_duration_value: Number(durationValue),
                    target_duration_unit: durationUnit,
                    project_key: project,
                    start_date: startDate
                })
            });
            const result = await res.json();
            if (result.error) { setError(result.error); }
            else { setData(result); setActiveSection('analysis'); }
        } catch (e) { setError('Failed to generate roadmap. Please try again.'); }
        setLoading(false); setIsLoading(false);
    };

    // ── Push to Jira ──
    const handlePushToJira = async () => {
        if (!data?.epics || !project) return;
        setPushingJira(true); setJiraResult(null);
        try {
            const res = await secureFetch(`/feature_roadmap/push_jira/${project}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ epics: data.epics })
            });
            setJiraResult(await res.json());
        } catch (e) { setJiraResult({ success: false, errors: [{ error: 'Network error' }] }); }
        setPushingJira(false);
    };

    // ── Download XLSX ──
    const handleDownloadXLSX = async () => {
        if (!data) return;
        setDownloadingXLSX(true);
        try {
            const res = await secureFetch('/feature_roadmap/download_xlsx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data })
            });
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Feature_Roadmap_${selectedStack.replace(/\s/g, '_').substring(0, 20)}.xlsx`;
            a.click(); window.URL.revokeObjectURL(url);
        } catch (e) { console.error('XLSX download failed', e); }
        setDownloadingXLSX(false);
    };

    // ── CSV Upload ──
    const addFeature = () => setFeatures(p => [...p, { name: '', description: '' }]);
    const removeFeature = idx => setFeatures(p => p.filter((_, i) => i !== idx));
    const updateFeature = (idx, field, val) => setFeatures(p => p.map((f, i) => i === idx ? { ...f, [field]: val } : f));
    const handleSmartUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        setExtracting(true); setError(null); setExtractionSummary(''); setUploadedFileName(file.name);
        const ext = file.name.split('.').pop().toLowerCase();
        console.log('[SmartUpload] File:', file.name, 'Type:', ext, 'Size:', file.size);
        const reader = new FileReader();
        reader.onerror = () => {
            console.error('[SmartUpload] FileReader error:', reader.error);
            setError('Failed to read file. Please try again.');
            setExtracting(false);
            e.target.value = '';
        };
        reader.onload = async (evt) => {
            try {
                const raw = evt.target.result;
                const content = ['csv', 'txt'].includes(ext) ? btoa(unescape(encodeURIComponent(raw))) : (raw.indexOf(',') !== -1 ? raw.substring(raw.indexOf(',') + 1) : raw);
                console.log('[SmartUpload] Base64 length:', content.length);
                if (!content || content.length < 50) { setError('File appears empty.'); setExtracting(false); e.target.value = ''; return; }
                const res = await secureFetch('/feature_roadmap/extract_features', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content, file_type: ext, filename: file.name }) });
                if (!res) { setError('Request failed — check connection.'); setExtracting(false); e.target.value = ''; return; }
                const data = await res.json();
                console.log('[SmartUpload] Response:', res.status, JSON.stringify(data).substring(0, 300));
                if (data?.features?.length > 0) { setFeatures(data.features.map(f => ({ name: f.name || '', description: f.description || '' }))); setExtractionSummary(data.extraction_summary || `Extracted ${data.features.length} features`); setInputMode('manual'); }
                else { setError(data?.error || 'No features extracted. Try a different file or Manual Entry.'); }
            } catch (err) { console.error('[SmartUpload]', err); setError(`Extraction failed: ${err.message || 'Unknown error'}`); }
            setExtracting(false);
            e.target.value = '';
        };
        ['csv', 'txt'].includes(ext) ? reader.readAsText(file) : reader.readAsDataURL(file);
    };

    // ═══════════════════════════════════════════════
    // INPUT FORM
    // ═══════════════════════════════════════════════
    if (!data) {
        return (
            <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4 relative">
                <header className="pb-6 border-b border-border mb-8">
                    <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Feature Roadmap</h2>
                    <p className="text-base font-medium mt-2 text-text-muted">
                        AI-Powered Pre-SOW Project Estimator &middot; Expert PM-Grade Analysis &middot; Project <span className="text-primary font-black">{project}</span>
                    </p>
                </header>

                {error && (
                    <div className="glass-card p-5 mb-6 border-l-4 border-danger">
                        <div className="flex items-center gap-3">
                            <Icon name="AlertTriangle" size={20} className="text-danger" />
                            <p className="text-sm font-bold text-danger">{error}</p>
                        </div>
                    </div>
                )}
                {loading && (
                    <div className="flex flex-col items-center justify-center py-20 animate-fade-in">
                        <Icon name="Loader2" size={48} className="animate-spin text-primary mb-6" />
                        <h3 className="text-2xl font-extrabold text-text-main mb-2">Architecting Your Roadmap</h3>
                        <p className="text-text-muted text-center max-w-md mb-8 leading-relaxed">
                            Our AI is analyzing {features.filter(f => f.name?.trim()).length || featuresText.split('\n').filter(l => l.trim()).length} features, calculating capacity, and mapping sprint phases.
                            <br/><br/>
                            <span className="font-bold text-warning">Enterprise AI analysis — estimated ~{estimatedMinutes} {estimatedMinutes === 1 ? 'minute' : 'minutes'} for {featureCount} features. Please do not close this tab.</span>
                        </p>
                        
                        {/* Live Progress Bar */}
                        <div className="w-full max-w-md bg-bg-card rounded-full h-4 border border-border overflow-hidden shadow-inner">
                            <div 
                                className="h-full transition-all duration-1000 ease-linear" 
                                style={{ width: `${Math.round(progress)}%`, background: 'var(--accent-gradient)' }}
                            ></div>
                        </div>
                        <div className="w-full max-w-md flex justify-between mt-3 px-1">
                            <span className="text-xs font-bold text-text-muted animate-pulse">Processing features in batches...</span>
                            <span className="text-sm font-black text-primary">{Math.round(progress)}% Complete</span>
                        </div>
                    </div>
                )}

                <div className={`max-w-5xl space-y-6 ${loading ? 'hidden' : 'block'}`}>
                    {/* Step 1: Tech Stack */}
                    <div className="glass-card p-7">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="w-9 h-9 rounded-xl flex items-center justify-center text-white font-black text-sm" style={{ background: 'var(--accent-gradient)' }}>1</div>
                            <div>
                                <h3 className="text-base font-extrabold text-text-main">Technology Stack</h3>
                                <p className="text-xs text-text-muted font-medium">Choose the stack for accurate scope & role estimation</p>
                            </div>
                        </div>
                        <select value={techStack} onChange={e => setTechStack(e.target.value)}
                            className="w-full p-3.5 rounded-xl border bg-bg-body text-text-main font-bold shadow-sm outline-none cursor-pointer hover:border-primary transition-colors border-border text-sm">
                            <option value="">— Select Tech Stack —</option>
                            {TECH_STACKS.map(ts => <option key={ts} value={ts}>{ts}</option>)}
                        </select>
                        {techStack === 'Custom (specify below)' && (
                            <input type="text" value={customStack} onChange={e => setCustomStack(e.target.value)}
                                placeholder="e.g., Svelte + Go + CockroachDB"
                                className="w-full mt-3 p-3.5 rounded-xl border bg-bg-body text-text-main font-bold shadow-sm outline-none hover:border-primary transition-colors border-border text-sm" />
                        )}
                    </div>

                    {/* Step 2: Target Duration */}
                    <div className="glass-card p-7">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="w-9 h-9 rounded-xl flex items-center justify-center text-white font-black text-sm" style={{ background: 'var(--accent-gradient)' }}>2</div>
                            <div>
                                <h3 className="text-base font-extrabold text-text-main">Target Duration & Start Date</h3>
                                <p className="text-xs text-text-muted font-medium">Client's desired timeline — shorter = more resources, longer = fewer resources</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-4">
                            {/* Duration Unit */}
                            <div>
                                <label className="text-xs font-bold text-text-muted uppercase tracking-wider mb-2 block">Unit</label>
                                <div className="flex bg-bg-body p-1 rounded-xl border border-border gap-1">
                                    {['days', 'months', 'years'].map(u => (
                                        <button key={u} onClick={() => { setDurationUnit(u); setDurationValue(DURATION_PRESETS[u][Math.min(2, DURATION_PRESETS[u].length - 1)]); }}
                                            className={`flex-1 px-3 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${durationUnit === u ? 'bg-primary text-white shadow-md' : 'text-text-muted hover:text-text-main'}`}>
                                            {u}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Duration Value */}
                            <div>
                                <label className="text-xs font-bold text-text-muted uppercase tracking-wider mb-2 block">Duration</label>
                                <select value={durationValue} onChange={e => setDurationValue(e.target.value)}
                                    className="w-full p-3 rounded-xl border bg-bg-body text-text-main font-bold shadow-sm outline-none cursor-pointer hover:border-primary transition-colors border-border text-sm">
                                    {DURATION_PRESETS[durationUnit].map(v => (
                                        <option key={v} value={v}>{v} {durationUnit}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Start Date */}
                            <div>
                                <label className="text-xs font-bold text-text-muted uppercase tracking-wider mb-2 block">Start Date</label>
                                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)}
                                    className="w-full p-3 rounded-xl border bg-bg-body text-text-main font-bold shadow-sm outline-none hover:border-primary transition-colors border-border text-sm" />
                            </div>
                        </div>

                        {/* Duration visual indicator */}
                        <div className="flex items-center gap-4 p-3 bg-bg-body rounded-xl border border-border mt-2">
                            <Icon name="Clock" size={16} className="text-primary" />
                            <span className="text-sm font-bold text-text-main">
                                {durationValue} {durationUnit} = ~{
                                    durationUnit === 'days' ? Math.round(durationValue / 22) :
                                    durationUnit === 'months' ? durationValue :
                                    Math.round(durationValue * 12)
                                } months = ~{
                                    durationUnit === 'days' ? Math.ceil(durationValue / 10) :
                                    durationUnit === 'months' ? Math.ceil(durationValue * 22 / 10) :
                                    Math.ceil(durationValue * 260 / 10)
                                } sprints
                            </span>
                            <span className="text-xs text-text-muted ml-auto font-medium">
                                {durationUnit === 'months' && durationValue <= 4 ? '⚡ Aggressive — Will need larger team' :
                                 durationUnit === 'months' && durationValue <= 8 ? '⚖️ Balanced — Standard team size' :
                                 durationUnit === 'years' && durationValue >= 2 ? '🐢 Relaxed — Minimal team possible' :
                                 '📊 AI will optimize team size'}
                            </span>
                        </div>
                    </div>

                    {/* Step 3: Features — Smart Input */}
                    <div className="glass-card p-7">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="w-9 h-9 rounded-xl flex items-center justify-center text-white font-black text-sm" style={{ background: 'var(--accent-gradient)' }}>3</div>
                            <div className="flex-1">
                                <h3 className="text-base font-extrabold text-text-main">Features & Requirements</h3>
                                <p className="text-xs text-text-muted font-medium">Define features manually or upload any document (PDF, PPTX, DOCX, XLSX, CSV)</p>
                            </div>
                        </div>
                        <div className="flex gap-2 mb-4">
                            <button onClick={() => setInputMode('manual')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all border ${inputMode === 'manual' ? 'bg-primary text-white border-primary' : 'bg-bg-body text-text-muted border-border hover:border-primary'}`}>✏️ Manual Entry</button>
                            <button onClick={() => setInputMode('upload')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all border ${inputMode === 'upload' ? 'bg-primary text-white border-primary' : 'bg-bg-body text-text-muted border-border hover:border-primary'}`}>📄 Smart Upload</button>
                        </div>
                        {inputMode === 'upload' && (
                            <div className="space-y-3">
                                <div className="border-2 border-dashed rounded-xl p-8 text-center transition-all hover:border-primary" style={{borderColor:'var(--border)'}}>
                                    {extracting ? (<div className="flex flex-col items-center gap-3"><Icon name="Loader2" size={32} className="animate-spin text-primary" /><p className="text-sm font-bold text-text-main">AI is scanning {uploadedFileName}...</p><p className="text-xs text-text-muted">Extracting features — filtering sizing labels, metadata, headers automatically</p></div>) : (<><Icon name="Upload" size={32} className="text-text-muted mx-auto mb-3" /><p className="text-sm font-bold text-text-main mb-1">Upload any document</p><p className="text-xs text-text-muted mb-1">PDF · PPTX · DOCX · XLSX · CSV · TXT</p><p className="text-xs text-text-muted mb-4" style={{opacity:0.7}}>AI extracts features from SOWs, RFPs, estimation sheets, meeting notes — filters out sizing labels, metadata noise</p><label className="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold text-sm cursor-pointer transition-all text-white" style={{ background: 'var(--accent-gradient)' }}><Icon name="FileUp" size={16} /> Choose File<input type="file" accept=".pdf,.pptx,.ppt,.xlsx,.xls,.csv,.txt,.docx,.doc" onChange={handleSmartUpload} className="hidden" /></label></>)}
                                </div>
                                {extractionSummary && (<div className="p-3 rounded-lg text-sm font-semibold flex items-center gap-2" style={{background:'rgba(34,197,94,0.1)',border:'1px solid rgba(34,197,94,0.3)',color:'#22c55e'}}><span>✅</span> {extractionSummary} — Review below, then Generate</div>)}
                            </div>
                        )}
                        {inputMode === 'manual' && (
                            <div className="space-y-2">
                                {features.map((f, idx) => (
                                    <div key={idx} className="flex gap-2 items-start p-3 rounded-lg border transition-all hover:border-primary" style={{background:'var(--bg-body)',borderColor: (!f.description?.trim() && f.name?.trim()) ? 'rgba(245,158,11,0.5)' : 'var(--border)'}}>
                                        <span className="text-xs font-black text-text-muted mt-2.5 w-6 shrink-0">{idx + 1}.</span>
                                        <div className="flex-1 space-y-1.5">
                                            <input type="text" value={f.name} onChange={e => updateFeature(idx, 'name', e.target.value)} placeholder="Feature name (e.g., User Authentication)" className="w-full p-2.5 rounded-lg border bg-bg-card text-text-main text-sm font-bold outline-none hover:border-primary transition-colors border-border" />
                                            <textarea value={f.description} onChange={e => updateFeature(idx, 'description', e.target.value)} placeholder="Describe what needs to be built..." rows={2} className="w-full p-2.5 rounded-lg border bg-bg-card text-text-muted text-xs font-medium outline-none hover:border-primary transition-colors border-border resize-none leading-relaxed" />
                                            {!f.description?.trim() && f.name?.trim() && <p className="text-xs font-semibold" style={{color:'#f59e0b'}}>⚠ Add description for better estimation</p>}
                                        </div>
                                        <button onClick={() => removeFeature(idx)} className="mt-2 p-1.5 rounded-lg hover:bg-danger/10 transition-all text-text-muted hover:text-danger"><Icon name="X" size={14} /></button>
                                    </div>
                                ))}
                                <button onClick={addFeature} className="w-full p-3 rounded-lg border-2 border-dashed text-sm font-bold transition-all hover:border-primary hover:text-primary text-text-muted" style={{borderColor:'var(--border)'}}>+ Add Feature</button>
                                {features.length > 0 && <div className="flex items-center justify-between mt-1"><span className="text-xs text-text-muted font-bold">{features.filter(f => f.name.trim()).length} features</span>{features.some(f => f.name?.trim() && !f.description?.trim()) && <span className="text-xs font-bold" style={{color:'#f59e0b'}}>⚠ {features.filter(f => f.name?.trim() && !f.description?.trim()).length} missing descriptions</span>}</div>}
                            </div>
                        )}
                    </div>

                    {/* Generate Button */}
                    <motion.button onClick={handleGenerate} disabled={loading || !selectedStack || (features.filter(f => f.name?.trim()).length === 0 && !featuresText.trim())}
                        whileHover={{ scale: 1.01 }} whileTap={{ scale: 0.98 }}
                        className="w-full p-5 rounded-2xl text-white font-black text-lg flex items-center justify-center gap-3 shadow-xl transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                        style={{ background: 'var(--accent-gradient)' }}>
                        <Icon name="Sparkles" size={22} /> Generate Expert-Grade Feature Roadmap ({features.filter(f => f.name?.trim()).length || featuresText.split('\n').filter(l => l.trim()).length} features)
                    </motion.button>
                </div>
            </div>
        );
    }

    // ═══════════════════════════════════════════════
    // RESULTS VIEW — All 12 Dimensions
    // ═══════════════════════════════════════════════
    const analysis = data.feature_analysis || [];
    const team = data.team_composition || [];
    const timeline = data.timeline || {};
    const gantt = data.gantt_phases || [];
    const epics = data.epics || [];
    const sprintMap = data.sprint_mapping || [];
    const resourceLoad = data.resource_loading || [];
    const uatMilestones = data.uat_milestones || [];
    const pilotHypercare = data.pilot_hypercare || {};
    const psa = data.parallel_stream_analysis || {};
    const ftSummary = data.feature_type_summary || {};
    const meta = data._meta || {};
    const totalPts = data.total_story_points || 0;
    const totalStories = epics.reduce((sum, e) => sum + (e.stories || []).length, 0);
    const maxDay = Math.max(1, ...analysis.map(f => f.end_day || 0), (pilotHypercare.hypercare || {}).end_day || 0);

    return (
        <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4">
            {/* Header */}
            <header className="flex justify-between items-end pb-6 border-b border-border mb-6">
                <div>
                    <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Feature Roadmap</h2>
                    <p className="text-base font-medium mt-2 text-text-muted">
                        <span className="text-primary font-black">{selectedStack}</span>
                        &middot; {analysis.length} features &middot; <span className="font-black text-primary">{totalPts} pts</span>
                        &middot; Target: <span className="font-black">{meta.target_duration_value} {meta.target_duration_unit}</span>
                    </p>
                </div>
                <div className="flex items-center gap-3">
                    <button onClick={handleDownloadXLSX} disabled={downloadingXLSX}
                        className="flex items-center gap-2 px-4 py-2.5 rounded-xl text-white font-bold text-xs shadow-lg transition-all hover:opacity-90"
                        style={{ background: 'linear-gradient(135deg, #10B981, #059669)' }}>
                        <Icon name="Download" size={14} />
                        {downloadingXLSX ? 'Generating...' : 'Download XLSX'}
                    </button>
                    <button onClick={() => { setData(null); setJiraResult(null); setProgress(0); }}
                        className="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-bg-card text-text-muted font-bold text-xs border border-border hover:border-primary transition-all">
                        <Icon name="RotateCcw" size={14} /> New Analysis
                    </button>
                </div>
            </header>

            {/* Summary Cards — 6 columns */}
            <div className="grid grid-cols-6 gap-3 mb-6">
                {[
                    { label: 'Total Points', value: totalPts, sub: 'story points', color: '#3B82F6' },
                    { label: 'Duration', value: timeline.total_months || psa.actual_parallel_months || '—', sub: 'months', color: '#10B981' },
                    { label: 'Sprints', value: timeline.total_sprints || '—', sub: '2-week', color: '#F59E0B' },
                    { label: 'Team Size', value: data.total_team_size || team.reduce((s, t) => s + (t.headcount || 1), 0), sub: 'members', color: '#8B5CF6' },
                    { label: 'Streams', value: psa.recommended_streams || 1, sub: 'parallel', color: '#06B6D4' },
                    { label: 'Epics', value: epics.length, sub: `${totalStories} stories`, color: '#F43F5E' },
                ].map((card, i) => (
                    <div key={i} className="glass-card p-4 border-l-4" style={{ borderLeftColor: card.color }}>
                        <div className="text-[10px] font-bold uppercase tracking-widest mb-1 text-text-muted">{card.label}</div>
                        <div className="text-2xl font-extrabold text-text-main">{card.value}</div>
                        <div className="text-[10px] text-text-muted mt-0.5">{card.sub}</div>
                    </div>
                ))}
            </div>

            {/* Parallel Stream Analysis Banner */}
            {psa.notes && (
                <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }}
                    className="rounded-2xl p-5 mb-6 shadow-lg"
                    style={{
                        background: psa.fits_target ? 'rgba(16,185,129,0.08)' : 'rgba(244,63,94,0.08)',
                        border: `2px solid ${psa.fits_target ? 'var(--success)' : 'var(--danger)'}`
                    }}>
                    <div className="flex items-center gap-4">
                        <Icon name={psa.fits_target ? "CheckCircle" : "AlertTriangle"} size={24}
                            style={{ color: psa.fits_target ? 'var(--success)' : 'var(--danger)' }} />
                        <div className="flex-1">
                            <div className="flex items-center gap-3 mb-1">
                                <span className="text-sm font-black text-text-main">Parallel Stream Analysis</span>
                                <span className="text-xs font-black px-2 py-0.5 rounded-full" style={{
                                    background: psa.fits_target ? 'rgba(16,185,129,0.15)' : 'rgba(244,63,94,0.15)',
                                    color: psa.fits_target ? 'var(--success)' : 'var(--danger)'
                                }}>{psa.fits_target ? '✅ FITS TARGET' : '⚠️ EXCEEDS TARGET'}</span>
                            </div>
                            <p className="text-xs font-medium text-text-muted">{psa.notes}</p>
                        </div>
                        <div className="flex gap-6 shrink-0">
                            <div className="text-center">
                                <div className="text-xs text-text-muted font-bold">Sequential</div>
                                <div className="text-lg font-black text-text-main">{psa.single_stream_months || '—'}m</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-text-muted font-bold">{psa.recommended_streams || 1} Streams</div>
                                <div className="text-lg font-black text-primary">{psa.actual_parallel_months || '—'}m</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-text-muted font-bold">Target</div>
                                <div className="text-lg font-black" style={{ color: psa.fits_target ? 'var(--success)' : 'var(--danger)' }}>{psa.target_months || '—'}m</div>
                            </div>
                        </div>
                    </div>
                </motion.div>
            )}

            {/* Section Tabs */}
            <div className="flex bg-bg-card p-1 rounded-2xl border border-border mb-6 gap-1">
                {SECTIONS.map(sec => (
                    <button key={sec.id} onClick={() => setActiveSection(sec.id)}
                        className={`flex-1 flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all ${activeSection === sec.id ? 'bg-primary text-white shadow-lg' : 'text-text-muted hover:text-text-main hover:bg-bg-body'}`}>
                        <Icon name={sec.icon} size={13} /> {sec.label}
                    </button>
                ))}
            </div>

            {/* ══════════ SECTION 1: Feature Analysis ══════════ */}
            {activeSection === 'analysis' && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                    {/* Feature Type Summary */}
                    {Object.keys(ftSummary).length > 0 && (
                        <div className="flex gap-3 mb-2">
                            {Object.entries(ftSummary).filter(([, v]) => v.count > 0).map(([type, v]) => (
                                <div key={type} className="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-bg-body">
                                    <span className="w-2.5 h-2.5 rounded-full" style={{ background: TYPE_COLORS[type] || '#999' }}></span>
                                    <span className="text-xs font-bold text-text-main">{type}</span>
                                    <span className="text-[10px] font-black text-primary">{v.count}</span>
                                    <span className="text-[10px] text-text-muted">{v.total_points}pts</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Feature Table */}
                    <div className="glass-card overflow-hidden shadow-xl">
                        <div className="grid gap-0" style={{ gridTemplateColumns: '50px 1.5fr 110px 1.5fr 100px 80px 1fr 1fr 120px' }}>
                            {['#', 'Feature', 'Type', 'Technical Scope', 'Size', 'Pts', 'Est. Team', 'Est. Conservative', 'Schedule'].map(h => (
                                <div key={h} className="p-3 text-[10px] font-black uppercase tracking-widest text-text-muted border-b border-border bg-bg-card">{h}</div>
                            ))}
                        </div>
                        {analysis.map((f, i) => {
                            const sizeConf = SIZE_CONFIG[f.size] || SIZE_CONFIG['MEDIUM'];
                            const typeColor = TYPE_COLORS[f.feature_type] || '#999';
                            return (
                                <motion.div key={i} initial={{ opacity: 0, x: -5 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: i * 0.02 }}
                                    className="grid gap-0 border-b border-border/50 hover:bg-primary/5 transition-colors"
                                    style={{ gridTemplateColumns: '50px 1.5fr 110px 1.5fr 100px 80px 1fr 1fr 120px' }}>
                                    <div className="p-3 text-xs font-bold text-text-muted">{f.id || i + 1}</div>
                                    <div className="p-3 text-xs font-bold text-text-main leading-snug">{f.feature}</div>
                                    <div className="p-3">
                                        <span className="text-[9px] font-bold px-2 py-1 rounded-full" style={{ background: `${typeColor}18`, color: typeColor }}>{f.feature_type}</span>
                                    </div>
                                    <div className="p-3 text-[10px] text-text-muted font-medium leading-relaxed">{f.technical_scope}</div>
                                    <div className="p-3 flex items-center justify-center">
                                        <span className="text-[9px] font-black px-2.5 py-1 rounded-full" style={{ background: sizeConf.bg, color: sizeConf.color, border: `1px solid ${sizeConf.color}33` }}>{f.size}</span>
                                    </div>
                                    <div className="p-3 text-center"><span className="text-base font-black text-primary">{f.story_points}</span></div>
                                    <div className="p-3 text-[10px] font-bold text-text-main">{f.est_team}</div>
                                    <div className="p-3 text-[10px] font-medium text-text-muted">{f.est_conservative}</div>
                                    <div className="p-3 text-[10px] font-bold text-primary">D{f.start_day}→D{f.end_day} <span className="text-text-muted">({f.sprint_allocation})</span></div>
                                </motion.div>
                            );
                        })}
                        {/* Total Row */}
                        <div className="grid gap-0" style={{ gridTemplateColumns: '50px 1.5fr 110px 1.5fr 100px 80px 1fr 1fr 120px', background: 'rgba(59,130,246,0.06)' }}>
                            <div className="p-3"></div>
                            <div className="p-3 text-xs font-black text-primary">TOTAL — {analysis.length} features</div>
                            <div className="p-3"></div><div className="p-3"></div><div className="p-3"></div>
                            <div className="p-3 text-center"><span className="text-xl font-black text-primary">{totalPts}</span></div>
                            <div className="p-3"></div><div className="p-3"></div><div className="p-3"></div>
                        </div>
                    </div>
                </motion.div>
            )}

            {/* ══════════ SECTION 2: Team & Streams ══════════ */}
            {activeSection === 'team' && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                    <div className="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        {team.map((t, i) => {
                            const roleColor = ['#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#F43F5E', '#06B6D4', '#EC4899'][i % 7];
                            return (
                                <motion.div key={i} initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: i * 0.05 }}
                                    className="glass-card p-5 border-l-4 hover:shadow-xl transition-all" style={{ borderLeftColor: roleColor }}>
                                    <div className="flex items-start justify-between mb-3">
                                        <div className="w-11 h-11 rounded-xl flex items-center justify-center text-white font-black text-lg" style={{ background: roleColor }}>{t.headcount}</div>
                                        <div className="flex flex-col items-end gap-1">
                                            <span className="text-[10px] font-black px-2 py-0.5 rounded-full bg-primary-dim text-primary">{t.headcount > 1 ? `${t.headcount} members` : '1 member'}</span>
                                            {!t.billable && <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-warning/10 text-warning">Non-billable</span>}
                                        </div>
                                    </div>
                                    <h4 className="font-extrabold text-text-main text-sm mb-1">{t.role}</h4>
                                    <p className="text-[10px] text-text-muted font-medium leading-relaxed mb-2">{t.justification}</p>
                                    {t.ramp_up_notes && <p className="text-[10px] font-bold text-primary">{t.ramp_up_notes}</p>}
                                    {t.stream_allocation && <p className="text-[10px] text-text-muted mt-1">Stream: {t.stream_allocation}</p>}
                                </motion.div>
                            );
                        })}
                    </div>

                    {/* UAT Milestones */}
                    {uatMilestones.length > 0 && (
                        <div className="glass-card p-6">
                            <h3 className="text-xs font-black uppercase tracking-widest text-text-muted mb-4 flex items-center gap-2">
                                <Icon name="Shield" size={14} /> UAT Milestone Gates
                            </h3>
                            <div className="grid grid-cols-2 lg:grid-cols-3 gap-3">
                                {uatMilestones.map((u, i) => (
                                    <div key={i} className="p-4 rounded-xl border border-border bg-bg-body hover:border-primary transition-colors">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-xs font-black px-2.5 py-1 rounded-full" style={{ background: 'rgba(139,92,246,0.12)', color: '#8B5CF6' }}>{u.name}</span>
                                            <span className="text-[10px] text-text-muted font-bold">{u.sprint} — Day {u.day}</span>
                                        </div>
                                        <p className="text-[10px] font-medium text-text-main mb-1">{u.scope}</p>
                                        <p className="text-[10px] text-text-muted">{u.exit_criteria}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Pilot & Hypercare */}
                    <div className="grid grid-cols-2 gap-4">
                        {pilotHypercare.pilot && (
                            <div className="glass-card p-5 border-l-4 border-warning">
                                <div className="flex items-center gap-2 mb-3">
                                    <Icon name="Rocket" size={16} className="text-warning" />
                                    <span className="font-black text-text-main">PILOT</span>
                                    <span className="text-xs text-text-muted font-bold">Day {pilotHypercare.pilot.start_day}→{pilotHypercare.pilot.end_day} ({pilotHypercare.pilot.duration_days} days)</span>
                                </div>
                                <p className="text-xs text-text-muted font-medium">{pilotHypercare.pilot.description}</p>
                                <p className="text-[10px] font-bold text-warning mt-2">Team: {pilotHypercare.pilot.team_needed}</p>
                            </div>
                        )}
                        {pilotHypercare.hypercare && (
                            <div className="glass-card p-5 border-l-4" style={{ borderLeftColor: '#06B6D4' }}>
                                <div className="flex items-center gap-2 mb-3">
                                    <Icon name="HeartPulse" size={16} style={{ color: '#06B6D4' }} />
                                    <span className="font-black text-text-main">HYPERCARE</span>
                                    <span className="text-xs text-text-muted font-bold">Day {pilotHypercare.hypercare.start_day}→{pilotHypercare.hypercare.end_day} ({pilotHypercare.hypercare.duration_days} days)</span>
                                </div>
                                <p className="text-xs text-text-muted font-medium">{pilotHypercare.hypercare.description}</p>
                                <p className="text-[10px] font-bold mt-2" style={{ color: '#06B6D4' }}>Team: {pilotHypercare.hypercare.team_needed}</p>
                            </div>
                        )}
                    </div>
                </motion.div>
            )}

            {/* ══════════ SECTION 3: Timeline ══════════ */}
            {activeSection === 'timeline' && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                    <div className="grid grid-cols-3 gap-5">
                        {[
                            { icon: 'Calendar', label: 'Working Days', value: timeline.total_working_days || '—', color: '#3B82F6' },
                            { icon: 'Clock', label: 'Months', value: timeline.total_months || '—', color: '#10B981' },
                            { icon: 'Repeat', label: 'Sprints (2-week)', value: timeline.total_sprints || '—', color: '#F59E0B' },
                        ].map((card, i) => (
                            <div key={i} className="glass-card p-7 text-center border-t-4" style={{ borderTopColor: card.color }}>
                                <Icon name={card.icon} size={28} style={{ color: card.color }} className="mx-auto mb-2 opacity-80" />
                                <div className="text-3xl font-black text-text-main mb-1">{card.value}</div>
                                <div className="text-sm font-bold text-text-muted">{card.label}</div>
                            </div>
                        ))}
                    </div>

                    <div className="glass-card p-6">
                        <h3 className="text-xs font-black uppercase tracking-widest text-text-muted mb-4 flex items-center gap-2">
                            <Icon name="Calculator" size={14} /> Calculation Breakdown
                        </h3>
                        <div className="space-y-2">
                            {[
                                ['Total Story Points', totalPts],
                                ['Parallel Streams', psa.recommended_streams || 1],
                                ['Team Velocity / Sprint', `${timeline.team_velocity_per_sprint || '—'} pts`],
                                ['Sprint Duration', '2 weeks (10 working days)'],
                                ['Total Sprints', timeline.total_sprints || '—'],
                                ['Working Days', `${timeline.total_working_days || '—'} days`],
                                ['Calendar Duration', `${timeline.total_months || '—'} months`],
                                ['Start Date', timeline.start_date || '—'],
                                ['Projected End Date', timeline.end_date || '—'],
                                ['Client Target', `${meta.target_duration_value} ${meta.target_duration_unit} (${meta.target_working_days} working days)`],
                                ['Sequential (No Parallel)', `${psa.single_stream_days || '—'} days (${psa.single_stream_months || '—'} months)`],
                                ['Coordination Overhead', `${psa.coordination_overhead_pct || 0}%`],
                            ].map(([label, value], i) => (
                                <div key={i} className="flex justify-between items-center p-3 bg-bg-body rounded-xl border border-border">
                                    <span className="text-sm font-bold text-text-muted">{label}</span>
                                    <span className="text-sm font-black text-text-main">{value}</span>
                                </div>
                            ))}
                        </div>
                        {timeline.assumptions && (
                            <div className="mt-4 p-3 bg-primary-dim rounded-xl border border-primary/20">
                                <p className="text-xs font-bold text-primary flex items-center gap-2">
                                    <Icon name="Info" size={14} /> {timeline.assumptions}
                                </p>
                            </div>
                        )}
                    </div>
                </motion.div>
            )}

            {/* ══════════ SECTION 4: Day-Level Gantt ══════════ */}
            {activeSection === 'gantt' && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }}>
                    <div className="glass-card overflow-hidden shadow-xl">
                        <div className="overflow-x-auto" style={{ maxHeight: '70vh' }}>
                            <div style={{ minWidth: `${300 + maxDay * 18}px` }}>
                                {/* Sprint header */}
                                <div className="flex sticky top-0 z-20 bg-bg-card border-b border-border">
                                    <div className="w-[300px] shrink-0 p-3 text-xs font-black uppercase tracking-widest text-text-muted border-r border-border">Feature</div>
                                    <div className="flex-1 flex">
                                        {Array.from({ length: Math.ceil(maxDay / 10) }, (_, si) => {
                                            const sprintStart = si * 10 + 1;
                                            const width = Math.min(10, maxDay - si * 10) * 18;
                                            return (
                                                <div key={si} className="text-center border-r border-border/30" style={{ width: `${width}px` }}>
                                                    <span className="text-[9px] font-black text-primary">SP{si + 1}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Feature Gantt rows */}
                                {analysis.map((f, idx) => {
                                    const ganttColors = ['#4FC3F7', '#81C784', '#FFB74D', '#E57373', '#BA68C8', '#4DD0E1', '#F06292', '#AED581'];
                                    const barColor = ganttColors[idx % ganttColors.length];
                                    return (
                                        <div key={idx} className="flex border-b border-border/30 hover:bg-primary/5 transition-colors group" style={{ height: '28px' }}>
                                            <div className="w-[300px] shrink-0 px-3 flex items-center gap-2 border-r border-border bg-bg-card">
                                                <span className="text-[10px] font-bold text-text-muted w-5">{f.id || idx + 1}</span>
                                                <span className="text-[10px] font-bold text-text-main truncate flex-1" title={f.feature}>{f.feature}</span>
                                                <span className="text-[8px] font-black px-1.5 py-0.5 rounded-full shrink-0" style={{ background: (SIZE_CONFIG[f.size] || {}).bg, color: (SIZE_CONFIG[f.size] || {}).color }}>{f.size}</span>
                                            </div>
                                            <div className="flex-1 relative">
                                                {/* Background grid */}
                                                {Array.from({ length: maxDay }, (_, d) => (
                                                    <div key={d} className="absolute top-0 bottom-0" style={{ left: `${d * 18}px`, width: '18px', borderRight: (d + 1) % 10 === 0 ? '1px solid rgba(var(--border-rgb, 200,200,200), 0.3)' : 'none' }} />
                                                ))}
                                                {/* Gantt bar */}
                                                <div className="absolute top-1 bottom-1 rounded-sm transition-opacity group-hover:opacity-90" style={{
                                                    left: `${((f.start_day || 1) - 1) * 18}px`,
                                                    width: `${((f.end_day || f.start_day || 1) - (f.start_day || 1) + 1) * 18}px`,
                                                    background: barColor,
                                                    opacity: 0.8
                                                }}>
                                                    <span className="text-[7px] font-bold text-white px-1 truncate block leading-[20px]">{f.story_points}pt</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}

                                {/* UAT markers row */}
                                {uatMilestones.length > 0 && (
                                    <div className="flex border-b border-border" style={{ height: '24px' }}>
                                        <div className="w-[300px] shrink-0 px-3 flex items-center border-r border-border bg-bg-card">
                                            <span className="text-[10px] font-black" style={{ color: '#8B5CF6' }}>UAT MILESTONES</span>
                                        </div>
                                        <div className="flex-1 relative">
                                            {uatMilestones.map((u, i) => (
                                                <div key={i} className="absolute top-0 bottom-0 flex items-center justify-center" style={{ left: `${((u.day || 1) - 1) * 18}px`, width: `${(u.duration_days || 5) * 18}px`, background: 'rgba(139,92,246,0.2)' }}>
                                                    <span className="text-[7px] font-black" style={{ color: '#8B5CF6' }}>{u.name}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Pilot row */}
                                {pilotHypercare.pilot && pilotHypercare.pilot.start_day > 0 && (
                                    <div className="flex border-b border-border" style={{ height: '24px' }}>
                                        <div className="w-[300px] shrink-0 px-3 flex items-center border-r border-border bg-bg-card">
                                            <span className="text-[10px] font-black text-warning">PILOT</span>
                                        </div>
                                        <div className="flex-1 relative">
                                            <div className="absolute top-0 bottom-0 rounded-sm" style={{
                                                left: `${(pilotHypercare.pilot.start_day - 1) * 18}px`,
                                                width: `${pilotHypercare.pilot.duration_days * 18}px`,
                                                background: 'rgba(245,158,11,0.25)'
                                            }} />
                                        </div>
                                    </div>
                                )}

                                {/* Hypercare row */}
                                {pilotHypercare.hypercare && pilotHypercare.hypercare.start_day > 0 && (
                                    <div className="flex border-b border-border" style={{ height: '24px' }}>
                                        <div className="w-[300px] shrink-0 px-3 flex items-center border-r border-border bg-bg-card">
                                            <span className="text-[10px] font-black" style={{ color: '#06B6D4' }}>HYPERCARE</span>
                                        </div>
                                        <div className="flex-1 relative">
                                            <div className="absolute top-0 bottom-0 rounded-sm" style={{
                                                left: `${(pilotHypercare.hypercare.start_day - 1) * 18}px`,
                                                width: `${pilotHypercare.hypercare.duration_days * 18}px`,
                                                background: 'rgba(6,182,212,0.25)'
                                            }} />
                                        </div>
                                    </div>
                                )}

                                {/* Resource loading row */}
                                {resourceLoad.length > 0 && (
                                    <div className="flex border-t-2 border-danger/30" style={{ height: '32px' }}>
                                        <div className="w-[300px] shrink-0 px-3 flex items-center border-r border-border bg-bg-card">
                                            <span className="text-[10px] font-black text-danger">RESOURCE LOADING</span>
                                        </div>
                                        <div className="flex-1 relative flex items-end">
                                            {resourceLoad.map((rl, i) => {
                                                const maxMembers = Math.max(1, ...resourceLoad.map(r => r.team_members_needed || 0));
                                                const pct = ((rl.team_members_needed || 0) / maxMembers) * 100;
                                                return (
                                                    <div key={i} className="absolute bottom-0 flex items-end justify-center"
                                                        style={{ left: `${((rl.day || 1) - 1) * 18}px`, width: '18px' }}>
                                                        <div className="w-3 rounded-t-sm" style={{ height: `${Math.max(pct * 0.28, 2)}px`, background: pct > 80 ? '#EF4444' : pct > 50 ? '#F59E0B' : '#10B981' }} />
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="mt-4 flex justify-end">
                        <button onClick={handleDownloadXLSX} disabled={downloadingXLSX}
                            className="flex items-center gap-2 px-5 py-3 rounded-xl font-bold text-sm text-white transition-all hover:shadow-lg"
                            style={{ background: 'linear-gradient(135deg, #10B981, #059669)' }}>
                            <Icon name="Download" size={16} />
                            {downloadingXLSX ? 'Generating...' : 'Download Full Excel (Expert PM Format)'}
                        </button>
                    </div>
                </motion.div>
            )}

            {/* ══════════ SECTION 5: Sprint Map ══════════ */}
            {activeSection === 'sprints' && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                    <div className="glass-card overflow-hidden shadow-xl">
                        <div className="grid gap-0" style={{ gridTemplateColumns: '80px 80px 80px 80px 120px 2fr 80px' }}>
                            {['Sprint', 'Start Day', 'End Day', 'Month', 'Calendar', 'Features', 'Points'].map(h => (
                                <div key={h} className="p-3 text-[10px] font-black uppercase tracking-widest text-text-muted border-b border-border bg-bg-card">{h}</div>
                            ))}
                        </div>
                        {sprintMap.map((sm, i) => (
                            <div key={i} className="grid gap-0 border-b border-border/50 hover:bg-primary/5 transition-colors"
                                style={{ gridTemplateColumns: '80px 80px 80px 80px 120px 2fr 80px' }}>
                                <div className="p-3 text-xs font-black text-primary">{sm.sprint}</div>
                                <div className="p-3 text-xs font-bold text-text-main">{sm.start_day}</div>
                                <div className="p-3 text-xs font-bold text-text-main">{sm.end_day}</div>
                                <div className="p-3 text-xs font-bold text-text-muted">{sm.month}</div>
                                <div className="p-3 text-xs font-bold text-text-main">{sm.calendar_month}</div>
                                <div className="p-3 text-[10px] text-text-muted font-medium">{(sm.features_in_sprint || []).join(', ')}</div>
                                <div className="p-3 text-center"><span className="text-sm font-black text-primary">{sm.points_in_sprint}</span></div>
                            </div>
                        ))}
                    </div>
                </motion.div>
            )}

            {/* ══════════ SECTION 6: Jira Breakdown ══════════ */}
            {activeSection === 'jira' && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                    {/* Jira Push Result */}
                    {jiraResult && (
                        <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }}
                            className="rounded-2xl p-5 shadow-lg"
                            style={{
                                background: jiraResult.success ? 'rgba(16,185,129,0.12)' : 'rgba(244,63,94,0.12)',
                                border: `2px solid ${jiraResult.success ? 'var(--success)' : 'var(--danger)'}`
                            }}>
                            <div className="flex items-center gap-3 mb-2">
                                <Icon name={jiraResult.success ? "CheckCircle" : "AlertTriangle"} size={22} style={{ color: jiraResult.success ? 'var(--success)' : 'var(--danger)' }} />
                                <span className="font-black text-text-main">
                                    {jiraResult.success ? `Created ${jiraResult.created_epics} Epics & ${jiraResult.created_stories} Stories!` : 'Some issues occurred'}
                                </span>
                            </div>
                            {jiraResult.details && jiraResult.details.map((d, i) => (
                                <div key={i} className="flex items-center gap-2 text-sm font-bold text-text-main ml-8 mb-1">
                                    <span className="text-xs font-black text-primary bg-primary-dim px-2 py-0.5 rounded-full">{d.epic_key}</span>
                                    <span>{d.epic_name}</span> <span className="text-text-muted">→ {d.stories_created} stories</span>
                                </div>
                            ))}
                        </motion.div>
                    )}

                    {/* Epics */}
                    {epics.map((epic, ei) => {
                        const epicColor = ['#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#F43F5E', '#06B6D4', '#EC4899'][ei % 7];
                        return (
                            <motion.div key={ei} initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: ei * 0.04 }}
                                className="glass-card overflow-hidden shadow-lg">
                                <div className="p-4 flex justify-between items-center" style={{ borderBottom: `3px solid ${epicColor}` }}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-9 h-9 rounded-xl flex items-center justify-center text-white font-black text-sm" style={{ background: epicColor }}>E{ei + 1}</div>
                                        <div>
                                            <h4 className="font-extrabold text-text-main text-base">{epic.epic_name}</h4>
                                            <p className="text-[10px] text-text-muted">{epic.epic_description}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3 shrink-0">
                                        {epic.feature_type && <span className="text-[9px] font-bold px-2 py-1 rounded-full" style={{ background: `${TYPE_COLORS[epic.feature_type] || '#999'}18`, color: TYPE_COLORS[epic.feature_type] || '#999' }}>{epic.feature_type}</span>}
                                        <span className="text-[10px] font-black px-2 py-1 rounded-full" style={{ background: `${epicColor}22`, color: epicColor }}>{(epic.stories || []).length} stories</span>
                                        <span className="text-lg font-black text-primary">{epic.total_points} pts</span>
                                    </div>
                                </div>
                                <div>
                                    {(epic.stories || []).map((story, si) => (
                                        <div key={si} className="flex items-center gap-4 p-3 border-b border-border/30 hover:bg-primary/5 transition-colors">
                                            <span className="flex-1 text-xs font-bold text-text-main">{story.summary}</span>
                                            <span className="text-xs font-black text-primary shrink-0">{story.story_points} pts</span>
                                            <span className="text-[9px] font-bold px-2 py-0.5 rounded-full shrink-0" style={{
                                                background: story.priority === 'High' ? 'rgba(244,63,94,0.12)' : story.priority === 'Low' ? 'rgba(16,185,129,0.12)' : 'rgba(245,158,11,0.12)',
                                                color: story.priority === 'High' ? '#F43F5E' : story.priority === 'Low' ? '#10B981' : '#F59E0B',
                                            }}>{story.priority}</span>
                                        </div>
                                    ))}
                                </div>
                            </motion.div>
                        );
                    })}

                    {/* Push to Jira */}
                    <motion.button onClick={handlePushToJira} disabled={pushingJira || !project}
                        whileHover={{ scale: 1.01 }} whileTap={{ scale: 0.99 }}
                        className="w-full p-5 rounded-2xl text-white font-black text-lg flex items-center justify-center gap-3 shadow-xl transition-all disabled:opacity-40"
                        style={{ background: pushingJira ? 'var(--border)' : 'linear-gradient(135deg, #3B82F6, #8B5CF6)' }}>
                        {pushingJira ? (
                            <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            Creating {epics.length} Epics & {totalStories} Stories in Jira...</>
                        ) : (
                            <><Icon name="Rocket" size={22} /> Push to Jira — Create {epics.length} Epics & {totalStories} Stories</>
                        )}
                    </motion.button>
                </motion.div>
            )}
        </div>
    );
}

        /* ================================================================
           DASHBOARD VIEW — Command Center
           ================================================================ */
        function DashboardView({ project, role, setIsLoading, isGlobalLoading }) {
    const [data, setData] = useState(null);
    const [sprints, setSprints] = useState([]);
    const [activeSprint, setActiveSprint] = useState('active');
    const [capacityData, setCapacityData] = useState(null);
    const [loadingCapacity, setLoadingCapacity] = useState(false);

    useEffect(() => {
        secureFetch(`/sprints/${project}`).then(r => r?.json()).then(d => { if (d && d.length) setSprints(d); });
    }, [project]);

    useEffect(() => {
        setData(null); setCapacityData(null); setIsLoading(true); setLoadingCapacity(true);
        const analyticsUrl = activeSprint === 'active' ? `/analytics/${project}` : `/analytics/${project}?sprint_id=${activeSprint}`;
        const capacityUrl = activeSprint === 'active' ? `/capacity_check/${project}` : `/capacity_check/${project}?sprint_id=${activeSprint}`;

        Promise.all([
            secureFetch(analyticsUrl).then(r => r?.json()),
            secureFetch(capacityUrl).then(r => r?.json()).catch(() => null)
        ]).then(([analyticsData, capData]) => {
            setData(analyticsData);
            setCapacityData(capData);
            setIsLoading(false);
            setLoadingCapacity(false);
        }).catch(() => { setIsLoading(false); setLoadingCapacity(false); });
    }, [project, activeSprint]);

    if (!data) return <LoadingScreen msg="Loading Command Center..." />;
    const metrics = data.metrics || {};
    const ai = data.ai_insights || {};
    const assignees = Object.entries(metrics.assignees || {});
    const maxPts = Math.max(1, ...assignees.map(([, s]) => s.points || 0));
    const statusColor = (status) => {
        const s = (status || '').toLowerCase();
        if (s.includes('done') || s.includes('closed') || s.includes('resolved')) return 'var(--success)';
        if (s.includes('progress') || s.includes('review')) return 'var(--primary)';
        return 'var(--border)';
    };

    const severityConfig = {
        critical: { bg: 'rgba(244,63,94,0.12)', border: 'var(--danger)', icon: 'AlertTriangle', color: 'var(--danger)', label: 'OVER-CAPACITY' },
        warning: { bg: 'rgba(245,158,11,0.12)', border: 'var(--warning)', icon: 'AlertTriangle', color: 'var(--warning)', label: 'AT RISK' },
        caution: { bg: 'rgba(245,158,11,0.08)', border: 'var(--warning)', icon: 'Clock', color: 'var(--warning)', label: 'AMBITIOUS' },
        healthy: { bg: 'rgba(16,185,129,0.08)', border: 'var(--success)', icon: 'CheckCircle', color: 'var(--success)', label: 'HEALTHY' },
        first_sprint: { bg: 'rgba(59,130,246,0.1)', border: 'var(--primary)', icon: 'Zap', color: 'var(--primary)', label: 'FIRST SPRINT' },
        empty: { bg: 'var(--bg-card)', border: 'var(--border)', icon: 'BarChart', color: 'var(--text-muted)', label: 'NO DATA' },
    };
    const isFirstSprint = capacityData?.severity === 'first_sprint';

    return (
        <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4 space-y-10">
            <header className="flex justify-between items-end pb-6 border-b border-border">
                <div>
                    <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Command Center</h2>
                    <p className="text-base font-medium mt-2 text-text-muted">Sprint Intelligence Dashboard &middot; Project <span className="text-primary font-black">{project}</span></p>
                </div>
                <div className="flex items-center gap-3">
                    <span className="text-xs font-black uppercase tracking-wider text-text-muted">Sprint</span>
                    <select value={activeSprint} onChange={e => setActiveSprint(e.target.value)} className="p-3 rounded-lg border bg-bg-card text-text-main font-bold shadow-sm outline-none cursor-pointer hover:border-primary transition-colors border-border">
                        <option value="active">Active Sprint</option>
                        {sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                    </select>
                </div>
            </header>

            {/* ═══════════════════════════════════════════
                ★ CAPACITY WARNING BANNER — The Key Feature
                ═══════════════════════════════════════════ */}
            {capacityData && capacityData.severity && (
                <motion.div initial={{ opacity: 0, y: -20, scale: 0.98 }} animate={{ opacity: 1, y: 0, scale: 1 }} transition={{ type: "spring", bounce: 0.3 }}
                    className="rounded-2xl p-6 relative overflow-hidden shadow-xl"
                    style={{
                        background: severityConfig[capacityData.severity]?.bg || 'var(--bg-card)',
                        border: `2px solid ${severityConfig[capacityData.severity]?.border || 'var(--border)'}`,
                    }}>
                    {/* Glow effect for critical/warning */}
                    {(capacityData.severity === 'critical' || capacityData.severity === 'warning') && (
                        <div className="absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"
                            style={{ background: severityConfig[capacityData.severity]?.border, opacity: 0.15 }} />
                    )}

                    <div className="relative z-10">
                        {/* Top row: Status badge + Utilization */}
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-xl flex items-center justify-center"
                                    style={{ background: `${severityConfig[capacityData.severity]?.border}22`, color: severityConfig[capacityData.severity]?.color }}>
                                    <Icon name={severityConfig[capacityData.severity]?.icon || 'BarChart'} size={24} />
                                </div>
                                <div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-black uppercase tracking-widest"
                                            style={{ color: severityConfig[capacityData.severity]?.color }}>
                                            {severityConfig[capacityData.severity]?.label}
                                        </span>
                                        <span className="text-xs font-bold text-text-muted">• Capacity Analysis</span>
                                    </div>
                                    <p className="text-base font-bold text-text-main mt-1 max-w-2xl leading-relaxed">{capacityData.warning}</p>
                                </div>
                            </div>

                            {/* Big utilization percentage */}
                            <div className="text-right shrink-0 ml-6">
                                <div className="text-5xl font-black" style={{ color: severityConfig[capacityData.severity]?.color }}>
                                    {isFirstSprint ? `${Math.round((capacityData.total_completed / Math.max(capacityData.total_committed, 1)) * 100)}%` : `${capacityData.utilization_pct}%`}
                                </div>
                                <div className="text-xs font-bold text-text-muted mt-1">
                                    {isFirstSprint ? 'Sprint Progress' : 'Sprint Utilization'}
                                </div>
                            </div>
                        </div>

                        {/* Capacity Bar */}
                        <div className="mt-4">
                            <div className="flex justify-between text-xs font-bold mb-2">
                                <span className="text-text-muted">
                                    Committed: <span className="text-text-main">{capacityData.total_committed} pts</span>
                                </span>
                                <span className="text-text-muted">
                                    Completed: <span className="text-success">{capacityData.total_completed} pts</span> &middot;
                                    Remaining: <span className="text-text-main">{capacityData.total_remaining} pts</span>
                                </span>
                                <span className="text-text-muted">
                                    {isFirstSprint ? (
                                        <>No velocity history yet <span className="ml-1 text-[10px]">(first sprint)</span></>
                                    ) : (
                                        <>Avg Velocity: <span className="text-primary">{capacityData.avg_velocity} pts</span>
                                        <span className="ml-1 text-[10px]">({capacityData.sprints_analyzed} sprints)</span></>
                                    )}
                                </span>
                            </div>
                            <div className="w-full h-4 bg-border/50 rounded-full overflow-hidden relative">
                                {/* Velocity marker */}
                                {capacityData.avg_velocity > 0 && capacityData.total_committed > 0 && (
                                    <div className="absolute top-0 bottom-0 w-0.5 bg-white z-20"
                                        style={{
                                            left: `${Math.min(100, (capacityData.avg_velocity / Math.max(capacityData.total_committed, capacityData.avg_velocity)) * 100)}%`,
                                            opacity: 0.7
                                        }}>
                                        <div className="absolute -top-5 -translate-x-1/2 text-[9px] font-black text-primary whitespace-nowrap">
                                            ▼ velocity
                                        </div>
                                    </div>
                                )}
                                {/* Completed portion */}
                                <motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(100, (capacityData.total_completed / Math.max(capacityData.total_committed, capacityData.avg_velocity, 1)) * 100)}%` }}
                                    transition={{ duration: 1, ease: "easeOut" }}
                                    className="h-full rounded-full" style={{ background: 'var(--success)' }} />
                                {/* Remaining portion (stacked) */}
                                <motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(100, (capacityData.total_remaining / Math.max(capacityData.total_committed, capacityData.avg_velocity, 1)) * 100)}%` }}
                                    transition={{ duration: 1, ease: "easeOut", delay: 0.3 }}
                                    className="h-full rounded-r-full absolute top-0"
                                    style={{
                                        left: `${(capacityData.total_completed / Math.max(capacityData.total_committed, capacityData.avg_velocity, 1)) * 100}%`,
                                        background: capacityData.severity === 'critical' ? 'var(--danger)' : capacityData.severity === 'warning' ? 'var(--warning)' : capacityData.severity === 'first_sprint' ? 'var(--primary)' : 'var(--primary)'
                                    }} />
                            </div>
                        </div>

                        {/* Per-Person Capacity (collapsed by default for non-critical) */}
                        {capacityData.person_capacity && Object.keys(capacityData.person_capacity).length > 0 && (
                            <div className="mt-6 pt-4 border-t" style={{ borderColor: `${severityConfig[capacityData.severity]?.border}44` }}>
                                <h4 className="text-xs font-black uppercase tracking-widest text-text-muted mb-3 flex items-center gap-2">
                                    <Icon name="Users" size={14} /> Team Member Capacity
                                </h4>
                                <div className="grid grid-cols-2 lg:grid-cols-3 gap-3">
                                    {Object.entries(capacityData.person_capacity)
                                        .filter(([name]) => name !== 'Unassigned')
                                        .sort(([, a], [, b]) => (b.committed || 0) - (a.committed || 0))
                                        .map(([name, person]) => {
                                            const personSev = person.status === 'overloaded' || person.status === 'heavy_load' ? 'critical'
                                                : person.status === 'at_risk' ? 'warning'
                                                : person.status === 'underutilized' || person.status === 'light_load' ? 'caution'
                                                : person.status === 'first_sprint' ? 'first_sprint' : 'healthy';
                                            const personColor = severityConfig[personSev]?.color || 'var(--text-muted)';

                                            // For first sprint: show completion % instead of utilization %
                                            const displayPct = isFirstSprint
                                                ? (person.committed > 0 ? Math.round((person.completed / person.committed) * 100) : 0)
                                                : person.utilization_pct;
                                            const barPct = isFirstSprint
                                                ? (person.committed > 0 ? Math.min(100, (person.completed / person.committed) * 100) : 0)
                                                : Math.min(100, person.utilization_pct);

                                            return (
                                                <div key={name} className="p-3 rounded-xl border transition-all hover:shadow-md" style={{
                                                    background: 'var(--bg-body)',
                                                    borderColor: (person.status === 'overloaded' || person.status === 'heavy_load') ? 'var(--danger)' : 'var(--border)',
                                                    borderWidth: (person.status === 'overloaded' || person.status === 'heavy_load') ? '2px' : '1px'
                                                }}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="font-bold text-text-main text-sm truncate">{name}</span>
                                                        <span className="text-xs font-black px-2 py-0.5 rounded-full shrink-0" style={{
                                                            background: `${personColor}18`,
                                                            color: personColor
                                                        }}>
                                                            {displayPct}%
                                                        </span>
                                                    </div>
                                                    <div className="w-full h-1.5 bg-border rounded-full overflow-hidden mb-1.5">
                                                        <div className="h-full rounded-full transition-all" style={{
                                                            width: `${barPct}%`,
                                                            background: (person.status === 'overloaded' || person.status === 'heavy_load') ? 'var(--danger)'
                                                                : person.status === 'at_risk' ? 'var(--warning)'
                                                                : isFirstSprint ? 'var(--primary)' : 'var(--success)'
                                                        }} />
                                                    </div>
                                                    <div className="flex justify-between text-[10px] text-text-muted font-medium">
                                                        <span>Committed: {person.committed} pts</span>
                                                        <span>{isFirstSprint
                                                            ? `Done: ${person.completed} pts`
                                                            : `Avg: ${person.historical_avg} pts`
                                                        }</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                </div>
                            </div>
                        )}

                        {/* Recommendations */}
                        {capacityData.recommendations && capacityData.recommendations.length > 0 && (
                            <div className="mt-4 pt-3 border-t" style={{ borderColor: `${severityConfig[capacityData.severity]?.border}33` }}>
                                <div className="flex flex-wrap gap-2">
                                    {capacityData.recommendations.map((rec, i) => (
                                        <div key={i} className="flex items-start gap-2 text-xs font-semibold text-text-main bg-bg-body px-3 py-2 rounded-lg border border-border">
                                            <Icon name="ArrowRight" size={12} className="text-primary shrink-0 mt-0.5" />
                                            <span>{rec}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </motion.div>
            )}

            {/* Standard Metrics Cards */}
            <div className="grid grid-cols-4 gap-6">
                <MetricCard label="Total Issues" value={metrics.total || 0} color="primary" />
                <MetricCard label="Story Points" value={(metrics.points || 0).toFixed(1)} color="success" />
                <MetricCard label="High Priority" value={metrics.blockers || 0} color="danger" isDanger={(metrics.blockers || 0) > 0} />
                <MetricCard label="Bugs" value={metrics.bugs || 0} color="warning" isDanger={(metrics.bugs || 0) > 0} />
            </div>

            {/* AI Executive Summary */}
            {ai.executive_summary && (
                <motion.div initial={{ opacity: 0, y: 16 }} animate={{ opacity: 1, y: 0 }} className="glass-card p-8 border-t-4 border-primary relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none opacity-50" style={{ background: 'var(--glow-primary)' }}></div>
                    <h3 className="text-xs font-black uppercase tracking-widest text-primary mb-4 flex items-center gap-2 relative z-10">
                        <Icon name="Sparkles" size={16} /> AI Executive Summary
                    </h3>
                    <p className="text-xl font-bold text-text-main leading-relaxed relative z-10">{ai.executive_summary}</p>
                    {ai.business_value && <p className="text-sm text-text-muted mt-4 font-medium leading-relaxed border-t border-border pt-4 relative z-10">{ai.business_value}</p>}
                </motion.div>
            )}

            {/* Team Workload Distribution */}
            {assignees.length > 0 && (
                <div className="glass-card p-8">
                    <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2">
                        <Icon name="Users" size={16} /> Team Workload Distribution
                    </h3>
                    <div className="space-y-4">
                        {assignees.map(([name, stats]) => {
                            // Merge with capacity data if available
                            const personCap = capacityData?.person_capacity?.[name];
                            const isOverloaded = personCap?.status === 'overloaded';
                            const isAtRisk = personCap?.status === 'at_risk';

                            return (
                                <div key={name} className={`flex items-center gap-4 p-4 bg-bg-body rounded-xl border transition-colors group ${isOverloaded ? 'border-danger border-2' : isAtRisk ? 'border-warning' : 'border-border hover:border-primary'}`}>
                                    {stats.avatar ? <img src={stats.avatar} className="w-10 h-10 rounded-full border-2 border-primary shrink-0" alt={name} /> : <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0" style={{ background: 'var(--accent-gradient)' }}>{name.charAt(0)}</div>}
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-center mb-1">
                                            <div className="flex items-center gap-2">
                                                <span className="font-bold text-text-main text-sm truncate">{name}</span>
                                                {isOverloaded && <span className="text-[10px] font-black text-danger bg-danger/10 px-2 py-0.5 rounded-full border border-danger/20">OVERLOADED</span>}
                                                {isAtRisk && <span className="text-[10px] font-black text-warning bg-warning/10 px-2 py-0.5 rounded-full border border-warning/20">AT RISK</span>}
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-xs font-black text-primary ml-4 shrink-0">{(stats.points || 0).toFixed(1)} pts</span>
                                                {personCap && personCap.historical_avg > 0 && (
                                                    <span className="text-[10px] font-bold text-text-muted shrink-0">
                                                        (avg: {personCap.historical_avg} pts)
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="w-full h-2 bg-border rounded-full overflow-hidden">
                                            <motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(100, ((stats.points || 0) / maxPts) * 100)}%` }}
                                                transition={{ duration: 0.8, ease: "easeOut" }}
                                                className="h-full rounded-full"
                                                style={{ background: isOverloaded ? 'var(--danger)' : isAtRisk ? 'var(--warning)' : 'var(--accent-gradient)' }}
                                            />
                                        </div>
                                        <div className="text-xs text-text-muted mt-1">{stats.count} issues assigned</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* AI Story Analysis */}
            {ai.story_progress && ai.story_progress.length > 0 && (
                <div className="glass-card p-8">
                    <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2">
                        <Icon name="AlignLeft" size={16} /> AI Story Analysis
                    </h3>
                    <div className="space-y-4">
                        {ai.story_progress.map((story, i) => (
                            <motion.div key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: i * 0.05 }}
                                className="p-5 bg-bg-body rounded-xl border border-border hover:border-primary transition-colors">
                                <div className="flex justify-between items-start gap-4 mb-2">
                                    <span className="text-xs font-black text-primary bg-primary-dim px-2.5 py-1 rounded-full shrink-0">{story.key}</span>
                                    <span className="text-xs font-bold px-2.5 py-1 rounded-full shrink-0" style={{ background: `${statusColor(story.status)}22`, color: statusColor(story.status), border: `1px solid ${statusColor(story.status)}44` }}>{story.status}</span>
                                </div>
                                <div className="font-bold text-text-main text-sm mt-2">{story.summary}</div>
                                {story.analysis && <div className="text-xs text-text-muted mt-2 font-medium leading-relaxed border-t border-border pt-2">{story.analysis}</div>}
                                {story.assignee && <div className="text-xs text-primary font-bold mt-2 flex items-center gap-1"><Icon name="Users" size={12} /> {story.assignee}</div>}
                            </motion.div>
                        ))}
                    </div>
                </div>
            )}

            {assignees.length === 0 && !ai.executive_summary && (
                <div className="glass-card p-16 flex flex-col items-center justify-center text-center">
                    <Icon name="Activity" size={56} className="text-text-muted mb-6 opacity-40" />
                    <h3 className="text-2xl font-extrabold text-text-main mb-3">No Sprint Data Found</h3>
                    <p className="text-text-muted font-medium max-w-md">No active sprint issues were found for project <span className="text-primary font-bold">{project}</span>.</p>
                </div>
            )}
        </div>
    );
}

        /* ================================================================
           ROADMAP VIEW
           ================================================================ */
        // ═══════════════════════════════════════════════════════════════════

const THEME = {
    primary: "var(--primary)",
    success: "var(--success)",
    warning: "var(--warning)",
    danger: "var(--danger)",
    purple: "#8B5CF6", // Static accent for charts
    cyan: "#06B6D4",   // Static accent for charts
    bg: "var(--bg-body)",
    bgCard: "var(--bg-card)",
    border: "var(--border)",
    textMain: "var(--text-main)",
    textMuted: "var(--text-muted)",
};

const BUCKET_COLORS = {
    new_features: "#3B82F6",
    tech_debt: "#F59E0B",
    bug_fixes: "#F43F5E",
    innovation: "#8B5CF6",
};

// ── Micro-Components ──
const StrategicIcon = ({ name, size = 16, color, className = "" }) => {
    const icons = {
        Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        Target: <><circle cx="12" cy="12" r="10" strokeWidth="2" stroke="currentColor" fill="none"/><circle cx="12" cy="12" r="6" strokeWidth="2" stroke="currentColor" fill="none"/><circle cx="12" cy="12" r="2" strokeWidth="2" stroke="currentColor" fill="none"/></>,
        TrendingUp: <path d="M23 6l-9.5 9.5-5-5L1 18" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/><polyline points="2 17 12 22 22 17" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/><polyline points="2 12 12 17 22 12" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/></>,
        Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        Link: <><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/></>,
        ChevronDown: <polyline points="6 9 12 15 18 9" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        Check: <polyline points="20 6 9 17 4 12" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
        X: <><line x1="18" y1="6" x2="6" y2="18" strokeWidth="2" stroke="currentColor" strokeLinecap="round"/><line x1="6" y1="6" x2="18" y2="18" strokeWidth="2" stroke="currentColor" strokeLinecap="round"/></>,
        PieChart: <><path d="M21.21 15.89A10 10 0 118 2.83" strokeWidth="2" stroke="currentColor" fill="none"/><path d="M22 12A10 10 0 0012 2v10z" strokeWidth="2" stroke="currentColor" fill="none"/></>,
        BarChart: <><line x1="12" y1="20" x2="12" y2="10" strokeWidth="2" stroke="currentColor" strokeLinecap="round"/><line x1="18" y1="20" x2="18" y2="4" strokeWidth="2" stroke="currentColor" strokeLinecap="round"/><line x1="6" y1="20" x2="6" y2="16" strokeWidth="2" stroke="currentColor" strokeLinecap="round"/></>,
        GitBranch: <><line x1="6" y1="3" x2="6" y2="15" strokeWidth="2" stroke="currentColor" strokeLinecap="round"/><circle cx="18" cy="6" r="3" strokeWidth="2" stroke="currentColor" fill="none"/><circle cx="6" cy="18" r="3" strokeWidth="2" stroke="currentColor" fill="none"/><path d="M18 9a9 9 0 01-9 9" strokeWidth="2" stroke="currentColor" fill="none"/></>,
    };
    return (
        <svg width={size} height={size} viewBox="0 0 24 24" className={className} style={{ color }}>
            {icons[name] || icons.Activity}
        </svg>
    );
};

const HealthRing = ({ score = 0, size = 120 }) => {
    const radius = (size - 12) / 2;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (Math.min(Math.max(score, 0), 100) / 100) * circumference;
    const color = score >= 75 ? THEME.success : score >= 50 ? THEME.warning : THEME.danger;

    return (
        <div style={{ position: "relative", width: size, height: size }}>
            <svg width={size} height={size} style={{ transform: "rotate(-90deg)" }}>
                <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={THEME.border} strokeWidth="6"/>
                <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={color} strokeWidth="6" strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={offset} style={{ transition: "stroke-dashoffset 1.2s ease-out" }} />
            </svg>
            <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
                <span style={{ fontSize: size * 0.28, fontWeight: 900, color: THEME.textMain, lineHeight: 1 }}>{score}</span>
                <span style={{ fontSize: size * 0.1, fontWeight: 700, color: THEME.textMuted, textTransform: "uppercase", letterSpacing: 1 }}>Health</span>
            </div>
        </div>
    );
};

const DonutChart = ({ buckets = {}, size = 180 }) => {
    const radius = 65;
    const circumference = 2 * Math.PI * radius;
    let cumulativeOffset = 0;

    const segments = Object.entries(buckets).map(([key, bucket]) => {
        const pct = bucket.actual_pct || 0;
        const segmentLength = (pct / 100) * circumference;
        const segment = { key, pct, color: BUCKET_COLORS[key] || "#666", offset: cumulativeOffset, length: segmentLength, label: bucket.label };
        cumulativeOffset += segmentLength;
        return segment;
    });

    return (
        <svg width={size} height={size} viewBox="0 0 180 180">
            <circle cx="90" cy="90" r={radius} fill="none" stroke={THEME.border} strokeWidth="22"/>
            {segments.map((seg, i) => (
                <circle key={seg.key} cx="90" cy="90" r={radius} fill="none" stroke={seg.color} strokeWidth="22" strokeLinecap="butt" strokeDasharray={`${Math.max(0, seg.length)} ${Math.max(0, circumference - seg.length)}`} strokeDashoffset={-seg.offset} style={{ transform: "rotate(-90deg)", transformOrigin: "center", transition: "all 0.8s ease-out", transitionDelay: `${i * 0.15}s` }} />
            ))}
            <text x="90" y="85" textAnchor="middle" fill={THEME.textMain} fontSize="22" fontWeight="900">
                {Object.values(buckets).reduce((s, b) => s + (b.item_count || 0), 0)}
            </text>
            <text x="90" y="102" textAnchor="middle" fill={THEME.textMuted} fontSize="10" fontWeight="700" textTransform="uppercase">items</text>
        </svg>
    );
};

const VelocitySparkline = ({ history = [], avgVelocity = 0, width = 280, height = 80 }) => {
    if (!history || history.length === 0) return null;
    const maxV = Math.max(...history.map(s => s.velocity || 0), avgVelocity || 1);
    const padding = 4;
    const w = width - padding * 2;
    const h = height - padding * 2;
    const points = history.map((s, i) => ({
        x: padding + (i / Math.max(history.length - 1, 1)) * w,
        y: padding + h - ((s.velocity || 0) / maxV) * h,
        velocity: s.velocity || 0,
        name: s.name,
    }));

    const avgY = padding + h - ((avgVelocity || 0) / maxV) * h;
    const pathD = points.map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`).join(" ");
    const areaD = pathD + ` L ${points[points.length-1].x} ${padding + h} L ${points[0].x} ${padding + h} Z`;

    return (
        <svg width={width} height={height} style={{ overflow: "visible" }}>
            <defs>
                <linearGradient id="sparkGrad" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stopColor={THEME.primary} stopOpacity="0.3"/>
                    <stop offset="100%" stopColor={THEME.primary} stopOpacity="0"/>
                </linearGradient>
            </defs>
            <path d={areaD} fill="url(#sparkGrad)"/>
            <line x1={padding} y1={avgY} x2={width - padding} y2={avgY} stroke={THEME.warning} strokeWidth="1" strokeDasharray="4 3" opacity="0.6"/>
            <path d={pathD} fill="none" stroke={THEME.primary} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
            {points.map((p, i) => (
                <circle key={i} cx={p.x} cy={p.y} r="3.5" fill={p.velocity >= (avgVelocity || 0) ? THEME.success : THEME.warning} stroke={THEME.bgCard} strokeWidth="1.5"/>
            ))}
        </svg>
    );
};

// ═══════════════════════════════════════════════════════════
//  PLANNING POKER v4 — 9 AI Agents
// ═══════════════════════════════════════════════════════════
function PlanningPokerView({ project, setIsLoading }) {
    const [phase, setPhase] = useState('setup');
    const [source, setSource] = useState('sprint');
    const [stories, setStories] = useState([]);
    const [agents, setAgents] = useState([]);
    const [selected, setSelected] = useState(new Set());
    const [results, setResults] = useState([]);
    const [currentIdx, setCurrentIdx] = useState(0);
    const [revealed, setRevealed] = useState(0);
    const [adjustments, setAdjustments] = useState({});
    const [error, setError] = useState('');
    const [sprints, setSprints] = useState([]);
    const [sprintId, setSprintId] = useState('active');

    useEffect(() => {
        if (!project) return;
        secureFetch(`/planning_poker/${project}/stories?source=${source}${sprintId !== 'active' ? `&sprint_id=${sprintId}` : ''}`)
            .then(r => r?.json()).then(d => { if (d?.stories) { setStories(d.stories); setAgents(d.agents || []); setSelected(new Set(d.stories.map(s => s.key))); } });
    }, [project, source, sprintId]);
    useEffect(() => { if (project) secureFetch(`/sprints/${project}`).then(r => r?.json()).then(d => { if (d?.sprints) setSprints(d.sprints); }).catch(() => {}); }, [project]);
    const toggle = k => setSelected(p => { const n = new Set(p); n.has(k) ? n.delete(k) : n.add(k); return n; });
    const startPoker = async () => {
        const sel = stories.filter(s => selected.has(s.key));
        if (!sel.length) return;
        setPhase('playing'); setError(''); setResults([]);
        try {
            const res = await secureFetch(`/planning_poker/${project}/play`, { method: 'POST', body: JSON.stringify({ stories: sel }) });
            const d = await res?.json();
            if (d?.results) { setResults(d.results); setPhase('results'); setCurrentIdx(0); setRevealed(0); }
            else { setError(d?.error || 'Poker failed'); setPhase('setup'); }
        } catch { setError('Poker failed'); setPhase('setup'); }
    };
    useEffect(() => { if (phase === 'results') { const t = setInterval(() => setRevealed(p => p < 10 ? p + 1 : p), 400); return () => clearInterval(t); } }, [phase, currentIdx]);

    const cr = results[currentIdx] || {};
    const votes = Array.isArray(cr?.votes) ? cr.votes : [];
    const influencers = Array.isArray(cr?.influencers) ? cr.influencers : [];
    const sa = cr?.super_agent || {};
    const agentMap = {}; agents.forEach(a => { agentMap[a.id] = a; });

    const pushToJira = async () => {
        const updates = results.map(r => ({ key: r.story_key, points: adjustments[r.story_key]?.points ?? r.super_agent?.final_points, comment: `AI Planning Poker: ${r.super_agent?.final_points} pts (${r.super_agent?.method_used || 'Multi-method'})` })).filter(u => u.points);
        const res = await secureFetch(`/planning_poker/${project}/push_jira`, { method: 'POST', body: JSON.stringify({ updates }) });
        const d = await res?.json();
        alert(`Pushed ${(d?.results || []).filter(r => r.status === 'success').length} updates to Jira`);
    };

    const pkrCSS = `.pkr-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .3s;opacity:0;transform:translateY(20px)}.pkr-show{opacity:1;transform:translateY(0)}.pkr-row-top{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px}.pkr-row-bot{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:75%;margin:0 auto}.pkr-chip{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;border-radius:10px;font-weight:900;font-size:16px;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#78350f}.pkr-chip-lg{min-width:56px;height:56px;font-size:24px;border-radius:14px}.pkr-conf{font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px}.pkr-inf{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;opacity:0;transform:translateX(-20px);transition:all .4s}.pkr-inf-show{opacity:1;transform:translateX(0)}.pkr-super{background:var(--bg-card);border:2px solid #f59e0b;border-radius:16px;padding:20px;opacity:0;transform:scale(0.9);transition:all .5s}.pkr-super-show{opacity:1;transform:scale(1)}.pkr-method{background:var(--bg-body);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center}`;

    if (phase === 'playing') return (<div className="animate-fade-in h-full flex items-center justify-center"><style>{pkrCSS}</style><div className="text-center"><div className="text-6xl mb-4 animate-bounce">🃏</div><p className="text-lg font-black text-text-main">Agents estimating...</p><p className="text-sm text-text-muted mt-2">9 AI agents analyzing {selected.size} stories</p></div></div>);

    if (phase === 'results' && results.length > 0) {
        const topVoters = votes.slice(0, 4); const botVoters = votes.slice(4, 7);
        const fibScale = [1, 2, 3, 5, 8, 13, 21];
        const voteDist = {}; fibScale.forEach(f => { voteDist[f] = 0; }); votes.forEach(v => { const p = Number(v.points); if (voteDist[p] !== undefined) voteDist[p]++; });
        const maxVotes = Math.max(1, ...Object.values(voteDist));
        const adjPts = adjustments[cr.story_key]?.points;
        return (
            <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4"><style>{pkrCSS}</style>
                <header className="flex justify-between items-center pb-4 border-b border-border mb-4">
                    <div><h2 className="text-2xl font-black text-text-main">AI Planning Poker</h2><p className="text-sm text-text-muted">Story {currentIdx + 1}/{results.length} — <span className="text-primary font-bold">{cr.story_key}</span>: {cr.story_summary}</p></div>
                    <div className="flex gap-2">{results.map((_, i) => <button key={i} onClick={() => { setCurrentIdx(i); setRevealed(0); }} className={`w-8 h-8 rounded-lg text-xs font-black ${i === currentIdx ? 'bg-primary text-white' : 'bg-bg-card text-text-muted border border-border'}`}>{i + 1}</button>)}</div>
                </header>
                <div className="pkr-row-top">{topVoters.map((v, i) => { const a = agentMap[v.agent_id] || {}; return (<div key={i} className={`pkr-card ${i < revealed ? 'pkr-show' : ''}`} style={{transitionDelay:`${i*100}ms`}}><div className="flex items-center justify-between mb-2"><span className="text-lg">{a.emoji}</span><span className={`pkr-conf ${v.confidence === 'high' ? 'bg-success/15 text-success' : 'bg-warning/15 text-warning'}`}>{v.confidence}</span></div><div className="text-xs font-black text-text-main mb-1">{a.name}</div><div className="pkr-chip mb-2">{v.points}</div><p className="text-xs text-text-muted leading-relaxed">{v.reasoning}</p>{v.risks && <p className="text-xs mt-1 font-semibold" style={{color:'#ef4444'}}>⚠ {v.risks}</p>}</div>); })}</div>
                <div className="pkr-row-bot">{botVoters.map((v, i) => { const a = agentMap[v.agent_id] || {}; const ri = i + 4; return (<div key={ri} className={`pkr-card ${ri < revealed ? 'pkr-show' : ''}`} style={{transitionDelay:`${ri*100}ms`}}><div className="flex items-center justify-between mb-2"><span className="text-lg">{a.emoji}</span><span className={`pkr-conf ${v.confidence === 'high' ? 'bg-success/15 text-success' : 'bg-warning/15 text-warning'}`}>{v.confidence}</span></div><div className="text-xs font-black text-text-main mb-1">{a.name}</div><div className="pkr-chip mb-2">{v.points}</div><p className="text-xs text-text-muted leading-relaxed">{v.reasoning}</p></div>); })}</div>
                <div className="grid grid-cols-2 gap-3 mt-4">{influencers.map((inf, i) => { const a = agentMap[inf.agent_id] || {}; return (<div key={i} className={`pkr-inf ${revealed >= 7 + i ? 'pkr-inf-show' : ''}`} style={{borderLeft:`4px solid ${inf.agent_id === 'ba' ? '#ec4899' : '#a855f7'}`,transitionDelay:`${(7+i)*100}ms`}}><div className="flex items-center gap-2 mb-2"><span className="text-lg">{a.emoji}</span><span className="text-sm font-black text-text-main">{a.name}</span><span className="text-xs px-2 py-0.5 rounded-full font-bold" style={{background:'rgba(168,85,247,0.12)',color:'#a855f7'}}>Observer</span></div>{inf.agent_id === 'ba' ? <><p className="text-xs text-text-muted mb-1"><strong>Challenge:</strong> {inf.challenge}</p><p className="text-xs text-text-muted"><strong>Suggestion:</strong> {inf.suggestion}</p></> : <><p className="text-xs text-text-muted mb-1"><strong>Observation:</strong> {inf.observation}</p><p className="text-xs text-text-muted"><strong>Historical:</strong> {inf.historical_comparison}</p></>}</div>); })}</div>
                <div className={`pkr-super mt-4 ${revealed >= 9 ? 'pkr-super-show' : ''}`} style={{transitionDelay:'900ms'}}>
                    <div className="flex items-center gap-3 mb-4"><span className="text-2xl">🏆</span><div><h3 className="text-base font-black text-text-main">Chief Estimation Officer</h3><p className="text-xs text-text-muted">{sa.method_used || 'Multi-method'}</p></div><div className="ml-auto pkr-chip pkr-chip-lg">{adjPts ?? sa.final_points ?? '?'}</div></div>
                    <div className="grid grid-cols-4 gap-2 mb-4">{[{l:'PERT',v:sa.pert_estimate?.pert_fibonacci,s:`${sa.pert_estimate?.optimistic}/${sa.pert_estimate?.most_likely}/${sa.pert_estimate?.pessimistic}`},{l:'3-Point',v:sa.three_point_estimate?.fibonacci,s:`avg: ${sa.three_point_estimate?.raw}`},{l:'Historical',v:sa.historical_estimate?.fibonacci,s:sa.historical_estimate?.matched_story||'—'},{l:'Analogous',v:sa.analogous_estimate?.fibonacci,s:sa.analogous_estimate?.reference_key||'—'}].map((m,i) => <div key={i} className="pkr-method"><div className="text-[10px] font-bold text-text-muted uppercase mb-1">{m.l}</div><div className="text-lg font-black text-text-main">{m.v ?? '—'}</div><div className="text-[9px] text-text-muted truncate">{m.s}</div></div>)}</div>
                    <p className="text-sm text-text-main leading-relaxed">{sa.rationale}</p>
                </div>
                <div className="mt-4 p-4 rounded-xl" style={{background:'var(--bg-card)',border:'1px solid var(--border)'}}><h4 className="text-xs font-black text-text-muted uppercase tracking-widest mb-3">Vote Distribution</h4><div className="flex items-end gap-2 h-16">{fibScale.map(f => (<div key={f} className="flex-1 flex flex-col items-center"><div className="w-full rounded-t" style={{height:`${(voteDist[f] / maxVotes) * 48}px`,background: voteDist[f] > 0 ? 'linear-gradient(to top,#f59e0b,#fbbf24)' : 'var(--border)',minHeight: voteDist[f] > 0 ? 8 : 2,transition:'height 0.5s'}} /><span className="text-[10px] font-bold text-text-muted mt-1">{f}</span></div>))}</div></div>
                <div className="mt-4 p-4 rounded-xl" style={{background:'var(--bg-card)',border:'1px solid var(--border)'}}><h4 className="text-xs font-black text-text-muted uppercase tracking-widest mb-3">Adjust & Push</h4><div className="flex gap-2 mb-3">{[1,2,3,5,8,13,21].map(f => <button key={f} onClick={() => setAdjustments(p => ({...p, [cr.story_key]: {...(p[cr.story_key]||{}), points: f}}))} className="px-3 py-2 rounded-lg text-sm font-black border transition-all" style={{background: adjPts === f ? '#f59e0b' : 'var(--bg-body)', color: adjPts === f ? '#78350f' : 'var(--text-muted)', borderColor: adjPts === f ? '#f59e0b' : 'var(--border)'}}>{f}</button>)}</div></div>
                {currentIdx === results.length - 1 && <button onClick={pushToJira} className="mt-4 w-full p-4 rounded-xl text-white font-black text-base" style={{background:'var(--accent-gradient)'}}>🚀 Push All to Jira</button>}
            </div>
        );
    }
    return (
        <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4"><style>{pkrCSS}</style>
            <header className="pb-4 border-b border-border mb-6"><h2 className="text-3xl font-extrabold text-text-main">AI Planning Poker</h2><p className="text-sm text-text-muted mt-1">9 AI agents · AI-era estimation · PERT analysis · Real sprint history</p></header>
            {error && <div className="p-3 rounded-lg text-sm font-semibold mb-4" style={{background:'rgba(239,68,68,0.08)',border:'1px solid rgba(239,68,68,0.25)',color:'#ef4444'}}>{error}</div>}
            <div className="flex flex-wrap gap-2 mb-4">{agents.map(a => <span key={a.id} className="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold" style={{background:'var(--bg-card)',border:'1px solid var(--border)'}}>{a.emoji} {a.name} {!a.votes && <span className="text-[9px] px-1.5 py-0.5 rounded-full" style={{background:'rgba(168,85,247,0.12)',color:'#a855f7'}}>Observer</span>}</span>)}</div>
            <div className="flex gap-2 mb-4">
                <button onClick={() => setSource('sprint')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase border ${source === 'sprint' ? 'bg-primary text-white border-primary' : 'bg-bg-body text-text-muted border-border'}`}>🏃 Sprint</button>
                <button onClick={() => setSource('backlog')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase border ${source === 'backlog' ? 'bg-primary text-white border-primary' : 'bg-bg-body text-text-muted border-border'}`}>📋 Backlog</button>
                {source === 'sprint' && sprints.length > 0 && <select value={sprintId} onChange={e => setSprintId(e.target.value)} className="px-3 py-2 rounded-lg text-xs font-bold bg-bg-body border border-border text-text-main"><option value="active">Active Sprint</option>{sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>}
            </div>
            <div className="rounded-xl border overflow-hidden" style={{borderColor:'var(--border)',background:'var(--bg-card)'}}>
                <div className="p-3 flex justify-between items-center" style={{borderBottom:'1px solid var(--border)',background:'var(--bg-body)'}}><span className="text-sm font-black text-text-main">{stories.length} Stories</span><button onClick={() => setSelected(p => p.size === stories.length ? new Set() : new Set(stories.map(s => s.key)))} className="text-xs font-bold text-primary" style={{background:'none',border:'none',cursor:'pointer'}}>{selected.size === stories.length ? '✕ Deselect' : '☑ Select All'}</button></div>
                <div style={{maxHeight:350,overflowY:'auto'}}>{stories.map(s => (<div key={s.key} onClick={() => toggle(s.key)} className="flex items-center gap-3 px-4 py-2.5 text-sm cursor-pointer transition-all hover:bg-bg-body" style={{borderBottom:'1px solid var(--border)',background:selected.has(s.key)?'rgba(245,158,11,0.04)':'transparent'}}><div style={{width:18,height:18,borderRadius:4,border:selected.has(s.key)?'2px solid #f59e0b':'2px solid var(--border)',background:selected.has(s.key)?'#f59e0b':'transparent',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>{selected.has(s.key) && <span style={{fontSize:9,fontWeight:900,color:'#000'}}>✓</span>}</div><span className="font-bold font-mono text-xs" style={{color:'var(--primary)',minWidth:60}}>{s.key}</span><span className="flex-1 text-text-main font-medium truncate">{s.summary}</span><span className="text-xs font-bold px-2 py-0.5 rounded-full" style={{background:'rgba(59,130,246,0.1)',color:'#3b82f6'}}>{s.issue_type}</span>{s.current_points ? <span className="text-xs font-black text-text-muted">{s.current_points}pts</span> : null}</div>))}</div>
            </div>
            <button onClick={startPoker} disabled={!selected.size} className="mt-4 w-full p-4 rounded-xl text-white font-black text-lg disabled:opacity-40" style={{background:'var(--accent-gradient)'}}>🃏 Start Poker ({selected.size})</button>
        </div>
    );
}

// ═══════════════════════════════════════════════════════════
//  STRATEGIC ROADMAP — SAFe PI Planning Hub (5 Tabs)
// ═══════════════════════════════════════════════════════════
function RoadmapView({ project, setIsLoading }) {
    const [activeTab, setActiveTab] = React.useState("pi_planning");
    const [piPlan, setPiPlan] = React.useState(null);
    const [backlog, setBacklog] = React.useState(null);
    const [loadingBacklog, setLoadingBacklog] = React.useState(false);
    const [generating, setGenerating] = React.useState(false);
    const [error, setError] = React.useState(null);
    const [piName, setPiName] = React.useState('PI-1');
    const [numSprints, setNumSprints] = React.useState(5);
    const [velPerSprint, setVelPerSprint] = React.useState(40);
    const [selectedKeys, setSelectedKeys] = React.useState(new Set());
    const [teams, setTeams] = React.useState(['Core Team']);
    const [teamInput, setTeamInput] = React.useState('');
    // ROAM state
    const [roamRisks, setRoamRisks] = React.useState([]);
    const [roamLoading, setRoamLoading] = React.useState(false);
    const [newRisk, setNewRisk] = React.useState({ title: '', description: '', status: 'Owned', owner: '' });
    // Objectives state
    const [objectives, setObjectives] = React.useState([]);
    const [objLoading, setObjLoading] = React.useState(false);
    const [newObj, setNewObj] = React.useState({ name: '', planned_value: 5, epics: '' });

    const tabs = [
        { id: "pi_planning", label: "PI Planning", icon: "Calendar" },
        { id: "program_board", label: "Program Board", icon: "Grid" },
        { id: "capacity", label: "Capacity Heatmap", icon: "BarChart" },
        { id: "roam", label: "ROAM Risks", icon: "AlertTriangle" },
        { id: "objectives", label: "PI Objectives", icon: "Target" },
    ];

    // Load backlog
    const loadBacklog = async () => {
        setLoadingBacklog(true); setError(null);
        try {
            const res = await secureFetch(`/pi_planning/${project}/backlog`);
            const d = await res?.json();
            if (d?.stories) { setBacklog(d); setSelectedKeys(new Set(d.stories.map(s => s.key))); if (d.velocity?.average) setVelPerSprint(Math.round(d.velocity.average)); }
        } catch { setError('Failed to load backlog'); }
        setLoadingBacklog(false);
    };
    React.useEffect(() => { if (project) loadBacklog(); }, [project]);

    // Load ROAM
    React.useEffect(() => {
        if (project && activeTab === 'roam') {
            setRoamLoading(true);
            secureFetch(`/pi_planning/${project}/roam`, { method: 'POST', body: JSON.stringify({ action: 'load' }) })
                .then(r => r?.json()).then(d => { if (d?.risks) setRoamRisks(d.risks); }).finally(() => setRoamLoading(false));
        }
    }, [project, activeTab]);
    const saveRoam = async (risks) => {
        setRoamRisks(risks);
        await secureFetch(`/pi_planning/${project}/roam`, { method: 'POST', body: JSON.stringify({ action: 'save', risks }) });
    };

    // Load Objectives
    React.useEffect(() => {
        if (project && activeTab === 'objectives') {
            setObjLoading(true);
            secureFetch(`/pi_planning/${project}/objectives`, { method: 'POST', body: JSON.stringify({ action: 'load' }) })
                .then(r => r?.json()).then(d => { if (d?.objectives) setObjectives(d.objectives); }).finally(() => setObjLoading(false));
        }
    }, [project, activeTab]);
    const saveObjectives = async (objs) => {
        setObjectives(objs);
        await secureFetch(`/pi_planning/${project}/objectives`, { method: 'POST', body: JSON.stringify({ action: 'save', objectives: objs }) });
    };

    const toggleStory = k => setSelectedKeys(p => { const n = new Set(p); n.has(k) ? n.delete(k) : n.add(k); return n; });
    const totalCapacity = velPerSprint * numSprints;
    const selectedStories = (backlog?.stories || []).filter(s => selectedKeys.has(s.key));
    const selectedPoints = selectedStories.reduce((a, s) => a + (s.points || 0), 0);

    const generatePlan = async () => {
        if (!selectedStories.length) return; setGenerating(true); setError(null); setPiPlan(null);
        try {
            const res = await secureFetch(`/pi_planning/${project}/generate`, { method: 'POST', body: JSON.stringify({ stories: selectedStories, velocity_per_sprint: velPerSprint, num_sprints: numSprints, pi_name: piName, teams }) });
            const d = await res?.json();
            if (d?.sprints) setPiPlan(d); else setError(d?.error || 'Failed');
        } catch { setError('Failed'); }
        setGenerating(false);
    };

    const addTeam = () => { if (teamInput.trim() && !teams.includes(teamInput.trim())) { setTeams(p => [...p, teamInput.trim()]); setTeamInput(''); } };

    const piCSS = `.pi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px}.pi-sprint{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;overflow:hidden}.pi-sprint-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.pi-bar{height:6px;border-radius:3px;background:var(--border);overflow:hidden}.pi-bar-fill{height:100%;border-radius:3px;transition:width 0.5s}.pi-story-row{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:13px}.pi-story-row:last-child{border-bottom:none}.pi-chip{display:inline-flex;align-items:center;padding:2px 8px;border-radius:99px;font-size:10px;font-weight:700}.pi-input{padding:8px 12px;border-radius:8px;background:var(--bg-body);border:1px solid var(--border);color:var(--text-main);font-size:13px;font-weight:700;outline:none;width:80px;text-align:center}.pi-btn{background:var(--accent-gradient,linear-gradient(135deg,#f59e0b,#d97706));color:#000;font-weight:800;border:none;cursor:pointer;border-radius:10px;padding:10px 20px}.pi-btn:disabled{opacity:0.4}.pi-cutline{border:2px dashed #ef4444;background:rgba(239,68,68,0.05);border-radius:12px;padding:16px;margin:12px 0}.pi-dep-line{stroke:#ef4444;stroke-width:2;fill:none;stroke-dasharray:6,4}.roam-col{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;min-height:200px;padding:12px}.roam-card{background:var(--bg-body);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;cursor:grab}@keyframes piSlide{0%{transform:translateY(12px);opacity:0}100%{transform:translateY(0);opacity:1}}.pi-slide{animation:piSlide 0.35s ease-out forwards}`;

    return (
        <div className="h-full flex flex-col overflow-hidden">
            <style>{piCSS}</style>
            {/* Tab Bar */}
            <div className="flex items-center gap-1 pb-4 border-b border-border mb-4 flex-wrap">
                {tabs.map(tab => (
                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                        className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all border ${activeTab === tab.id ? 'bg-primary text-white border-primary shadow-lg' : 'bg-bg-card text-text-muted border-border hover:border-primary'}`}>
                        <Icon name={tab.icon} size={14} /> {tab.label}
                    </button>
                ))}
            </div>

            <main className="flex-1 overflow-y-auto pr-2 pb-12">
                {error && <div className="p-3 rounded-lg text-sm font-semibold mb-4" style={{background:'rgba(239,68,68,0.08)',border:'1px solid rgba(239,68,68,0.25)',color:'#ef4444'}}>{error}</div>}

                {/* ─── TAB 1: PI PLANNING SEQUENCER ─── */}
                {activeTab === "pi_planning" && !piPlan && (
                    <div className="space-y-4 animate-fade-in">
                        <div><h2 className="text-xl font-black text-text-main">PI Planning — Sequencer AI</h2><p className="text-sm text-text-muted mt-1">Sequence pre-pointed stories into sprints with hard capacity enforcement</p></div>
                        <div className="pi-card p-5"><h3 className="text-sm font-black text-text-main mb-3">PI Configuration</h3>
                            <div className="flex items-end gap-4 flex-wrap">
                                <div><label className="text-xs font-bold text-text-muted uppercase block mb-1">PI Name</label><input type="text" value={piName} onChange={e => setPiName(e.target.value)} className="pi-input" style={{width:100}} /></div>
                                <div><label className="text-xs font-bold text-text-muted uppercase block mb-1">Sprints</label><input type="number" value={numSprints} onChange={e => setNumSprints(Number(e.target.value))} min={2} max={10} className="pi-input" /></div>
                                <div><label className="text-xs font-bold text-text-muted uppercase block mb-1">Velocity/Sprint</label><input type="number" value={velPerSprint} onChange={e => setVelPerSprint(Number(e.target.value))} min={5} max={200} className="pi-input" /></div>
                                <div className="flex-1 p-3 rounded-lg" style={{background:'var(--bg-body)',border:'1px solid var(--border)'}}><span className="text-sm font-bold text-text-main">Capacity: <strong style={{color:'var(--primary)'}}>{totalCapacity} pts</strong></span>{backlog && <span className="text-sm text-text-muted ml-2">· Selected: <strong className={selectedPoints > totalCapacity ? 'text-danger' : 'text-success'}>{selectedPoints} pts</strong></span>}{selectedPoints > totalCapacity && <span className="pi-chip ml-2" style={{background:'rgba(239,68,68,0.12)',color:'#ef4444'}}>Over by {selectedPoints-totalCapacity}</span>}</div>
                            </div>
                            <div className="flex items-center gap-2 mt-3"><label className="text-xs font-bold text-text-muted uppercase">Teams:</label>{teams.map((t,i) => <span key={i} className="pi-chip" style={{background:'rgba(59,130,246,0.1)',color:'#3b82f6'}}>{t} <button onClick={() => setTeams(p => p.filter((_,j) => j!==i))} className="ml-1 text-danger" style={{fontSize:8,cursor:'pointer'}}>✕</button></span>)}<input type="text" value={teamInput} onChange={e => setTeamInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addTeam()} placeholder="Add team..." className="pi-input" style={{width:120,textAlign:'left'}} /><button onClick={addTeam} className="text-xs font-bold text-primary" style={{cursor:'pointer'}}>+Add</button></div>
                        </div>
                        {loadingBacklog ? <div className="text-center py-12"><Icon name="Loader2" size={32} className="animate-spin text-primary mx-auto" /><p className="text-sm font-bold text-text-muted mt-3">Loading backlog...</p></div> :
                        backlog?.stories?.length > 0 ? (<div className="pi-card overflow-hidden">
                            <div className="p-4 flex items-center justify-between" style={{borderBottom:'1px solid var(--border)',background:'var(--bg-body)'}}><span className="text-sm font-black text-text-main">{backlog.stories.length} Pre-Pointed Stories ({backlog.total_points} pts)</span><div className="flex gap-3"><button onClick={() => setSelectedKeys(p => p.size===backlog.stories.length ? new Set() : new Set(backlog.stories.map(s=>s.key)))} className="text-xs font-bold text-primary" style={{background:'none',border:'none',cursor:'pointer'}}>{selectedKeys.size===backlog.stories.length?'Deselect All':'Select All'}</button><button onClick={generatePlan} disabled={generating||!selectedStories.length} className="pi-btn text-sm">{generating?'⏳ Sequencing...':'🧩 Generate PI Plan'}</button></div></div>
                            <div style={{maxHeight:400,overflowY:'auto'}}>{backlog.stories.map(s => (<div key={s.key} onClick={() => toggleStory(s.key)} className="pi-story-row cursor-pointer" style={{background:selectedKeys.has(s.key)?'rgba(245,158,11,0.04)':'transparent'}}><div style={{width:18,height:18,borderRadius:4,border:selectedKeys.has(s.key)?'2px solid #f59e0b':'2px solid var(--border)',background:selectedKeys.has(s.key)?'#f59e0b':'transparent',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>{selectedKeys.has(s.key) && <span style={{fontSize:9,fontWeight:900,color:'#000'}}>✓</span>}</div><span className="font-bold font-mono text-xs" style={{color:'var(--primary)',minWidth:70}}>{s.key}</span><span className="flex-1 text-text-main font-medium truncate text-sm">{s.summary}</span><span className="pi-chip" style={{background:'rgba(59,130,246,0.12)',color:'#3b82f6'}}>{s.type}</span><span className="pi-chip" style={{background:s.priority==='Highest'||s.priority==='High'?'rgba(239,68,68,0.12)':'rgba(234,179,8,0.12)',color:s.priority==='Highest'||s.priority==='High'?'#ef4444':'#eab308'}}>{s.priority}</span><span className="text-sm font-black text-text-main" style={{minWidth:36,textAlign:'right'}}>{s.points}pts</span></div>))}</div>
                        </div>) : <div className="pi-card p-12 text-center"><p className="text-text-muted font-semibold">No pre-pointed stories found. Run Planning Poker first.</p></div>}
                    </div>
                )}

                {/* PI Plan Results + Gantt */}
                {activeTab === "pi_planning" && piPlan && (
                    <div className="space-y-4 animate-fade-in">
                        <div className="flex items-center justify-between"><div><h2 className="text-xl font-black text-text-main">{piPlan.pi_name} — Sprint Sequence</h2><p className="text-sm text-text-muted mt-1">{piPlan.total_committed || 0} pts committed{(piPlan.spillover||[]).length > 0 && ` · ${piPlan.total_spillover || 0} pts spillover`}</p></div><button onClick={() => setPiPlan(null)} className="px-4 py-2 text-xs font-bold uppercase rounded-lg border text-text-muted" style={{borderColor:'var(--border)',background:'var(--bg-card)'}}>← Reconfigure</button></div>
                        {/* GANTT VIEW */}
                        <div className="pi-card p-5 overflow-x-auto"><h3 className="text-xs font-black text-text-muted uppercase tracking-widest mb-4">📊 Gantt View</h3>
                            <div style={{minWidth: numSprints * 140 + 200}}>
                                <div className="flex" style={{borderBottom:'1px solid var(--border)',paddingBottom:8,marginBottom:8}}><div style={{width:200,flexShrink:0}} className="text-xs font-black text-text-muted">Story</div>{(piPlan.sprints||[]).map((sp,i) => <div key={i} style={{flex:1,minWidth:120}} className="text-xs font-black text-text-muted text-center">{sp.name}</div>)}</div>
                                {(piPlan.sprints||[]).flatMap(sp => (sp.stories||[]).map(s => ({...s, sprint: sp.name, sprintIdx: (piPlan.sprints||[]).indexOf(sp)}))).reduce((acc, s) => { if (!acc.find(x => x.key === s.key)) acc.push(s); return acc; }, []).slice(0,30).map((s, si) => {
                                    const spIdx = s.sprintIdx; const span = Math.max(1, Math.ceil(s.points / 5));
                                    return (<div key={si} className="flex items-center" style={{marginBottom:3,minHeight:28}}>
                                        <div style={{width:200,flexShrink:0}} className="text-xs font-medium text-text-main truncate pr-2" title={s.summary}><span className="font-mono font-bold text-primary">{s.key}</span> {s.summary?.substring(0,25)}{(s.summary||'').length > 25 ? '...' : ''}</div>
                                        <div className="flex flex-1">{Array.from({length: numSprints}).map((_, i) => (<div key={i} style={{flex:1,minWidth:120,padding:'2px 4px'}}>{i === spIdx && <div className="rounded-md px-2 py-1 text-[10px] font-bold text-white truncate" style={{background: s.priority === 'High' || s.priority === 'Highest' ? '#ef4444' : s.priority === 'Medium' ? '#f59e0b' : '#3b82f6', width: `${Math.min(100, span * 50)}%`, minWidth: 60}}>{s.points}pts</div>}</div>))}</div>
                                    </div>);
                                })}
                            </div>
                        </div>
                        {/* Sprint Cards */}
                        {(piPlan.sprints||[]).map((sprint, si) => { const util = sprint.utilization_pct || Math.round((sprint.committed_points / velPerSprint)*100); const barColor = util > 95 ? '#ef4444' : util > 80 ? '#f59e0b' : '#22c55e'; return (
                            <div key={si} className="pi-sprint pi-slide" style={{animationDelay:`${si*80}ms`}}>
                                <div className="pi-sprint-hdr"><div><span className="text-sm font-black text-text-main">{sprint.name}</span><span className="text-xs text-text-muted ml-2">{sprint.committed_points||0}/{sprint.capacity||velPerSprint}pts</span></div><div className="flex items-center gap-2"><div className="pi-bar" style={{width:100}}><div className="pi-bar-fill" style={{width:`${Math.min(util,100)}%`,background:barColor}}></div></div><span className="text-xs font-bold" style={{color:barColor}}>{util}%</span></div></div>
                                {(sprint.stories||[]).map((s,idx) => (<div key={idx} className="pi-story-row"><span className="font-bold font-mono text-xs" style={{color:'var(--primary)',minWidth:70}}>{s.key}</span><span className="flex-1 text-text-main font-medium truncate">{s.summary}</span>{s.team && <span className="pi-chip" style={{background:'rgba(59,130,246,0.12)',color:'#3b82f6'}}>{s.team}</span>}<span className="pi-chip" style={{background:s.priority==='High'||s.priority==='Highest'?'rgba(239,68,68,0.12)':'rgba(234,179,8,0.12)',color:s.priority==='High'||s.priority==='Highest'?'#ef4444':'#eab308'}}>{s.priority}</span><span className="text-sm font-black text-text-main" style={{minWidth:36,textAlign:'right'}}>{s.points}pts</span></div>))}
                            </div>); })}
                        {/* Spillover */}
                        {(piPlan.spillover||[]).length > 0 && (<div className="pi-cutline text-center"><p className="text-sm font-black text-danger mb-3">🚫 Capacity Cut-Line — {piPlan.total_spillover||0} pts unscheduled</p>{(piPlan.spillover||[]).map((s,i) => <div key={i} className="pi-story-row justify-center"><span className="font-mono font-bold text-xs text-danger">{s.key}</span><span className="text-text-muted font-medium truncate">{s.summary}</span><span className="font-black text-text-muted">{s.points}pts</span></div>)}</div>)}
                        {/* Dependencies */}
                        {(piPlan.dependencies||[]).length > 0 && <div className="pi-card p-5"><h3 className="text-xs font-black text-text-muted uppercase tracking-widest mb-3">🔗 Dependencies</h3>{piPlan.dependencies.map((d,i) => <div key={i} className="flex items-center gap-3 text-xs p-2 rounded-lg mb-1" style={{background:'var(--bg-body)'}}><span className="font-bold font-mono text-primary">{d.from}</span><span className="text-danger">→</span><span className="font-bold font-mono" style={{color:'#a855f7'}}>{d.to}</span><span className="text-text-muted flex-1">{d.reason}</span></div>)}</div>}
                        {piPlan.sequencing_rationale && <div className="pi-card p-5"><h3 className="text-xs font-black text-text-muted uppercase mb-2">📋 Rationale</h3><p className="text-sm text-text-main leading-relaxed">{piPlan.sequencing_rationale}</p></div>}
                        {(piPlan.risks||[]).length > 0 && <div className="pi-card p-5" style={{borderLeft:'4px solid #f59e0b'}}><h3 className="text-xs font-black uppercase mb-2" style={{color:'#f59e0b'}}>⚠️ Risks</h3>{piPlan.risks.map((r,i) => <p key={i} className="text-sm text-text-muted mt-1">• {r}</p>)}</div>}
                    </div>
                )}

                {/* ─── TAB 2: PROGRAM BOARD — Red String Dependency Matrix ─── */}
                {activeTab === "program_board" && (
                    <div className="space-y-4 animate-fade-in">
                        <div><h2 className="text-xl font-black text-text-main">Program Board — Dependency Matrix</h2><p className="text-sm text-text-muted mt-1">The "Red String" board: Teams × Sprints with auto-detected dependency lines</p></div>
                        {piPlan ? (() => {
                            const sprintNames = (piPlan.sprints||[]).map(s => s.name);
                            const allTeams = [...new Set((piPlan.sprints||[]).flatMap(sp => (sp.stories||[]).map(s => s.team || 'Unassigned')))];
                            if (!allTeams.length) allTeams.push('Core Team');
                            const deps = piPlan.dependencies || [];
                            const storyMap = {};
                            (piPlan.sprints||[]).forEach((sp, si) => (sp.stories||[]).forEach(s => { storyMap[s.key] = { ...s, sprintIdx: si, sprint: sp.name }; }));
                            return (<>
                                <div className="pi-card overflow-x-auto p-4">
                                    <svg style={{position:'absolute',top:0,left:0,width:'100%',height:'100%',pointerEvents:'none',zIndex:5}}>
                                        {deps.map((d,i) => {
                                            const from = storyMap[d.from]; const to = storyMap[d.to];
                                            if (!from || !to) return null;
                                            return <line key={i} x1={200 + from.sprintIdx * 180 + 90} y1={60 + allTeams.indexOf(from.team || 'Unassigned') * 80 + 40} x2={200 + to.sprintIdx * 180 + 90} y2={60 + allTeams.indexOf(to.team || 'Unassigned') * 80 + 40} className="pi-dep-line" markerEnd="url(#arrowhead)" />;
                                        })}
                                        <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ef4444" /></marker></defs>
                                    </svg>
                                    <div style={{minWidth: sprintNames.length * 180 + 200, position: 'relative'}}>
                                        {/* Header */}
                                        <div className="flex" style={{borderBottom:'2px solid var(--border)',paddingBottom:8,marginBottom:4}}>
                                            <div style={{width:200,flexShrink:0}} className="text-xs font-black text-text-muted uppercase">Team / Track</div>
                                            {sprintNames.map((sp,i) => <div key={i} style={{width:180,flexShrink:0}} className="text-xs font-black text-text-muted text-center uppercase">{sp}</div>)}
                                        </div>
                                        {/* Rows */}
                                        {allTeams.map((team, ti) => (
                                            <div key={ti} className="flex" style={{borderBottom:'1px solid var(--border)',minHeight:80}}>
                                                <div style={{width:200,flexShrink:0,display:'flex',alignItems:'center'}} className="text-sm font-black text-text-main px-2"><span className="pi-chip" style={{background:'rgba(59,130,246,0.1)',color:'#3b82f6'}}>{team}</span></div>
                                                {sprintNames.map((sp, si) => {
                                                    const storiesInCell = (piPlan.sprints[si]?.stories||[]).filter(s => (s.team || 'Unassigned') === team);
                                                    return (<div key={si} style={{width:180,flexShrink:0,padding:4,borderLeft:'1px solid var(--border)'}}>
                                                        {storiesInCell.map((s,j) => {
                                                            const hasDep = deps.some(d => d.from === s.key || d.to === s.key);
                                                            return (<div key={j} className="rounded-lg p-2 mb-1 text-xs" style={{background: hasDep ? 'rgba(239,68,68,0.08)' : 'var(--bg-body)', border: hasDep ? '1px solid rgba(239,68,68,0.3)' : '1px solid var(--border)'}}>
                                                                <div className="font-bold font-mono" style={{color: hasDep ? '#ef4444' : 'var(--primary)',fontSize:10}}>{s.key}</div>
                                                                <div className="text-text-muted truncate" style={{fontSize:10}}>{s.summary?.substring(0,30)}</div>
                                                                <div className="font-black mt-0.5">{s.points}pts {hasDep && <span style={{color:'#ef4444'}}>🔗</span>}</div>
                                                            </div>);
                                                        })}
                                                    </div>);
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {deps.length > 0 && <div className="pi-card p-4"><h3 className="text-xs font-black text-text-muted uppercase mb-2">🔴 Red Strings ({deps.length})</h3>{deps.map((d,i) => <div key={i} className="flex items-center gap-2 text-xs p-2 rounded mb-1" style={{background:'rgba(239,68,68,0.04)'}}><span className="font-mono font-bold text-primary">{d.from}</span><span style={{color:'#ef4444'}}>⟶ {d.type} ⟶</span><span className="font-mono font-bold" style={{color:'#a855f7'}}>{d.to}</span><span className="text-text-muted">{d.reason}</span></div>)}</div>}
                            </>);
                        })() : <div className="pi-card p-12 text-center"><p className="text-text-muted font-semibold">Generate a PI Plan first to see the Program Board.</p><button onClick={() => setActiveTab('pi_planning')} className="pi-btn mt-4 text-sm">Go to PI Planning →</button></div>}
                    </div>
                )}

                {/* ─── TAB 3: CAPACITY vs LOAD HEATMAP ─── */}
                {activeTab === "capacity" && (
                    <div className="space-y-4 animate-fade-in">
                        <div><h2 className="text-xl font-black text-text-main">Capacity vs. Load Heatmap</h2><p className="text-sm text-text-muted mt-1">Per-team, per-sprint load visualization. Red = over-allocated. Forces mathematical honesty.</p></div>
                        {piPlan ? (() => {
                            const sprintNames = (piPlan.sprints||[]).map(s => s.name);
                            const allTeams = [...new Set((piPlan.sprints||[]).flatMap(sp => (sp.stories||[]).map(s => s.team || 'Core Team')))];
                            const teamCap = Math.round(velPerSprint / Math.max(1, allTeams.length));
                            return (<>
                                <div className="pi-card p-5"><span className="text-xs font-bold text-text-muted">Velocity/Sprint: <strong className="text-primary">{velPerSprint} pts</strong> · Teams: <strong>{allTeams.length}</strong> · Capacity/Team/Sprint: <strong style={{color:'#22c55e'}}>{teamCap} pts</strong></span></div>
                                <div className="grid gap-4" style={{gridTemplateColumns: `repeat(${Math.min(sprintNames.length, 5)}, 1fr)`}}>
                                    {sprintNames.map((sp, si) => {
                                        const sprintData = piPlan.sprints[si];
                                        const totalUtil = sprintData?.utilization_pct || Math.round(((sprintData?.committed_points||0) / velPerSprint) * 100);
                                        return (<div key={si} className="pi-card p-4 pi-slide" style={{animationDelay:`${si*60}ms`}}>
                                            <h3 className="text-sm font-black text-text-main mb-1">{sp}</h3>
                                            <div className="pi-bar mb-3" style={{height:10}}><div className="pi-bar-fill" style={{width:`${Math.min(totalUtil,100)}%`,background:totalUtil>95?'#ef4444':totalUtil>80?'#f59e0b':'#22c55e'}}></div></div>
                                            <div className="text-xs font-bold mb-3" style={{color:totalUtil>95?'#ef4444':totalUtil>80?'#f59e0b':'#22c55e'}}>{sprintData?.committed_points||0}/{velPerSprint} pts ({totalUtil}%)</div>
                                            {allTeams.map((team, ti) => {
                                                const pts = (sprintData?.stories||[]).filter(s => (s.team || 'Core Team') === team).reduce((a,s) => a + (s.points||0), 0);
                                                const pct = Math.round((pts / Math.max(1, teamCap)) * 100);
                                                const over = pct > 100;
                                                return (<div key={ti} className="mb-2">
                                                    <div className="flex justify-between text-[10px] font-bold mb-0.5"><span className="text-text-muted">{team}</span><span style={{color: over ? '#ef4444' : pct > 80 ? '#f59e0b' : '#22c55e'}}>{pts}/{teamCap}pts</span></div>
                                                    <div className="pi-bar" style={{height:8}}><div className="pi-bar-fill" style={{width:`${Math.min(pct,100)}%`,background: over ? '#ef4444' : pct > 80 ? '#f59e0b' : '#22c55e'}}></div></div>
                                                    {over && <div className="text-[9px] font-bold mt-0.5" style={{color:'#ef4444'}}>⚠ Over by {pts - teamCap} pts ({pct}%)</div>}
                                                </div>);
                                            })}
                                        </div>);
                                    })}
                                </div>
                            </>);
                        })() : <div className="pi-card p-12 text-center"><p className="text-text-muted font-semibold">Generate a PI Plan first to see capacity data.</p><button onClick={() => setActiveTab('pi_planning')} className="pi-btn mt-4 text-sm">Go to PI Planning →</button></div>}
                    </div>
                )}

                {/* ─── TAB 4: ROAM RISK REGISTER ─── */}
                {activeTab === "roam" && (
                    <div className="space-y-4 animate-fade-in">
                        <div><h2 className="text-xl font-black text-text-main">ROAM Risk Register</h2><p className="text-sm text-text-muted mt-1">Resolved · Owned · Accepted · Mitigated — Drag risks between columns</p></div>
                        {/* Add Risk */}
                        <div className="pi-card p-4">
                            <div className="flex gap-2 flex-wrap items-end">
                                <div className="flex-1"><label className="text-xs font-bold text-text-muted uppercase block mb-1">Risk Title</label><input type="text" value={newRisk.title} onChange={e => setNewRisk(p => ({...p, title: e.target.value}))} placeholder="e.g., Cloud license not secured" className="w-full p-2.5 rounded-lg border bg-bg-body text-text-main text-sm font-bold border-border outline-none" /></div>
                                <div style={{width:140}}><label className="text-xs font-bold text-text-muted uppercase block mb-1">Status</label><select value={newRisk.status} onChange={e => setNewRisk(p => ({...p, status: e.target.value}))} className="w-full p-2.5 rounded-lg border bg-bg-body text-text-main text-sm font-bold border-border outline-none">{['Resolved','Owned','Accepted','Mitigated'].map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                <div style={{width:120}}><label className="text-xs font-bold text-text-muted uppercase block mb-1">Owner</label><input type="text" value={newRisk.owner} onChange={e => setNewRisk(p => ({...p, owner: e.target.value}))} placeholder="Who?" className="w-full p-2.5 rounded-lg border bg-bg-body text-text-main text-sm font-bold border-border outline-none" /></div>
                                <button onClick={() => { if (!newRisk.title.trim()) return; const updated = [...roamRisks, { ...newRisk, id: Date.now() }]; saveRoam(updated); setNewRisk({ title: '', description: '', status: 'Owned', owner: '' }); }} className="pi-btn text-sm px-4 py-2.5">+ Add Risk</button>
                            </div>
                        </div>
                        {/* ROAM Kanban */}
                        <div className="grid grid-cols-4 gap-3">
                            {[{s:'Resolved',c:'#22c55e',e:'✅'},{s:'Owned',c:'#3b82f6',e:'👤'},{s:'Accepted',c:'#f59e0b',e:'⚡'},{s:'Mitigated',c:'#a855f7',e:'🛡️'}].map(col => (
                                <div key={col.s} className="roam-col">
                                    <div className="flex items-center gap-2 mb-3 pb-2" style={{borderBottom:`2px solid ${col.c}`}}><span className="text-lg">{col.e}</span><span className="text-xs font-black uppercase tracking-widest" style={{color:col.c}}>{col.s}</span><span className="pi-chip ml-auto" style={{background:`${col.c}20`,color:col.c}}>{roamRisks.filter(r => r.status === col.s).length}</span></div>
                                    {roamRisks.filter(r => r.status === col.s).map((risk, i) => (
                                        <div key={risk.id || i} className="roam-card">
                                            <div className="text-xs font-black text-text-main mb-1">{risk.title}</div>
                                            {risk.owner && <div className="text-[10px] text-text-muted">👤 {risk.owner}</div>}
                                            <div className="flex gap-1 mt-2">{['Resolved','Owned','Accepted','Mitigated'].filter(s => s !== risk.status).map(s => <button key={s} onClick={() => { const updated = roamRisks.map(r => r.id === risk.id ? {...r, status: s} : r); saveRoam(updated); }} className="text-[8px] font-bold px-1.5 py-0.5 rounded border" style={{borderColor:'var(--border)',color:'var(--text-muted)',cursor:'pointer'}}>→{s}</button>)}</div>
                                            <button onClick={() => saveRoam(roamRisks.filter(r => r.id !== risk.id))} className="text-[8px] text-danger mt-1 font-bold" style={{cursor:'pointer'}}>Remove</button>
                                        </div>
                                    ))}
                                    {roamRisks.filter(r => r.status === col.s).length === 0 && <div className="text-center text-xs text-text-muted py-4 opacity-50">No {col.s.toLowerCase()} risks</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* ─── TAB 5: PI OBJECTIVES & BUSINESS VALUE ─── */}
                {activeTab === "objectives" && (
                    <div className="space-y-4 animate-fade-in">
                        <div><h2 className="text-xl font-black text-text-main">PI Objectives & Business Value</h2><p className="text-sm text-text-muted mt-1">Map delivery output to business goals. Track planned vs actual value delivery.</p></div>
                        {/* Add Objective */}
                        <div className="pi-card p-4">
                            <div className="flex gap-2 flex-wrap items-end">
                                <div className="flex-1"><label className="text-xs font-bold text-text-muted uppercase block mb-1">Objective</label><input type="text" value={newObj.name} onChange={e => setNewObj(p => ({...p, name: e.target.value}))} placeholder="e.g., Launch One-Click Checkout" className="w-full p-2.5 rounded-lg border bg-bg-body text-text-main text-sm font-bold border-border outline-none" /></div>
                                <div style={{width:120}}><label className="text-xs font-bold text-text-muted uppercase block mb-1">Planned Value (1-10)</label><input type="number" value={newObj.planned_value} onChange={e => setNewObj(p => ({...p, planned_value: Number(e.target.value)}))} min={1} max={10} className="pi-input" /></div>
                                <div className="flex-1"><label className="text-xs font-bold text-text-muted uppercase block mb-1">Linked Epic Keys (comma-sep)</label><input type="text" value={newObj.epics} onChange={e => setNewObj(p => ({...p, epics: e.target.value}))} placeholder="PROJ-1, PROJ-2" className="w-full p-2.5 rounded-lg border bg-bg-body text-text-main text-sm font-bold border-border outline-none" /></div>
                                <button onClick={() => { if (!newObj.name.trim()) return; saveObjectives([...objectives, { ...newObj, id: Date.now(), actual_value: 0, epics: newObj.epics.split(',').map(e => e.trim()).filter(Boolean) }]); setNewObj({ name: '', planned_value: 5, epics: '' }); }} className="pi-btn text-sm px-4 py-2.5">+ Add</button>
                            </div>
                        </div>
                        {/* Objectives List */}
                        <div className="space-y-3">
                            {objectives.map((obj, i) => {
                                const pctDelivered = Math.round((obj.actual_value / Math.max(1, obj.planned_value)) * 100);
                                const atRisk = pctDelivered < 50 && obj.planned_value >= 5;
                                return (<div key={obj.id || i} className="pi-card p-5 pi-slide" style={{animationDelay:`${i*60}ms`, borderLeft: atRisk ? '4px solid #ef4444' : '4px solid #22c55e'}}>
                                    <div className="flex items-center justify-between mb-3">
                                        <div><h3 className="text-base font-black text-text-main">{obj.name}</h3><div className="flex gap-1 mt-1">{(obj.epics||[]).map((e,j) => <span key={j} className="pi-chip" style={{background:'rgba(59,130,246,0.1)',color:'#3b82f6'}}>{e}</span>)}</div></div>
                                        <div className="text-right"><div className="text-2xl font-black" style={{color: atRisk ? '#ef4444' : '#22c55e'}}>{obj.actual_value}/{obj.planned_value}</div><div className="text-[10px] font-bold text-text-muted uppercase">Business Value</div></div>
                                    </div>
                                    <div className="pi-bar mb-2" style={{height:10}}><div className="pi-bar-fill" style={{width:`${pctDelivered}%`,background: atRisk ? '#ef4444' : pctDelivered > 70 ? '#22c55e' : '#f59e0b'}}></div></div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs font-bold" style={{color: atRisk ? '#ef4444' : '#22c55e'}}>{pctDelivered}% delivered {atRisk && '— AT RISK ⚠️'}</span>
                                        <div className="flex items-center gap-2">
                                            <label className="text-[10px] font-bold text-text-muted">Actual:</label>
                                            <input type="number" value={obj.actual_value} onChange={e => { const updated = objectives.map((o,j) => j===i ? {...o, actual_value: Number(e.target.value)} : o); saveObjectives(updated); }} min={0} max={10} className="pi-input" style={{width:60}} />
                                            <button onClick={() => saveObjectives(objectives.filter((_,j) => j!==i))} className="text-xs text-danger font-bold" style={{cursor:'pointer'}}>✕ Remove</button>
                                        </div>
                                    </div>
                                </div>);
                            })}
                            {objectives.length === 0 && <div className="pi-card p-12 text-center"><p className="text-text-muted font-semibold">No PI Objectives defined yet. Add objectives above to track business value.</p></div>}
                        </div>
                        {/* Summary */}
                        {objectives.length > 0 && (<div className="pi-card p-5" style={{background:'var(--bg-body)'}}>
                            <h3 className="text-xs font-black text-text-muted uppercase mb-3">📊 Business Value Summary</h3>
                            <div className="grid grid-cols-3 gap-4">
                                <div className="text-center"><div className="text-2xl font-black text-primary">{objectives.reduce((a,o) => a + o.planned_value, 0)}</div><div className="text-[10px] font-bold text-text-muted uppercase">Total Planned</div></div>
                                <div className="text-center"><div className="text-2xl font-black text-success">{objectives.reduce((a,o) => a + (o.actual_value||0), 0)}</div><div className="text-[10px] font-bold text-text-muted uppercase">Total Actual</div></div>
                                <div className="text-center"><div className="text-2xl font-black" style={{color: objectives.filter(o => o.actual_value < o.planned_value * 0.5 && o.planned_value >= 5).length > 0 ? '#ef4444' : '#22c55e'}}>{objectives.filter(o => o.actual_value < o.planned_value * 0.5 && o.planned_value >= 5).length}</div><div className="text-[10px] font-bold text-text-muted uppercase">At Risk</div></div>
                            </div>
                        </div>)}
                    </div>
                )}
            </main>
        </div>
    );
}

// ── Main Production Component ──

        /* ══════════════════════════════════════════════════════════════════
           ★ PREMIUM SLIDE SYSTEM — Rich Corporate Deck with Geometric Art
           ══════════════════════════════════════════════════════════════════ */

        /* --- Geometric Background Elements --- */
        const GeoBgHero = () => (
            <div style={{ position: 'absolute', inset: 0, overflow: 'hidden', pointerEvents: 'none' }}>
                {/* Large gradient mesh */}
                <div style={{ position: 'absolute', top: '-20%', right: '-10%', width: '70%', height: '70%', background: 'radial-gradient(ellipse, var(--slide-accent) 0%, transparent 65%)', opacity: 0.08, filter: 'blur(60px)' }} />
                <div style={{ position: 'absolute', bottom: '-15%', left: '-5%', width: '50%', height: '60%', background: 'radial-gradient(ellipse, var(--slide-accent-2) 0%, transparent 65%)', opacity: 0.06, filter: 'blur(50px)' }} />
                {/* Geometric grid pattern */}
                <svg style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', opacity: 0.035 }} xmlns="http://www.w3.org/2000/svg">
                    <defs><pattern id="heroGrid" width="80" height="80" patternUnits="userSpaceOnUse">
                        <path d="M80 0L0 80M-20 20L20 -20M60 100L100 60" stroke="var(--slide-accent)" strokeWidth="0.5" fill="none" />
                    </pattern></defs>
                    <rect width="100%" height="100%" fill="url(#heroGrid)" />
                </svg>
                {/* Corner accent arcs */}
                <svg style={{ position: 'absolute', top: 0, right: 0, width: '400px', height: '400px', opacity: 0.06 }} viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="400" cy="0" r="300" stroke="var(--slide-accent)" strokeWidth="1" />
                    <circle cx="400" cy="0" r="200" stroke="var(--slide-accent-2)" strokeWidth="0.5" />
                    <circle cx="400" cy="0" r="100" stroke="var(--slide-accent)" strokeWidth="0.3" />
                </svg>
                <svg style={{ position: 'absolute', bottom: 0, left: 0, width: '300px', height: '300px', opacity: 0.04 }} viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="0" cy="300" r="250" stroke="var(--slide-accent-2)" strokeWidth="1" />
                    <circle cx="0" cy="300" r="150" stroke="var(--slide-accent)" strokeWidth="0.5" />
                </svg>
            </div>
        );

        const GeoBgContent = () => (
            <div style={{ position: 'absolute', inset: 0, overflow: 'hidden', pointerEvents: 'none' }}>
                <div style={{ position: 'absolute', top: '-10%', right: '-5%', width: '45%', height: '45%', background: 'radial-gradient(ellipse, var(--slide-accent) 0%, transparent 70%)', opacity: 0.05, filter: 'blur(80px)' }} />
                <svg style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', opacity: 0.025 }} xmlns="http://www.w3.org/2000/svg">
                    <defs><pattern id="dotP" width="40" height="40" patternUnits="userSpaceOnUse">
                        <circle cx="2" cy="2" r="1" fill="var(--slide-accent)" />
                    </pattern></defs>
                    <rect width="100%" height="100%" fill="url(#dotP)" />
                </svg>
            </div>
        );

        const GeoBgFlow = () => (
            <div style={{ position: 'absolute', inset: 0, overflow: 'hidden', pointerEvents: 'none' }}>
                <div style={{ position: 'absolute', bottom: '-20%', left: '20%', width: '60%', height: '50%', background: 'radial-gradient(ellipse, var(--slide-accent-3) 0%, transparent 70%)', opacity: 0.06, filter: 'blur(70px)' }} />
                <svg style={{ position: 'absolute', inset: 0, width: '100%', height: '100%', opacity: 0.03 }} xmlns="http://www.w3.org/2000/svg">
                    <defs><pattern id="diagP" width="30" height="30" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                        <line x1="0" y1="0" x2="0" y2="30" stroke="var(--slide-accent-3)" strokeWidth="0.5" />
                    </pattern></defs>
                    <rect width="100%" height="100%" fill="url(#diagP)" />
                </svg>
            </div>
        );

        const SectionLabel = ({ text, icon }) => (
            <motion.div initial={{ opacity: 0, x: -20 }} whileInView={{ opacity: 1, x: 0 }} viewport={{ once: true }} transition={{ duration: 0.6, ease: [0.16, 1, 0.3, 1] }} style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' }}>
                <div style={{ width: '28px', height: '2px', borderRadius: '1px', flexShrink: 0, background: 'var(--slide-accent)' }} />
                {icon && <span style={{ color: 'var(--slide-accent)', display: 'flex', alignItems: 'center' }}>{icon}</span>}
                <span style={{ fontSize: '11px', fontWeight: 700, letterSpacing: '0.15em', textTransform: 'uppercase', color: 'var(--slide-accent)', fontFamily: "'Outfit',sans-serif" }}>{text}</span>
            </motion.div>
        );

        /* --- Slide Icon Mapper (replaces emojis) --- */
        const SlideIcon = ({ name, size = 28, gradient = false }) => {
            const iconMap = { 'hero': 'Globe', 'summary': 'FileText', 'metrics': 'BarChart', 'kpi': 'BarChart', 'risks': 'Shield', 'blockers': 'AlertTriangle', 'flow': 'GitBranch', 'plan': 'Target', 'team': 'Users', 'velocity': 'TrendingUp', 'sprint': 'Zap', 'timeline': 'Clock' };
            const iconName = iconMap[name] || 'Layers';
            if (gradient) {
                return (
                    <div style={{ width: size + 16, height: size + 16, borderRadius: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--accent-gradient)', boxShadow: '0 4px 20px var(--slide-glow)' }}>
                        <Icon name={iconName} size={size} className="" style={{ color: 'white' }} />
                    </div>
                );
            }
            return <Icon name={iconName} size={size} />;
        };

        /* ═══════════════════════════════════════
           ★ RENDER SLIDE — Premium Layouts
           ═══════════════════════════════════════ */
        function RenderSlide({ slide, isActive }) {
            const layout = slide.layout || 'standard';
            const safeItems = Array.isArray(slide.items) ? slide.items : (slide.items ? [{ title: slide.items, label: "Item", value: slide.items, text: slide.items }] : []);
            const safeContent = Array.isArray(slide.content) ? slide.content : (slide.content ? [slide.content] : []);

            const V = { once: true, amount: 0.25 };
            const fadeUp = { initial: { opacity: 0, y: 32, filter: 'blur(6px)' }, whileInView: { opacity: 1, y: 0, filter: 'blur(0)' }, viewport: V, transition: { duration: 0.75, ease: [0.16, 1, 0.3, 1] } };
            const fadeIn = { initial: { opacity: 0 }, whileInView: { opacity: 1 }, viewport: V, transition: { duration: 0.65, ease: [0.16, 1, 0.3, 1] } };

            const accentColors = ['var(--slide-accent)', 'var(--slide-accent-2)', 'var(--slide-accent-3)', 'var(--slide-accent-4)'];

            // ——— HERO — Premium Corporate Title Slide ———
            if (layout === 'hero') return (
                <div className="slide-root" style={{ width: '100%', height: '100%', background: 'var(--slide-bg)', position: 'relative', overflow: 'hidden', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', textAlign: 'center', padding: '72px 80px', fontFamily: "'Outfit',sans-serif" }}>
                    <GeoBgHero />

                    {/* Gradient glass orb behind title */}
                    <div className="orb-float" style={{ position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', width: '500px', height: '500px', background: 'radial-gradient(circle, var(--slide-glow) 0%, transparent 65%)', pointerEvents: 'none' }} />

                    {/* Thin circle rings for depth */}
                    <div style={{ position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', width: '600px', height: '600px', border: '1px solid var(--slide-border)', borderRadius: '50%', opacity: 0.4 }} />
                    <div style={{ position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', width: '800px', height: '800px', border: '1px solid var(--slide-border)', borderRadius: '50%', opacity: 0.2 }} />

                    <div style={{ position: 'relative', zIndex: 2, maxWidth: '860px' }}>
                        {/* Icon badge instead of emoji */}
                        <motion.div {...fadeUp} transition={{ duration: 0.8 }} style={{ marginBottom: '28px', display: 'flex', justifyContent: 'center' }}>
                            <div style={{ width: '64px', height: '64px', borderRadius: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--accent-gradient)', boxShadow: '0 8px 32px var(--slide-glow)', color: 'white' }}>
                                <Icon name="Layers" size={32} />
                            </div>
                        </motion.div>

                        <motion.h1 {...fadeUp} transition={{ duration: 0.8, delay: 0.05 }} style={{
                            fontSize: slide.title && slide.title.length > 40 ? '48px' : '64px',
                            fontWeight: 800, letterSpacing: '-0.04em', lineHeight: 1.08, color: 'var(--slide-text)',
                            marginBottom: '24px', fontFamily: "'Outfit',sans-serif"
                        }}>{slide.title}</motion.h1>

                        {/* Accent line with shimmer */}
                        <motion.div {...fadeIn} transition={{ duration: 0.5, delay: 0.2 }} style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
                            <div className="shimmer-line" style={{ width: '56px', height: '3px', borderRadius: '2px' }} />
                        </motion.div>

                        {slide.subtitle && (
                            <motion.p {...fadeUp} transition={{ duration: 0.7, delay: 0.15 }} style={{ fontSize: '20px', fontWeight: 400, color: 'var(--slide-text-dim)', lineHeight: 1.55, fontFamily: "'Outfit',sans-serif" }}>
                                {slide.subtitle}
                            </motion.p>
                        )}
                    </div>

                    {/* Bottom gradient line */}
                    <div style={{ position: 'absolute', bottom: 0, left: '5%', right: '5%', height: '2px', background: 'linear-gradient(90deg, transparent, var(--slide-accent), var(--slide-accent-2), transparent)', opacity: 0.3 }} />
                </div>
            );

            // ——— KPI GRID — Premium Metric Cards ———
            if (layout === 'kpi_grid') {
                const cols = Math.min(safeItems.length, 4);
                return (
                    <div className="slide-root" style={{ width: '100%', height: '100%', background: 'var(--slide-bg)', position: 'relative', overflow: 'hidden', display: 'flex', flexDirection: 'column', padding: '56px 72px', fontFamily: "'Outfit',sans-serif" }}>
                        <GeoBgContent />
                        {/* Top-right gradient accent */}
                        <div style={{ position: 'absolute', top: 0, right: 0, width: '350px', height: '350px', background: `radial-gradient(circle at top right, var(--slide-glow), transparent 70%)`, pointerEvents: 'none' }} />

                        <div style={{ position: 'relative', zIndex: 1, display: 'flex', flexDirection: 'column', flex: 1 }}>
                            <SectionLabel text="Performance Metrics" icon={<Icon name="BarChart" size={14} />} />
                            <motion.h2 {...fadeUp} style={{ fontSize: '44px', fontWeight: 800, color: 'var(--slide-text)', letterSpacing: '-0.035em', lineHeight: 1.08, marginBottom: '40px', fontFamily: "'Outfit',sans-serif" }}>{slide.title}</motion.h2>

                            <div style={{ display: 'grid', gridTemplateColumns: `repeat(${cols},1fr)`, gap: '18px', flex: 1 }}>
                                {safeItems.map((kpi, i) => (
                                    <motion.div key={i} initial={{ opacity: 0, y: 32 }} whileInView={{ opacity: 1, y: 0 }} viewport={V} transition={{ duration: 0.65, delay: i * 0.09 }} style={{
                                        background: 'var(--slide-surface)', border: '1px solid var(--slide-border)',
                                        borderRadius: '18px', padding: '28px 24px', display: 'flex', flexDirection: 'column', justifyContent: 'space-between',
                                        position: 'relative', overflow: 'hidden',
                                        boxShadow: '0 4px 24px rgba(0,0,0,0.06)', backdropFilter: 'blur(12px)'
                                    }}>
                                        {/* Top accent gradient bar */}
                                        <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: `linear-gradient(90deg, ${accentColors[i % 4]}, ${accentColors[(i + 1) % 4]})`, borderRadius: '2px 2px 0 0' }} />
                                        {/* Icon circle */}
                                        <div style={{ width: '44px', height: '44px', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: `${accentColors[i % 4]}15`, color: accentColors[i % 4], marginBottom: '16px', border: `1px solid ${accentColors[i % 4]}25` }}>
                                            <Icon name={['BarChart', 'Target', 'Users', 'TrendingUp'][i % 4]} size={22} />
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '48px', fontWeight: 800, letterSpacing: '-0.04em', lineHeight: 1, color: 'var(--slide-text)', marginBottom: '8px', fontFamily: "'Outfit',sans-serif" }}>{kpi.value}</div>
                                            <div style={{ fontSize: '12px', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: 'var(--slide-text-dim)' }}>{kpi.label}</div>
                                        </div>
                                    </motion.div>
                                ))}
                            </div>
                        </div>
                        <div style={{ position: 'absolute', bottom: 0, left: '5%', right: '5%', height: '2px', background: 'linear-gradient(90deg, transparent, var(--slide-accent), var(--slide-accent-2), transparent)', opacity: 0.2 }} />
                    </div>
                );
            }

            // ——— FLOWCHART — Premium Process Flow ———
            if (layout === 'flowchart') return (
                <div className="slide-root" style={{ width: '100%', height: '100%', background: 'var(--slide-bg)', position: 'relative', overflow: 'hidden', display: 'flex', flexDirection: 'column', padding: '56px 72px', fontFamily: "'Outfit',sans-serif" }}>
                    <GeoBgFlow />

                    <div style={{ position: 'relative', zIndex: 1, flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <SectionLabel text="Process Flow" icon={<Icon name="GitBranch" size={14} />} />
                        <motion.h2 {...fadeUp} style={{ fontSize: '44px', fontWeight: 800, color: 'var(--slide-text)', letterSpacing: '-0.035em', lineHeight: 1.08, marginBottom: '48px', fontFamily: "'Outfit',sans-serif" }}>{slide.title}</motion.h2>

                        <div style={{ flex: 1, display: 'flex', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'flex-start', width: '100%', gap: 0 }}>
                                {safeItems.map((step, i) => (
                                    <React.Fragment key={i}>
                                        <motion.div initial={{ opacity: 0, y: 24 }} whileInView={{ opacity: 1, y: 0 }} viewport={V} transition={{ duration: 0.6, delay: i * 0.1 }} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '14px' }}>
                                            {/* Step number — gradient for first, bordered for rest */}
                                            <div style={{
                                                width: '52px', height: '52px', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                background: i === 0 ? 'var(--accent-gradient)' : 'var(--slide-surface)',
                                                border: `2px solid ${i === 0 ? 'transparent' : 'var(--slide-border)'}`,
                                                fontSize: '20px', fontWeight: 800, color: i === 0 ? 'white' : 'var(--slide-text-dim)',
                                                boxShadow: i === 0 ? '0 4px 20px var(--slide-glow)' : '0 2px 8px rgba(0,0,0,0.05)',
                                                fontFamily: "'Outfit',sans-serif"
                                            }}>{i + 1}</div>
                                            {/* Card */}
                                            <div style={{
                                                background: 'var(--slide-surface)', backdropFilter: 'blur(12px)',
                                                border: `1px solid ${i === 0 ? 'var(--slide-accent)' : 'var(--slide-border)'}`,
                                                borderRadius: '14px', padding: '20px 16px', textAlign: 'center', width: '100%',
                                                boxShadow: i === 0 ? '0 4px 16px var(--slide-glow)' : '0 2px 8px rgba(0,0,0,0.04)'
                                            }}>
                                                {/* Top colored bar */}
                                                {i === 0 && <div style={{ position: 'absolute', top: 0, left: '20%', right: '20%', height: '2px', background: 'var(--accent-gradient)', borderRadius: '1px' }} />}
                                                <div style={{ fontSize: '14px', fontWeight: 700, color: 'var(--slide-text)', lineHeight: 1.4 }}>{step.title}</div>
                                            </div>
                                        </motion.div>
                                        {i < safeItems.length - 1 && (
                                            <motion.div {...fadeIn} transition={{ duration: 0.4, delay: i * 0.1 + 0.2 }} style={{ width: '36px', flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', marginTop: '26px' }}>
                                                <div style={{ width: '100%', height: '2px', background: `linear-gradient(90deg, ${accentColors[i % 4]}, ${accentColors[(i + 1) % 4]})`, borderRadius: '1px' }} />
                                            </motion.div>
                                        )}
                                    </React.Fragment>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div style={{ position: 'absolute', bottom: 0, left: '5%', right: '5%', height: '2px', background: 'linear-gradient(90deg, transparent, var(--slide-accent-3), var(--slide-accent), transparent)', opacity: 0.2 }} />
                </div>
            );

            // ——— ICON COLUMNS — Premium Card Columns ———
            if (layout === 'icon_columns') {
                const cols = Math.min(safeItems.length, 3);
                return (
                    <div className="slide-root" style={{ width: '100%', height: '100%', background: 'var(--slide-bg)', position: 'relative', overflow: 'hidden', display: 'flex', flexDirection: 'column', fontFamily: "'Outfit',sans-serif" }}>
                        <GeoBgContent />
                        <div style={{ padding: '56px 72px 28px 72px', position: 'relative', zIndex: 1, flexShrink: 0 }}>
                            <SectionLabel text="Highlights" icon={<Icon name="Award" size={14} />} />
                            <motion.h2 {...fadeUp} style={{ fontSize: '44px', fontWeight: 800, color: 'var(--slide-text)', letterSpacing: '-0.035em', lineHeight: 1.08, fontFamily: "'Outfit',sans-serif" }}>{slide.title}</motion.h2>
                        </div>
                        {/* Gradient divider */}
                        <div style={{ height: '2px', marginLeft: '72px', marginRight: '72px', background: 'linear-gradient(90deg, var(--slide-accent), var(--slide-border), transparent)', opacity: 0.3 }} />

                        <div style={{ display: 'grid', gridTemplateColumns: `repeat(${cols},1fr)`, flex: 1, minHeight: 0 }}>
                            {safeItems.map((col, i) => (
                                <motion.div key={i} initial={{ opacity: 0, y: 28 }} whileInView={{ opacity: 1, y: 0 }} viewport={V} transition={{ duration: 0.65, delay: i * 0.1 }} style={{
                                    padding: '36px 32px',
                                    borderRight: i < safeItems.length - 1 ? '1px solid var(--slide-border)' : 'none',
                                    display: 'flex', flexDirection: 'column', gap: '14px', position: 'relative', overflow: 'hidden'
                                }}>
                                    {/* Subtle top glow */}
                                    <div style={{ position: 'absolute', top: '-20px', left: '10%', width: '80%', height: '60px', background: `${accentColors[i % 4]}`, opacity: 0.04, filter: 'blur(30px)', pointerEvents: 'none' }} />
                                    {/* Icon badge */}
                                    <div style={{ width: '48px', height: '48px', borderRadius: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: `${accentColors[i % 4]}12`, color: accentColors[i % 4], border: `1px solid ${accentColors[i % 4]}20`, marginBottom: '4px' }}>
                                        <Icon name={['Shield', 'AlertTriangle', 'Zap'][i % 3]} size={24} />
                                    </div>
                                    <div style={{ fontSize: '20px', fontWeight: 700, color: 'var(--slide-text)', lineHeight: 1.25, letterSpacing: '-0.02em' }}>{col.title}</div>
                                    <div style={{ fontSize: '14px', color: 'var(--slide-text-dim)', lineHeight: 1.65, fontWeight: 400 }}>{col.text}</div>
                                </motion.div>
                            ))}
                        </div>
                        <div style={{ position: 'absolute', bottom: 0, left: '5%', right: '5%', height: '2px', background: 'linear-gradient(90deg, transparent, var(--slide-accent), transparent)', opacity: 0.2 }} />
                    </div>
                );
            }

            // ——— STANDARD (Editorial Split) — Premium ———
            return (
                <div className="slide-root" style={{ width: '100%', height: '100%', background: 'var(--slide-bg)', position: 'relative', overflow: 'hidden', display: 'flex', fontFamily: "'Outfit',sans-serif" }}>
                    <GeoBgContent />

                    {/* LEFT panel */}
                    <div style={{
                        width: '340px', flexShrink: 0,
                        padding: '56px 36px 56px 72px',
                        borderRight: '1px solid var(--slide-border)',
                        display: 'flex', flexDirection: 'column', justifyContent: 'center',
                        position: 'relative', overflow: 'hidden'
                    }}>
                        {/* Vertical gradient accent */}
                        <div style={{ position: 'absolute', left: 0, top: '56px', width: '3px', height: '80px', background: 'var(--accent-gradient)', borderRadius: '0 2px 2px 0' }} />
                        <div style={{ position: 'absolute', left: '-40px', top: '50%', transform: 'translateY(-50%)', width: '140px', height: '140px', background: 'var(--slide-accent)', borderRadius: '50%', opacity: 0.04, filter: 'blur(40px)', pointerEvents: 'none' }} />

                        <SectionLabel text="Overview" icon={<Icon name="FileText" size={14} />} />
                        <motion.h2 {...fadeUp} style={{ fontSize: '36px', fontWeight: 800, letterSpacing: '-0.03em', lineHeight: 1.12, color: 'var(--slide-text)', fontFamily: "'Outfit',sans-serif" }}>
                            {slide.title}
                        </motion.h2>
                    </div>

                    {/* RIGHT panel */}
                    <div style={{ flex: 1, padding: '56px 64px', display: 'flex', flexDirection: 'column', justifyContent: 'center', overflow: 'hidden' }}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '18px' }}>
                            {safeContent.map((bullet, i) => (
                                <motion.div key={i} initial={{ opacity: 0, x: 20 }} whileInView={{ opacity: 1, x: 0 }} viewport={V} transition={{ duration: 0.55, delay: i * 0.07 }} style={{ display: 'flex', alignItems: 'flex-start', gap: '14px' }}>
                                    <div style={{
                                        width: '28px', height: '28px', borderRadius: '8px', flexShrink: 0,
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        background: `${accentColors[i % 4]}12`, color: accentColors[i % 4],
                                        border: `1px solid ${accentColors[i % 4]}20`, marginTop: '2px'
                                    }}>
                                        <Icon name={['CheckCircle', 'ArrowRight', 'Zap'][i % 3]} size={14} />
                                    </div>
                                    <div style={{ fontSize: '16px', color: 'var(--slide-text)', lineHeight: 1.65, fontWeight: 400, fontFamily: "'Outfit',sans-serif" }}>{bullet}</div>
                                </motion.div>
                            ))}
                        </div>
                    </div>

                    {/* Slide watermark */}
                    <div style={{ position: 'absolute', bottom: '18px', right: '24px', fontSize: '10px', color: 'var(--slide-border)', fontWeight: 700, letterSpacing: '0.12em', textTransform: 'uppercase', fontFamily: "'Outfit',sans-serif" }}>
                        {slide.title ? slide.title.substring(0, 24) : ''}
                    </div>
                    <div style={{ position: 'absolute', bottom: 0, left: '5%', right: '5%', height: '2px', background: 'linear-gradient(90deg, transparent, var(--slide-accent), transparent)', opacity: 0.2 }} />
                </div>
            );
        }

        /* ═══════════════════════════════════════
           ★ SMART DECK VIEW — Premium Viewer
           ═══════════════════════════════════════ */
        function SmartDeckView({ project, endpoint, isFullScreenLayout, onClose }) {
            const [slides, setSlides] = useState([]);
            const [deckTheme, setDeckTheme] = useState('sprint');
            const [loading, setLoading] = useState(true);
            const [activeIdx, setActiveIdx] = useState(0);
            const [isExporting, setIsExporting] = useState(false);
            const [aiError, setAiError] = useState(null);
            const scrollRef = useRef(null);
            const wrapperRef = useRef(null);
            const sectionRefs = useRef([]);

            useEffect(() => {
                setLoading(true); setAiError(null); setActiveIdx(0);
                secureFetch(endpoint).then(r => r?.json()).then(data => {
                    if (data && data.status === 'success' && data.slides) { setSlides(data.slides); setDeckTheme(data.theme || 'sprint'); }
                    else { setAiError(data?.message || "Failed to generate deck data."); }
                    setLoading(false);
                }).catch(() => { setAiError("Network connection to AI failed."); setLoading(false); });
            }, [endpoint]);

            useEffect(() => {
                if (!slides.length) return;
                const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { const idx = sectionRefs.current.findIndex(r => r === entry.target); if (idx !== -1) setActiveIdx(idx); } }); }, { threshold: 0.5, root: scrollRef.current });
                sectionRefs.current.forEach(r => { if (r) observer.observe(r); });
                return () => observer.disconnect();
            }, [slides]);

            useEffect(() => {
                const onKey = (e) => {
                    if (e.key === 'ArrowDown' || e.key === 'ArrowRight') scrollTo(Math.min(slides.length - 1, activeIdx + 1));
                    else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') scrollTo(Math.max(0, activeIdx - 1));
                };
                window.addEventListener('keydown', onKey);
                return () => window.removeEventListener('keydown', onKey);
            }, [activeIdx, slides]);

            const scrollTo = (idx) => { sectionRefs.current[idx]?.scrollIntoView({ behavior: 'smooth', block: 'start' }); };
            const toggleFullScreen = () => { if (!document.fullscreenElement) wrapperRef.current?.requestFullscreen().catch(e => console.error(e)); else document.exitFullscreen(); };

            const handleExportPPTX = async () => {
                setIsExporting(true);
                try {
                    const res = await secureFetch('/generate_ppt', { method: 'POST', body: JSON.stringify({ project: project, slides: slides, theme: deckTheme }) });
                    if (res && res.ok) {
                        const blob = await res.blob(); const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = `${project}_${deckTheme.charAt(0).toUpperCase() + deckTheme.slice(1)}_Deck.pptx`;
                        document.body.appendChild(a); a.click(); a.remove();
                    } else { alert("Failed to compile native Presentation."); }
                } catch (e) { console.error(e); }
                setIsExporting(false);
            };

            if (loading) return (
                <div style={{ background: 'var(--slide-bg)', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '20px', fontFamily: "'Outfit',sans-serif" }}>
                    <div style={{ width: '44px', height: '44px', border: '2px solid var(--slide-border)', borderTop: '2px solid var(--slide-accent)', borderRadius: '50%', animation: 'rotation 0.9s linear infinite' }} />
                    <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--slide-text-dim)', letterSpacing: '0.12em', textTransform: 'uppercase' }}>AI Orchestrating Deck</div>
                </div>
            );
            if (aiError) return (
                <div style={{ background: 'var(--slide-bg)', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontFamily: "'Outfit',sans-serif" }}>
                    <div style={{ background: 'var(--slide-surface)', border: '1px solid var(--danger)', borderRadius: '16px', padding: '40px 48px', maxWidth: '480px', textAlign: 'center' }}>
                        <Icon name="AlertTriangle" size={40} className="mx-auto mb-4" style={{ color: 'var(--danger)' }} />
                        <div style={{ fontSize: '15px', fontWeight: 600, color: 'var(--danger)', lineHeight: 1.5 }}>{aiError}</div>
                    </div>
                </div>
            );
            if (!slides || slides.length === 0) return <div style={{ color: 'var(--slide-text)', padding: '40px', fontFamily: "'Outfit',sans-serif" }}>No slide data returned.</div>;

            const wrapStyle = isFullScreenLayout
                ? { height: '100%', display: 'flex', flexDirection: 'column', background: 'var(--slide-bg)', fontFamily: "'Outfit','DM Sans',sans-serif" }
                : { maxHeight: '780px', display: 'flex', flexDirection: 'column', background: 'var(--slide-bg)', borderRadius: '20px', overflow: 'hidden', marginBottom: '2rem', border: '1px solid var(--slide-border)', boxShadow: '0 24px 80px rgba(0,0,0,0.15)', fontFamily: "'Outfit','DM Sans',sans-serif" };

            const SLIDE_H = isFullScreenLayout ? '100%' : '680px';

            return (
                <div ref={wrapperRef} className="deck-wrapper" style={wrapStyle}>
                    {/* ── PREMIUM TOPBAR ── */}
                    <div style={{
                        height: '52px', flexShrink: 0, zIndex: 50,
                        background: 'var(--slide-surface)', backdropFilter: 'blur(20px)',
                        borderBottom: '1px solid var(--slide-border)',
                        display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                        padding: '0 20px'
                    }}>
                        {/* LEFT */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '7px', background: 'var(--primary-dim)', border: '1px solid var(--slide-border)', borderRadius: '100px', padding: '4px 12px' }}>
                                <div style={{ width: '7px', height: '7px', borderRadius: '50%', background: 'var(--slide-accent)', boxShadow: '0 0 8px var(--slide-glow)', flexShrink: 0 }} />
                                <span style={{ fontSize: '10px', fontWeight: 700, color: 'var(--slide-accent)', letterSpacing: '0.1em', textTransform: 'uppercase' }}>{{ 'sprint': 'AI Sprint Deck', 'weekly': 'Weekly Report', 'monthly': 'Monthly Review', 'quarterly': 'Quarterly QBR' }[deckTheme] || 'AI Deck'}</span>
                            </div>
                            <span style={{ fontSize: '12px', color: 'var(--slide-text-dim)', fontWeight: 500 }}>
                                <span style={{ color: 'var(--slide-text)', fontWeight: 700 }}>{activeIdx + 1}</span> / {slides.length}
                            </span>
                            <span style={{ fontSize: '12px', color: 'var(--slide-text-dim)', fontWeight: 500, maxWidth: '280px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                {slides[activeIdx]?.title || ''}
                            </span>
                        </div>
                        {/* RIGHT */}
                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                            <button onClick={toggleFullScreen} title="Fullscreen" style={{
                                width: '32px', height: '32px', borderRadius: '8px',
                                background: 'var(--slide-surface-alt)', border: '1px solid var(--slide-border)',
                                color: 'var(--slide-text-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}><Icon name="Maximize" size={14} /></button>

                            <button onClick={handleExportPPTX} disabled={isExporting} style={{
                                background: isExporting ? 'var(--primary-dim)' : 'var(--accent-gradient)',
                                color: 'white', border: 'none', borderRadius: '8px',
                                padding: '7px 16px', fontSize: '12px', fontWeight: 600,
                                cursor: isExporting ? 'not-allowed' : 'pointer',
                                display: 'flex', alignItems: 'center', gap: '7px',
                                transition: 'all 0.2s', boxShadow: isExporting ? 'none' : '0 2px 12px var(--slide-glow)'
                            }}>
                                {isExporting
                                    ? <><span style={{ width: '12px', height: '12px', border: '2px solid rgba(255,255,255,0.3)', borderTop: '2px solid white', borderRadius: '50%', display: 'inline-block', animation: 'rotation 0.8s linear infinite' }} /> Compiling</>
                                    : <><Icon name="Download" size={14} /> Export PPTX</>
                                }
                            </button>

                            {onClose && (
                                <button onClick={onClose} style={{
                                    width: '32px', height: '32px', borderRadius: '8px',
                                    background: 'var(--slide-surface-alt)', border: '1px solid var(--slide-border)',
                                    color: 'var(--slide-text-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer',
                                    transition: 'all 0.2s'
                                }}><Icon name="X" size={14} /></button>
                            )}
                        </div>
                    </div>

                    {/* ── BODY ── */}
                    <div style={{ flex: 1, display: 'flex', minHeight: 0, position: 'relative', overflow: 'hidden' }}>
                        <div ref={scrollRef} style={{ flex: 1, overflowY: 'auto', overflowX: 'hidden', scrollSnapType: 'y mandatory' }} className="hide-scroll">
                            {slides.map((slide, i) => (
                                <div key={i} ref={el => sectionRefs.current[i] = el} style={{
                                    height: SLIDE_H, minHeight: isFullScreenLayout ? 'calc(100vh - 52px)' : '680px',
                                    scrollSnapAlign: 'start', position: 'relative', flexShrink: 0
                                }}>
                                    <RenderSlide slide={slide} isActive={i === activeIdx} />
                                    <div style={{ position: 'absolute', top: '18px', right: '18px', fontSize: '10px', fontWeight: 700, letterSpacing: '0.1em', color: 'var(--slide-text-dim)', opacity: 0.4, fontFamily: "'Outfit',sans-serif", textTransform: 'uppercase', pointerEvents: 'none' }}>{String(i + 1).padStart(2, '0')}</div>
                                </div>
                            ))}
                            <div style={{ height: '1px' }} />
                        </div>

                        {/* RIGHT: Dot nav */}
                        <div style={{
                            width: '44px', flexShrink: 0,
                            display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '10px',
                            padding: '20px 0',
                            borderLeft: '1px solid var(--slide-border)',
                            background: 'var(--slide-surface)'
                        }}>
                            {slides.map((_, i) => (
                                <button key={i} onClick={() => scrollTo(i)} title={slides[i]?.title} style={{
                                    width: activeIdx === i ? '10px' : '6px',
                                    height: activeIdx === i ? '10px' : '6px',
                                    borderRadius: '50%', border: 'none', cursor: 'pointer',
                                    background: activeIdx === i ? 'var(--slide-accent)' : 'var(--slide-border)',
                                    boxShadow: activeIdx === i ? '0 0 10px var(--slide-glow)' : 'none',
                                    transition: 'all 0.3s cubic-bezier(0.4,0,0.2,1)', padding: 0
                                }} />
                            ))}
                        </div>
                    </div>

                    {/* ── BOTTOM: progress bar ── */}
                    <div style={{ height: '3px', flexShrink: 0, background: 'var(--slide-border)', position: 'relative', overflow: 'hidden' }}>
                        <motion.div style={{ height: '100%', background: 'var(--accent-gradient)', transformOrigin: 'left' }} animate={{ scaleX: slides.length > 1 ? (activeIdx) / (slides.length - 1) : 1 }} transition={{ duration: 0.4, ease: [0.4, 0, 0.2, 1] }} />
                    </div>
                </div>
            );
        }

        /* ================================================================
           TIMELINE VIEW
           ================================================================ */
        function TimelineView({ project, setIsLoading }) {
            const [data, setData] = useState(null);
            const [sprints, setSprints] = useState([]);
            const [activeSprint, setActiveSprint] = useState('active');
            const [storyPrompt, setStoryPrompt] = useState("");
            const [isGeneratingStory, setIsGeneratingStory] = useState(false);
            const [generatedStory, setGeneratedStory] = useState(null);
            const [isCreatingStory, setIsCreatingStory] = useState(false);
            const [storyStatus, setStoryStatus] = useState(null);
            const [selectedImage, setSelectedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const fileInputRef = useRef(null);
            const [epicPrompt, setEpicPrompt] = useState("");
            const [isGeneratingEpic, setIsGeneratingEpic] = useState(false);
            const [generatedEpic, setGeneratedEpic] = useState(null);
            const [isCreatingEpic, setIsCreatingEpic] = useState(false);
            const [epicStatus, setEpicStatus] = useState(null);

            useEffect(() => { secureFetch(`/sprints/${project}`).then(r => r?.json()).then(d => { if (d && d.length) setSprints(d); }); }, [project]);
            useEffect(() => {
                setData(null); setIsLoading(true);
                secureFetch(activeSprint === 'active' ? `/analytics/${project}` : `/analytics/${project}?sprint_id=${activeSprint}`)
                    .then(r => r?.json()).then(d => { setData(d); setIsLoading(false); });
            }, [project, activeSprint]);

            const handleImageChange = (e) => { const file = e.target.files[0]; if (file) { setSelectedImage(file); const reader = new FileReader(); reader.onloadend = () => setImagePreview(reader.result); reader.readAsDataURL(file); } };
            const clearImage = () => { setSelectedImage(null); setImagePreview(null); if (fileInputRef.current) fileInputRef.current.value = ""; };

            const handleGenerateStory = async () => {
                if (!storyPrompt.trim() && !selectedImage) return;
                setIsGeneratingStory(true); setGeneratedStory(null); setStoryStatus(null);
                let imageDataUrl = null;
                if (selectedImage) imageDataUrl = await new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.readAsDataURL(selectedImage); });
                try {
                    const payload = { project, prompt: storyPrompt }; if (imageDataUrl) payload.image_data = imageDataUrl;
                    const r = await secureFetch('/timeline/generate_story', { method: 'POST', body: JSON.stringify(payload) });
                    const res = await r.json();
                    if (res.status === 'success') { setGeneratedStory(res.story); clearImage(); }
                    else { setStoryStatus({ type: 'error', text: res.message || "AI failed to generate story." }); }
                } catch (e) { setStoryStatus({ type: 'error', text: "Network error generating story." }); }
                setIsGeneratingStory(false);
            };

            const handlePushStory = async () => {
                setIsCreatingStory(true); setStoryStatus(null);
                try {
                    const r = await secureFetch('/timeline/create_issue', { method: 'POST', body: JSON.stringify({ project, issue_type: "Story", story: generatedStory }) });
                    const res = await r.json();
                    if (res.status === 'success') { setStoryStatus({ type: 'success', text: `Success! Story ${res.key} added to Jira.`, url: res.url }); setTimeout(() => { setGeneratedStory(null); setStoryPrompt(""); setStoryStatus(null); }, 8000); }
                    else { setStoryStatus({ type: 'error', text: res.message }); }
                } catch (e) { setStoryStatus({ type: 'error', text: "Network connection to backend failed." }); }
                setIsCreatingStory(false);
            };

            const handleGenerateEpic = async () => {
                if (!epicPrompt.trim()) return;
                setIsGeneratingEpic(true); setGeneratedEpic(null); setEpicStatus(null);
                try {
                    const r = await secureFetch('/timeline/generate_epic', { method: 'POST', body: JSON.stringify({ project, prompt: epicPrompt }) });
                    const res = await r.json();
                    if (res.status === 'success') { setGeneratedEpic(res.epic); } else { setEpicStatus({ type: 'error', text: res.message || "AI failed to generate Epic." }); }
                } catch (e) { setEpicStatus({ type: 'error', text: "Network error generating Epic." }); }
                setIsGeneratingEpic(false);
            };

            const handlePushEpic = async () => {
                setIsCreatingEpic(true); setEpicStatus(null);
                try {
                    const r = await secureFetch('/timeline/create_issue', { method: 'POST', body: JSON.stringify({ project, issue_type: "Epic", story: generatedEpic }) });
                    const res = await r.json();
                    if (res.status === 'success') { setEpicStatus({ type: 'success', text: `Success! Epic ${res.key} added to Jira.`, url: res.url }); setTimeout(() => { setGeneratedEpic(null); setEpicPrompt(""); setEpicStatus(null); }, 8000); }
                    else { setEpicStatus({ type: 'error', text: res.message }); }
                } catch (e) { setEpicStatus({ type: 'error', text: "Network connection failed." }); }
                setIsCreatingEpic(false);
            };

            if (!data) return <LoadingScreen msg="Loading Workspace..." />;

            const dynamicsData = Object.entries(data.metrics?.assignees || {}).map(([name, stats]) => {
                const origList = stats.tasks.filter(t => !t.added_mid_sprint); const midList = stats.tasks.filter(t => t.added_mid_sprint);
                const originalPts = origList.reduce((sum, t) => sum + (t.points || 0), 0); const midPts = midList.reduce((sum, t) => sum + (t.points || 0), 0);
                const finalPts = stats.tasks.filter(t => t.status.toLowerCase().includes('done') || t.status.toLowerCase().includes('closed') || t.status.toLowerCase().includes('resolved')).reduce((sum, t) => sum + (t.points || 0), 0);
                let delta = 0; if (originalPts > 0) delta = (((finalPts - originalPts) / originalPts) * 100); else if (originalPts === 0 && finalPts > 0) delta = 100;
                return { user: name, originalPts, origList, midPts, midList, finalPts, delta, avatar: stats.avatar };
            });
            const totalOrig = dynamicsData.reduce((sum, r) => sum + r.originalPts, 0);
            const totalMid = dynamicsData.reduce((sum, r) => sum + r.midPts, 0);
            const totalFinal = dynamicsData.reduce((sum, r) => sum + r.finalPts, 0);
            const totalDelta = totalOrig > 0 ? (((totalFinal - totalOrig) / totalOrig) * 100).toFixed(2) : "0.00";

            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-32 pr-4 relative space-y-16 block">
                    <div>
                        <header className="mb-8 flex justify-between items-end pb-6 border-b border-border">
                            <div><h2 className="text-4xl font-extrabold tracking-tight text-text-main">Sprint Dynamics</h2><p className="text-base font-medium mt-2 text-text-muted">Real-time view of capacity and delivery delta</p></div>
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-black uppercase tracking-wider text-text-muted">Target Sprint</span>
                                <select value={activeSprint} onChange={e => setActiveSprint(e.target.value)} className="p-3 rounded-lg border bg-bg-card text-text-main font-bold shadow-sm outline-none cursor-pointer hover:border-primary transition-colors">
                                    <option value="active">Active Sprint</option>
                                    {sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                        </header>

                        {dynamicsData.length === 0 ? (
                            <div className="p-10 rounded-2xl border border-border shadow-xl bg-bg-card flex flex-col items-center justify-center">
                                <Icon name="AlertTriangle" size={48} className="text-warning mb-4 opacity-80" />
                                <h3 className="text-xl font-extrabold text-text-main mb-2">No Active Data Found</h3>
                                <p className="text-text-muted font-medium text-center max-w-md">We couldn't detect any user tickets in Jira for this sprint.</p>
                            </div>
                        ) : (
                            <div className="rounded-2xl border shadow-2xl overflow-hidden" style={{ borderColor: 'var(--border)', background: 'var(--bg-card)' }}>
                                <div className="overflow-x-auto hide-scroll">
                                    <table className="w-full text-left border-collapse whitespace-nowrap">
                                        <thead>
                                            <tr style={{ background: 'var(--bg-body)', color: 'var(--text-muted)', borderBottom: '1px solid var(--border)' }} className="text-[11px] uppercase tracking-widest">
                                                <th className="p-5 font-black" style={{ borderRight: '1px solid var(--border)', width: '200px', minWidth: '150px' }}>Assignee</th>
                                                <th className="p-5 font-black text-center" style={{ borderRight: '1px solid var(--border)' }}>Original Commitment</th>
                                                <th className="p-5 font-black w-1/3" style={{ borderRight: '1px solid var(--border)' }}>Original Scope (Jira IDs)</th>
                                                <th className="p-5 font-black text-center" style={{ borderRight: '1px solid var(--border)' }}>Mid-Sprint Variance</th>
                                                <th className="p-5 font-black w-1/4" style={{ borderRight: '1px solid var(--border)' }}>Scope Creep / Added</th>
                                                <th className="p-5 font-black text-center" style={{ borderRight: '1px solid var(--border)' }}>Final Delivered</th>
                                                <th className="p-5 font-black text-center">Sprint Delta</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm font-medium" style={{ color: 'var(--text-main)' }}>
                                            {dynamicsData.map(row => (
                                                <tr key={row.user} className="hover:bg-bg-hover transition-colors" style={{ borderBottom: '1px solid var(--border)' }}>
                                                    <td className="p-5" style={{ borderRight: '1px solid var(--border)', maxWidth: '200px' }}>
    <div className="flex items-center gap-3 min-w-0">
        {row.avatar ? <img src={row.avatar} className="w-8 h-8 rounded-full border shrink-0" style={{ borderColor: 'var(--border)' }} /> : <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-md shrink-0" style={{ background: 'var(--accent-gradient)' }}>{row.user.charAt(0)}</div>}
        <span className="font-bold tracking-wide truncate" title={row.user}>{row.user}</span>
    </div>
</td>
                                                    <td className="p-5 text-center font-black text-lg" style={{ borderRight: '1px solid var(--border)' }}>{row.originalPts}</td>
                                                    <td className="p-5" style={{ borderRight: '1px solid var(--border)' }}>
                                                        <div className="flex flex-wrap gap-2">
                                                            {row.origList.length > 0 ? row.origList.map(t => <span key={t.key} className="px-2.5 py-1 rounded-md text-xs font-bold" style={{ background: 'var(--bg-body)', border: '1px solid var(--border)', color: 'var(--text-muted)' }} title={t.summary}>{t.key}</span>) : <span className="text-xs italic" style={{ color: 'var(--text-muted)' }}>None</span>}
                                                        </div>
                                                    </td>
                                                    <td className="p-5 text-center" style={{ borderRight: '1px solid var(--border)' }}>
                                                        <span className={`px-3 py-1 rounded-full text-xs font-black shadow-sm ${row.midPts > 0 ? 'bg-amber-500/10 text-amber-400 border border-amber-500/20' : ''}`} style={row.midPts === 0 ? { background: 'var(--bg-body)', color: 'var(--text-muted)', border: '1px solid var(--border)' } : {}}>
                                                            {row.midPts > 0 ? `+${row.midPts} pts` : '0 pts'}
                                                        </span>
                                                    </td>
                                                    <td className="p-5" style={{ borderRight: '1px solid var(--border)' }}>
                                                        <div className="flex flex-wrap gap-2">
                                                            {row.midList.length > 0 ? row.midList.map(t => <span key={t.key} className="px-2.5 py-1 bg-amber-500/10 border border-amber-500/20 rounded-md text-xs text-amber-400 shadow-sm font-bold" title={t.summary}>{t.key}</span>) : <span className="text-xs italic font-medium" style={{ color: 'var(--text-muted)' }}>No scope creep</span>}
                                                        </div>
                                                    </td>
                                                    <td className="p-5 text-center font-black text-lg" style={{ borderRight: '1px solid var(--border)' }}>{row.finalPts}</td>
                                                    <td className="p-5 text-center">
                                                        <span className={`px-3 py-1.5 rounded-lg text-xs font-black shadow-sm flex items-center justify-center gap-1 mx-auto w-24 ${row.delta < 0 ? 'bg-red-500/10 text-red-400 border border-red-500/20' : row.delta > 0 ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : ''}`} style={row.delta === 0 ? { background: 'var(--bg-body)', color: 'var(--text-muted)', border: '1px solid var(--border)' } : {}}>
                                                            {row.delta > 0 ? <Icon name="TrendingUp" size={12} /> : row.delta < 0 ? <Icon name="TrendingDown" size={12} /> : null} {Math.abs(row.delta).toFixed(1)}%
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot style={{ background: 'var(--primary-dim)', borderTop: '2px solid var(--primary)' }}>
                                            <tr>
                                                <td className="p-5 text-primary font-black uppercase tracking-widest text-xs" style={{ borderRight: '1px solid var(--primary)' }}>Sprint Totals</td>
                                                <td className="p-5 text-center text-primary font-black text-xl" style={{ borderRight: '1px solid var(--primary)' }}>{totalOrig}</td>
                                                <td className="p-5" style={{ borderRight: '1px solid var(--primary)' }}></td>
                                                <td className="p-5 text-center text-amber-500 font-black text-lg" style={{ borderRight: '1px solid var(--primary)' }}>+{totalMid}</td>
                                                <td className="p-5" style={{ borderRight: '1px solid var(--primary)' }}></td>
                                                <td className="p-5 text-center text-primary font-black text-xl" style={{ borderRight: '1px solid var(--primary)' }}>{totalFinal}</td>
                                                <td className="p-5 text-center text-primary font-black text-lg tracking-wide">{totalDelta}%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* AI Story Generator */}
                    <div>
                        <div className="glass-card border-t-4 border-primary p-8 relative overflow-hidden shadow-2xl">
                            <div className="absolute top-0 right-0 w-80 h-80 rounded-full blur-3xl -mr-24 -mt-24 pointer-events-none opacity-40" style={{ background: 'var(--glow-primary)' }}></div>
                            <h3 className="text-2xl font-extrabold flex items-center gap-3 mb-6 text-text-main"><Icon name="Sparkles" size={24} className="text-primary" /> Auto-Generate User Story</h3>
                            <div className="flex flex-col gap-4">
                                <textarea value={storyPrompt} onChange={e => setStoryPrompt(e.target.value)} placeholder="Describe the feature, or paste requirements here..." className="w-full bg-bg-body border border-border rounded-xl px-5 py-4 text-base font-medium text-text-main outline-none focus:border-primary focus:ring-2 focus:ring-primary-dim transition-all resize-none h-32 shadow-inner" ></textarea>
                                <div className="flex gap-4 items-start">
                                    <input type="file" accept="image/*" onChange={handleImageChange} ref={fileInputRef} className="hidden" />
                                    <button onClick={() => fileInputRef.current.click()} className="px-5 py-3 bg-bg-card border border-border rounded-xl font-bold text-text-muted hover:text-text-main hover:border-primary transition flex items-center gap-3 shrink-0"><Icon name="Image" size={20} /> {selectedImage ? 'Change Image' : 'Upload Screenshot'}</button>
                                    {imagePreview && (<div className="relative group"><img src={imagePreview} alt="Preview" className="h-20 w-auto rounded-lg border border-border shadow-md" /><button onClick={clearImage} className="absolute -top-2 -right-2 bg-danger text-white rounded-full p-1 shadow-lg opacity-0 group-hover:opacity-100 transition"><Icon name="X" size={12} /></button></div>)}
                                    <button onClick={handleGenerateStory} disabled={isGeneratingStory || (!storyPrompt && !selectedImage)} className="flex-1 px-8 py-4 font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 flex items-center justify-center gap-3 text-lg shadow-lg" style={{ background: 'var(--accent-gradient)' }}>
                                        {isGeneratingStory ? <span className="loader w-6 h-6 border-2"></span> : <Icon name="Sparkles" size={22} />}
                                        {isGeneratingStory ? 'Synthesizing...' : 'Generate Story'}
                                    </button>
                                </div>
                            </div>
                            <AnimatePresence>{storyStatus && !generatedStory && (<motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`mt-6 p-4 rounded-xl text-sm font-bold border flex items-center gap-3 shadow-lg ${storyStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}><Icon name={storyStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} />{storyStatus.text}</motion.div>)}</AnimatePresence>
                            <AnimatePresence>
                                {generatedStory && (
                                    <motion.div initial={{ opacity: 0, height: 0, y: 20 }} animate={{ opacity: 1, height: 'auto', y: 0 }} exit={{ opacity: 0, height: 0, y: 20 }} transition={{ type: "spring", bounce: 0.3 }} className="mt-8 pt-8 border-t border-border">
                                        <div className="bg-bg-card rounded-2xl p-8 border border-border shadow-xl relative overflow-hidden flex flex-col gap-6">
                                            <h4 className="text-sm font-black text-primary uppercase tracking-widest flex items-center gap-2"><Icon name="AlignLeft" size={16} /> Review & Edit Story</h4>
                                            <div className="grid grid-cols-4 gap-6">
                                                <div className="col-span-3"><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Story Summary</label><input value={generatedStory.title} onChange={e => setGeneratedStory({ ...generatedStory, title: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-lg font-bold text-text-main outline-none focus:border-primary transition-all" /></div>
                                                <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Story Points</label><input type="number" value={generatedStory.points} onChange={e => setGeneratedStory({ ...generatedStory, points: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-lg font-bold text-primary text-center outline-none focus:border-primary transition-all" /></div>
                                            </div>
                                            <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Description</label><textarea rows="4" value={generatedStory.description} onChange={e => setGeneratedStory({ ...generatedStory, description: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y" /></div>
                                            <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Acceptance Criteria (One per line)</label><textarea rows="4" value={generatedStory.acceptance_criteria.join('\n')} onChange={e => setGeneratedStory({ ...generatedStory, acceptance_criteria: e.target.value.split('\n') })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y leading-relaxed" /></div>
                                            <div className="grid grid-cols-2 gap-6">
                                                <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Target Assignee</label><input value={generatedStory.assignee} onChange={e => setGeneratedStory({ ...generatedStory, assignee: e.target.value })} className="w-full bg-bg-body border border-border rounded-xl px-4 py-3 text-sm font-bold text-text-main outline-none focus:border-primary transition-all" /></div>
                                                <div className="bg-primary-dim p-4 rounded-xl border border-primary/20 flex gap-4 items-start"><Icon name="Sparkles" size={20} className="text-primary shrink-0 mt-0.5" /><div><h5 className="text-xs font-black text-primary uppercase tracking-widest mb-1">AI Reasoning</h5><p className="text-xs text-text-main leading-relaxed font-semibold">{generatedStory.tech_stack_inferred}</p></div></div>
                                            </div>
                                            <div className="mt-4 flex flex-col items-end gap-4 border-t border-border pt-6">
                                                <AnimatePresence>{storyStatus && (<motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`p-4 rounded-xl text-sm w-full flex items-center gap-3 font-bold border shadow-md ${storyStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}><Icon name={storyStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} /><span className="flex-1">{storyStatus.text}</span>{storyStatus.url && <a href={storyStatus.url} target="_blank" className="px-4 py-2 bg-success text-white rounded-lg font-bold flex items-center gap-2 hover:shadow-lg transition shadow-md text-xs uppercase tracking-wider">View in Jira <Icon name="ExternalLink" size={14} /></a>}</motion.div>)}</AnimatePresence>
                                                <button onClick={handlePushStory} disabled={isCreatingStory || (storyStatus && storyStatus.type === 'success')} className="px-10 py-4 text-base font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 bg-success flex items-center gap-3 shadow-lg w-full md:w-auto justify-center">
                                                    {isCreatingStory ? <span className="loader w-5 h-5 border-2"></span> : <Icon name="Upload" size={20} />}
                                                    {isCreatingStory ? 'Pushing to Jira...' : 'Confirm & Push Story to Jira'}
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>

                    {/* AI Epic Generator */}
                    <div className="glass-card overflow-hidden shadow-2xl border-t-4 relative" style={{ borderTopColor: 'var(--slide-accent-2)' }}>
                        <div className="border-b border-border p-10 relative" style={{ background: 'rgba(139, 92, 246, 0.05)' }}>
                            <div className="absolute top-0 right-0 w-96 h-96 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none" style={{ background: 'var(--glow-accent)' }}></div>
                            <div className="max-w-3xl relative z-10">
                                <h3 className="text-3xl font-extrabold text-text-main flex items-center gap-3 mb-4"><Icon name="Target" size={28} style={{ color: 'var(--slide-accent-2)' }} /> The AI Backlog Generator</h3>
                                <h4 className="text-lg font-bold mb-3" style={{ color: 'var(--slide-accent-2)' }}>Built right into your agile flow</h4>
                                <p className="text-base text-text-muted leading-relaxed font-medium">Writing clear, structured backlog items takes time. The AI Epic Generator transforms raw ideas into implementation-ready Epics.</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-8 p-10 bg-bg-body border-b border-border relative z-10">
                            <div><h5 className="font-extrabold text-text-main text-lg mb-2 flex items-center gap-2"><Icon name="MessageSquare" size={18} style={{ color: 'var(--slide-accent-2)' }} /> Write the way you talk</h5><p className="text-sm text-text-muted font-medium leading-relaxed">Just tell the AI in a short sentence what you want to build.</p></div>
                            <div><h5 className="font-extrabold text-text-main text-lg mb-2 flex items-center gap-2"><Icon name="Zap" size={18} style={{ color: 'var(--slide-accent-2)' }} /> Auto-Generated Epics</h5><p className="text-sm text-text-muted font-medium leading-relaxed">Get detailed and structured Epics with description, acceptance criteria & more.</p></div>
                            <div><h5 className="font-extrabold text-text-main text-lg mb-2 flex items-center gap-2"><Icon name="CheckCircle" size={18} style={{ color: 'var(--slide-accent-2)' }} /> Better clarity for everyone</h5><p className="text-sm text-text-muted font-medium leading-relaxed">Actionable, consistent epics that keep Stakeholder, Product Owner and Dev Teams aligned.</p></div>
                        </div>
                        <div className="p-10 bg-bg-card relative z-10">
                            <h4 className="text-lg font-bold text-text-main mb-6 text-center">How the AI Backlog Generator works<br /><span className="text-sm font-black uppercase tracking-widest mt-2 block" style={{ color: 'var(--slide-accent-2)' }}>From messy notes to developer-ready Epics — in seconds.</span></h4>
                            <div className="flex flex-col gap-4 max-w-4xl mx-auto">
                                <textarea value={epicPrompt} onChange={e => setEpicPrompt(e.target.value)} placeholder="e.g. I need a feature to create and manage customer journeys..." className="w-full bg-bg-body border rounded-xl px-6 py-5 text-lg font-medium text-text-main outline-none focus:ring-4 transition-all resize-none h-32 shadow-inner" style={{ borderColor: 'rgba(139,92,246,0.3)', focusBorderColor: 'var(--slide-accent-2)' }}></textarea>
                                <button onClick={handleGenerateEpic} disabled={isGeneratingEpic || !epicPrompt} className="self-end px-10 py-4 font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 flex items-center justify-center gap-3 text-lg shadow-lg" style={{ background: 'linear-gradient(135deg, #8B5CF6, #6366F1)' }}>
                                    {isGeneratingEpic ? <span className="loader w-6 h-6 border-2"></span> : <Icon name="Sparkles" size={22} />}
                                    {isGeneratingEpic ? 'Crafting Epic...' : 'Generate Epic'}
                                </button>
                            </div>
                            <AnimatePresence>{epicStatus && !generatedEpic && (<motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`mt-6 max-w-4xl mx-auto p-4 rounded-xl text-sm font-bold border flex items-center gap-3 shadow-lg ${epicStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}><Icon name={epicStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} />{epicStatus.text}</motion.div>)}</AnimatePresence>
                            <AnimatePresence>
                                {generatedEpic && (
                                    <motion.div initial={{ opacity: 0, height: 0, y: 20 }} animate={{ opacity: 1, height: 'auto', y: 0 }} exit={{ opacity: 0, height: 0, y: 20 }} transition={{ type: "spring", bounce: 0.3 }} className="mt-10 max-w-4xl mx-auto">
                                        <div className="bg-bg-body rounded-2xl p-8 border shadow-xl flex flex-col gap-6" style={{ borderColor: 'rgba(139,92,246,0.2)' }}>
                                            <h4 className="text-sm font-black uppercase tracking-widest flex items-center gap-2" style={{ color: 'var(--slide-accent-2)' }}><Icon name="AlignLeft" size={16} /> Review & Edit Epic</h4>
                                            <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Epic Summary</label><input value={generatedEpic.title} onChange={e => setGeneratedEpic({ ...generatedEpic, title: e.target.value })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-lg font-bold text-text-main outline-none focus:border-primary transition-all" /></div>
                                            <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Motivation / Business Value</label><textarea rows="3" value={generatedEpic.motivation} onChange={e => setGeneratedEpic({ ...generatedEpic, motivation: e.target.value })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y" /></div>
                                            <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Description</label><textarea rows="5" value={generatedEpic.description} onChange={e => setGeneratedEpic({ ...generatedEpic, description: e.target.value })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y" /></div>
                                            <div><label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Acceptance Criteria (One per line)</label><textarea rows="5" value={generatedEpic.acceptance_criteria.join('\n')} onChange={e => setGeneratedEpic({ ...generatedEpic, acceptance_criteria: e.target.value.split('\n') })} className="w-full bg-bg-card border border-border rounded-xl px-4 py-3 text-sm font-medium text-text-main outline-none focus:border-primary transition-all resize-y leading-relaxed" /></div>
                                            <div className="mt-4 flex flex-col items-end gap-4 border-t border-border pt-6">
                                                <AnimatePresence>{epicStatus && (<motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`p-4 rounded-xl text-sm w-full flex items-center gap-3 font-bold border shadow-md ${epicStatus.type === 'error' ? 'bg-danger/10 text-danger border-danger/30' : 'bg-success/10 text-success border-success/30'}`}><Icon name={epicStatus.type === 'error' ? 'AlertTriangle' : 'CheckCircle'} size={20} /><span className="flex-1">{epicStatus.text}</span>{epicStatus.url && <a href={epicStatus.url} target="_blank" className="px-4 py-2 bg-success text-white rounded-lg font-bold flex items-center gap-2 hover:shadow-lg transition shadow-md text-xs uppercase tracking-wider">View in Jira <Icon name="ExternalLink" size={14} /></a>}</motion.div>)}</AnimatePresence>
                                                <button onClick={handlePushEpic} disabled={isCreatingEpic || (epicStatus && epicStatus.type === 'success')} className="px-10 py-4 text-base font-extrabold text-white rounded-xl transition-all hover:shadow-xl hover:scale-[1.02] disabled:opacity-60 disabled:hover:scale-100 flex items-center gap-3 shadow-lg w-full md:w-auto justify-center" style={{ background: 'linear-gradient(135deg, #8B5CF6, #6366F1)' }}>
                                                    {isCreatingEpic ? <span className="loader w-5 h-5 border-2"></span> : <Icon name="Upload" size={20} />}
                                                    {isCreatingEpic ? 'Pushing to Jira...' : 'Confirm & Push Epic to Jira'}
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>
                </div>
            );
        }

        /* ================================================================
           REPORTS VIEW
           ================================================================ */
        function ReportsView({ project, setIsLoading, isGlobalLoading }) {
            const [data, setData] = useState(null);
            const [timeframe, setTimeframe] = useState('weekly');
            const [showDeck, setShowDeck] = useState(false);

            useEffect(() => { setData(null); setShowDeck(false); setIsLoading(true); secureFetch(`/reports/${project}/${timeframe}`).then(r => r?.json()).then(d => { setData(d); setIsLoading(false); }); }, [project, timeframe]);
            if (!data) return <LoadingScreen msg={`Compiling ${timeframe} AI Dossier...`} />;
            const dossier = data.dossier || {};

            return (
                <div className="animate-fade-in space-y-8 h-full overflow-y-auto pb-12 pr-4">
                    <header className="flex justify-between items-end mb-10 border-b border-border pb-6">
                        <div><h2 className="text-4xl font-extrabold tracking-tight text-text-main">Artifacts</h2><p className="text-base font-medium mt-2 text-text-muted">AI Performance Dossier &middot; Executive Reports</p></div>
                        <div className="flex items-center gap-2 bg-bg-card p-1.5 rounded-xl border border-border shadow-sm">{['weekly', 'monthly', 'quarterly'].map(t => (<button key={t} onClick={() => setTimeframe(t)} className={`px-5 py-2.5 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${timeframe === t ? 'text-white shadow-md' : 'text-text-muted hover:text-text-main hover:bg-bg-hover'}`} style={timeframe === t ? { background: 'var(--accent-gradient)' } : {}}>{t}</button>))}</div>
                    </header>

                    <div className="p-8 rounded-2xl border flex justify-between items-center shadow-xl relative overflow-hidden" style={{ background: 'var(--accent-gradient)', borderColor: 'transparent' }}>
                        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>
                        <div className="relative z-10">
                            <h3 className="text-2xl font-extrabold text-white mb-2 flex items-center gap-3"><Icon name="Monitor" size={24} /> Generate {timeframe.charAt(0).toUpperCase() + timeframe.slice(1)} Business Review</h3>
                            <p className="text-base text-white/80 font-medium">The Super Agent will write a structured, multi-slide executive presentation.</p>
                        </div>
                        <button onClick={() => setShowDeck(true)} className="bg-white text-primary px-8 py-4 rounded-xl font-extrabold shadow-lg hover:shadow-xl hover:scale-105 transition-all relative z-10 flex items-center gap-3"><Icon name="Sparkles" size={20} /> Generate Deck</button>
                    </div>

                    {showDeck && <SmartDeckView project={project} endpoint={`/report_deck/${project}/${timeframe}`} isFullScreenLayout={false} onClose={() => setShowDeck(false)} />}

                    <div className="glass-card p-10 border-t-4 border-primary"><h3 className="text-sm font-black text-primary mb-6 uppercase tracking-widest flex items-center gap-3"><Icon name="Sparkles" size={18} /> The AI Verdict</h3><p className="text-3xl font-bold leading-relaxed text-text-main">{dossier.ai_verdict}</p></div>
                    <div className="grid grid-cols-3 gap-8">
                        <div className="glass-card p-8 text-center hover:border-success transition-colors"><span className="text-xs font-black text-text-muted uppercase tracking-widest">Issues Completed</span><div className="text-6xl font-black text-success mt-4">{data.completed_count}</div></div>
                        <div className="glass-card p-8 text-center hover:border-primary transition-colors"><span className="text-xs font-black text-text-muted uppercase tracking-widest">Velocity Delivered</span><div className="text-6xl font-black text-primary mt-4">{data.completed_points}</div></div>
                        <div className="glass-card p-8 text-center border-t-4 border-warning relative overflow-hidden"><Icon name="Award" size={32} className="text-warning mx-auto mb-4" /><span className="text-xs font-black text-text-muted uppercase tracking-widest">Top Contributor</span><div className="text-2xl font-extrabold mt-3 text-text-main">{dossier.top_contributor?.split('-')[0]}</div><div className="text-sm text-text-muted font-bold mt-2">{dossier.top_contributor?.split('-')[1]}</div></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="glass-card p-8 border-t-4 border-success">
                            <h3 className="text-sm font-black uppercase tracking-widest flex items-center gap-3 mb-8 text-success"><Icon name="TrendingUp" size={18} /> Key Accomplishments</h3>
                            <div className="space-y-6">{dossier.key_accomplishments?.map((acc, i) => (<div key={i} className="flex gap-5 items-start pb-6 border-b last:border-0 border-border"><div className="w-8 h-8 rounded-lg bg-success/10 text-success flex items-center justify-center font-black text-sm shrink-0">{i + 1}</div><div><h4 className="text-lg font-extrabold mb-2 text-text-main">{acc.title}</h4><p className="text-sm leading-relaxed font-medium text-text-muted">{acc.impact}</p></div></div>))}</div>
                        </div>
                        <div className="glass-card p-8 border-l-4 border-danger bg-danger/5">
                            <h3 className="text-sm font-black uppercase tracking-widest flex items-center gap-3 mb-8 text-danger"><Icon name="AlertTriangle" size={18} /> Hidden Friction Detected</h3>
                            <div className="p-6 rounded-xl bg-bg-body border border-danger/20 shadow-inner"><p className="text-base leading-relaxed font-bold text-text-main">{dossier.hidden_friction}</p></div>
                        </div>
                    </div>
                </div>
            );
        }

        /* ================================================================
           RETRO VIEW
           ================================================================ */
        function RetroView({ project, setIsLoading, isGlobalLoading }) {
            const [sprints, setSprints] = useState([]); const [activeSprint, setActiveSprint] = useState(null); const [board, setBoard] = useState(null); const [input, setInput] = useState(""); const [col, setCol] = useState("well");
            const [toast, setToast] = useState(null);
            const [chatHistory, setChatHistory] = useState([{ role: 'ai', text: "Hi! I am your AI Agile Coach. What would you like to know about this sprint's retrospective?" }]);
            const [chatInput, setChatInput] = useState(""); const [isChatting, setIsChatting] = useState(false); const chatEndRef = useRef(null);

            useEffect(() => { secureFetch(`/sprints/${project}`).then(r => r?.json()).then(d => { setSprints(d); if (d && d.length) setActiveSprint(d[0].id); }); }, [project]);
            const fetchBoard = () => { if (activeSprint) { secureFetch(`/retro/${project}?sprint_id=${activeSprint}`).then(r => r?.json()).then(setBoard); } };
            useEffect(() => { fetchBoard(); const interval = setInterval(fetchBoard, 5000); return () => clearInterval(interval); }, [project, activeSprint]);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory, isChatting]);

            const save = (b) => { setBoard(b); secureFetch(`/retro/update`, { method: 'POST', body: JSON.stringify({ project, sprint: activeSprint, board: b }) }); };
            const add = () => { if (!input.trim()) return; const n = board[col] ? [...board[col]] : []; n.push({ id: Date.now(), text: input }); save({ ...board, [col]: n }); setInput(""); };
            const remove = (columnName, itemId) => { const updatedCol = board[columnName].filter(item => item.id !== itemId); save({ ...board, [columnName]: updatedCol }); };

            const sendChat = async () => {
                if (!chatInput.trim()) return;
                const newHistory = [...chatHistory, { role: 'user', text: chatInput }]; setChatHistory(newHistory); setChatInput(""); setIsChatting(true);
                try { const r = await secureFetch(`/retro/chat`, { method: 'POST', body: JSON.stringify({ board, question: chatInput }) }); const d = await r.json(); setChatHistory([...newHistory, { role: 'ai', text: d.reply || "Sorry, I couldn't generate a response." }]); }
                catch (e) { setChatHistory([...newHistory, { role: 'ai', text: "Network error connecting to the Agile Coach." }]); }
                setIsChatting(false);
            };

            const generateInviteLink = async () => {
                const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
                const r = await secureFetch(`/guest/retro/generate_link`, { method: 'POST', body: JSON.stringify({ project, sprint: activeSprint, license_key: config.license_key }) });
                const d = await r.json();
                if (d.token) { const link = `${window.location.origin}${window.location.pathname}?guest_token=${d.token}`; navigator.clipboard.writeText(link); setToast("Guest Link copied to clipboard!"); setTimeout(() => setToast(null), 3000); }
            };

            if (!board) return <LoadingScreen msg="Fetching Retrospective..." />;
            return (
                <div className="h-full flex flex-col animate-fade-in pr-4 relative">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-4xl font-extrabold text-text-main flex items-center gap-4">
                                Retrospective
                                <button onClick={generateInviteLink} className="text-sm px-4 py-2 bg-primary-dim text-primary rounded-lg font-bold flex items-center gap-2 hover:bg-primary hover:text-white transition-colors border border-primary-dim shadow-sm"><Icon name="Link" size={16} /> Invite Team</button>
                            </h2>
                        </div>
                        <select value={activeSprint || ""} onChange={e => setActiveSprint(e.target.value)} className="p-3 rounded-lg border bg-bg-card text-text-main font-bold shadow-sm">{sprints.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                    </header>
                    <AnimatePresence>{toast && (<motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className="absolute top-0 right-4 z-50 bg-success text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-3"><Icon name="CheckCircle" size={18} /> {toast}</motion.div>)}</AnimatePresence>
                    <div className="flex gap-4 mb-10 bg-bg-card p-4 rounded-2xl border border-border shadow-lg">
                        <div className="flex bg-bg-body rounded-xl p-1.5 border border-border">{['well', 'improve', 'kudos'].map(c => (<button key={c} onClick={() => setCol(c)} className={`px-6 py-3 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${col === c ? 'bg-primary text-white shadow-md' : 'text-text-muted hover:text-text-main'}`}>{c}</button>))}</div>
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && add()} placeholder="Type feedback here..." className="flex-1 bg-transparent text-text-main px-6 font-medium text-lg outline-none" />
                        <button onClick={add} className="bg-primary px-10 text-white font-extrabold rounded-xl hover:shadow-lg hover:scale-105 transition-all">Post</button>
                    </div>
                    <div className="grid grid-cols-4 gap-8 flex-1 pb-6 min-h-0">
                        {['well', 'improve', 'kudos'].map(c => (
                            <div key={c} className="retro-col shadow-xl">
                                <div className="retro-col-header bg-bg-card/50"><span>{c}</span><Icon name={c === 'well' ? 'CheckCircle' : c === 'improve' ? 'TrendingDown' : 'Star'} size={18} /></div>
                                <div className="retro-col-body bg-bg-body/50">
                                    {board[c]?.map(i => (<div key={i.id} className="retro-card font-medium relative group"><span className="pr-6 block">{i.text}</span><button onClick={() => remove(c, i.id)} className="absolute top-2 right-2 p-1.5 bg-danger/10 text-danger rounded-md opacity-0 group-hover:opacity-100 transition-all hover:bg-danger hover:text-white"><Icon name="Trash" size={14} /></button></div>))}
                                </div>
                            </div>
                        ))}
                        <div className="retro-col shadow-xl flex flex-col h-full" style={{ background: 'var(--primary-dim)', borderColor: 'var(--primary)' }}>
                            <div className="retro-col-header text-primary shrink-0" style={{ background: 'rgba(59,130,246,0.08)' }}><span className="flex items-center gap-2"><Icon name="Sparkles" size={16} /> Ask your Agile Coach</span></div>
                            <div className="retro-col-body flex flex-col p-4 gap-4 overflow-y-auto hide-scroll flex-1" style={{ background: 'rgba(59,130,246,0.03)' }}>
                                {chatHistory.map((msg, idx) => (
                                    <div key={idx} className={`p-4 rounded-2xl max-w-[90%] text-sm shadow-sm ${msg.role === 'user' ? 'bg-primary text-white self-end rounded-br-none' : 'bg-bg-card text-text-main border border-border self-start rounded-bl-none prose prose-sm dark:prose-invert'}`}
                                        dangerouslySetInnerHTML={msg.role === 'ai' ? { __html: marked.parse(msg.text) } : undefined}>
                                        {msg.role === 'user' ? msg.text : null}
                                    </div>
                                ))}
                                {isChatting && <div className="self-start text-primary p-3"><span className="loader w-5 h-5 border-2"></span></div>}
                                <div ref={chatEndRef} />
                            </div>
                            <div className="p-3 bg-bg-card border-t border-border flex gap-3 shrink-0">
                                <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendChat()} placeholder="Ask for insights or action items..." className="flex-1 bg-bg-body text-text-main text-sm font-medium px-4 py-3 rounded-xl outline-none border border-border focus:border-primary transition-colors" />
                                <button onClick={sendChat} disabled={isChatting || !chatInput.trim()} className="bg-primary text-white px-4 rounded-xl hover:scale-105 transition disabled:opacity-50 disabled:hover:scale-100 shadow-md"><Icon name="Zap" size={18} /></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        /* ================================================================
           ROLES & TEAM VIEW — Scrum Team Management + Email
           ================================================================ */
        function RolesView({ project, setIsLoading }) {
            const SCRUM_ROLES = [
                { key: 'product_owner', label: 'Product Owner', icon: 'Award', color: 'var(--slide-accent)', desc: 'Maximizes product value, owns backlog' },
                { key: 'scrum_master', label: 'Scrum Master', icon: 'Shield', color: 'var(--slide-accent-2)', desc: 'Facilitates process, removes impediments' },
                { key: 'dev_team', label: 'Development Team', icon: 'GitBranch', color: 'var(--slide-accent-3)', desc: 'Cross-functional builders who deliver increments' },
                { key: 'qa_team', label: 'QA Team', icon: 'Crosshair', color: 'var(--warning)', desc: 'Quality assurance & test automation' },
                { key: 'product_manager', label: 'Product Manager', icon: 'Target', color: '#F43F5E', desc: 'Strategic alignment, roadmap ownership' },
                { key: 'stakeholder', label: 'Stakeholders', icon: 'Briefcase', color: '#8B5CF6', desc: 'Sponsors, directors & business leaders' },
            ];

            const [team, setTeam] = useState([]);
            const [jiraUsers, setJiraUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fetchingJira, setFetchingJira] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingMember, setEditingMember] = useState(null);
            const [toast, setToast] = useState(null);

            // Add form state
            const [formRole, setFormRole] = useState('dev_team');
            const [formName, setFormName] = useState('');
            const [formEmail, setFormEmail] = useState('');

            // Email compose state
            const [showEmailCompose, setShowEmailCompose] = useState(false);
            const [selectedRecipients, setSelectedRecipients] = useState([]);
            const [emailSubject, setEmailSubject] = useState('');
            const [emailBody, setEmailBody] = useState('');
            const [isGeneratingEmail, setIsGeneratingEmail] = useState(false);
            const [isSendingEmail, setIsSendingEmail] = useState(false);
            const [emailSentStatus, setEmailSentStatus] = useState(null);

            // Load team on mount
            useEffect(() => {
                loadTeam();
            }, [project]);

            const loadTeam = async () => {
                setLoading(true);
                try {
                    const r = await secureFetch(`/team/${project}`);
                    if (r && r.ok) {
                        const data = await r.json();
                        setTeam(data.team || []);
                        setJiraUsers(data.jira_users || []);
                    }
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            const fetchFromJira = async () => {
                setFetchingJira(true);
                try {
                    const r = await secureFetch(`/team/${project}/fetch_jira`);
                    if (r && r.ok) {
                        const data = await r.json();
                        setJiraUsers(data.jira_users || []);
                        if (data.jira_users?.length > 0) {
                            showToast(`Found ${data.jira_users.length} team members from Jira!`, 'success');
                        } else {
                            showToast('No assignable users found in Jira. Add your team manually below.', 'warning');
                        }
                    }
                } catch (e) { showToast('Failed to fetch from Jira.', 'error'); }
                setFetchingJira(false);
            };

            const saveTeam = async (updatedTeam) => {
                setTeam(updatedTeam);
                try {
                    await secureFetch(`/team/${project}/save`, {
                        method: 'POST',
                        body: JSON.stringify({ team: updatedTeam })
                    });
                } catch (e) { console.error(e); }
            };

            const addMember = () => {
                if (!formName.trim()) return;
                const newMember = {
                    id: Date.now(),
                    name: formName.trim(),
                    email: formEmail.trim(),
                    role: formRole,
                    added_at: new Date().toISOString()
                };
                const updated = [...team, newMember];
                saveTeam(updated);
                setFormName(''); setFormEmail(''); setShowAddForm(false);
                showToast(`${formName} added as ${SCRUM_ROLES.find(r => r.key === formRole)?.label}`, 'success');
            };

            const addJiraUser = (jiraUser) => {
                // Check if already added
                if (team.some(m => m.name === jiraUser.displayName)) {
                    showToast(`${jiraUser.displayName} is already in the team.`, 'warning');
                    return;
                }
                setFormName(jiraUser.displayName);
                setFormEmail(jiraUser.email || '');
                setShowAddForm(true);
            };

            const removeMember = (id) => {
                const updated = team.filter(m => m.id !== id);
                saveTeam(updated);
                showToast('Member removed.', 'success');
            };

            const updateMember = (id, field, value) => {
                const updated = team.map(m => m.id === id ? { ...m, [field]: value } : m);
                saveTeam(updated);
            };

            const showToast = (text, type = 'success') => {
                setToast({ text, type });
                setTimeout(() => setToast(null), 3500);
            };

            // Email functions
            const toggleRecipient = (member) => {
                setSelectedRecipients(prev => {
                    const exists = prev.find(r => r.id === member.id);
                    return exists ? prev.filter(r => r.id !== member.id) : [...prev, member];
                });
            };

            const selectRoleGroup = (roleKey) => {
                const roleMembers = team.filter(m => m.role === roleKey && m.email);
                const allSelected = roleMembers.every(rm => selectedRecipients.find(sr => sr.id === rm.id));
                if (allSelected) {
                    setSelectedRecipients(prev => prev.filter(p => !roleMembers.find(rm => rm.id === p.id)));
                } else {
                    const newRecipients = [...selectedRecipients];
                    roleMembers.forEach(rm => {
                        if (!newRecipients.find(nr => nr.id === rm.id)) newRecipients.push(rm);
                    });
                    setSelectedRecipients(newRecipients);
                }
            };

            const generateEmailDraft = async () => {
                setIsGeneratingEmail(true);
                try {
                    const recipientRoles = [...new Set(selectedRecipients.map(r => SCRUM_ROLES.find(sr => sr.key === r.role)?.label || r.role))].join(', ');
                    const r = await secureFetch('/team/generate_email', {
                        method: 'POST',
                        body: JSON.stringify({ project, recipients: recipientRoles, context: `Sprint update email for project ${project}` })
                    });
                    if (r && r.ok) {
                        const data = await r.json();
                        setEmailSubject(data.subject || '');
                        setEmailBody(data.body || '');
                    }
                } catch (e) { console.error(e); }
                setIsGeneratingEmail(false);
            };

            const sendDirectEmail = async () => {
                const toEmails = selectedRecipients.filter(r => r.email).map(r => r.email);
                if (!toEmails.length) { showToast('No email addresses found for selected recipients.', 'error'); return; }
                if (!emailSubject.trim() && !emailBody.trim()) { showToast('Please add a subject or message.', 'error'); return; }

                setIsSendingEmail(true); setEmailSentStatus(null);
                try {
                    const r = await secureFetch('/team/send_email', {
                        method: 'POST',
                        body: JSON.stringify({
                            project,
                            recipients: toEmails,
                            recipient_names: selectedRecipients.filter(r => r.email).map(r => r.name),
                            subject: emailSubject,
                            body: emailBody
                        })
                    });
                    if (r && r.ok) {
                        const data = await r.json();
                        if (data.status === 'sent') {
                            setEmailSentStatus({ type: 'success', text: `Email delivered to ${toEmails.length} recipient${toEmails.length > 1 ? 's' : ''} successfully!` });
                            showToast('Email sent!', 'success');
                        } else {
                            setEmailSentStatus({ type: 'error', text: data.message || 'Failed to send email.' });
                        }
                    } else {
                        setEmailSentStatus({ type: 'error', text: 'Server error sending email.' });
                    }
                } catch (e) {
                    setEmailSentStatus({ type: 'error', text: 'Network error. Try "Open in Mail Client" instead.' });
                }
                setIsSendingEmail(false);
            };

            const openInMailClient = () => {
                const toEmails = selectedRecipients.filter(r => r.email).map(r => r.email).join(',');
                if (!toEmails) { showToast('No email addresses found for selected recipients.', 'error'); return; }
                const mailtoLink = `mailto:${toEmails}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                window.open(mailtoLink, '_blank');
                showToast('Email client opened with your draft!', 'success');
            };

            const copyEmailAddresses = () => {
                const emails = selectedRecipients.filter(r => r.email).map(r => r.email).join('; ');
                navigator.clipboard.writeText(emails);
                showToast('Email addresses copied to clipboard!', 'success');
            };

            if (loading) return <LoadingScreen msg="Loading Team & Roles..." />;

            const getMembersByRole = (roleKey) => team.filter(m => m.role === roleKey);
            const membersWithEmail = team.filter(m => m.email);

            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4 space-y-10 relative">
                    {/* Toast */}
                    <AnimatePresence>
                        {toast && (
                            <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className={`fixed top-4 right-8 z-50 px-6 py-3 rounded-xl font-bold shadow-2xl flex items-center gap-3 text-sm border ${toast.type === 'success' ? 'bg-success/15 text-success border-success/30' : toast.type === 'error' ? 'bg-danger/15 text-danger border-danger/30' : 'bg-warning/15 text-warning border-warning/30'}`}>
                                <Icon name={toast.type === 'success' ? 'CheckCircle' : toast.type === 'error' ? 'AlertTriangle' : 'AlertTriangle'} size={18} /> {toast.text}
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Header */}
                    <header className="flex justify-between items-end pb-6 border-b border-border">
                        <div>
                            <h2 className="text-4xl font-extrabold tracking-tight text-text-main">Roles & Team</h2>
                            <p className="text-base font-medium mt-2 text-text-muted">Scrum Team Management &middot; Project <span className="text-primary font-black">{project}</span></p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={fetchFromJira} disabled={fetchingJira} className="px-5 py-3 bg-bg-card border border-border rounded-xl font-bold text-text-muted hover:text-primary hover:border-primary transition-all flex items-center gap-2 text-sm disabled:opacity-50">
                                {fetchingJira ? <span className="loader w-4 h-4 border-2"></span> : <Icon name="RefreshCcw" size={16} />}
                                Fetch from Jira
                            </button>
                            <button onClick={() => { setShowAddForm(true); setEditingMember(null); setFormName(''); setFormEmail(''); }} className="px-5 py-3 text-white rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all" style={{ background: 'var(--accent-gradient)' }}>
                                <Icon name="UserPlus" size={16} /> Add Team Member
                            </button>
                            {membersWithEmail.length > 0 && (
                                <button onClick={() => { setShowEmailCompose(true); setSelectedRecipients([]); setEmailSubject(''); setEmailBody(''); setEmailSentStatus(null); }} className="px-5 py-3 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all text-white" style={{ background: 'linear-gradient(135deg, #F59E0B, #F43F5E)' }}>
                                    <Icon name="Mail" size={16} /> Compose Email
                                </button>
                            )}
                        </div>
                    </header>

                    {/* Jira Users Discovery */}
                    <AnimatePresence>
                        {jiraUsers.length > 0 && (
                            <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} exit={{ opacity: 0, height: 0 }} className="glass-card p-6 border-t-4 border-primary overflow-hidden">
                                <h3 className="text-sm font-black uppercase tracking-widest text-primary mb-4 flex items-center gap-2"><Icon name="Globe" size={16} /> Jira Team Members Discovered</h3>
                                <p className="text-xs text-text-muted mb-4 font-medium">Click a member to add them to your Scrum team with a role assignment.</p>
                                <div className="flex flex-wrap gap-3">
                                    {jiraUsers.map((u, i) => {
                                        const alreadyAdded = team.some(m => m.name === u.displayName);
                                        return (
                                            <motion.button key={i} initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: i * 0.03 }}
                                                onClick={() => !alreadyAdded && addJiraUser(u)}
                                                disabled={alreadyAdded}
                                                className={`flex items-center gap-3 px-4 py-3 rounded-xl border text-sm font-bold transition-all ${alreadyAdded ? 'opacity-40 cursor-not-allowed bg-bg-body border-border' : 'bg-bg-card border-border hover:border-primary hover:shadow-md cursor-pointer hover:scale-[1.02]'}`}>
                                                {u.avatar ? <img src={u.avatar} className="w-8 h-8 rounded-full border-2 border-primary" /> : <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs" style={{ background: 'var(--accent-gradient)' }}>{u.displayName?.charAt(0)}</div>}
                                                <div className="text-left">
                                                    <div className="text-text-main">{u.displayName}</div>
                                                    {u.email && <div className="text-xs text-text-muted font-normal">{u.email}</div>}
                                                </div>
                                                {alreadyAdded && <Icon name="CheckCircle" size={16} className="text-success ml-2" />}
                                                {!alreadyAdded && <Icon name="Plus" size={16} className="text-primary ml-2" />}
                                            </motion.button>
                                        );
                                    })}
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Add Member Form */}
                    <AnimatePresence>
                        {showAddForm && (
                            <motion.div initial={{ opacity: 0, y: -20, height: 0 }} animate={{ opacity: 1, y: 0, height: 'auto' }} exit={{ opacity: 0, y: -20, height: 0 }} className="glass-card p-8 border-l-4 border-primary overflow-hidden relative">
                                <div className="absolute top-0 right-0 w-48 h-48 rounded-full blur-3xl -mr-12 -mt-12 pointer-events-none opacity-40" style={{ background: 'var(--glow-primary)' }}></div>
                                <div className="flex justify-between items-center mb-6 relative z-10">
                                    <h3 className="text-lg font-extrabold text-text-main flex items-center gap-3"><Icon name="UserPlus" size={20} className="text-primary" /> Add Team Member</h3>
                                    <button onClick={() => setShowAddForm(false)} className="p-2 hover:bg-bg-hover rounded-lg transition"><Icon name="X" size={18} className="text-text-muted" /></button>
                                </div>
                                <div className="grid grid-cols-3 gap-6 relative z-10">
                                    <div>
                                        <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Scrum Role</label>
                                        <select value={formRole} onChange={e => setFormRole(e.target.value)} className="w-full p-3 rounded-xl text-sm input-field font-bold shadow-sm">
                                            {SCRUM_ROLES.map(r => <option key={r.key} value={r.key}>{r.label}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Full Name</label>
                                        <input value={formName} onChange={e => setFormName(e.target.value)} placeholder="e.g. Jane Smith" className="w-full p-3 rounded-xl text-sm input-field font-semibold shadow-sm" onKeyDown={e => e.key === 'Enter' && addMember()} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Email Address</label>
                                        <div className="flex gap-3">
                                            <input value={formEmail} onChange={e => setFormEmail(e.target.value)} placeholder="jane@company.com" className="flex-1 p-3 rounded-xl text-sm input-field font-semibold shadow-sm" onKeyDown={e => e.key === 'Enter' && addMember()} />
                                            <button onClick={addMember} disabled={!formName.trim()} className="px-6 py-3 text-white rounded-xl font-extrabold text-sm shadow-md hover:shadow-lg hover:scale-[1.02] transition-all disabled:opacity-50 disabled:hover:scale-100 flex items-center gap-2" style={{ background: 'var(--accent-gradient)' }}>
                                                <Icon name="Plus" size={16} /> Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Role Cards Grid */}
                    <div className="grid grid-cols-3 gap-6">
                        {SCRUM_ROLES.map((role, ri) => {
                            const members = getMembersByRole(role.key);
                            return (
                                <motion.div key={role.key} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: ri * 0.06 }} className="glass-card overflow-hidden hover:shadow-xl transition-shadow group">
                                    {/* Role Header */}
                                    <div className="p-5 border-b border-border relative overflow-hidden" style={{ background: `${role.color}08` }}>
                                        <div className="absolute top-0 left-0 right-0 h-1" style={{ background: `linear-gradient(90deg, ${role.color}, transparent)` }} />
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-xl flex items-center justify-center shrink-0" style={{ background: `${role.color}15`, color: role.color, border: `1px solid ${role.color}25` }}>
                                                <Icon name={role.icon} size={22} />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h4 className="font-extrabold text-text-main text-sm tracking-tight">{role.label}</h4>
                                                <p className="text-xs text-text-muted font-medium mt-0.5 truncate">{role.desc}</p>
                                            </div>
                                            <span className="text-xs font-black px-2.5 py-1 rounded-full" style={{ background: `${role.color}15`, color: role.color }}>{members.length}</span>
                                        </div>
                                    </div>
                                    {/* Members List */}
                                    <div className="p-4 min-h-[120px] flex flex-col gap-2">
                                        {members.length === 0 ? (
                                            <div className="flex-1 flex flex-col items-center justify-center py-6 opacity-40">
                                                <Icon name={role.icon} size={28} className="text-text-muted mb-2" />
                                                <span className="text-xs font-bold text-text-muted">No members assigned</span>
                                            </div>
                                        ) : members.map(member => (
                                            <motion.div key={member.id} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} className="flex items-center gap-3 p-3 bg-bg-body rounded-xl border border-border hover:border-primary transition-all group/member relative">
                                                <div className="w-9 h-9 rounded-full flex items-center justify-center text-white font-bold text-xs shrink-0 shadow-md" style={{ background: `linear-gradient(135deg, ${role.color}, ${role.color}CC)` }}>
                                                    {member.name?.charAt(0)?.toUpperCase()}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold text-text-main text-sm truncate">{member.name}</div>
                                                    {member.email && <div className="text-xs text-text-muted truncate flex items-center gap-1"><Icon name="Mail" size={10} /> {member.email}</div>}
                                                </div>
                                                <div className="flex gap-1 opacity-0 group-hover/member:opacity-100 transition-opacity">
                                                    <button onClick={() => removeMember(member.id)} className="p-1.5 hover:bg-danger/10 rounded-lg transition" title="Remove"><Icon name="Trash" size={14} className="text-danger" /></button>
                                                </div>
                                            </motion.div>
                                        ))}
                                        <button onClick={() => { setFormRole(role.key); setFormName(''); setFormEmail(''); setShowAddForm(true); }} className="mt-1 p-2 border border-dashed border-border rounded-xl text-xs font-bold text-text-muted hover:text-primary hover:border-primary transition-all flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100">
                                            <Icon name="Plus" size={14} /> Add {role.label}
                                        </button>
                                    </div>
                                </motion.div>
                            );
                        })}
                    </div>

                    {/* Team Summary Stats */}
                    {team.length > 0 && (
                        <div className="glass-card p-8">
                            <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2"><Icon name="BarChart" size={16} /> Team Summary</h3>
                            <div className="grid grid-cols-6 gap-4">
                                {SCRUM_ROLES.map(role => {
                                    const count = getMembersByRole(role.key).length;
                                    return (
                                        <div key={role.key} className="text-center p-4 bg-bg-body rounded-xl border border-border">
                                            <div className="text-3xl font-black text-text-main mb-1">{count}</div>
                                            <div className="text-xs font-bold text-text-muted truncate">{role.label}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Email Compose Panel */}
                    <AnimatePresence>
                        {showEmailCompose && (
                            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 20 }} className="glass-card overflow-hidden border-t-4 shadow-2xl relative" style={{ borderTopColor: '#F59E0B' }}>
                                <div className="absolute top-0 right-0 w-80 h-80 rounded-full blur-3xl -mr-24 -mt-24 pointer-events-none" style={{ background: 'rgba(245, 158, 11, 0.08)' }}></div>

                                {/* Email Header */}
                                <div className="p-8 border-b border-border relative z-10">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-2xl font-extrabold text-text-main flex items-center gap-3"><Icon name="Send" size={24} className="text-warning" /> Compose Team Email</h3>
                                            <p className="text-sm text-text-muted font-medium mt-2">Select recipients by name or role group, then compose and send.</p>
                                        </div>
                                        <button onClick={() => setShowEmailCompose(false)} className="p-2 hover:bg-bg-hover rounded-lg transition"><Icon name="X" size={20} className="text-text-muted" /></button>
                                    </div>
                                </div>

                                {/* Recipient Selection */}
                                <div className="p-8 bg-bg-body border-b border-border relative z-10">
                                    <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-4 block">Select Recipients</label>

                                    {/* Quick Role Selectors */}
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {SCRUM_ROLES.map(role => {
                                            const roleMembers = team.filter(m => m.role === role.key && m.email);
                                            if (roleMembers.length === 0) return null;
                                            const allSelected = roleMembers.every(rm => selectedRecipients.find(sr => sr.id === rm.id));
                                            return (
                                                <button key={role.key} onClick={() => selectRoleGroup(role.key)}
                                                    className={`px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 ${allSelected ? 'text-white shadow-md' : 'bg-bg-card border-border text-text-muted hover:border-primary hover:text-primary'}`}
                                                    style={allSelected ? { background: role.color, borderColor: role.color } : {}}>
                                                    <Icon name={role.icon} size={14} /> All {role.label}s
                                                </button>
                                            );
                                        })}
                                    </div>

                                    {/* Individual Members */}
                                    <div className="flex flex-wrap gap-2">
                                        {team.filter(m => m.email).map(member => {
                                            const isSelected = selectedRecipients.find(r => r.id === member.id);
                                            const role = SCRUM_ROLES.find(r => r.key === member.role);
                                            return (
                                                <button key={member.id} onClick={() => toggleRecipient(member)}
                                                    className={`flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold border transition-all ${isSelected ? 'border-primary bg-primary-dim text-primary shadow-sm' : 'bg-bg-card border-border text-text-muted hover:border-primary'}`}>
                                                    <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px] font-bold shrink-0" style={{ background: role?.color || 'var(--primary)' }}>
                                                        {member.name?.charAt(0)?.toUpperCase()}
                                                    </div>
                                                    {member.name}
                                                    {isSelected && <Icon name="CheckCircle" size={14} className="text-primary" />}
                                                </button>
                                            );
                                        })}
                                    </div>

                                    {selectedRecipients.length > 0 && (
                                        <div className="mt-4 flex items-center gap-2 text-xs font-bold text-primary">
                                            <Icon name="Mail" size={14} />
                                            {selectedRecipients.length} recipient{selectedRecipients.length !== 1 ? 's' : ''} selected
                                            <button onClick={copyEmailAddresses} className="ml-2 px-3 py-1 bg-primary-dim rounded-lg hover:bg-primary hover:text-white transition-all flex items-center gap-1">
                                                <Icon name="Copy" size={12} /> Copy Emails
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Email Compose */}
                                {selectedRecipients.length > 0 && (
                                    <div className="p-8 relative z-10 space-y-6">
                                        {/* To: line showing recipients */}
                                        <div className="flex items-start gap-3">
                                            <span className="text-xs font-black text-text-muted uppercase tracking-widest mt-2.5 shrink-0 w-8">To:</span>
                                            <div className="flex flex-wrap gap-2 flex-1">
                                                {selectedRecipients.map(r => (
                                                    <span key={r.id} className="flex items-center gap-2 px-3 py-1.5 bg-primary-dim border border-primary/20 rounded-full text-xs font-bold text-primary">
                                                        {r.name} {r.email && <span className="text-primary/60 font-normal">&lt;{r.email}&gt;</span>}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Subject + AI Draft */}
                                        <div className="flex gap-4">
                                            <div className="flex-1">
                                                <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Subject</label>
                                                <input value={emailSubject} onChange={e => setEmailSubject(e.target.value)} placeholder="e.g. Sprint Review Update — Project ABC" className="w-full p-3 rounded-xl text-sm input-field font-semibold shadow-sm" />
                                            </div>
                                            <button onClick={generateEmailDraft} disabled={isGeneratingEmail} className="self-end px-5 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md hover:shadow-lg hover:scale-[1.02] transition-all text-white disabled:opacity-50" style={{ background: 'var(--accent-gradient)' }}>
                                                {isGeneratingEmail ? <span className="loader w-4 h-4 border-2"></span> : <Icon name="Sparkles" size={16} />}
                                                AI Draft
                                            </button>
                                        </div>

                                        {/* Body */}
                                        <div>
                                            <label className="text-xs font-black text-text-muted uppercase tracking-widest mb-2 block">Message Body</label>
                                            <textarea value={emailBody} onChange={e => setEmailBody(e.target.value)} rows={8} placeholder="Write your message here, or click AI Draft to auto-generate..." className="w-full p-4 rounded-xl text-sm input-field font-medium shadow-sm resize-y leading-relaxed" />
                                        </div>

                                        {/* Send Status */}
                                        <AnimatePresence>
                                            {emailSentStatus && (
                                                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`p-4 rounded-xl text-sm font-bold border flex items-center gap-3 shadow-md ${emailSentStatus.type === 'success' ? 'bg-success/10 text-success border-success/30' : 'bg-danger/10 text-danger border-danger/30'}`}>
                                                    <Icon name={emailSentStatus.type === 'success' ? 'CheckCircle' : 'AlertTriangle'} size={20} />
                                                    <span className="flex-1">{emailSentStatus.text}</span>
                                                    <button onClick={() => setEmailSentStatus(null)} className="p-1 hover:opacity-70 transition"><Icon name="X" size={14} /></button>
                                                </motion.div>
                                            )}
                                        </AnimatePresence>

                                        {/* Action Buttons */}
                                        <div className="flex justify-between items-center pt-4 border-t border-border">
                                            <button onClick={copyEmailAddresses} className="px-4 py-2.5 bg-bg-card border border-border rounded-xl font-bold text-text-muted hover:text-text-main transition-all flex items-center gap-2 text-xs">
                                                <Icon name="Copy" size={14} /> Copy Addresses
                                            </button>
                                            <div className="flex gap-3">
                                                <button onClick={openInMailClient} disabled={!emailSubject && !emailBody} className="px-5 py-3 bg-bg-card border border-border rounded-xl font-bold text-text-muted hover:text-primary hover:border-primary transition-all flex items-center gap-2 text-sm disabled:opacity-40">
                                                    <Icon name="ExternalLink" size={16} /> Open in Mail Client
                                                </button>
                                                <button onClick={sendDirectEmail} disabled={isSendingEmail || (!emailSubject && !emailBody)} className="px-8 py-3 text-white rounded-xl font-extrabold text-sm shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:hover:scale-100 flex items-center gap-3" style={{ background: 'linear-gradient(135deg, #10B981, #059669)' }}>
                                                    {isSendingEmail ? <><span className="loader w-4 h-4 border-2"></span> Sending...</> : <><Icon name="Send" size={16} /> Send Email</>}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Empty State */}
                    {team.length === 0 && jiraUsers.length === 0 && (
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="glass-card p-16 flex flex-col items-center justify-center text-center">
                            <div className="w-20 h-20 rounded-2xl flex items-center justify-center mb-6 mx-auto" style={{ background: 'var(--primary-dim)', color: 'var(--primary)' }}>
                                <Icon name="Users" size={36} />
                            </div>
                            <h3 className="text-2xl font-extrabold text-text-main mb-3">Build Your Scrum Team</h3>
                            <p className="text-text-muted font-medium max-w-lg mb-8">
                                As defined in Essential Scrum by Kenneth S. Rubin, every Scrum project needs clearly defined roles. Start by fetching your team from Jira, or add members manually.
                            </p>
                            <div className="flex gap-4">
                                <button onClick={fetchFromJira} disabled={fetchingJira} className="px-6 py-3 bg-bg-card border border-border rounded-xl font-bold text-text-muted hover:text-primary hover:border-primary transition-all flex items-center gap-2 text-sm">
                                    {fetchingJira ? <span className="loader w-4 h-4 border-2"></span> : <Icon name="Globe" size={16} />}
                                    Fetch from Jira
                                </button>
                                <button onClick={() => setShowAddForm(true)} className="px-6 py-3 text-white rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg" style={{ background: 'var(--accent-gradient)' }}>
                                    <Icon name="UserPlus" size={16} /> Add Manually
                                </button>
                            </div>
                        </motion.div>
                    )}
                </div>
            );
        }

        /* ================================================================
           MEETING AGENT VIEW — AI Meeting Transcript Processor
           ================================================================ */
        function MeetingAgentView({ project, setIsLoading }) {
            const [subView, setSubView] = useState('input'); // input | results | history | capacity
            const [transcript, setTranscript] = useState('');
            const [meetingType, setMeetingType] = useState('');
            const [processing, setProcessing] = useState(false);
            const [results, setResults] = useState(null);
            const [sessionId, setSessionId] = useState(null);
            const [selectedStories, setSelectedStories] = useState(new Set());
            const [selectedEpics, setSelectedEpics] = useState(new Set());
            const [creating, setCreating] = useState(false);
            const [createdIssues, setCreatedIssues] = useState([]);
            const [history, setHistory] = useState([]);
            const [capacityData, setCapacityData] = useState(null);
            const [sprintHistory, setSprintHistory] = useState(null);
            const [loadingCapacity, setLoadingCapacity] = useState(false);
            const [error, setError] = useState(null);

            // Load meeting history on mount
            useEffect(() => {
                if (project) {
                    secureFetch(`/meeting/sessions/${project}`).then(r => r?.json()).then(d => { if (Array.isArray(d)) setHistory(d); });
                }
            }, [project]);

            const processTranscript = async () => {
                if (!transcript.trim() || transcript.trim().length < 50) {
                    setError('Please paste a transcript with at least 50 characters.');
                    return;
                }
                setProcessing(true); setError(null); setResults(null);
                try {
                    const body = { transcript, project, meeting_type: meetingType || undefined, platform: 'manual' };
                    const res = await secureFetch('/meeting/upload', { method: 'POST', body: JSON.stringify(body) });
                    const data = await res?.json();
                    if (data?.status === 'success') {
                        setResults(data.results);
                        setSessionId(data.session_id);
                        // Auto-select all stories
                        const stories = data.results?.extracted?.stories || [];
                        setSelectedStories(new Set(stories.map((_, i) => i)));
                        const epics = data.results?.extracted?.epics || [];
                        setSelectedEpics(new Set(epics.map((_, i) => i)));
                        setSubView('results');
                    } else {
                        setError(data?.message || 'Processing failed. Please try again.');
                    }
                } catch (e) { setError('Network error. Please check your connection.'); }
                setProcessing(false);
            };

            const approveAndCreate = async () => {
                if (!sessionId || selectedStories.size === 0) return;
                setCreating(true);
                try {
                    const body = { story_indices: [...selectedStories], epic_indices: [...selectedEpics], auto_assign: true };
                    const res = await secureFetch(`/meeting/session/${sessionId}/approve`, { method: 'POST', body: JSON.stringify(body) });
                    const data = await res?.json();
                    if (data?.status === 'success') {
                        setCreatedIssues(data.created || []);
                    } else {
                        setError(data?.message || 'Failed to create issues.');
                    }
                } catch (e) { setError('Network error during creation.'); }
                setCreating(false);
            };

            const loadCapacity = async () => {
                setLoadingCapacity(true);
                try {
                    const [capRes, histRes] = await Promise.all([
                        secureFetch(`/meeting/capacity/${project}`).then(r => r?.json()),
                        secureFetch(`/meeting/history/${project}`).then(r => r?.json())
                    ]);
                    if (capRes) setCapacityData(capRes);
                    if (histRes) setSprintHistory(histRes);
                } catch (e) { setError('Could not load capacity data.'); }
                setLoadingCapacity(false);
            };

            const loadSession = async (sid) => {
                try {
                    const res = await secureFetch(`/meeting/session/${sid}`);
                    const data = await res?.json();
                    if (data?.results) {
                        setResults(data.results);
                        setSessionId(sid);
                        const stories = data.results?.extracted?.stories || [];
                        setSelectedStories(new Set(stories.map((_, i) => i)));
                        setSubView('results');
                    }
                } catch (e) { setError('Could not load session.'); }
            };

            const stories = results?.extracted?.stories || [];
            const epics = results?.extracted?.epics || [];
            const summary = results?.extracted?.discussion_summary || '';
            const capacityConcerns = results?.extracted?.capacity_concerns || [];
            const actionItems = results?.extracted?.action_items || [];
            const velocity = results?.velocity || {};
            const capacityReport = results?.capacity_report || {};

            const fitBadge = (fit) => {
                if (fit === 'fits') return { bg: 'var(--success)', text: '✅ Fits' };
                if (fit === 'tight') return { bg: 'var(--warning)', text: '⚠️ Tight' };
                if (fit === 'wont_fit') return { bg: 'var(--danger)', text: '❌ Over' };
                return { bg: 'var(--border)', text: '❓ Unknown' };
            };

            const meetingTypeLabel = (t) => {
                const labels = { sprint_planning: 'Sprint Planning', backlog_grooming: 'Backlog Grooming', retrospective: 'Retrospective', capacity_planning: 'Capacity Planning', daily_standup: 'Daily Standup', sprint_review: 'Sprint Review' };
                return labels[t] || t || 'Auto-detect';
            };

            return (
                <div className="animate-fade-in h-full overflow-y-auto pb-12 pr-4 space-y-8">
                    {/* Header */}
                    <header className="flex justify-between items-end pb-6 border-b border-border">
                        <div>
                            <h2 className="text-4xl font-extrabold tracking-tight text-text-main flex items-center gap-3">
                                <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ background: 'var(--accent-gradient)', color: 'white' }}><Icon name="MessageSquare" size={24} /></div>
                                Meeting Agent
                            </h2>
                            <p className="text-base font-medium mt-2 text-text-muted">AI-Powered Agile Ceremony Processor · Project <span className="text-primary font-black">{project}</span></p>
                        </div>
                        <div className="flex gap-2">
                            {['input', 'results', 'capacity', 'history'].map(v => (
                                <button key={v} onClick={() => { if (v === 'capacity' && !capacityData) loadCapacity(); setSubView(v); }}
                                    className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${subView === v ? 'bg-primary text-white' : 'bg-bg-card text-text-muted border border-border hover:border-primary'}`}>
                                    {v === 'input' ? 'New Session' : v === 'results' ? 'Results' : v === 'capacity' ? 'Capacity' : 'History'}
                                </button>
                            ))}
                        </div>
                    </header>

                    {error && (
                        <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} className="p-4 rounded-xl bg-danger/10 border border-danger/20 text-danger text-sm font-bold flex justify-between items-center">
                            <span>{error}</span>
                            <button onClick={() => setError(null)} className="hover:opacity-70"><Icon name="X" size={16} /></button>
                        </motion.div>
                    )}

                    {/* ——— INPUT SUB-VIEW ——— */}
                    {subView === 'input' && (
                        <div className="space-y-6">
                            <div className="glass-card p-8 space-y-6 relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none opacity-50" style={{ background: 'var(--glow-primary)' }} />
                                <div className="relative z-10">
                                    <h3 className="text-lg font-extrabold text-text-main mb-1 flex items-center gap-2"><Icon name="Upload" size={20} className="text-primary" /> Paste Meeting Transcript</h3>
                                    <p className="text-sm text-text-muted font-medium mb-4">Paste your Sprint Planning, Grooming, Retrospective, or Capacity Planning transcript below.</p>

                                    <div className="flex gap-4 mb-4">
                                        <div className="flex-1">
                                            <label className="text-xs font-bold uppercase tracking-wider text-text-muted mb-2 block">Meeting Type</label>
                                            <select value={meetingType} onChange={e => setMeetingType(e.target.value)} className="w-full p-3 rounded-lg text-sm input-field font-semibold">
                                                <option value="">Auto-detect from transcript</option>
                                                <option value="sprint_planning">Sprint Planning</option>
                                                <option value="backlog_grooming">Backlog Grooming / Refinement</option>
                                                <option value="retrospective">Retrospective</option>
                                                <option value="capacity_planning">Capacity Planning</option>
                                                <option value="daily_standup">Daily Standup</option>
                                                <option value="sprint_review">Sprint Review / Demo</option>
                                            </select>
                                        </div>
                                    </div>

                                    <textarea value={transcript} onChange={e => setTranscript(e.target.value)}
                                        placeholder={"Paste your meeting transcript here...\n\nExample:\nSarah: Let's discuss the user authentication story. We need SSO integration with Google and Microsoft.\nJohn: I think that's about 8 points. The OAuth flow is complex.\nSarah: Agreed. Let's also add a password reset feature.\nMike: That's simpler, maybe 3 points. I can take that one.\n..."}
                                        className="w-full h-64 p-4 rounded-xl input-field font-mono text-sm resize-none leading-relaxed"
                                        style={{ minHeight: '250px' }} />

                                    <div className="flex justify-between items-center mt-4">
                                        <span className="text-xs text-text-muted font-medium">{transcript.length} characters · {transcript.split(/\s+/).filter(w => w).length} words</span>
                                        <button onClick={processTranscript} disabled={processing || transcript.trim().length < 50}
                                            className="px-8 py-3 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex items-center gap-3 text-sm disabled:opacity-50 disabled:hover:scale-100"
                                            style={{ background: 'var(--accent-gradient)' }}>
                                            {processing ? <><span className="loader w-5 h-5 border-2" /> Analyzing with AI...</> : <><Icon name="Sparkles" size={18} /> Process Transcript</>}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Quick Tips */}
                            <div className="grid grid-cols-3 gap-4">
                                {[
                                    { icon: 'Zap', title: 'Sprint Planning', desc: 'Auto-generates user stories with acceptance criteria and point estimates' },
                                    { icon: 'RefreshCcw', title: 'Retrospective', desc: 'Extracts what went well, improvements, and action items' },
                                    { icon: 'BarChart', title: 'Capacity Planning', desc: 'Analyzes team velocity and sprint fit for each story' }
                                ].map((tip, i) => (
                                    <div key={i} className="glass-card p-5 flex gap-4 items-start hover:border-primary transition-colors">
                                        <div className="w-10 h-10 rounded-lg flex items-center justify-center shrink-0" style={{ background: 'var(--primary-dim)', color: 'var(--primary)' }}><Icon name={tip.icon} size={20} /></div>
                                        <div><h4 className="font-bold text-text-main text-sm">{tip.title}</h4><p className="text-xs text-text-muted mt-1 leading-relaxed">{tip.desc}</p></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* ——— RESULTS SUB-VIEW ——— */}
                    {subView === 'results' && results && (
                        <div className="space-y-6">
                            {/* Summary Card */}
                            <div className="glass-card p-8 border-t-4 border-primary relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none opacity-30" style={{ background: 'var(--glow-primary)' }} />
                                <div className="relative z-10">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="px-3 py-1 rounded-full text-xs font-bold" style={{ background: 'var(--primary-dim)', color: 'var(--primary)' }}>
                                            {meetingTypeLabel(results.meeting_type)}
                                        </span>
                                        <span className="text-xs font-bold text-text-muted">{stories.length} stories · {epics.length} epics · {results?.extracted?.total_estimated_points || 0} total points</span>
                                    </div>
                                    <p className="text-base font-semibold text-text-main leading-relaxed">{summary}</p>
                                </div>
                            </div>

                            {/* Metric Cards */}
                            <div className="grid grid-cols-4 gap-4">
                                <MetricCard label="Stories Found" value={stories.length} color="primary" />
                                <MetricCard label="Total Points" value={results?.extracted?.total_estimated_points || 0} color="success" />
                                <MetricCard label="Team Velocity" value={velocity?.avg_velocity || '—'} color="primary" />
                                <MetricCard label="Trend" value={velocity?.trend === 'improving' ? '📈 Up' : velocity?.trend === 'declining' ? '📉 Down' : velocity?.trend === 'stable' ? '→ Stable' : '—'} color="warning" />
                            </div>

                            {/* Stories List with Checkboxes */}
                            {stories.length > 0 && (
                                <div className="glass-card p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-sm font-black uppercase tracking-widest text-text-muted flex items-center gap-2"><Icon name="AlignLeft" size={16} /> AI-Generated Stories</h3>
                                        <div className="flex gap-3">
                                            <button onClick={() => setSelectedStories(new Set(stories.map((_, i) => i)))} className="text-xs font-bold text-primary hover:underline">Select All</button>
                                            <button onClick={() => setSelectedStories(new Set())} className="text-xs font-bold text-text-muted hover:underline">Deselect All</button>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {stories.map((story, idx) => {
                                            const fit = fitBadge(story.sprint_fit);
                                            const isSelected = selectedStories.has(idx);
                                            return (
                                                <motion.div key={idx} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: idx * 0.05 }}
                                                    className={`p-5 bg-bg-body rounded-xl border transition-all cursor-pointer hover:shadow-md ${isSelected ? 'border-primary shadow-sm' : 'border-border'}`}
                                                    onClick={() => { const s = new Set(selectedStories); s.has(idx) ? s.delete(idx) : s.add(idx); setSelectedStories(s); }}>
                                                    <div className="flex items-start gap-4">
                                                        <div className={`w-6 h-6 rounded-md border-2 flex items-center justify-center shrink-0 mt-0.5 transition-all ${isSelected ? 'bg-primary border-primary' : 'border-border'}`}>
                                                            {isSelected && <Icon name="CheckCircle" size={14} className="text-white" />}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-3 flex-wrap mb-2">
                                                                <span className="font-bold text-text-main text-sm">{story.title}</span>
                                                                <span className="px-2 py-0.5 rounded-full text-xs font-black" style={{ background: `${fit.bg}22`, color: fit.bg, border: `1px solid ${fit.bg}44` }}>{fit.text}</span>
                                                                <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-primary-dim text-primary">{story.suggested_points || 0} pts</span>
                                                                {story.priority && <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${story.priority === 'High' ? 'bg-danger/10 text-danger' : story.priority === 'Low' ? 'bg-success/10 text-success' : 'bg-warning/10 text-warning'}`}>{story.priority}</span>}
                                                            </div>
                                                            <p className="text-xs text-text-muted leading-relaxed mb-2">{story.description}</p>
                                                            {story.acceptance_criteria?.length > 0 && (
                                                                <div className="mt-2">
                                                                    <span className="text-xs font-bold text-text-muted uppercase tracking-wider">Acceptance Criteria:</span>
                                                                    <ul className="mt-1 space-y-1">
                                                                        {story.acceptance_criteria.map((ac, ai) => (
                                                                            <li key={ai} className="text-xs text-text-muted flex items-start gap-2"><Icon name="CheckCircle" size={12} className="text-success shrink-0 mt-0.5" />{ac}</li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            )}
                                                            <div className="flex gap-6 mt-3 text-xs text-text-muted font-medium">
                                                                {story.suggested_assignee && story.suggested_assignee !== 'Unassigned' && <span className="flex items-center gap-1"><Icon name="Users" size={12} className="text-primary" /> {story.suggested_assignee}</span>}
                                                                {story.estimated_days > 0 && <span className="flex items-center gap-1"><Icon name="Clock" size={12} /> ~{story.estimated_days} days</span>}
                                                                {story.estimation_reasoning && <span className="truncate max-w-xs" title={story.estimation_reasoning}>{story.estimation_reasoning}</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </motion.div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Epics */}
                            {epics.length > 0 && (
                                <div className="glass-card p-8">
                                    <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2"><Icon name="Layers" size={16} /> AI-Generated Epics</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        {epics.map((epic, idx) => (
                                            <div key={idx} className={`p-5 bg-bg-body rounded-xl border transition-all cursor-pointer ${selectedEpics.has(idx) ? 'border-primary shadow-sm' : 'border-border'}`}
                                                onClick={() => { const s = new Set(selectedEpics); s.has(idx) ? s.delete(idx) : s.add(idx); setSelectedEpics(s); }}>
                                                <div className="flex items-center gap-3 mb-2">
                                                    <div className={`w-5 h-5 rounded-md border-2 flex items-center justify-center shrink-0 ${selectedEpics.has(idx) ? 'bg-primary border-primary' : 'border-border'}`}>
                                                        {selectedEpics.has(idx) && <Icon name="CheckCircle" size={12} className="text-white" />}
                                                    </div>
                                                    <span className="font-bold text-text-main text-sm">{epic.title}</span>
                                                </div>
                                                <p className="text-xs text-text-muted leading-relaxed">{epic.motivation}</p>
                                                {epic.child_story_indices?.length > 0 && <p className="text-xs text-primary font-bold mt-2">{epic.child_story_indices.length} linked stories</p>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Action Items / Concerns */}
                            {(actionItems.length > 0 || capacityConcerns.length > 0) && (
                                <div className="grid grid-cols-2 gap-4">
                                    {actionItems.length > 0 && (
                                        <div className="glass-card p-6">
                                            <h4 className="text-xs font-black uppercase tracking-widest text-text-muted mb-4 flex items-center gap-2"><Icon name="Target" size={14} /> Action Items</h4>
                                            <ul className="space-y-2">{actionItems.map((item, i) => <li key={i} className="text-sm text-text-main font-medium flex items-start gap-2"><Icon name="ArrowRight" size={14} className="text-primary shrink-0 mt-0.5" />{item}</li>)}</ul>
                                        </div>
                                    )}
                                    {capacityConcerns.length > 0 && (
                                        <div className="glass-card p-6">
                                            <h4 className="text-xs font-black uppercase tracking-widest text-text-muted mb-4 flex items-center gap-2"><Icon name="AlertTriangle" size={14} className="text-warning" /> Capacity Concerns</h4>
                                            <ul className="space-y-2">{capacityConcerns.map((item, i) => <li key={i} className="text-sm text-text-main font-medium flex items-start gap-2"><Icon name="AlertTriangle" size={14} className="text-warning shrink-0 mt-0.5" />{item}</li>)}</ul>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Retro Items (if retrospective) */}
                            {results?.extracted?.retro_items && (
                                <div className="grid grid-cols-3 gap-4">
                                    {['well', 'improve', 'actions'].map(col => {
                                        const items = results.extracted.retro_items[col] || [];
                                        const colors = { well: 'var(--success)', improve: 'var(--danger)', actions: 'var(--primary)' };
                                        const labels = { well: 'What Went Well', improve: 'Needs Improvement', actions: 'Action Items' };
                                        return (
                                            <div key={col} className="glass-card overflow-hidden">
                                                <div className="p-4 border-b border-border text-xs font-black uppercase tracking-wider" style={{ color: colors[col], borderTopWidth: '3px', borderTopColor: colors[col] }}>{labels[col]}</div>
                                                <div className="p-4 space-y-3">
                                                    {items.map((item, i) => (
                                                        <div key={i} className="p-3 bg-bg-body rounded-lg border border-border text-sm text-text-main">
                                                            {item.text || item}
                                                            {item.owner && <span className="block text-xs text-primary font-bold mt-1">Owner: {item.owner}</span>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Create in Jira Button */}
                            {stories.length > 0 && (
                                <div className="glass-card p-6 flex justify-between items-center">
                                    <div>
                                        <span className="text-sm font-bold text-text-main">{selectedStories.size} stories and {selectedEpics.size} epics selected</span>
                                        <span className="text-xs text-text-muted ml-3">Will be created in Jira project <span className="text-primary font-bold">{project}</span></span>
                                    </div>
                                    {createdIssues.length > 0 ? (
                                        <div className="flex items-center gap-3">
                                            <Icon name="CheckCircle" size={20} className="text-success" />
                                            <div>
                                                <span className="text-sm font-bold text-success">{createdIssues.length} issues created!</span>
                                                <div className="flex gap-2 mt-1 flex-wrap">
                                                    {createdIssues.map((iss, i) => (
                                                        <a key={i} href={iss.url} target="_blank" rel="noopener noreferrer" className="text-xs font-bold text-primary hover:underline">{iss.key}</a>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <button onClick={approveAndCreate} disabled={creating || selectedStories.size === 0}
                                            className="px-8 py-3 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex items-center gap-3 text-sm disabled:opacity-50"
                                            style={{ background: 'var(--accent-gradient)' }}>
                                            {creating ? <><span className="loader w-5 h-5 border-2" /> Creating in Jira...</> : <><Icon name="Zap" size={18} /> Create in Jira</>}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {subView === 'results' && !results && (
                        <div className="glass-card p-16 flex flex-col items-center justify-center text-center">
                            <Icon name="MessageSquare" size={56} className="text-text-muted mb-6 opacity-40" />
                            <h3 className="text-2xl font-extrabold text-text-main mb-3">No Results Yet</h3>
                            <p className="text-text-muted font-medium max-w-md">Process a meeting transcript first, or load a past session from History.</p>
                            <button onClick={() => setSubView('input')} className="mt-6 px-6 py-3 text-white font-bold rounded-xl text-sm" style={{ background: 'var(--accent-gradient)' }}>Go to Input</button>
                        </div>
                    )}

                    {/* ——— CAPACITY SUB-VIEW ——— */}
                    {subView === 'capacity' && (
                        <div className="space-y-6">
                            {loadingCapacity ? <LoadingScreen msg="Loading Capacity Analysis..." /> : !capacityData ? (
                                <div className="glass-card p-16 text-center">
                                    <Icon name="BarChart" size={56} className="text-text-muted mb-6 opacity-40 mx-auto" />
                                    <h3 className="text-2xl font-extrabold text-text-main mb-3">Capacity Analysis</h3>
                                    <button onClick={loadCapacity} className="mt-4 px-6 py-3 text-white font-bold rounded-xl text-sm" style={{ background: 'var(--accent-gradient)' }}>Load Capacity Data</button>
                                </div>
                            ) : (
                                <>
                                    {/* Velocity Chart */}
                                    {sprintHistory?.velocity && (
                                        <div className="glass-card p-8">
                                            <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2"><Icon name="TrendingUp" size={16} /> Team Velocity</h3>
                                            <div className="grid grid-cols-4 gap-4 mb-6">
                                                <MetricCard label="Avg Velocity" value={sprintHistory.velocity.avg_velocity} color="primary" />
                                                <MetricCard label="Trend" value={sprintHistory.velocity.trend === 'improving' ? '📈 Improving' : sprintHistory.velocity.trend === 'declining' ? '📉 Declining' : '→ Stable'} color={sprintHistory.velocity.trend === 'improving' ? 'success' : sprintHistory.velocity.trend === 'declining' ? 'danger' : 'warning'} />
                                                <MetricCard label="Min" value={sprintHistory.velocity.min} color="warning" />
                                                <MetricCard label="Max" value={sprintHistory.velocity.max} color="success" />
                                            </div>
                                            {/* Velocity Bar Chart */}
                                            {sprintHistory.sprint_history?.length > 0 && (
                                                <div className="mt-4">
                                                    <div className="flex items-end gap-3 h-40">
                                                        {sprintHistory.sprint_history.map((s, i) => {
                                                            const maxV = Math.max(1, ...sprintHistory.sprint_history.map(x => x.velocity));
                                                            const pct = (s.velocity / maxV) * 100;
                                                            return (
                                                                <div key={i} className="flex-1 flex flex-col items-center gap-2 group">
                                                                    <span className="text-xs font-black text-primary opacity-0 group-hover:opacity-100 transition-opacity">{s.velocity} pts</span>
                                                                    <div className="w-full rounded-t-lg transition-all hover:opacity-80" style={{ height: `${pct}%`, background: 'var(--accent-gradient)', minHeight: '4px' }} />
                                                                    <span className="text-xs text-text-muted font-medium truncate w-full text-center" title={s.name}>{s.name?.replace('Sprint ', 'S')}</span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Team Workload */}
                                    {capacityData.team_capacity && Object.keys(capacityData.team_capacity).length > 0 && (
                                        <div className="glass-card p-8">
                                            <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-6 flex items-center gap-2"><Icon name="Users" size={16} /> Current Sprint Workload</h3>
                                            <div className="space-y-3">
                                                {Object.entries(capacityData.team_capacity).map(([name, load]) => (
                                                    <div key={name} className="p-4 bg-bg-body rounded-xl border border-border flex items-center gap-4">
                                                        <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0" style={{ background: 'var(--accent-gradient)' }}>{name.charAt(0)}</div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between items-center mb-1">
                                                                <span className="font-bold text-text-main text-sm">{name}</span>
                                                                <span className={`text-xs font-black px-2 py-0.5 rounded-full ${load.utilization_pct > 120 ? 'bg-danger/10 text-danger' : load.utilization_pct < 60 ? 'bg-success/10 text-success' : 'bg-primary/10 text-primary'}`}>{load.utilization_pct}%</span>
                                                            </div>
                                                            <div className="w-full h-2 bg-border rounded-full overflow-hidden">
                                                                <div className="h-full rounded-full transition-all" style={{
                                                                    width: `${Math.min(100, load.utilization_pct)}%`,
                                                                    background: load.utilization_pct > 120 ? 'var(--danger)' : load.utilization_pct < 60 ? 'var(--success)' : 'var(--primary)'
                                                                }} />
                                                            </div>
                                                            <div className="flex gap-4 mt-1 text-xs text-text-muted">
                                                                <span>Committed: {load.committed} pts</span>
                                                                <span>Completed: {load.completed} pts</span>
                                                                <span>Avg: {load.historical_avg} pts</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Recommendations */}
                                    {capacityData.recommendations?.length > 0 && (
                                        <div className="glass-card p-8">
                                            <h3 className="text-sm font-black uppercase tracking-widest text-text-muted mb-4 flex items-center gap-2"><Icon name="Sparkles" size={16} className="text-primary" /> AI Recommendations</h3>
                                            <ul className="space-y-3">
                                                {capacityData.recommendations.map((rec, i) => (
                                                    <li key={i} className="text-sm font-medium text-text-main p-3 bg-bg-body rounded-lg border border-border">{rec}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {/* AI Analysis */}
                                    {capacityData.ai_analysis?.capacity_summary && (
                                        <div className="glass-card p-8 border-t-4 border-primary">
                                            <h3 className="text-xs font-black uppercase tracking-widest text-primary mb-4 flex items-center gap-2"><Icon name="Sparkles" size={16} /> AI Capacity Summary</h3>
                                            <p className="text-base font-semibold text-text-main leading-relaxed">{capacityData.ai_analysis.capacity_summary}</p>
                                            {capacityData.ai_analysis.risk_level && (
                                                <span className={`mt-4 inline-block px-3 py-1 rounded-full text-xs font-bold ${capacityData.ai_analysis.risk_level === 'high' ? 'bg-danger/10 text-danger' : capacityData.ai_analysis.risk_level === 'medium' ? 'bg-warning/10 text-warning' : 'bg-success/10 text-success'}`}>
                                                    Risk: {capacityData.ai_analysis.risk_level.toUpperCase()}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}

                    {/* ——— HISTORY SUB-VIEW ——— */}
                    {subView === 'history' && (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-extrabold text-text-main">Meeting History</h3>
                                <button onClick={() => secureFetch(`/meeting/sessions/${project}`).then(r => r?.json()).then(d => { if (Array.isArray(d)) setHistory(d); })} className="text-xs font-bold text-primary hover:underline flex items-center gap-1"><Icon name="RefreshCcw" size={14} /> Refresh</button>
                            </div>
                            {history.length === 0 ? (
                                <div className="glass-card p-16 text-center">
                                    <Icon name="Clock" size={56} className="text-text-muted mb-6 opacity-40 mx-auto" />
                                    <h3 className="text-xl font-extrabold text-text-main mb-3">No Sessions Yet</h3>
                                    <p className="text-text-muted font-medium">Process your first meeting transcript to get started.</p>
                                </div>
                            ) : (
                                history.map(sess => (
                                    <div key={sess.id} onClick={() => loadSession(sess.id)} className="glass-card p-5 flex justify-between items-center cursor-pointer hover:border-primary transition-all group">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: 'var(--primary-dim)', color: 'var(--primary)' }}>
                                                <Icon name="MessageSquare" size={20} />
                                            </div>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-text-main text-sm">{meetingTypeLabel(sess.meeting_type)}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${sess.status === 'completed' ? 'bg-success/10 text-success' : sess.status === 'error' ? 'bg-danger/10 text-danger' : 'bg-warning/10 text-warning'}`}>{sess.status}</span>
                                                    <span className="text-xs text-text-muted">via {sess.platform}</span>
                                                </div>
                                                <p className="text-xs text-text-muted mt-1 truncate max-w-lg">{sess.transcript_preview}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className="text-xs text-text-muted">{new Date(sess.created_at).toLocaleDateString()}</span>
                                            <Icon name="ChevronRight" size={16} className="text-text-muted group-hover:text-primary transition-colors" />
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function StandupView() { return <div className="h-full flex items-center justify-center text-2xl font-black text-text-muted uppercase tracking-widest">Standup Bot Coming Soon</div>; }
        function LoadingScreen({ msg = "Loading..." }) { return (<div className="h-full w-full flex flex-col items-center justify-center animate-pulse"><div className="w-12 h-12 border-4 border-t-transparent rounded-full animate-spin mb-6 text-primary" style={{ borderColor: 'var(--border)', borderTopColor: 'var(--primary)' }}></div><div className="text-base font-bold tracking-wider text-primary uppercase">{msg}</div></div>); }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>