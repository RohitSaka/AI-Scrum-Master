<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Agile Intelligence | Enterprise</title>
    <link rel="icon" href="data:,">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --transition-speed: 0.2s; }
        .dark-mode {
            --bg-body: #0f172a; --bg-sidebar: #020617; --bg-card: #1e293b; --bg-hover: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
            --primary: #6366f1; --primary-fg: #ffffff; --primary-dim: rgba(99, 102, 241, 0.15);
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .light-mode {
            --bg-body: #F4F5F7; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF; --bg-hover: #EBECF0;
            --text-main: #172B4D; --text-muted: #5E6C84; --border: #DFE1E6;
            --primary: #0052CC; --primary-fg: #ffffff; --primary-dim: rgba(0, 82, 204, 0.1);
            --danger: #DE350B; --success: #00875A; --warning: #FF991F;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); --glass-border: 1px solid var(--border);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background-color var(--transition-speed), color var(--transition-speed); overflow: hidden; }
        .glass-card { background: var(--bg-card); border: var(--glass-border); box-shadow: var(--shadow); border-radius: 0.5rem; }
        .nav-btn { color: var(--text-muted); padding: 0.75rem; border-radius: 0.375rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-btn.active { background: var(--primary-dim); color: var(--primary); border-left: 3px solid var(--primary); }
        .input-field { background-color: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: var(--primary); }
        .chat-bubble { position: fixed; bottom: 24px; right: 24px; z-index: 50; }
        .prose strong { color: var(--primary); font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; }
        .prose li { margin-bottom: 0.25rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .loader { width: 20px; height: 20px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion;
        const API_BASE = "https://ai-scrum-master-cm2c.onrender.com"; 

        const Icon = ({ name, size = 18 }) => {
            const icons = {
                BarChart2: <><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>,
                MessageSquare: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></>,
                RefreshCcw: <><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></>,
                Sun: <><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></>,
                Moon: <><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icons[name] || null}</svg>;
        };

        const secureFetch = async (endpoint, options = {}) => {
            const config = JSON.parse(localStorage.getItem('ig_config') || '{}');
            if (!config.token || !config.domain) return null;
            const headers = { 'Content-Type': 'application/json', 'x-license-key': 'IG-ENTERPRISE', 'x-jira-domain': config.domain, 'x-jira-email': config.email, 'x-jira-token': config.token, ...options.headers };
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                if (res.status === 403 || res.status === 401) { localStorage.removeItem('ig_config'); window.location.reload(); return null; }
                return res;
            } catch (error) { console.error("Network Error:", error); return null; }
        };

        function App() {
            const [config, setConfig] = useState(JSON.parse(localStorage.getItem('ig_config')));
            const [theme, setTheme] = useState(localStorage.getItem('ig_theme') || 'dark');
            useEffect(() => { document.body.className = theme === 'dark' ? 'dark-mode' : 'light-mode'; localStorage.setItem('ig_theme', theme); }, [theme]);
            if (!config || !config.token) return <LoginScreen onLogin={(c) => setConfig(c)} theme={theme} setTheme={setTheme} />;
            return <DashboardLayout userRole={config.role || 'scrum_master'} theme={theme} setTheme={setTheme} />;
        }

        function LoginScreen({ onLogin, theme, setTheme }) {
            const [form, setForm] = useState({ domain: '', email: '', token: '', role: 'scrum_master' });
            const [loading, setLoading] = useState(false);
            const handleLogin = () => {
                if (!form.domain || !form.email || !form.token) return alert("Please fill in all fields.");
                setLoading(true); localStorage.setItem('ig_config', JSON.stringify(form));
                setTimeout(() => { setLoading(false); onLogin(form); }, 1000);
            };
            return (
                <div className="h-screen flex items-center justify-center relative transition-colors duration-500" style={{backgroundColor: 'var(--bg-body)'}}>
                    <div className="absolute top-4 right-4"><ThemeToggle theme={theme} setTheme={setTheme} /></div>
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="w-[400px] glass-card p-10 z-10 shadow-2xl">
                        <div className="mb-8 text-center">
                            <h1 className="text-2xl font-bold tracking-tight" style={{color: 'var(--text-main)'}}>IG Agile</h1>
                            <p className="text-sm" style={{color: 'var(--text-muted)'}}>Enterprise Intelligence</p>
                        </div>
                        <div className="space-y-5">
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>Role Profile</label><select value={form.role} onChange={e=>setForm({...form, role:e.target.value})} className="w-full p-3 rounded-lg text-sm input-field cursor-pointer"><option value="leadership">üëë Executive / Leadership</option><option value="scrum_master">‚öîÔ∏è Scrum Master / PM</option><option value="developer">üõ†Ô∏è Developer / Engineer</option></select></div>
                            <div className="h-px bg-slate-700/20"></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>Jira Domain</label><input value={form.domain} onChange={e=>setForm({...form, domain:e.target.value})} placeholder="company.atlassian.net" className="w-full p-3 rounded-lg text-sm input-field" /></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>Email</label><input value={form.email} onChange={e=>setForm({...form, email:e.target.value})} placeholder="you@company.com" className="w-full p-3 rounded-lg text-sm input-field" /></div>
                            <div><label className="text-[10px] font-bold uppercase tracking-wider mb-1 block" style={{color: 'var(--text-muted)'}}>API Token</label><input type="password" value={form.token} onChange={e=>setForm({...form, token:e.target.value})} placeholder="Atlassian API Token" className="w-full p-3 rounded-lg text-sm input-field" /></div>
                            <button onClick={handleLogin} disabled={loading} className="w-full text-white font-bold p-3 rounded-lg shadow-lg transition disabled:opacity-50 mt-4 flex justify-center items-center gap-2" style={{backgroundColor: 'var(--primary)', color: 'var(--primary-fg)'}}>{loading ? <span className="loader"></span> : "Connect Securely"}</button>
                        </div>
                    </motion.div>
                </div>
            );
        }

        function DashboardLayout({ userRole, theme, setTheme }) {
            const [view, setView] = useState('dashboard');
            const [projects, setProjects] = useState([]);
            const [activeProject, setActiveProject] = useState(null);
            const [isChatOpen, setIsChatOpen] = useState(false);

            useEffect(() => {
                secureFetch('/projects').then(r => r ? r.json() : []).then(data => {
                    if (data && data.length > 0) { setProjects(data); setActiveProject(data[0].key); }
                    else { setProjects([{key: 'DEMO', name: 'Demo Project'}]); setActiveProject('DEMO'); }
                }).catch(() => setProjects([{key: 'ERR', name: 'Connection Error'}]));
            }, []);

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 flex flex-col justify-between border-r transition-colors duration-300" style={{backgroundColor: 'var(--bg-sidebar)', borderColor: 'var(--border)'}}>
                        <div className="p-4">
                            <div className="mb-8 pl-2 flex items-center gap-2">
                                <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold" style={{backgroundColor: 'var(--primary)'}}>IG</div>
                                <div><h1 className="text-lg font-bold tracking-tight" style={{color: 'var(--text-main)'}}>Agile</h1><p className="text-[10px] uppercase tracking-wider" style={{color: 'var(--text-muted)'}}>{userRole.replace('_', ' ')}</p></div>
                            </div>
                            <nav className="space-y-1">
                                <NavBtn id="dashboard" icon="BarChart2" label="Command Center" active={view} set={setView} />
                                {userRole !== 'leadership' && <><NavBtn id="timeline" icon="Calendar" label="Timeline" active={view} set={setView} /><NavBtn id="standup" icon="MessageSquare" label="Standup Bot" active={view} set={setView} /></>}
                                {(userRole === 'scrum_master' || userRole === 'leadership') && <><NavBtn id="retro" icon="RefreshCcw" label="Retrospective" active={view} set={setView} /><NavBtn id="reports" icon="FileText" label="Reports" active={view} set={setView} /><NavBtn id="burndown" icon="TrendingDown" label="Burndown" active={view} set={setView} /></>}
                            </nav>
                        </div>
                        <div className="p-4 border-t space-y-4" style={{borderColor: 'var(--border)'}}>
                            <ThemeToggle theme={theme} setTheme={setTheme} fullWidth />
                            <div><label className="text-[10px] font-bold uppercase mb-2 block" style={{color: 'var(--text-muted)'}}>Active Project</label>
                                <select value={activeProject || ''} onChange={e=>setActiveProject(e.target.value)} className="w-full p-2 rounded border text-sm input-field cursor-pointer">
                                    {projects.map(p => <option key={p.key} value={p.key}>{p.name} ({p.key})</option>)}
                                </select>
                            </div>
                            <button onClick={()=>{localStorage.removeItem('ig_config'); window.location.reload()}} className="w-full text-left text-xs p-1 hover:underline" style={{color: 'var(--danger)'}}>Sign Out</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-auto p-8 relative transition-colors duration-300">
                        {activeProject ? (
                            <>
                                {view === 'dashboard' && <DashboardView project={activeProject} role={userRole} />}
                                {view === 'timeline' && <TimelineView project={activeProject} />}
                                {view === 'standup' && <StandupView project={activeProject} />}
                                {view === 'retro' && <RetroView project={activeProject} />}
                                {view === 'reports' && <ReportsView project={activeProject} />}
                                {view === 'burndown' && <BurndownView project={activeProject} />}
                            </>
                        ) : <LoadingScreen msg="Connecting to Jira..." />}
                    </main>
                    <AIChatBubble isOpen={isChatOpen} toggle={() => setIsChatOpen(!isChatOpen)} project={activeProject} />
                </div>
            );
        }

        function ThemeToggle({ theme, setTheme, fullWidth }) {
            return (
                <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`p-2 rounded border text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 transition hover:opacity-80 ${fullWidth ? 'w-full' : ''}`} style={{borderColor: 'var(--border)', color: 'var(--text-muted)', background: 'var(--bg-card)'}}>
                    <Icon name={theme === 'dark' ? 'Sun' : 'Moon'} size={14} /> {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
                </button>
            );
        }

        const NavBtn = ({ id, icon, label, active, set }) => (
            <button onClick={()=>set(id)} className={`nav-btn w-full ${active===id ? 'active' : ''}`}><Icon name={icon} size={18} /> {label}</button>
        );

        function MetricCard({ label, value, color, isDanger }) {
            return (
                <div className="glass-card p-6 border-l-4 transition hover:transform hover:scale-[1.02]" style={{borderLeftColor: isDanger ? 'var(--danger)' : `var(--${color})`}}>
                    <div className="text-[10px] font-bold uppercase tracking-widest mb-1" style={{color: 'var(--text-muted)'}}>{label}</div>
                    <div className="text-3xl font-bold" style={{color: 'var(--text-main)'}}>{value}</div>
                </div>
            );
        }

        // --- DASHBOARD (FIXED STALE DATA) ---
        function DashboardView({ project, role }) {
            const [data, setData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            
            useEffect(() => { 
                setIsLoading(true); // FORCE LOADING SCREEN
                secureFetch(`/analytics/${project}`)
                    .then(r => r ? r.json() : null)
                    .then(d => { setData(d); setIsLoading(false); })
                    .catch(() => setIsLoading(false));
            }, [project]);
            
            if (isLoading || !data) return <LoadingScreen msg="AI is analyzing sprint data..." />;

            return (
                <div className="animate-fade-in space-y-6">
                    <header className="flex justify-between items-end">
                        <div><h2 className="text-3xl font-bold" style={{color: 'var(--text-main)'}}>Command Center</h2><p className="text-sm mt-1" style={{color: 'var(--text-muted)'}}>Live sprint health & risk analysis</p></div>
                        {data.ai_insights?.risk_level && <span className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide border ${data.ai_insights.risk_level === 'High' ? 'bg-red-500/10 border-red-500 text-red-500' : 'bg-emerald-500/10 border-emerald-500 text-emerald-500'}`}>Risk: {data.ai_insights.risk_level}</span>}
                    </header>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <MetricCard label="Velocity (Pts)" value={data.metrics.points} color="primary" />
                        <MetricCard label="Active Tasks" value={data.metrics.total} color="success" />
                        <MetricCard label="Blockers" value={data.metrics.blockers} color="danger" isDanger={data.metrics.blockers > 0} />
                        <MetricCard label="Bugs Found" value={data.metrics.bugs} color="warning" />
                    </div>
                    <div className="glass-card p-8 border-l-4 relative overflow-hidden" style={{borderLeftColor: 'var(--primary)'}}>
                        <h3 className="text-xs font-bold uppercase tracking-widest mb-3" style={{color: 'var(--primary)'}}>AI Executive Summary</h3>
                        <p className="text-lg font-light leading-relaxed" style={{color: 'var(--text-main)'}} dangerouslySetInnerHTML={{ __html: marked.parse(data.ai_insights?.executive_summary || "Processing...") }}></p>
                        {data.ai_insights?.key_recommendation && <div className="mt-6 pt-6 border-t flex gap-2 items-start" style={{borderColor: 'var(--border)'}}><span style={{color: 'var(--warning)'}}>üí°</span><div><span className="text-xs font-bold uppercase block mb-1" style={{color: 'var(--text-muted)'}}>Recommendation</span><span className="text-sm" style={{color: 'var(--text-main)'}}>{data.ai_insights.key_recommendation}</span></div></div>}
                    </div>
                </div>
            );
        }

        // --- TIMELINE (FIXED STALE DATA & CRASH) ---
        function TimelineView({ project }) {
            const [data, setData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            
            useEffect(() => { 
                setIsLoading(true); // FORCE LOADING SCREEN
                secureFetch(`/analytics/${project}`)
                    .then(r=>r?.json())
                    .then(d => { setData(d); setIsLoading(false); })
                    .catch(() => setIsLoading(false));
            }, [project]);
            
            if (isLoading || !data) return <LoadingScreen msg="Loading assignees..." />;

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6" style={{color: 'var(--text-main)'}}>Delivery Timeline</h2>
                    <div className="glass-card rounded-xl overflow-hidden">
                        {Object.entries(data.metrics.assignees).map(([name, stats]) => (
                            <div key={name} className="flex border-b p-4 transition items-center hover:bg-opacity-50" style={{borderColor: 'var(--border)'}}>
                                <div className="w-48 flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white" style={{backgroundColor: 'var(--border)'}}>{name.charAt(0)}</div>
                                    <div><div className="text-sm font-medium" style={{color: 'var(--text-main)'}}>{name.split(" ")[0]}</div><div className="text-[10px]" style={{color: 'var(--text-muted)'}}>{stats.points} pts</div></div>
                                </div>
                                <div className="flex-1 flex gap-2 flex-wrap">
                                    {/* SAFE CHAINING ADDED HERE (?.) TO PREVENT CRASH IF TASKS MISSING */}
                                    {stats.tasks?.map(t => (
                                        <div key={t.key} className="px-3 py-1.5 rounded text-xs border cursor-pointer hover:scale-105 transition shadow-sm" style={{borderColor: t.priority==='High' ? 'var(--danger)' : 'var(--primary)', backgroundColor: 'var(--bg-body)', color: 'var(--text-main)'}}>
                                            <span className="font-bold opacity-70 mr-1">{t.key}</span> {t.summary.substring(0, 25)}...
                                        </div>
                                    ))}
                                    {(!stats.tasks || stats.tasks.length === 0) && <span className="text-xs text-slate-500 italic">No tasks listed</span>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- RETRO (FIXED STALE DATA) ---
        function RetroView({ project }) {
            const [sprints, setSprints] = useState([]); const [activeSprint, setActiveSprint] = useState(null); const [board, setBoard] = useState(null); const [input, setInput] = useState(""); const [col, setCol] = useState("well"); const [loadingAI, setLoadingAI] = useState(false);
            
            useEffect(() => { 
                setSprints([]); setActiveSprint(null); setBoard(null); // RESET STATE
                secureFetch(`/sprints/${project}`).then(r=>r?.json()).then(d => { setSprints(d); if(d.length) setActiveSprint(d[0].id); }); 
            }, [project]);
            
            useEffect(() => { 
                if(activeSprint) { setBoard(null); secureFetch(`/retro/${project}?sprint_id=${activeSprint}`).then(r=>r?.json()).then(setBoard); } 
            }, [project, activeSprint]);
            
            const save = (nb) => { setBoard(nb); secureFetch(`/retro/update`, {method:'POST', body:JSON.stringify({project, sprint:activeSprint, board:nb})}); };
            const add = () => { if(!input) return; save({...board, [col]: [...board[col], {id:Date.now(), text:input}]}); setInput(""); };
            const genActions = () => { setLoadingAI(true); secureFetch(`/retro/generate_actions`, {method:'POST', body:JSON.stringify({board})}).then(r=>r.json()).then(d => { save({...board, actions:[...board.actions, ...d.actions]}); setLoadingAI(false); }); };
            
            if(!board) return <LoadingScreen msg="Loading Retrospective..." />;

            return (
                <div className="h-full flex flex-col pb-6">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold" style={{color: 'var(--text-main)'}}>Retrospective</h2><select value={activeSprint||""} onChange={e=>setActiveSprint(e.target.value)} className="p-2 rounded border text-xs input-field">{sprints.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                    <div className="flex gap-2 mb-6"><div className="flex p-1 rounded-lg border" style={{borderColor: 'var(--border)', backgroundColor: 'var(--bg-card)'}}>{['well', 'improve', 'kudos'].map(c => <button key={c} onClick={()=>setCol(c)} className="px-4 py-1.5 rounded-md text-xs font-bold capitalize transition" style={{backgroundColor: col===c ? 'var(--primary)' : 'transparent', color: col===c ? 'white' : 'var(--text-muted)'}}>{c}</button>)}</div><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&add()} placeholder={`Add to ${col}...`} className="flex-1 rounded-lg px-4 text-sm input-field" /><button onClick={add} className="text-white px-6 rounded-lg font-bold text-sm" style={{backgroundColor: 'var(--primary)'}}>Post</button></div>
                    <div className="grid grid-cols-4 gap-4 flex-1 min-h-0">
                        {['well','improve','kudos'].map(c=><div key={c} className="glass-card p-4 rounded-xl flex flex-col overflow-hidden"><h3 className="font-bold uppercase text-[10px] mb-4" style={{color: 'var(--text-muted)'}}>{c}</h3><div className="overflow-y-auto space-y-3 flex-1">{board[c]?.map(i=><div key={i.id} className="p-3 rounded border text-sm" style={{backgroundColor: 'var(--bg-body)', borderColor: 'var(--border)', color: 'var(--text-main)'}}>{i.text}</div>)}</div></div>)}
                        <div className="glass-card p-4 rounded-xl flex flex-col border-l-2" style={{borderLeftColor: 'var(--primary)'}}><h3 className="font-bold uppercase text-[10px] mb-4 flex justify-between" style={{color: 'var(--primary)'}}>Actions <button onClick={genActions} disabled={loadingAI} className="px-2 py-1 rounded text-[10px]" style={{backgroundColor: 'var(--primary-dim)', color: 'var(--primary)'}}>{loadingAI?"...":"‚ú® AI"}</button></h3><div className="overflow-y-auto space-y-3 flex-1">{board.actions?.map(i=><div key={i.id} className="p-3 rounded border text-sm" style={{borderColor: 'var(--primary)', backgroundColor: 'var(--primary-dim)', color: 'var(--text-main)'}}>{i.text}</div>)}</div></div>
                    </div>
                </div>
            );
        }

        // --- OTHERS ---
        function StandupView({ project }) { return <div className="text-center p-10 opacity-50 text-xl font-bold" style={{color: 'var(--text-muted)'}}>Standup Bot Coming Soon</div>; }
        function BurndownView() { return <div className="text-center p-10 opacity-50 text-xl font-bold" style={{color: 'var(--text-muted)'}}>Burndown Chart Coming Soon</div> }
        
        // --- REPORTS (FIXED CRASH) ---
        function ReportsView({ project }) { 
            const [rep, setRep] = useState(null);
            
            useEffect(()=>{ 
                setRep(null); // FIX: Was wrongly calling setData(null)
                secureFetch(`/reports/${project}/weekly`)
                    .then(r=>r?.json())
                    .then(setRep)
                    .catch(() => setRep({completed_count: 0, completed_points: 0, ai_summary: {summary: "Failed to load"}}));
            },[project]);
            
            if(!rep) return <LoadingScreen msg="Generating Weekly Report..."/>;
            return <div className="glass-card p-8"><h2 className="text-2xl font-bold mb-2" style={{color: 'var(--text-main)'}}>Weekly Report</h2><div className="text-4xl font-black mb-4" style={{color: 'var(--primary)'}}>{rep.completed_count} Tasks Completed</div><p className="leading-relaxed" style={{color: 'var(--text-muted)'}}>{rep.ai_summary?.summary}</p></div> 
        }

        function LoadingScreen({ msg = "Loading..." }) { 
            return (
                <div className="h-full w-full flex flex-col items-center justify-center animate-pulse">
                    <div className="w-10 h-10 border-4 border-t-transparent rounded-full animate-spin mb-4" style={{borderColor: 'var(--primary)', borderTopColor: 'transparent'}}></div>
                    <div className="text-sm font-medium tracking-wide" style={{color: 'var(--primary)'}}>{msg}</div>
                </div>
            ); 
        }

        function AIChatBubble({ isOpen, toggle, project }) {
            const [input, setInput] = useState(""); const [msgs, setMsgs] = useState([{role:'ai', text:"I'm your Data Analyst. Ask me anything."}]);
            const ask = () => { if(!input) return; const q=input; setMsgs(p=>[...p,{role:'user', text:q}]); setInput(""); secureFetch('/chat/agent', {method:'POST', body:JSON.stringify({project, query:q})}).then(r=>r?.json()).then(d=>setMsgs(p=>[...p,{role:'ai', text:d.response}])); };
            const parseMarkdown = (text) => text ? marked.parse(text) : "";
            return (
                <div className="chat-bubble">
                    <AnimatePresence>{isOpen && (
                        <motion.div initial={{opacity:0, y:20}} animate={{opacity:1, y:0}} exit={{opacity:0}} className="mb-4 w-96 glass-card flex flex-col overflow-hidden shadow-2xl border" style={{height:'500px', borderColor: 'var(--border)'}}>
                            <div className="p-3 text-white font-bold flex justify-between text-sm" style={{backgroundColor: 'var(--primary)'}}><span>Analyst AI</span><button onClick={toggle}>‚úï</button></div>
                            <div className="flex-1 p-4 overflow-y-auto space-y-3" style={{backgroundColor: 'var(--bg-body)'}}>{msgs.map((m,i) => <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`p-3 rounded-lg text-sm max-w-[85%] prose prose-invert`} style={{backgroundColor: m.role==='user'?'var(--primary)':'var(--bg-card)', color: m.role==='user'?'white':'var(--text-main)', border: m.role==='bot'?'1px solid var(--border)':'none'}} dangerouslySetInnerHTML={{ __html: parseMarkdown(m.text) }} /></div>)}</div>
                            <div className="p-2 flex gap-2 border-t" style={{borderColor: 'var(--border)', backgroundColor: 'var(--bg-sidebar)'}}><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&ask()} className="flex-1 rounded p-1.5 text-xs input-field" placeholder="Ask..." /><button onClick={ask} className="font-bold text-xs px-2" style={{color: 'var(--primary)'}}><Icon name="Send" size={16}/></button></div>
                        </motion.div>
                    )}</AnimatePresence>
                    <button onClick={toggle} className="w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-lg transition hover:scale-110 text-white" style={{backgroundColor: 'var(--primary)'}}>‚ú®</button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>